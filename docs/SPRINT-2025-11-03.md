# GPS2 Sprint - November 3, 2025

**Started:** November 3, 2025
**Status:** Active ðŸš§
**Branch:** GPS2-42
**Previous Sprint:** [SPRINT-2025-11-02.md](SPRINT-2025-11-02.md)

---

## ðŸŽ¯ **Sprint Goals**

**Focus:** Code audit, Phase 2.5 systems, and high-priority bug fixes

**Priority Areas:**
1. Audit previous sprint's code and CSS for consistency
2. Implement Phase 2.5 systems (Food consumption limits, personality traits)
3. Fix window focus bug affecting autonomous behavior
4. Polish and optimization

---

## ðŸ“‹ **Sprint Backlog**

### Code Audit & Cleanup ðŸ”

#### Audit Previous Sprint Code
**Priority:** HIGH
**Status:** âœ… Completed
**Category:** Code Quality

**Goal:** Review all code from November 2 sprint for consistency, best practices, and potential issues

**Areas Reviewed:**
1. **Smart Bedding System** âœ… (Previously audited)
   - Proportional bedding consumption logic verified
   - Fractional quantity tracking working correctly
   - Dialog UX and error handling complete

2. **Companion Bond System Updates** âœ… (Previously audited)
   - Proximity time tracking and reactivity fixes verified
   - Bond strength message calculations correct
   - Bonding rate (+1 per 10 seconds) working

3. **Player Friendship Display** âœ… (Previously audited)
   - Friendship message logic verified
   - Display positioning and styling complete

4. **Toggle Button Implementation** âœ… (Previously audited)
   - Toggle button consistency across panels verified
   - Flex utilities usage correct

5. **Hand-Feed System** âœ… (Previously audited)
   - Food selection dialog verified
   - Cooldown system implementation complete
   - Bedding type select truncation fix working

6. **Animation Systems** âœ… **NEW AUDIT**
   - Guinea pig chomp animation (chewing chew toys)
   - Guinea pig wiggle during player interactions
   - Animation timing, priorities, and paused states

7. **Visual Display Systems** âœ… **NEW AUDIT**
   - Guinea pig sprite offsets (same shelter stacking fix)
   - Offset calculation and rendering

8. **Bug Fixes** âœ… **NEW AUDIT**
   - clearAllStorage() rewrite
   - Activity feed auto-scroll direction fix
   - Tooltip hover grace period implementation
   - Hay duplication bug fix + duplicate drop handler removal

9. **Social Bonding** âœ… **NEW AUDIT**
   - Sleeping-together bonding bonus (System 24)
   - Bond event recording

10. **Interaction Systems** âœ… **NEW AUDIT**
    - Gentle pet wipe interaction (hygiene boost)
    - Interaction cooldown tracking

**Files Audited:**
- [habitatConditions.ts](../src/stores/habitatConditions.ts) âœ…
- [guineaPigStore.ts](../src/stores/guineaPigStore.ts) âœ…
- [bondingProgression.ts](../src/utils/bondingProgression.ts) âœ…
- [CleanCageDialog.vue](../src/components/game/dialogs/CleanCageDialog.vue) âœ…
- [FoodSelectionDialog.vue](../src/components/game/dialogs/FoodSelectionDialog.vue) âœ…
- [SocializeSidebar.vue](../src/components/game/habitat/sidebars/SocializeSidebar.vue) âœ…
- [HabitatDebug.vue](../src/components/debug/environment/HabitatDebug.vue) âœ…
- [AutonomyDebug.vue](../src/components/debug/environment/AutonomyDebug.vue) âœ…
- **[GuineaPigSprite.vue](../src/components/game/habitat/GuineaPigSprite.vue)** âœ… **NEW**
- **[useGuineaPigBehavior.ts](../src/composables/game/useGuineaPigBehavior.ts)** âœ… **NEW**
- **[behaviorStateStore.ts](../src/stores/behaviorStateStore.ts)** âœ… **NEW**
- **[interactionEffects.ts](../src/utils/interactionEffects.ts)** âœ… **NEW**
- **[UtilityNav.vue](../src/components/layout/UtilityNav.vue)** âœ… **NEW**
- **[ActivityFeed.vue](../src/components/game/ui/ActivityFeed.vue)** âœ… **NEW**
- **[HabitatItemPopover.vue](../src/components/game/habitat/HabitatItemPopover.vue)** âœ… **NEW**
- **[useHabitatContainers.ts](../src/composables/useHabitatContainers.ts)** âœ… **NEW**

**Checklist:**
- [x] Run TypeScript strict mode check âœ… Build passes
- [x] Review all `TODO` and `FIXME` comments âœ… Only 3 found, all future features
- [x] Check for unused imports and variables âœ… None found
- [x] Verify error handling in new functions âœ… All have proper guards and returns
- [x] Check for magic numbers (should use constants) âœ… Most fixed, 1 minor issue found
- [x] Review computed property dependencies âœ… All properly defined
- [x] Verify reactive updates work correctly âœ… Map recreation pattern used correctly
- [x] Check for memory leaks (intervals, listeners) âœ… **2 minor risks found**
- [x] Review animation systems âœ… Properly implemented
- [x] Review bug fixes âœ… All working correctly
- [x] Check for production console.logs âœ… **Excessive logging found in behavior system**

**Code Quality Issues Fixed (Previous Audit):**
1. **habitatConditions.ts** - Replaced magic numbers (5, 10, 15) with `CONSUMPTION.WATER_MINIMUM_LEVEL`, `WATER_CONSUMPTION_MIN`, `WATER_CONSUMPTION_MAX`
2. **guineaPigStore.ts** - Fixed parameter name `hoursToAdd` â†’ `minutesToAdd` to match actual usage
3. **supplies.ts** - Added water consumption constants to centralized config

**Performance & Efficiency Fixes (Previous Audit):**
1. **ðŸ”´ CRITICAL: SocializeSidebar.vue** - Fixed memory leak where `setInterval` created new Map every second
   - **Before:** `interactionCooldowns.value = new Map(interactionCooldowns.value)` every 1000ms
   - **After:** Interval only runs when cooldown active, auto-stops when expired
   - **Impact:** Eliminates unnecessary re-renders and Map allocations

2. **friendshipMessages.ts** - Extracted duplicate functions (38 lines â†’ shared utility)
   - Removed duplicate `getBondStrengthMessage()` and `getPlayerFriendshipMessage()`
   - Created shared utility with threshold-based lookup
   - **Impact:** DRY principle, easier to maintain message thresholds

3. **guineaPigStore.ts** - Added `getBondsForGuineaPig(id)` optimized method
   - **Before:** `getAllBonds().filter(bond => ...)` - O(n) get all + O(n) filter
   - **After:** Direct iteration with early returns - O(n) single pass
   - **Impact:** Faster bond lookups for UI rendering

4. **bondingProgression.ts** - Lazy-initialized cached store instances
   - **Before:** Called `useGuineaPigStore()` etc. every game tick per bond
   - **After:** Lazy initialization on first call, then cached (prevents circular dependency errors)
   - **Impact:** Eliminates repeated store initialization overhead while avoiding module-load issues

5. **FoodSelectionDialog.vue** - Optimized filtering logic
   - **Before:** `.map().filter()` - created objects then discarded them
   - **After:** Check quantity first, only create objects for items with stock
   - **Impact:** Fewer object allocations, faster filtering

6. **CleanCageDialog.vue** - Removed `!important` flag, used specificity instead
   - Changed `.text-warning` to `.bedding-info__value.text-warning`
   - **Impact:** Better CSS maintainability, follows BEM standards

**NEW Issues Found (Extended Audit):**

**ðŸŸ¡ MEDIUM - Production Console.logs**
- **File:** [useGuineaPigBehavior.ts](../src/composables/game/useGuineaPigBehavior.ts)
- **Lines:** 596-710 (eat behavior), 973-1055 (eat hay behavior)
- **Issue:** 18+ console.log statements in production code
- **Impact:** Performance overhead, clutters console, not suitable for production
- **Recommendation:** Remove or wrap in `DEBUG_BEHAVIOR` flag (like `DEBUG_SOCIALIZE` on line 57)
- **Priority:** Medium (not breaking, but should be cleaned up)

**ðŸŸ¡ MINOR - Memory Leak Risk: Uncleaned Timeout**
- **File:** [HabitatItemPopover.vue](../src/components/game/habitat/HabitatItemPopover.vue)
- **Line:** 74: `let hideTimeout: number | null = null`
- **Issue:** Timeout may not be cleared if component unmounts while timeout is pending
- **Impact:** Low risk - timeout is short (200-300ms), but cleanup is best practice
- **Recommendation:** Add `onUnmounted(() => { if (hideTimeout) clearTimeout(hideTimeout) })`
- **Priority:** Low (minor cleanup)

**ðŸŸ¡ MINOR - Memory Leak Risk: Untracked setTimeout**
- **File:** [behaviorStateStore.ts](../src/stores/behaviorStateStore.ts)
- **Line:** 73: `setTimeout(() => { ... }, duration)`
- **Issue:** If guinea pig is removed from store before timeout completes, timeout will still execute
- **Impact:** Very low risk - just sets activity to idle on deleted guinea pig (no-op)
- **Recommendation:** Track timeout reference and add cleanup in `removeBehaviorState()`
- **Priority:** Low (edge case, minimal impact)

**ðŸŸ¢ MINOR - Magic Number**
- **File:** [GuineaPigSprite.vue](../src/components/game/habitat/GuineaPigSprite.vue)
- **Line:** 51: `const CELL_SIZE = 60`
- **Issue:** Magic number duplicated from HabitatVisual
- **Impact:** Minimal - but creates maintenance risk if cell size changes
- **Recommendation:** Import from shared constants or props
- **Priority:** Low (not urgent)

**Verified Working:**
- Smart bedding system with proportional consumption âœ…
- Bond proximity time tracking with reactivity âœ…
- Fractional quantity tracking (amountRemaining) âœ…
- Error handling in cleanCage() function âœ…
- Food selection dialog with category filtering âœ…
- All performance optimizations pass TypeScript strict mode âœ…
- **Guinea pig chomp animation** âœ… **NEW**
- **Guinea pig interaction wiggle animation** âœ… **NEW**
- **Gentle wipe interaction (hygiene/comfort boost)** âœ… **NEW**
- **Sleeping-together bonding bonus** âœ… **NEW**
- **Sprite offset rendering (no stacking)** âœ… **NEW**
- **clearAllStorage() proper sequencing** âœ… **NEW**
- **Activity feed scroll to top (newest first)** âœ… **NEW**
- **Tooltip hover grace period** âœ… **NEW**
- **Hay duplication fix (infinite resource exploit eliminated)** âœ… **NEW**

**Animation System Review:**
- âœ… Chomp animation triggers correctly on chewing activity
- âœ… Interaction wiggle animation triggers on all player interactions
- âœ… Animation priorities handled with `!important` (playing/chewing/interacting > walking)
- âœ… Paused states comprehensive (lines 218-234 in GuineaPigSprite.vue)
- âœ… CSS uses BEM naming (`.guinea-pig-sprite--chewing`)
- âœ… CSS uses logical properties throughout
- âœ… Flipped animations for left-facing guinea pigs
- âœ… `triggerPlayerInteraction()` helper properly sets duration and auto-returns to idle

**Bug Fix Verification:**
- âœ… **clearAllStorage()** properly sequences: stop game loop â†’ clear habitat â†’ clear guinea pigs â†’ clear storage â†’ delay â†’ reload
- âœ… **Activity feed** scrolls to top (line 161), matches reverse display order
- âœ… **Tooltip hover** grace period (200ms) with popover hover detection prevents disappearing
- âœ… **Hay duplication** fix removes incorrect `addConsumableWithServings()` call (useHabitatContainers.ts:297)
- âœ… **Duplicate drop handlers** removed from HabitatVisual (prevents double consumption)

**Social Bonding Verification:**
- âœ… **Sleeping together** bonus (+2 bond points) when both guinea pigs sleeping at same position
- âœ… Bond event recorded with description in bond history
- âœ… Activity feed shows cuddle message with location
- âœ… Works for any shared sleeping location (shelters, beds, floor)

**Code Quality Summary:**
- **Total Files Audited:** 17 files (8 previously + 9 new)
- **Critical Issues:** 0
- **Medium Issues:** 1 (console.logs in production)
- **Minor Issues:** 2 (timeout cleanup edge cases) + 1 (magic number)
- **Systems Verified Working:** 15 systems (5 previous + 10 new)
- **Overall Assessment:** Code quality is excellent, only minor cleanup needed

---

#### CSS Audit & Consistency Check
**Priority:** HIGH
**Status:** ðŸ“‹ Not Started
**Category:** Code Quality

**Goal:** Ensure CSS follows project standards and uses utilities where appropriate

**Areas to Review:**
1. Check for inline styles (should use utilities)
2. Verify BEM naming consistency
3. Check for duplicate styles
4. Ensure logical properties are used (not physical)
5. Verify mobile-first responsive design
6. Check for hardcoded values (should use CSS variables)
7. Review container query usage

**Files to Review:**
- [CleanCageDialog.vue](../src/components/game/dialogs/CleanCageDialog.vue)
- [FoodSelectionDialog.vue](../src/components/game/dialogs/FoodSelectionDialog.vue)
- [SocializeSidebar.vue](../src/components/game/habitat/sidebars/SocializeSidebar.vue)
- Any other files modified in previous sprint

**Checklist:**
- [ ] No inline styles (use utility classes)
- [ ] BEM naming convention followed
- [ ] Logical properties used (margin-inline, etc.)
- [ ] CSS variables used for spacing/colors
- [ ] No !important flags (unless absolutely necessary)
- [ ] Mobile-first media queries
- [ ] Container queries used where appropriate

---

### High Priority Bugs ðŸ”¥

#### Guinea Pigs Stop Autonomous Behavior When Window Loses Focus
**Priority:** HIGH
**Status:** ðŸ“‹ Not Started
**Category:** Core Gameplay

**Issue:** When the game is running but user switches to a different program, guinea pigs fail to fulfill their needs or do any other autonomous actions (pooping still works).

**Possible Cause:** Browser throttling requestAnimationFrame when window not focused.

**Potential Solutions:**
1. Switch from requestAnimationFrame to setInterval for autonomous behavior
2. Use Page Visibility API to detect when tab loses focus
3. Accumulate time while unfocused and "catch up" when refocused
4. Use Web Workers for autonomous behavior (more complex)

**Files to Investigate:**
- [gameTimingStore.ts](../src/stores/gameTimingStore.ts) - Main game loop
- [useGuineaPigBehavior.ts](../src/composables/game/useGuineaPigBehavior.ts) - Autonomous behaviors

---

## âš™ï¸ **Phase 2.5 Systems**

**Note:** These systems were deferred during Phase 4 development and need to be implemented before Phase 5.

### System 10.1: Personality Trait Influences on Interactions
**Priority:** HIGH
**Status:** ðŸ“‹ Not Started
**Category:** Social System Enhancement

**Documentation:** [System 10.1](systems/phase2.5/system-10.1-personality-influences.md)

**Goal:** Personality traits affect how guinea pigs respond to player interactions

**Key Features:**
- Shy guinea pigs: lower acceptance rate for handling/play
- Bold guinea pigs: higher acceptance rate, more eager
- Calm guinea pigs: longer tolerance for interactions
- Energetic guinea pigs: prefer active interactions (play > petting)

---

### System 10.2.5: Fulfillment Limitation System
**Priority:** HIGH
**Status:** ðŸ“‹ Not Started
**Category:** Food & Wellness System

**Documentation:** [System 10.2.5](systems/phase2.5/system-10.2.5-fulfillment-limitation.md)

**Goal:** Limit food consumption per hunger cycle to prevent spam feeding

**Key Features:**
- 5 servings max per hunger cycle (excludes hay)
- Hay unlimited (always available)
- Prevents overfeeding exploits
- More realistic feeding patterns

**Includes:** Food Serving Guide UI component (see documentation)

---

### System 10.3: Wellness-Based Interaction Reactions
**Priority:** HIGH
**Status:** ðŸ“‹ Not Started
**Category:** Social System Enhancement

**Documentation:** [System 10.3](systems/phase2.5/system-10.3-wellness-reactions.md)

**Goal:** Guinea pig wellness affects interaction acceptance rates

**Key Features:**
- High wellness (>70): more accepting, lower rejection rate
- Low wellness (<30): more rejections, needs rest/care
- Creates gameplay loop: good care â†’ better interactions â†’ higher friendship

---

## ðŸŽ¯ **Future Sprints - Planned Work**

These items are planned for future sprints and are not part of the current sprint scope.

### Social Interaction Enhancements ðŸ¤

#### Multi-Type Guinea Pig Interactions
**Priority:** LOW (Phase 5+)
**Status:** ðŸ“‹ Not Started (Future Enhancement)

Expand guinea pig social interactions beyond just "socialize":
- Play Interaction (social + play needs)
- Sniff/Investigate (social only)
- Groom/Allogrooming (social + hygiene)
- Huddle/Cuddle (social + comfort)

---

#### Pushable Toys System
**Priority:** LOW (Phase 5+)
**Status:** ðŸ“‹ Not Started (Future Enhancement)

Guinea pigs physically move balls and pushable toys across grid cells.

---

### Adoption System Enhancement ðŸ¹

#### Pre-Bonded Pairs & Solo Guinea Pigs
**Priority:** HIGH (Future Sprint)
**Status:** ðŸ“‹ Not Started

**Documentation:** See sprint doc for full specification

Implement adoption constraints:
- Bonded pairs must be adopted together
- Solo-suitable guinea pigs can be adopted alone
- Enhanced observation system (3 clues including bonding status)

---

### Testing & Balance ðŸŽ®

#### Gameplay Testing Checklist
**Priority:** HIGH (Future Sprint)
**Status:** ðŸ“‹ Not Started

Comprehensive testing of all systems:
- Needs & wellness system
- Autonomous behaviors
- Food & consumption
- Habitat conditions
- Social bonding
- Item metadata & realism

---

#### Create Realism Guidelines
**Priority:** MEDIUM (Future Sprint)
**Status:** ðŸ“‹ Not Started

Document realistic guinea pig care guidelines for game balance:
- Feeding frequency & amounts
- Sleep patterns
- Social behavior
- Habitat cleanliness standards

---

## ðŸ“ **Notes**

- Previous sprint completed 9 major items including bedding system, bonding improvements, and UI enhancements
- Focus this sprint on quality: audit, cleanup, and Phase 2.5 systems
- Window focus bug is high priority as it affects core gameplay experience
- **Next task:** Update [DEVELOPMENT_PHASES.md](DEVELOPMENT_PHASES.md) and related docs to document this cleanup/audit phase
