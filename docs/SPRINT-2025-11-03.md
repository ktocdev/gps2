# GPS2 Sprint - November 3, 2025

**Started:** November 3, 2025
**Status:** Active ğŸš§
**Branch:** GPS2-43
**Previous Sprint:** [SPRINT-2025-11-02.md](SPRINT-2025-11-02.md)

**Progress:**
- âœ… Code Audit Completed (17 files audited, 9.6/10 score)
- âœ… CSS Audit Completed (9 components, 9.6/10 score)
- âœ… Magic Number Fix (CELL_SIZE)
- âœ… Panel Utility Improvements Applied
- âœ… Window Focus Bug Fixed (Page Visibility API + PauseOverlay)
- âœ… Nails Need Display Fixed
- âœ… Needs Decay System Fixed (recalibrated rates + removed death spiral)
- âœ… Needs System Reframing (behavior thresholds + color system redesign)
- âœ… Age Display Hidden (deferred to Phase 5+ aging feature)
- âœ… Clip Nails Interaction Added (with need-based availability)
- âœ… Emoji Selection Fixed (no-select utility class)
- âœ… Bond Progress Bars Replaced (now using SliderField component)
- âœ… Hand-Feed Dialog Confirmation Added (two-step process prevents accidents)
- ğŸ“‹ New items added from todos.md
- ğŸš§ Next: todos.md items + Phase 2.5 systems

---

## ğŸ¯ **Sprint Goals**

**Focus:** Code audit, Phase 2.5 systems, and high-priority bug fixes

**Priority Areas:**
1. Audit previous sprint's code and CSS for consistency
2. Implement Phase 2.5 systems (Food consumption limits, personality traits)
3. Fix window focus bug affecting autonomous behavior
4. Polish and optimization

---

## ğŸ“‹ **Sprint Backlog**

### Code Audit & Cleanup ğŸ”

#### Audit Previous Sprint Code
**Priority:** HIGH
**Status:** âœ… Completed
**Category:** Code Quality

**Goal:** Review all code from November 2 sprint for consistency, best practices, and potential issues

**Areas Reviewed:**
1. **Smart Bedding System** âœ… (Previously audited)
   - Proportional bedding consumption logic verified
   - Fractional quantity tracking working correctly
   - Dialog UX and error handling complete

2. **Companion Bond System Updates** âœ… (Previously audited)
   - Proximity time tracking and reactivity fixes verified
   - Bond strength message calculations correct
   - Bonding rate (+1 per 10 seconds) working

3. **Player Friendship Display** âœ… (Previously audited)
   - Friendship message logic verified
   - Display positioning and styling complete

4. **Toggle Button Implementation** âœ… (Previously audited)
   - Toggle button consistency across panels verified
   - Flex utilities usage correct

5. **Hand-Feed System** âœ… (Previously audited)
   - Food selection dialog verified
   - Cooldown system implementation complete
   - Bedding type select truncation fix working

6. **Animation Systems** âœ… **NEW AUDIT**
   - Guinea pig chomp animation (chewing chew toys)
   - Guinea pig wiggle during player interactions
   - Animation timing, priorities, and paused states

7. **Visual Display Systems** âœ… **NEW AUDIT**
   - Guinea pig sprite offsets (same shelter stacking fix)
   - Offset calculation and rendering

8. **Bug Fixes** âœ… **NEW AUDIT**
   - clearAllStorage() rewrite
   - Activity feed auto-scroll direction fix
   - Tooltip hover grace period implementation
   - Hay duplication bug fix + duplicate drop handler removal

9. **Social Bonding** âœ… **NEW AUDIT**
   - Sleeping-together bonding bonus (System 24)
   - Bond event recording

10. **Interaction Systems** âœ… **NEW AUDIT**
    - Gentle pet wipe interaction (hygiene boost)
    - Interaction cooldown tracking

**Files Audited:**
- [habitatConditions.ts](../src/stores/habitatConditions.ts) âœ…
- [guineaPigStore.ts](../src/stores/guineaPigStore.ts) âœ…
- [bondingProgression.ts](../src/utils/bondingProgression.ts) âœ…
- [CleanCageDialog.vue](../src/components/game/dialogs/CleanCageDialog.vue) âœ…
- [FoodSelectionDialog.vue](../src/components/game/dialogs/FoodSelectionDialog.vue) âœ…
- [SocializeSidebar.vue](../src/components/game/habitat/sidebars/SocializeSidebar.vue) âœ…
- [HabitatDebug.vue](../src/components/debug/environment/HabitatDebug.vue) âœ…
- [AutonomyDebug.vue](../src/components/debug/environment/AutonomyDebug.vue) âœ…
- **[GuineaPigSprite.vue](../src/components/game/habitat/GuineaPigSprite.vue)** âœ… **NEW**
- **[useGuineaPigBehavior.ts](../src/composables/game/useGuineaPigBehavior.ts)** âœ… **NEW**
- **[behaviorStateStore.ts](../src/stores/behaviorStateStore.ts)** âœ… **NEW**
- **[interactionEffects.ts](../src/utils/interactionEffects.ts)** âœ… **NEW**
- **[UtilityNav.vue](../src/components/layout/UtilityNav.vue)** âœ… **NEW**
- **[ActivityFeed.vue](../src/components/game/ui/ActivityFeed.vue)** âœ… **NEW**
- **[HabitatItemPopover.vue](../src/components/game/habitat/HabitatItemPopover.vue)** âœ… **NEW**
- **[useHabitatContainers.ts](../src/composables/useHabitatContainers.ts)** âœ… **NEW**

**Checklist:**
- [x] Run TypeScript strict mode check âœ… Build passes
- [x] Review all `TODO` and `FIXME` comments âœ… Only 3 found, all future features
- [x] Check for unused imports and variables âœ… None found
- [x] Verify error handling in new functions âœ… All have proper guards and returns
- [x] Check for magic numbers (should use constants) âœ… Most fixed, 1 minor issue found
- [x] Review computed property dependencies âœ… All properly defined
- [x] Verify reactive updates work correctly âœ… Map recreation pattern used correctly
- [x] Check for memory leaks (intervals, listeners) âœ… **2 minor risks found**
- [x] Review animation systems âœ… Properly implemented
- [x] Review bug fixes âœ… All working correctly
- [x] Check for production console.logs âœ… **Excessive logging found in behavior system**

**Code Quality Issues Fixed (Previous Audit):**
1. **habitatConditions.ts** - Replaced magic numbers (5, 10, 15) with `CONSUMPTION.WATER_MINIMUM_LEVEL`, `WATER_CONSUMPTION_MIN`, `WATER_CONSUMPTION_MAX`
2. **guineaPigStore.ts** - Fixed parameter name `hoursToAdd` â†’ `minutesToAdd` to match actual usage
3. **supplies.ts** - Added water consumption constants to centralized config

**Performance & Efficiency Fixes (Previous Audit):**
1. **ğŸ”´ CRITICAL: SocializeSidebar.vue** - Fixed memory leak where `setInterval` created new Map every second
   - **Before:** `interactionCooldowns.value = new Map(interactionCooldowns.value)` every 1000ms
   - **After:** Interval only runs when cooldown active, auto-stops when expired
   - **Impact:** Eliminates unnecessary re-renders and Map allocations

2. **friendshipMessages.ts** - Extracted duplicate functions (38 lines â†’ shared utility)
   - Removed duplicate `getBondStrengthMessage()` and `getPlayerFriendshipMessage()`
   - Created shared utility with threshold-based lookup
   - **Impact:** DRY principle, easier to maintain message thresholds

3. **guineaPigStore.ts** - Added `getBondsForGuineaPig(id)` optimized method
   - **Before:** `getAllBonds().filter(bond => ...)` - O(n) get all + O(n) filter
   - **After:** Direct iteration with early returns - O(n) single pass
   - **Impact:** Faster bond lookups for UI rendering

4. **bondingProgression.ts** - Lazy-initialized cached store instances
   - **Before:** Called `useGuineaPigStore()` etc. every game tick per bond
   - **After:** Lazy initialization on first call, then cached (prevents circular dependency errors)
   - **Impact:** Eliminates repeated store initialization overhead while avoiding module-load issues

5. **FoodSelectionDialog.vue** - Optimized filtering logic
   - **Before:** `.map().filter()` - created objects then discarded them
   - **After:** Check quantity first, only create objects for items with stock
   - **Impact:** Fewer object allocations, faster filtering

6. **CleanCageDialog.vue** - Removed `!important` flag, used specificity instead
   - Changed `.text-warning` to `.bedding-info__value.text-warning`
   - **Impact:** Better CSS maintainability, follows BEM standards

**NEW Issues Found (Extended Audit):**

**ğŸŸ¡ MEDIUM - Production Console.logs**
- **File:** [useGuineaPigBehavior.ts](../src/composables/game/useGuineaPigBehavior.ts)
- **Lines:** 596-710 (eat behavior), 973-1055 (eat hay behavior)
- **Issue:** 18+ console.log statements in production code
- **Impact:** Performance overhead, clutters console, not suitable for production
- **Recommendation:** Remove or wrap in `DEBUG_BEHAVIOR` flag (like `DEBUG_SOCIALIZE` on line 57)
- **Priority:** Medium (not breaking, but should be cleaned up)

**ğŸŸ¡ MINOR - Memory Leak Risk: Uncleaned Timeout**
- **File:** [HabitatItemPopover.vue](../src/components/game/habitat/HabitatItemPopover.vue)
- **Line:** 74: `let hideTimeout: number | null = null`
- **Issue:** Timeout may not be cleared if component unmounts while timeout is pending
- **Impact:** Low risk - timeout is short (200-300ms), but cleanup is best practice
- **Recommendation:** Add `onUnmounted(() => { if (hideTimeout) clearTimeout(hideTimeout) })`
- **Priority:** Low (minor cleanup)

**ğŸŸ¡ MINOR - Memory Leak Risk: Untracked setTimeout**
- **File:** [behaviorStateStore.ts](../src/stores/behaviorStateStore.ts)
- **Line:** 73: `setTimeout(() => { ... }, duration)`
- **Issue:** If guinea pig is removed from store before timeout completes, timeout will still execute
- **Impact:** Very low risk - just sets activity to idle on deleted guinea pig (no-op)
- **Recommendation:** Track timeout reference and add cleanup in `removeBehaviorState()`
- **Priority:** Low (edge case, minimal impact)

**ğŸŸ¢ MINOR - Magic Number**
- **File:** [GuineaPigSprite.vue](../src/components/game/habitat/GuineaPigSprite.vue)
- **Line:** 51: `const CELL_SIZE = 60`
- **Issue:** Magic number duplicated from HabitatVisual
- **Impact:** Minimal - but creates maintenance risk if cell size changes
- **Recommendation:** Import from shared constants or props
- **Priority:** Low (not urgent)

**Verified Working:**
- Smart bedding system with proportional consumption âœ…
- Bond proximity time tracking with reactivity âœ…
- Fractional quantity tracking (amountRemaining) âœ…
- Error handling in cleanCage() function âœ…
- Food selection dialog with category filtering âœ…
- All performance optimizations pass TypeScript strict mode âœ…
- **Guinea pig chomp animation** âœ… **NEW**
- **Guinea pig interaction wiggle animation** âœ… **NEW**
- **Gentle wipe interaction (hygiene/comfort boost)** âœ… **NEW**
- **Sleeping-together bonding bonus** âœ… **NEW**
- **Sprite offset rendering (no stacking)** âœ… **NEW**
- **clearAllStorage() proper sequencing** âœ… **NEW**
- **Activity feed scroll to top (newest first)** âœ… **NEW**
- **Tooltip hover grace period** âœ… **NEW**
- **Hay duplication fix (infinite resource exploit eliminated)** âœ… **NEW**

**Animation System Review:**
- âœ… Chomp animation triggers correctly on chewing activity
- âœ… Interaction wiggle animation triggers on all player interactions
- âœ… Animation priorities handled with `!important` (playing/chewing/interacting > walking)
- âœ… Paused states comprehensive (lines 218-234 in GuineaPigSprite.vue)
- âœ… CSS uses BEM naming (`.guinea-pig-sprite--chewing`)
- âœ… CSS uses logical properties throughout
- âœ… Flipped animations for left-facing guinea pigs
- âœ… `triggerPlayerInteraction()` helper properly sets duration and auto-returns to idle

**Bug Fix Verification:**
- âœ… **clearAllStorage()** properly sequences: stop game loop â†’ clear habitat â†’ clear guinea pigs â†’ clear storage â†’ delay â†’ reload
- âœ… **Activity feed** scrolls to top (line 161), matches reverse display order
- âœ… **Tooltip hover** grace period (200ms) with popover hover detection prevents disappearing
- âœ… **Hay duplication** fix removes incorrect `addConsumableWithServings()` call (useHabitatContainers.ts:297)
- âœ… **Duplicate drop handlers** removed from HabitatVisual (prevents double consumption)

**Social Bonding Verification:**
- âœ… **Sleeping together** bonus (+2 bond points) when both guinea pigs sleeping at same position
- âœ… Bond event recorded with description in bond history
- âœ… Activity feed shows cuddle message with location
- âœ… Works for any shared sleeping location (shelters, beds, floor)

**Code Quality Summary:**
- **Total Files Audited:** 17 files (8 previously + 9 new)
- **Critical Issues:** 0
- **Medium Issues:** 1 (console.logs in production)
- **Minor Issues:** 2 (timeout cleanup edge cases) + 1 (magic number)
- **Systems Verified Working:** 15 systems (5 previous + 10 new)
- **Overall Assessment:** Code quality is excellent, only minor cleanup needed

---

#### CSS Audit & Consistency Check
**Priority:** HIGH
**Status:** âœ… Completed
**Category:** Code Quality

**Goal:** Ensure CSS follows project standards and uses utilities where appropriate

**Audit Results:** See [CSS-AUDIT-SPRINT-2025-11-02.md](audits/CSS-AUDIT-SPRINT-2025-11-02.md)

**Files Audited:** 9 components from SPRINT-2025-11-02.md
- [CleanCageDialog.vue](../src/components/game/dialogs/CleanCageDialog.vue) âœ… EXCELLENT (10/10)
- [FoodSelectionDialog.vue](../src/components/game/dialogs/FoodSelectionDialog.vue) âœ… EXCELLENT (10/10)
- [SocializeSidebar.vue](../src/components/game/habitat/sidebars/SocializeSidebar.vue) âœ… GOOD (9/10)
- [GuineaPigSprite.vue](../src/components/game/habitat/GuineaPigSprite.vue) âœ… EXCELLENT (10/10)
- [HabitatDebug.vue](../src/components/debug/environment/HabitatDebug.vue) âœ… GOOD (8.5/10)
- [ActivityFeed.vue](../src/components/game/ui/ActivityFeed.vue) âœ… EXCELLENT (10/10)
- [HabitatItemPopover.vue](../src/components/game/habitat/HabitatItemPopover.vue) âœ… EXCELLENT (10/10)
- [AutonomyDebug.vue](../src/components/debug/environment/AutonomyDebug.vue) âœ… EXCELLENT (10/10)
- [UtilityNav.vue](../src/components/layout/UtilityNav.vue) âœ… EXCELLENT (10/10)

**Overall Score: 9.6/10** - Excellent CSS Quality

**Checklist:**
- [x] No inline styles (use utility classes) âœ… All fixed
- [x] BEM naming convention followed âœ… 100% compliance
- [x] Logical properties used (margin-inline, etc.) âœ… 100% usage
- [x] CSS variables used for spacing/colors âœ… 100% usage
- [x] No !important flags (unless absolutely necessary) âœ… Only 1 found, uses specificity
- [x] Mobile-first media queries âœ… All components mobile-first
- [x] Container queries used where appropriate âšª Not yet adopted project-wide

**Minor Improvements Applied:**
- âœ… SocializeSidebar.vue - Replaced custom `.bond-status` with `.panel .panel--compact` utility
- âœ… HabitatDebug.vue - Replaced custom `.food-bowl-container` with `.panel .panel--compact` utility
- âœ… CSS file size decreased: 134.16 kB â†’ 133.73 kB (0.43 kB saved)

**Key Findings:**
- âœ… Perfect BEM naming convention adherence
- âœ… 100% logical properties usage (RTL-ready)
- âœ… Exclusive use of CSS variables (no magic numbers)
- âœ… Zero inline styles
- âœ… Mobile-first responsive design throughout
- âœ… Accessibility-first animations with `prefers-reduced-motion`

---

### High Priority Bugs ğŸ”¥

#### Guinea Pigs Stop Autonomous Behavior When Window Loses Focus âœ…
**Priority:** HIGH
**Status:** âœ… Complete
**Category:** Core Gameplay

**Issue:** When the game is running but user switches to a different program, guinea pigs fail to fulfill their needs or do any other autonomous actions (pooping still works).

**Solution Implemented:** Page Visibility API with automatic pause and PauseOverlay dialog

**Implementation:**
1. Added Page Visibility API listener in [App.vue](../src/App.vue)
2. Automatically pauses game when `document.hidden` is true (tab switch/window minimize)
3. Shows configurable [PauseOverlay](../src/components/game/dialogs/PauseOverlay.vue) dialog
4. Added `'visibility'` pause reason to [gameController.ts](../src/stores/gameController.ts)
5. Supports multiple pause reasons with context-aware messaging (manual, visibility, orientation, navigation)

**User Experience:**
- Tab switch â†’ Game pauses â†’ Overlay appears with clear message
- User can "Resume Game" or "Close and Pause" (dismiss overlay, keep paused)
- Overlay also used for manual pause with appropriate messaging

**Files Modified:**
- [App.vue](../src/App.vue) - Page Visibility API integration, pause watcher
- [gameController.ts](../src/stores/gameController.ts) - Added visibility pause reason, isVisibilityPaused computed
- [PauseOverlay.vue](../src/components/game/dialogs/PauseOverlay.vue) - Configurable pause dialog (created)

---

## âš™ï¸ **Phase 2.5 Systems**

**Note:** These systems were deferred during Phase 4 development and need to be implemented before Phase 5.

### System 10.1: Personality Trait Influences on Interactions
**Priority:** HIGH
**Status:** ğŸ“‹ Not Started
**Category:** Social System Enhancement

**Documentation:** [System 10.1](systems/phase2.5/system-10.1-personality-influences.md)

**Goal:** Personality traits affect how guinea pigs respond to player interactions

**Key Features:**
- Shy guinea pigs: lower acceptance rate for handling/play
- Bold guinea pigs: higher acceptance rate, more eager
- Calm guinea pigs: longer tolerance for interactions
- Energetic guinea pigs: prefer active interactions (play > petting)

---

### System 10.2.5: Fulfillment Limitation System
**Priority:** HIGH
**Status:** ğŸ“‹ Not Started
**Category:** Food & Wellness System

**Documentation:** [System 10.2.5](systems/phase2.5/system-10.2.5-fulfillment-limitation.md)

**Goal:** Limit food consumption per hunger cycle to prevent spam feeding

**Key Features:**
- 5 servings max per hunger cycle (excludes hay)
- Hay unlimited (always available)
- Prevents overfeeding exploits
- More realistic feeding patterns

**Includes:** Food Serving Guide UI component (see documentation)

---

### System 10.3: Wellness-Based Interaction Reactions
**Priority:** HIGH
**Status:** ğŸ“‹ Not Started
**Category:** Social System Enhancement

**Documentation:** [System 10.3](systems/phase2.5/system-10.3-wellness-reactions.md)

**Goal:** Guinea pig wellness affects interaction acceptance rates

**Key Features:**
- High wellness (>70): more accepting, lower rejection rate
- Low wellness (<30): more rejections, needs rest/care
- Creates gameplay loop: good care â†’ better interactions â†’ higher friendship

---

### Needs System Fixes ğŸ¯

#### Add Nails Need to Needs Display âœ…
**Priority:** HIGH
**Status:** âœ… Complete
**Category:** Bug Fix

**Issue:** Nails need was not visible in the needs section display, though it existed in the data model.

**Root Cause:** The `'nails'` need type was missing from the `wellnessNeeds` array in NeedsPanel.vue (line 109).

**Solution:** Added `'nails'` to the `wellnessNeeds` category array.

**Files Modified:**
- [NeedsPanel.vue](../src/components/debug/environment/NeedsPanel.vue) - Added 'nails' to wellnessNeeds array

**Verification:**
- NeedBar.vue already had 'nails' in formatNeedName mapping (line 116) âœ…
- Nails need now displays in Wellness Needs section
- Replenish All Needs button now includes nails in the operation

---

#### Adjust Thirst Decay Rate âœ…
**Priority:** HIGH
**Status:** âœ… Complete
**Category:** Game Balance

**Issue:** Needs decaying 2 points per tick creating unfair death spirals.

**Root Causes:**
1. Decay rates designed for 5-sec ticks, game runs 1-sec ticks
2. Health/wellness modifiers compounded decay, creating death spirals

**Solution - Two-Part Fix:**

**Part 1: Recalibrated decay rates (11 needs):**
- Critical: hunger: 10, thirst: 8, energy: 7, shelter: 9
- Environmental: play: 5, social: 4, comfort: 3
- Maintenance: hygiene: 3, nails: 0.5, health: 1, chew: 2.5

**Part 2: Removed death spiral modifiers:**
- âŒ Removed age modifier (0.5x-2.0x)
- âŒ Removed health modifier (accelerated hunger/thirst when low)
- âœ… Kept personality modifiers (stable)
- âœ… Kept bonding modifiers (positive only)

**Result:** Fair, consistent decay without wellness spirals

**Files Modified:**
- [guineaPigStore.ts](../src/stores/guineaPigStore.ts) - Lines 439-456, 609-643

---

#### Needs System Reframing: From "Death Meter" to "Comfortable Guinea Pig" âœ…
**Priority:** HIGH
**Status:** âœ… Complete
**Category:** Game Design & Balance

**Philosophy Shift:** The needs system was reframed from a "survival panic" model to a "comfortable guinea pig" model where guinea pigs autonomously fulfill needs before they become critical.

**Key Changes:**

**1. Behavior Threshold Adjustments:**
- Guinea pigs now seek fulfillment at comfortable levels (40-65% range)
- Prevents emergency situations in normal gameplay
- Final thresholds after iterative balancing:
  - hunger: 65% (seek food when satisfaction drops below 65%)
  - thirst: 60%
  - energy: 60%
  - shelter: 65%
  - hygiene: 55%
  - chew: 55%
  - play: 50%
  - social: 50%

**2. Need Bar Color System Redesign:**
- **Old System:** Orange/red warning colors appeared too early
- **New System:** More gradual, less alarming progression
  - **Green (60-100%):** Satisfied, guinea pig comfortable
  - **Grey (40-60%):** Okay, not urgent
  - **Yellow (30-40%):** Getting low, attention recommended
  - **Red (0-30%):** Low, guinea pig uncomfortable

**3. Status Text Updates:**
- Replaced alarming language with neutral descriptions:
  - "Satisfied" (60-100%)
  - "Okay" (40-60%)
  - "Getting Low" (30-40%)
  - "Low" (0-30%)

**Design Rationale:**
- 30-40% satisfaction is **not a bad thing** in this model
- Guinea pigs proactively manage their needs
- Needs decay provides engagement without stress
- Penalties only occur when needs fall critically low (prolonged neglect)

**Files Modified:**
- [autonomySettingsStore.ts](../src/stores/autonomySettingsStore.ts) - Updated DEFAULT_THRESHOLDS (lines 12-21)
- [NeedBar.vue](../src/components/game/ui/NeedBar.vue) - Updated color thresholds and status text (lines 45-58, 140-161)
- [NeedRow.vue](../src/components/basic/NeedRow.vue) - Updated urgency calculation (lines 42-47)

**Player Feedback Integration:**
> "i think this is less of '0 is the need is totally drained' and more of 'the point in which they seek fulfillment is when it starts to bother the guinea pig a little bit' but not dire. the guinea pig can choose what to do and is just going to fulfill needs as needed. i think with that we should use less reds in the needs bars, because it isn't a 'death' meter, but more of a timer to when the guinea pig gets it."

This reframing creates a more relaxed, observation-focused gameplay experience rather than constant emergency management.

---

#### Hide Age Display (Defer to Phase 5+) âœ…
**Priority:** LOW
**Status:** âœ… Complete
**Category:** Code Cleanup

**Issue:** Age was displayed in guinea pig tooltip but no aging mechanics exist yet. Age field exists in data model but has no gameplay impact.

**Decision:** Temporarily hide age display until proper aging system is implemented (Phase 5+).

**What Was Done:**
- Commented out age calculation in tooltip (line 88)
- Removed "Age: X days" from tooltip display (line 96)
- Added comment: "temporarily hidden - will be re-enabled with aging system"

**What Remains Unchanged:**
- `birthDate` field still stored
- `stats.age` field still calculated on creation
- Age data preserved for future aging feature

**Files Modified:**
- [GuineaPigSprite.vue](../src/components/game/habitat/GuineaPigSprite.vue) - Lines 87-88, 96

**Reasoning:**
- Age was only cosmetic data with no gameplay effect
- Discovered age was being used in unfair death spiral modifiers (now removed)
- Cleaner to hide until proper aging mechanics designed

---

#### Add "Clip Nails" Interaction âœ…
**Priority:** MEDIUM
**Status:** âœ… Complete
**Category:** Player Interactions

**Goal:** Add player interaction to fulfill the nails need, complementing the existing hygiene interaction (gentle wipe).

**Implementation:**

**1. New Interaction Button:**
- Added "âœ‚ï¸ Clip Nails" button to Basic Interactions section in [SocializeSidebar.vue](../src/components/game/habitat/sidebars/SocializeSidebar.vue)
- Positioned after "Gentle Wipe" for logical grouping of care actions

**2. Interaction Effects:**
- **Nails Need:** +100 (fully restores)
- **Comfort Need:** -5 (guinea pigs tolerate but don't enjoy nail clipping)
- **Friendship Gain:** +1 (minimal, it's necessary care not fun)
- **Cooldown:** 600 seconds (10 minutes)

**3. Smart Availability:**
- Button disabled when nails â‰¥ 75%
- Tooltip feedback: "Nails are still good (wait until below 75%)"
- Prevents unnecessary/excessive nail clipping

**4. Consistent UX Pattern:**
Applied need-based disabling to related interactions:
- **Hand Feed:** Disabled when hunger â‰¥ 95%
- **Gentle Wipe:** Disabled when hygiene â‰¥ 75%
- **Clip Nails:** Disabled when nails â‰¥ 75%

**Files Modified:**
- [SocializeSidebar.vue](../src/components/game/habitat/sidebars/SocializeSidebar.vue) - Added button, disabled states, tooltips (lines 116-125, 286-336)
- [HabitatDebug.vue](../src/components/debug/environment/HabitatDebug.vue) - Added clip-nails event handler (line 96)
- [interactionEffects.ts](../src/utils/interactionEffects.ts) - Added clip-nails effect data, name, and emoji (lines 41-45, 98, 118)

**Design Notes:**
- Nails decay very slowly (0.5 rate vs 3-10 for other needs)
- 75% threshold means player clips nails roughly every 200 minutes of gameplay
- Reflects realistic guinea pig nail care frequency
- Small comfort penalty creates authentic care experience

---

### UI/UX Improvements ğŸ¨

#### Prevent Emoji Selection During Drag & Drop âœ…
**Priority:** MEDIUM
**Status:** âœ… Complete
**Category:** User Experience

**Issue:** Emojis were being accidentally selected/highlighted when trying to drag and drop items in the habitat, creating a poor user experience.

**Solution:** Added CSS `user-select: none` utility class to all draggable emoji elements.

**Implementation:**

**1. Created `.no-select` Utility Class:**
```css
.no-select {
  user-select: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
}
```

**2. Applied to All Draggable Elements:**
- **Habitat Items:**
  - [FoodBowl.vue](../src/components/game/habitat/FoodBowl.vue) - Bowl emoji
  - [HayRack.vue](../src/components/game/habitat/HayRack.vue) - Ladder and hay emojis
  - [WaterBottle.vue](../src/components/game/habitat/WaterBottle.vue) - Water droplet emoji
  - [ChewItem.vue](../src/components/game/habitat/ChewItem.vue) - Chew item emoji
  - [Poop.vue](../src/components/game/habitat/Poop.vue) - Poop emoji
  - [PelletsVisual.vue](../src/components/game/habitat/PelletsVisual.vue) - Pellet emojis

- **Interactive Elements:**
  - [GuineaPigSprite.vue](../src/components/game/habitat/GuineaPigSprite.vue) - Guinea pig emoji
  - [InventorySidebar.vue](../src/components/game/habitat/sidebars/InventorySidebar.vue) - Draggable inventory item emojis and text

**Files Modified:**
- [base.css](../src/styles/base.css) - Added `.no-select` utility class (lines 227-232)
- 8 Vue component files - Applied class to emoji elements

**Result:** Users can now drag and drop items without accidentally selecting text or emojis, creating a smoother interaction experience.

**Bonus Refactor:**
- Discovered [Poop.vue](../src/components/game/habitat/Poop.vue) was dead code (not being used)
- Poops were being rendered as raw emojis in [HabitatVisual.vue](../src/components/game/habitat/HabitatVisual.vue)
- Refactored to use the Poop component properly for encapsulation and consistency with other habitat items
- Removed obsolete `handleSubgridItemClick` function

---

#### Replace Bond Progress Bar with Slider Component âœ…
**Priority:** MEDIUM
**Status:** âœ… Complete
**Category:** UI Enhancement

**Issue:** Bond progress bars (both player friendship and companion bonds) didn't visually update as bond levels increased due to CSS transition issues.

**Solution:** Replaced custom bond progress bar implementation with the SliderField component in read-only mode (disabled state).

**Implementation:**

**1. Replaced Player Friendship Bar:**
```vue
<SliderField
  :model-value="Math.round(selectedGuineaPig.friendship)"
  :min="0"
  :max="100"
  :step="1"
  disabled
  size="sm"
  suffix="%"
  @update:model-value="() => {}"
/>
```

**2. Replaced Companion Bond Bars:**
```vue
<SliderField
  :model-value="Math.round(bondInfo.bond.bondingLevel)"
  :min="0"
  :max="100"
  :step="1"
  disabled
  size="sm"
  suffix="%"
  @update:model-value="() => {}"
/>
```

**3. Removed Obsolete CSS:**
- Removed `.bond-progress`, `.bond-progress__bar`, `.bond-progress__fill`, `.bond-progress__label` styles
- Kept `.bond-stats`, `.bond-stat`, `.bond-status__header`, and `.bond-tier` styles

**Files Modified:**
- [SocializeSidebar.vue](../src/components/game/habitat/sidebars/SocializeSidebar.vue) - Replaced both friendship and companion bond progress bars

**Benefits:**
- âœ… Bond levels now update visually in real-time
- âœ… Consistent UI with other progress displays (SliderField component)
- âœ… Native browser range input provides smooth visual feedback
- âœ… Reduced custom CSS maintenance

---

#### Add Confirmation Button to Hand-Feed Dialog âœ…
**Priority:** MEDIUM
**Status:** âœ… Complete
**Category:** UX Improvement

**Issue:** Clicking a food item in the hand-feed dialog immediately fed it, leading to accidental feeding.

**Solution:** Implemented two-step confirmation process for safer interaction.

**Implementation:**

**1. Added Selection State:**
- Added `selectedFoodId` ref to track currently selected food
- Updated `selectFood()` to only set selection (not immediately feed)
- Created new `confirmFeed()` function to handle actual feeding

**2. Visual Selection Feedback:**
```css
.food-item--selected {
  border-color: var(--color-primary);
  background-color: var(--color-primary-bg);
}
```

**3. Added Feed Button:**
- Primary "Feed" button in footer (only enabled when food selected)
- Cancel button (tertiary) to close dialog without feeding
- Footer uses flex layout with gap for proper spacing

**User Flow:**
1. User opens hand-feed dialog
2. User clicks a food item â†’ item highlights with selection state
3. User clicks "Feed" button â†’ guinea pig is fed and dialog closes
4. Selection resets for next use

**Files Modified:**
- [FoodSelectionDialog.vue](../src/components/game/dialogs/FoodSelectionDialog.vue) - Added selection state, confirmation button, and visual feedback

**Benefits:**
- âœ… Prevents accidental feeding
- âœ… Clear visual feedback of selection
- âœ… Explicit confirmation step
- âœ… Better UX for deliberate actions

---

### Habitat Item System ğŸ 

#### Enable Treats to be Hand-Fed and Dragged into Habitat
**Priority:** HIGH
**Status:** ğŸ“‹ Not Started
**Category:** Gameplay Feature

**Issue:** Treats have dual functionality issues:
1. **Cannot be hand-fed** - Treats don't appear in hand-feed dialog, but they should be available alongside regular food
2. **Cannot be dragged into habitat** - Treats should also be placeable as habitat items (like chew toys)

**Two Implementation Paths:**

**Path 1: Add Treats to Hand-Feed Dialog**
- Add "Treats" category to food selection dialog
- Query treats from suppliesStore (subcategory: 'treats')
- Display treats in dialog with special visual indicator (they're special!)
- Treats would be hand-fed immediately (not placed in habitat)

**Path 2: Enable Treats as Habitat Items**
- Treats function like chew toys (placeable, consumable)
- Guinea pigs autonomously discover and eat treats in habitat
- Treats decay/disappear when consumed

**Recommended: Implement Both Paths**
- Treats can be hand-fed OR placed in habitat (player choice)
- Hand-feeding: Immediate interaction, bonds with player
- Habitat placement: Guinea pig discovers on their own, autonomous behavior

**Files to Modify:**
- [FoodSelectionDialog.vue](../src/components/game/dialogs/FoodSelectionDialog.vue) - Add treats category
- [suppliesStore.ts](../src/stores/suppliesStore.ts) - Verify treat categorization
- [HabitatVisual.vue](../src/components/game/habitat/HabitatVisual.vue) - Enable drag for treats (if Path 2)

**Expected Behavior:**
- Treats appear in hand-feed dialog under "Treats" category
- Optionally: Treats can also be dragged into habitat for autonomous discovery

---

#### Prevent Duplicate Items in Habitat
**Priority:** HIGH
**Status:** ğŸ“‹ Not Started
**Category:** Game Logic

**Issue:** Some items should not allow duplicates in the habitat (e.g., water bottles, specific types of beds).

**Implementation:**
- Add `allowDuplicates: boolean` metadata to item definitions
- Update habitat placement logic to check for existing instances
- Show user feedback when attempting to place duplicate restricted items

**Items That Should Not Allow Duplicates:**
- Water bottles (1 per habitat)
- Large beds (1-2 max depending on habitat size)
- Certain specialty items

**Files to Modify:**
- [supplies.ts](../src/types/supplies.ts) - Add `allowDuplicates` field to item metadata
- [habitatConditions.ts](../src/stores/habitatConditions.ts) - Add duplicate checking in `placeItemInHabitat()`
- Item catalog JSON files

**Estimated Effort:** 1-2 hours

---

#### Add "Fill Hay Rack" Buttons (Global + Individual)
**Priority:** MEDIUM
**Status:** ğŸ“‹ Not Started
**Category:** UX Improvement

**Issue:** Currently, players must manually drag hay servings into hay racks. There should be quick fill buttons both globally (Care Actions sidebar) and per-rack (tooltip), similar to the "Refill Bedding" button.

**Two-Level Implementation:**

**1. Global "Fill All Hay Racks" Button (Care Actions Sidebar)**
- Fills ALL hay racks in habitat sequentially until hay inventory is exhausted
- If multiple racks exist, distributes hay across all racks with empty slots
- Prioritizes racks by placement order (first placed, first filled)

**2. Individual "Fill This Rack" Button (Hay Rack Tooltip)**
- Each hay rack's HabitatItemPopover has a "Fill Rack" action button
- Fills ONLY the selected hay rack with available hay
- Useful for targeted refills when managing multiple racks

**Expected Behavior:**

**Global Button (Fill All):**
```typescript
function fillAllHayRacks() {
  const hayRacks = habitatConditions.getAllHayRacks() // Returns array of hay racks
  let remainingHay = inventoryStore.getHayCount()
  let totalAdded = 0

  for (const rack of hayRacks) {
    if (remainingHay === 0) break

    const emptySlots = rack.capacity - rack.currentServings
    const servingsToAdd = Math.min(emptySlots, remainingHay)

    if (servingsToAdd > 0) {
      habitatConditions.addHayToRack(rack.instanceId, servingsToAdd)
      remainingHay -= servingsToAdd
      totalAdded += servingsToAdd
    }
  }

  if (totalAdded > 0) {
    inventoryStore.consumeHay(totalAdded)
    showFeedback(`Filled hay racks with ${totalAdded} serving${totalAdded > 1 ? 's' : ''}`)
  }
}
```

**Individual Button (Fill Single Rack):**
```typescript
function fillSingleHayRack(rackInstanceId: string) {
  const rack = habitatConditions.getHayRack(rackInstanceId)
  if (!rack) return

  const emptySlots = rack.capacity - rack.currentServings
  const availableHay = inventoryStore.getHayCount()
  const servingsToAdd = Math.min(emptySlots, availableHay)

  if (servingsToAdd > 0) {
    habitatConditions.addHayToRack(rackInstanceId, servingsToAdd)
    inventoryStore.consumeHay(servingsToAdd)
    showFeedback(`Filled hay rack with ${servingsToAdd} serving${servingsToAdd > 1 ? 's' : ''}`)
  }
}
```

**Button States:**

**Global Button:**
- **Enabled:** At least one hay rack has empty slots AND player has hay in inventory
- **Disabled:** No hay racks in habitat OR all racks full OR no hay in inventory
- **Tooltip (disabled):**
  - "No hay racks in habitat"
  - "All hay racks are full"
  - "No hay in inventory"

**Individual Button (in tooltip):**
- **Enabled:** This rack has empty slots AND player has hay in inventory
- **Disabled:** This rack is full OR no hay in inventory
- **Tooltip (disabled):**
  - "Hay rack is full (X/X servings)"
  - "No hay in inventory"

**Files to Modify:**
- [CareActionsSidebar.vue](../src/components/game/habitat/sidebars/CareActionsSidebar.vue) - Add "Fill All Hay Racks" button
- [HayRack.vue](../src/components/game/habitat/HayRack.vue) - Add "Fill Rack" action to popover
- [HabitatItemPopover.vue](../src/components/game/habitat/HabitatItemPopover.vue) - Support fill action
- [habitatConditions.ts](../src/stores/habitatConditions.ts) - Add `getAllHayRacks()` and `addHayToRack(instanceId, servings)` methods
- [inventoryStore.ts](../src/stores/inventoryStore.ts) - Add `getHayCount()` and `consumeHay()` methods

**UI Placement:**

**Care Actions Sidebar:**
```
Core Care:
- ğŸ§¹ Clean Cage
- ğŸ›ï¸ Refill Bedding
- ğŸŒ¾ Fill All Hay Racks (NEW)
- ğŸ’§ Refill Water
```

**Hay Rack Popover (Actions section):**
```
Actions:
- ğŸŒ¾ Fill Rack (NEW)
- ğŸ—‘ï¸ Remove
```

**Benefits:**
- âœ… Faster hay rack management (both bulk and individual)
- âœ… Handles multiple hay racks intelligently
- âœ… Consistent with refill bedding pattern
- âœ… Flexible: Fill all racks at once OR target specific rack
- âœ… Reduces tedious manual dragging

**Estimated Effort:** 2-3 hours

---

## ğŸ¯ **Future Sprints - Planned Work**

These items are planned for future sprints and are not part of the current sprint scope.

### Social Interaction Enhancements ğŸ¤

#### Multi-Type Guinea Pig Interactions
**Priority:** LOW (Phase 5+)
**Status:** ğŸ“‹ Not Started (Future Enhancement)

Expand guinea pig social interactions beyond just "socialize":
- Play Interaction (social + play needs)
- Sniff/Investigate (social only)
- Groom/Allogrooming (social + hygiene)
- Huddle/Cuddle (social + comfort)

---

#### Pushable Toys System
**Priority:** LOW (Phase 5+)
**Status:** ğŸ“‹ Not Started (Future Enhancement)

Guinea pigs physically move balls and pushable toys across grid cells.

---

#### Special Treat Visual Effects
**Priority:** LOW (Phase 5+ - Polish)
**Status:** ğŸ“‹ Not Started (Future Enhancement)

**Goal:** Add fun visual effects when guinea pigs consume special treats.

**Special Effects:**
- ğŸƒ **Pumpkin Spice Treat:** Guinea pig glows orange for a few seconds
- ğŸï¸ **Island Treat:** Guinea pig transforms into a ğŸ  fish emoji temporarily
- ğŸŒˆ **Rainbow Treat:** Guinea pig glows with rainbow gradient transition

**Implementation:**
- Add CSS animations/filters for glow effects
- Temporary emoji replacement system
- Animation trigger on treat consumption
- Duration: 3-5 seconds per effect

**Files to Modify:**
- [GuineaPigSprite.vue](../src/components/game/habitat/GuineaPigSprite.vue) - Add effect animations
- [useGuineaPigBehavior.ts](../src/composables/game/useGuineaPigBehavior.ts) - Trigger effects on treat consumption
- CSS animations for glow/rainbow effects

**Estimated Effort:** 2-3 hours (fun polish feature)

---

### Adoption System Enhancement ğŸ¹

#### Pre-Bonded Pairs & Solo Guinea Pigs
**Priority:** HIGH (Future Sprint)
**Status:** ğŸ“‹ Not Started

**Documentation:** See sprint doc for full specification

Implement adoption constraints:
- Bonded pairs must be adopted together
- Solo-suitable guinea pigs can be adopted alone
- Enhanced observation system (3 clues including bonding status)

---

### Testing & Balance ğŸ®

#### Gameplay Testing Checklist
**Priority:** HIGH (Future Sprint)
**Status:** ğŸ“‹ Not Started

Comprehensive testing of all systems:
- Needs & wellness system
- Autonomous behaviors
- Food & consumption
- Habitat conditions
- Social bonding
- Item metadata & realism

---

#### Create Realism Guidelines
**Priority:** MEDIUM (Future Sprint)
**Status:** ğŸ“‹ Not Started

Document realistic guinea pig care guidelines for game balance:
- Feeding frequency & amounts
- Sleep patterns
- Social behavior
- Habitat cleanliness standards

---

## ğŸ“ **Notes**

### Completed This Sprint âœ…
- **Code Audit** - Comprehensive audit of 17 files from previous sprint
  - Created [CODE-AUDIT-2025-11-03.md](audits/CODE-AUDIT-2025-11-03.md)
  - Found and documented 1 medium + 3 minor issues
  - All systems verified working correctly

- **CSS Audit** - Comprehensive CSS standards audit of 9 components
  - Created [CSS-AUDIT-SPRINT-2025-11-02.md](audits/CSS-AUDIT-SPRINT-2025-11-02.md)
  - **Overall Score: 9.6/10** - Excellent quality
  - 100% BEM compliance, 100% logical properties, 100% CSS variables
  - Applied panel utility improvements to SocializeSidebar and HabitatDebug

- **Bug Fixes**
  - âœ… Fixed CELL_SIZE magic number in GuineaPigSprite (now uses prop from parent)
  - âœ… Memory leak fixes from previous sprint verified
  - âœ… Fixed emoji selection during drag & drop (added `.no-select` utility class)
  - âœ… Refactored Poop component - was dead code, now properly integrated in HabitatVisual
  - âœ… Fixed bond progress bars not updating visually (replaced with SliderField component)
  - âœ… Added hand-feed confirmation button (prevents accidental feeding)

- **Needs System Improvements**
  - âœ… Recalibrated all 11 needs decay rates for 1-second game loop
  - âœ… Removed death spiral modifiers (age/health compounding)
  - âœ… Reframed needs system philosophy: "comfortable guinea pig" vs "death meter"
  - âœ… Updated behavior thresholds (40-65% range for autonomous fulfillment)
  - âœ… Redesigned need bar colors: Green (60+) â†’ Grey (40-60) â†’ Yellow (30-40) â†’ Red (0-30)
  - âœ… Updated status text to be less alarming

- **New Features**
  - âœ… Page Visibility API - auto-pause when tab loses focus
  - âœ… PauseOverlay dialog with configurable messaging
  - âœ… Clip Nails interaction with need-based availability
  - âœ… Smart interaction disabling (Hand Feed, Gentle Wipe, Clip Nails)
  - âœ… Added nails need to display

### Active Items ğŸš§

**High Priority Bugs & Fixes:**
- âœ… ~~Window focus bug (autonomous behavior stops when window loses focus)~~ - COMPLETED
- âœ… ~~Nails need not showing in needs display~~ - COMPLETED
- âœ… ~~Thirst decay rate too fast~~ - COMPLETED (recalibrated all needs)
- ğŸ”¥ Treats cannot be dragged into habitat
- ğŸ”¥ Prevent duplicate habitat items

**Medium Priority UX Improvements:**
- âœ… ~~Bond progress bars not updating visually~~ - COMPLETED (replaced with SliderField)
- âœ… ~~Hand-feed dialog needs confirmation button~~ - COMPLETED (two-step selection process)
- âœ… ~~Emoji selection during drag & drop~~ - COMPLETED

**Phase 2.5 Systems:**
- System 10.2.3: Personality Influences on Food Choice
- System 10.2.5: Fulfillment Limitation System
- System 10.3: Wellness-Based Interaction Reactions

**Future Enhancements:**
- Special treat visual effects (polish feature)
- Multi-type guinea pig interactions
- Pushable toys system
- Pre-bonded pairs adoption system

### Next Steps
1. **Immediate:** Fix high-priority bugs (nails display, thirst rate, treats drag)
2. **This Sprint:** Window focus bug + Phase 2.5 systems
3. **This Sprint:** Medium-priority UX improvements
4. **Future:** Polish features and adoption system enhancements
