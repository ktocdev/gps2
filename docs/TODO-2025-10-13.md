# GPS2 Implementation TODO - October 13, 2025

**Created:** October 13, 2025
**Updated:** October 19, 2025
**Status:** Phase 3 Near Complete ✅ - Preparing for Phase 4 Autonomy 🔜
**Branch:** GPS2-29
**Previous:** [TODO-2025-10-05.md](archive/TODO-2025-10-05.md)

---

## 🎉 **Phase 2 Complete!**

### System 6.95: Permanent Adoption & Stardust Sanctuary ✅

All core features implemented and tested:
- ✅ Permanent adoption model (no returns, no sessions)
- ✅ Stardust Sanctuary achievement (85% friendship threshold)
- ✅ Natural store churn (2-5 day adoption timers)
- ✅ Friendship-gated features with 100% wellness freeze
- ✅ Observe interaction with personality glimpses
- ✅ Pet Adoption UI with habitat organization (3-4 per habitat)
- ✅ Paired adoption timers (40% chance, leave together)
- ✅ AdoptionConfirmDialog component
- ✅ InfoButton enhancements and guidance
- ✅ Removed disliked activities and habitats (kept food dislikes)
- ✅ ~~Feeding cycle status panel with manual reset controls~~ (removed - integrated into needs system)

**Documentation:** [System 6.95 Implementation Plan](systems/phase2/system-6.95.1-implementation-plan.md)

---

## 📋 **Phase 2.5: Interactive Feedback Enhancement** (Deferred)

**Status:** On Hold - Will resume after Phase 3 completion

Phase 2.5 systems (wellness reactions, rescue system, enhanced messages) deferred to focus on habitat environment systems.

**Pending Systems:**
- System 3: Wellness-Based Interaction Reactions
- System 4: Guinea Pig Rescue System
- System 5: Enhanced Activity Messages

**Documentation:** [Phase 2.5 Systems](systems/phase2.5/)

---

## 📋 **Phase 3: Habitat & Environment**

**Status:** Core Systems Complete ✅ - Autonomy Prep Items Remaining 🔜

### Phase 3 Progress Summary

Phase 3 core systems implemented following proper dependency flow:
1. ✅ **Supplies Store** - 104+ item catalog with metadata
2. ✅ **Inventory Management** - Instance-based tracking with sell-back
3. ✅ **Habitat Conditions** - Resource consumption and environmental tracking
4. ✅ **Habitat UI** - Visual grid with drag-and-drop (Phases 1-2)
5. ✅ **Serving System** - Hay rack and food bowl with serving-based inventory
6. ✅ **Maintenance** - Poop tracking, cleanliness, bedding, water

**Remaining:** Water consumption, item type metadata, decay systems, position tracking, usage history

---

### Completed Phase 3 Systems

#### **System 11: Supplies Store System** ✅ **COMPLETED**
**Priority:** HIGH (foundation for all Phase 3 systems)
**Status:** ✅ **Completed** (October 15, 2025 | Branch: GPS2-26, GPS2-27)

**Goal:** Central catalog of all purchasable items in the game

**Completed Features:**
- ✅ **Bedding types** (cheap, average, premium) with absorbency/decay rates, color varieties
- ✅ **Hay varieties** (8 types: Timothy, Orchard Grass, Alfalfa, Meadow, Oat, Botanical, Wheat, Mixed) with nutritional profiles
- ✅ **Food items** organized by 6 subcategories:
  - Fresh Greens (5 items)
  - Fresh Herbs (4 items)
  - Vegetables (7 items)
  - Fruits (6 items)
  - Pellets (3 tiers: Cheap, Standard, Fortified)
  - Premium Treats (3 items with visual effects & badge unlocks)
- ✅ **Habitat items** (64+ items across 5 subcategories):
  - Hideaways (13): Basic, Tunnels, Premium, Beds
  - Toys (11): Rolling, Interactive, Premium
  - Chews (12): Natural Wood, Shaped, Premium
  - Bowls & Bottles (12): Water bottles, Food bowls, Hay racks
  - Enrichment (16): Platforms, Exploration, Sensory, Premium
- ✅ **Item metadata** (name, description, price, category, stats, quality, tags)
- ✅ **Availability system** (always, seasonal, limited)
- ✅ **Purchase flow integration** (currency deduction, inventory addition)
- ✅ **Reusable SupplyItemCard component** with quantity selector and purchase controls
- ✅ **Sell-back system** (100% refund for unopened/unplaced items)
- ✅ **Starter inventory** (6 essential items given on first guinea pig adoption)

**Total Items:** 104+ unique purchasable items

**Files Created:**
- ✅ `src/stores/suppliesStore.ts` - Main supplies catalog store with 104+ items
- ✅ `src/types/supplies.ts` - TypeScript interfaces for items, inventory, cart, purchase, sell-back
- ✅ `src/stores/inventoryStore.ts` - Instance-based inventory with sell-back restrictions
- ✅ `src/components/debug/SuppliesStoreDebug.vue` - Supplies store debug panel with sell-back UI
- ✅ `src/components/debug/SupplyItemCard.vue` - Reusable item card with sell/buy controls
- ✅ `src/components/debug/InventoryDebug.vue` - Three-column grid inventory display

**Integration Points:**
- ✅ Player Progression (currency for purchases) - Integrated
- ✅ Inventory Store (purchase flow, ownership tracking) - Implemented
- ✅ Pet Store Manager (starter inventory on first adoption) - Integrated
- → Habitat Conditions (bedding/hay consumption) - Ready for integration
- → Needs Controller (food consumption) - Ready for integration

**Documentation:** [System 11: Supplies Store](systems/phase3/system-11-supplies-store.md)

---

#### **System 12: Inventory Management System** ✅ **COMPLETED**
**Priority:** HIGH (depends on Supplies Store)
**Status:** ✅ **Completed** (October 16, 2025 | Branch: GPS2-27)

**Goal:** Track owned items, quantities, and consumption across all game systems

**Completed Features:**
- ✅ **Instance-based tracking** - Each item is a unique instance with individual state
- ✅ **Item state tracking** - Track opened/unopened bags, placed/unplaced habitat items
- ✅ **Sell-back system** - 100% refund for returnable items with restrictions:
  - Cannot return opened bags of hay or bedding
  - Cannot return items placed in habitat
  - Otherwise items can be sold back for full price
- ✅ **Category organization** - Consumables (bedding, hay, food) and Habitat Items
- ✅ **Starter inventory** - New players receive 6 essential items on first adoption:
  - 1× Timothy Hay
  - 1× Average Bedding
  - 1× Standard Pellets
  - 1× Green Leaf Lettuce
  - 1× Carrot
  - 1× Apple Wood Sticks
- ✅ **Debug controls** - Mark items as opened/placed for testing sell-back restrictions
- ✅ **Data migration** - Automatic migration from old quantity-based to instance-based format
- ✅ **Three-column responsive grid** - Mobile-first design (1/2/3 columns)
- ✅ **Inventory card design** - Gradient backgrounds, distinct from store cards
- ✅ **Navigation organization** - Inventory moved to Environment Systems dropdown

**Instance-Based System:**
- Each item has unique `instanceId` for individual tracking
- Separate counts for opened/unopened, placed/unplaced items
- "Open One" button marks single instance as opened
- "Place One" / "Remove One" buttons for habitat item placement
- Returnable quantity shows items eligible for sell-back

**Files Completed:**
- ✅ `src/stores/inventoryStore.ts` - Full instance-based implementation
- ✅ `src/types/supplies.ts` - ItemInstance interface with state tracking
- ✅ `src/components/debug/InventoryDebug.vue` - Redesigned with grid layout
- ✅ `src/components/debug/SupplyItemCard.vue` - Sell-back UI integration
- ✅ `src/stores/petStoreManager.ts` - Starter inventory integration

**Integration Points:**
- ✅ Supplies Store (item catalog, pricing) - Fully integrated
- ✅ Player Progression (currency for sell-back refunds) - Integrated
- ✅ Pet Store Manager (starter inventory on adoption) - Integrated
- ✅ Habitat Conditions (bedding/hay consumption) - Fully integrated
- ✅ Habitat Item System (placement tracking) - Fully integrated
- → Needs Controller (food consumption) - Ready for integration

---

#### **System 13: Habitat Conditions Store** ✅ **COMPLETED**
**Priority:** HIGH (fully integrated with Supplies & Inventory)
**Status:** ✅ **Completed** (October 16, 2025 | Branch: GPS2-27)

**Goal:** Environmental condition tracking consuming inventory resources

**Completed Features:**
- ✅ Cleanliness tracking (0-100%, decay over time)
- ✅ Bedding freshness (quality-based: cheap/average/premium with absorbency/decay from Supplies Store)
- ✅ Hay freshness (bag tracking with 20 handfuls per bag, auto-refill from inventory)
- ✅ Water level (0-100%, refill system)
- ✅ Resource management actions (clean cage, refresh bedding, refill hay, refill water, give hay handful)
- ✅ Condition history tracking
- ✅ Reset to 100% on new game session
- ✅ **Habitat Items Tracking** - Track items placed IN habitat separately from inventory
- ✅ **Starter Habitat Items** - 4 items placed in habitat on first adoption (water bottle, igloo, bowl, hay rack)
- ✅ **Migration-free implementation** - Removed all backward compatibility code

**HabitatDebug Panel Features:**
- ✅ No guinea pigs warning pattern
- ✅ Full-width Habitat Conditions panel with integrated controls
- ✅ Bedding/Hay type selects integrated directly into condition items
- ✅ Dynamic condition summary with themed gradients (green/yellow/red based on overall condition)
- ✅ Smart hay handful system (auto-opens new bag when current bag is empty)
- ✅ Stock count display in select option labels
- ✅ **Habitat Items Panel (FPO)** - Grid display of items currently in habitat
- ✅ **Move to Inventory** - Remove items from habitat back to inventory

**Supplies Store Integration:**
- ✅ Bedding metadata pulled from Supplies Store (absorbency, decay rate)
- ✅ Hay metadata pulled from Supplies Store (8 types available)
- ✅ Habitat items metadata (water bottles, bowls, igloo, hay rack)
- ✅ All item stats sourced from central catalog

**Inventory Integration:**
- ✅ Real consumption depletes inventory (marks items as opened/used)
- ✅ Bedding refresh consumes 1 bedding bag from inventory
- ✅ Hay refill consumes 1 hay bag from inventory (gives 20 handfuls)
- ✅ Handful of hay consumes from current bag (auto-opens new bag if needed)
- ✅ Habitat items marked as "placed" when added to habitat
- ✅ Habitat items unmarked when moved back to inventory

**Habitat Items System:**
- ✅ `habitatItems` ref tracking items currently placed in habitat
- ✅ `addItemToHabitat()` - Move item from inventory to habitat
- ✅ `removeItemFromHabitat()` - Move item from habitat back to inventory
- ✅ `initializeStarterHabitat()` - Set up starter items on first adoption
- ✅ Integration with `markAsPlacedInHabitat()` / `unmarkAsPlacedInHabitat()` in inventory store

**Starter Habitat Setup:**
- ✅ **In Habitat (4 items placed):**
  - Basic Water Bottle
  - Plastic Igloo
  - Basic Ceramic Bowl
  - Basic Hay Rack
- ✅ **In Inventory Only (6 items):**
  - Timothy Hay (unopened bag)
  - Average Bedding (unopened bag)
  - Standard Pellets
  - Green Leaf Lettuce
  - Carrot
  - Apple Wood Sticks

**Files Completed:**
- ✅ `src/stores/habitatConditions.ts` - Full integration with Supplies & Inventory
- ✅ `src/components/debug/HabitatDebug.vue` - Complete UI with Habitat Items panel
- ✅ `src/stores/suppliesStore.ts` - Added `habitat_basic_water_bottle` item
- ✅ `src/stores/petStoreManager.ts` - Starter habitat items integration
- ✅ `src/stores/inventoryStore.ts` - Habitat placement tracking

**Documentation:** [System 13: Habitat Conditions](systems/phase3/system-13-habitat-conditions.md)

---

#### **System 14: Habitat UI & Item Placement System** ✅ **PHASE 1 & 2 COMPLETE**
**Priority:** HIGH
**Status:** ✅ Phases 1-2 Complete (October 17, 2025 | Branch: GPS2-29) | Phase 3 Deferred

**Completed Features:**
- ✅ **Visual Habitat Grid** - 14x10 medium habitat (60px cells)
- ✅ **Subgrid System** - 56x40 subcells for poop/particles
- ✅ **Drag & Drop** - HTML5 native implementation
- ✅ **Item Placement** - Drag from inventory sidebar to habitat
- ✅ **Position Persistence** - itemPositions Map with localStorage
- ✅ **Stacking Support** - Items can overlap with z-index
- ✅ **Repositioning** - Placed items can be dragged to new positions
- ✅ **Constraints** - Water bottles restricted to edges
- ✅ **Visual Feedback** - Green (valid) / Red (invalid) drop zones
- ✅ **Food Bowl System** - Interactive food placement with drag/drop
- ✅ **Hay Rack System** - 4-serving capacity with visual fullness
- ✅ **Serving-Based Inventory** - Consumables track servings independently

**Phase 3 Decision:**
Phase 3 (Guinea Pig Integration) deferred to Phase 4 autonomy system to avoid building temporary systems. Guinea pig sprites will be implemented with full autonomy, pathfinding, and AI decision-making.

**Files Created:**
- ✅ `src/components/game/HabitatVisual.vue`
- ✅ `src/components/game/FoodBowl.vue`
- ✅ `src/components/game/HayRack.vue`
- ✅ `src/components/game/InventoryTileServing.vue`

**Documentation:** [System 14.1: Habitat UI Implementation Plan](systems/phase3/system-14.1-habitat-ui-implementation-plan.md)

---

#### **System 14.2: Hay Rack & Serving System** ✅ **COMPLETE**
**Priority:** HIGH
**Status:** ✅ Complete (October 19, 2025 | Branch: GPS2-29)

**Completed Features:**
- ✅ **Serving Metadata** - servingsRemaining, maxServings tracking
- ✅ **Hay Rack Component** - 4-serving capacity with visual fullness (white→gold)
- ✅ **Food Bowl Integration** - Accepts individual servings
- ✅ **Serving-Based Items:**
  - Hay (8 types): 4 servings each
  - Lettuce (3 types): 6 servings each
  - Carrot: 8 servings
  - Pellets (3 types): 10 servings each
- ✅ **Inventory Display** - InventoryTileServing with depletion colors
- ✅ **Drag Validation** - Custom MIME types for category restrictions
- ✅ **Automatic Cleanup** - Depleted items removed from inventory

**Documentation:** [System 14.2: Hay Rack & Serving System](systems/phase3/system-14.2-hay-rack-and-serving-system.md)

---

#### **System 15: Habitat Maintenance & Hygiene** ✅ **COMPLETE**
**Priority:** HIGH
**Status:** ✅ Complete (October 19, 2025 | Branch: GPS2-29)

**Completed Features:**
- ✅ **Poop Tracking** - Grid-based placement and removal
- ✅ **Poop Component** - Click to remove individual poops
- ✅ **Cleanliness Impact** - Each poop reduces cleanliness by 2-5 points
- ✅ **Clean Cage** - Removes all poops, sets cleanliness to 100%
- ✅ **Bedding System** - Already implemented with freshness tracking
- ✅ **Water System** - Already implemented with refill action
- ✅ **Maintenance UI** - Integrated in HabitatDebug panel

**Files Modified:**
- ✅ `src/stores/habitatConditions.ts` - Added poop tracking
- ✅ `src/components/game/HabitatVisual.vue` - Poop display integration
- ✅ `src/components/game/Poop.vue` - Created

**Documentation:** [System 15: Habitat Maintenance & Hygiene](systems/phase3/system-15-habitat-maintenance-hygiene.md) | [System 15.1: Habitat Debug Plan](systems/phase3/system-15.1-habitat-debug-development-plan.md)

---

#### **System 16: Autonomy Preparation** 🔜

**Priority:** HIGH (Required for Phase 4 Autonomy)
**Status:** 📋 Not Started
**Estimated Time:** 8-13 hours

**Goal:** Complete Phase 3 by implementing 5 critical systems required for guinea pig autonomy

**5-Phase Implementation:**

1. **Phase 1: Item Type Metadata** (1-2 hours)
   - Add `itemType` to supplies: 'water_bottle' | 'food_bowl' | 'hay_rack' | 'shelter' | 'bed' | 'toy' | 'chew'
   - Map item types to need satisfaction
   - Enable autonomy to identify item functions

2. **Phase 2: Water Consumption System** (1-2 hours)
   - Track guinea pig drinking from water bottles
   - Reduce waterLevel in habitatConditions
   - Water bottle position lookup for pathfinding

3. **Phase 3: Environmental Decay** (2-3 hours)
   - Bedding freshness gradual decay (quality-based rates)
   - Cleanliness decay from guinea pig activity
   - Time-based decay integration with game loop

4. **Phase 4: Guinea Pig Position Tracking** (2-3 hours)
   - Track guinea pig position in habitat grid
   - Initialize position when guinea pig becomes active
   - Movement updates position and records activity

5. **Phase 5: Item Usage History** (2-3 hours)
   - Track when items were last used by guinea pig
   - Effectiveness decay with overuse (encourages rotation)
   - Usage count and statistics for AI decisions

**Files to Modify:**
- `src/types/supplies.ts` - Add ItemType and NeedType
- `src/stores/suppliesStore.ts` - Add item type metadata
- `src/stores/habitatConditions.ts` - Add all 5 phases
- `src/stores/gameController.ts` - Integrate decay and recovery
- `src/stores/guineaPigStore.ts` - Initialize positions
- `src/components/game/HabitatVisual.vue` - Display positions

**Documentation:** [System 16: Autonomy Preparation](systems/phase3/system-16-autonomy-preparation.md)

---

## 🎯 **High Priority Improvements**

### Currency Reward System 🔥
**Goal:** Implement currency earning system that rewards good guinea pig care

**Concept:** Friendship Dividends - Guinea pigs earn currency based on friendship points × wellness
- Active pigs: `(friendshipPoints / 100) × (wellness / 100) × 20 = currency/hour`
- Sanctuary pigs: `(friendshipPoints / 100) × 30 = currency/hour` (higher rate, friendship-only)
- Offline accumulation (8-hour cap to prevent FOMO)
- Bonus systems: Daily login (+100), interactions (+5 each), friendship milestones (250-2000 points)
- Self-balancing economy that scales with progression and rewards long-term bonds

**Documentation:** [Currency Reward System Design](game-design/currency-reward-system.md)

**Implementation Priority:** HIGH - Required before expanding supplies catalog

---

### Friendship System Redesign 🔥
**Goal:** Change from percentage (0-100%) to infinite point-based with levels

**Key Changes:**
- Point-based progression (not capped at 100%)
- 10+ tiered levels (Level 4 = Stardust Sanctuary unlock)
- Migration: existing friendship % × 10 = starting points

**Files:** guineaPig.ts, guineaPigStore.ts, petStoreManager.ts, GuineaPigEditor.vue

---

### Port Real Food Items to Preferences 🔥
**Goal:** Replace hardcoded food arrays with Supplies Store catalog

**Implementation:**
- Pull food from `suppliesStore.getFoodByCategory()` instead of hardcoded lists
- Update preference generation to use real item IDs
- Validate guinea pig preferences against Supplies Store

**Files:** GuineaPigEditor.vue, petStoreManager.ts, guineaPigStore.ts

---

### Personality-Based Habitat Sensitivity 🔥
**Goal:** Add 5th personality trait (cleanliness 1-10) affecting habitat tolerance

**Trait Effects:**
- **Picky (7-10):** Won't eat hay <60% fresh, stressed by mess
- **Moderate (4-6):** Baseline 40% thresholds
- **Piggy (1-3):** Tolerates mess, eats hay down to 20% fresh

**Files:** guineaPig.ts, guineaPigStore.ts, habitatConditions.ts, needsController.ts, messageGenerator.ts

---

## 🔧 **Technical Debt & Polish**

### Code Cleanup
- [x] Review and consolidate debug panel styles
- [x] Audit unused imports across components
- [x] Remove any remaining legacy favorites references in comments
- [x] CSS & Component Cleanup (Phase 5 complete - improved color contrast, mobile-first patterns)
- [ ] Standardize error handling patterns

### UI/UX Improvements
- [ ] Add loading states for long operations
- [ ] Improve mobile responsiveness for debug panels
- [ ] Add keyboard shortcuts for common debug actions
- [x] Enhance visual feedback for disabled buttons

### Documentation
- [x] Update architecture diagrams for Phase 2 changes
- [x] Document state management patterns
- [ ] Create component library reference
- [ ] Add inline JSDoc comments for complex functions

---

## 📝 **Notes**

### Recent Changes (Phase 7 - October 13)
- Changed "Cage" terminology to "Habitat" throughout Pet Adoption UI
- Changed "Pet Store" to "Pet Adoption" in main heading
- Added InfoButton to Stardust Sanctuary with feature description
- Increased InfoButton popover width (300px default, 400px max)
- ~~Added Feeding Cycle Status panel showing hunger progress and manual reset controls~~ (removed)
- Removed disliked activities and habitats from preference system (kept food dislikes)
- Updated all affected components, stores, and message generators

### Property Name Considerations
Note: `cageNumber` property name remains in code for data compatibility, only UI labels use "habitat"

### System Integration
All Phase 2 systems are fully integrated:
- Friendship system with passive gain/loss
- Needs system with personality modifiers
- Preferences with food/activity favorites
- Consumption limits with hunger cycles
- Stardust Sanctuary with 85% threshold
- Permanent adoption with natural churn

---

## 🎮 **Testing Checklist**

### Pre-Phase 3 Testing
- [ ] Test full adoption flow with observe interaction
- [ ] Verify paired guinea pigs leave store together
- [ ] Test Stardust Sanctuary unlock at 85% friendship
- [ ] Verify consumption limits reset at 100% hunger
- [ ] Test preference system (favorites, dislikes, rejection)
- [ ] Verify habitat grouping displays correctly
- [ ] Test InfoButton tooltips across all panels

### Integration Testing
- [ ] Test multiple guinea pigs with different personalities
- [ ] Verify friendship gain/loss calculations
- [ ] Test edge cases (0% friendship, 100% friendship)
- [ ] Verify adoption timer expiration and store updates
- [ ] Test manual consumption limit resets

---

## 🚀 **Commands**

**Development:**
- `npm run dev` - Start development server
- `npm run build` - Production build (run before commits)
- `npm run preview` - Preview production build

**Git:**
- Current branch: `GPS2-24`
- Main branch: `main`

---

## 📚 **Documentation Links**

- [Project Plan](PROJECT_PLAN.md)
- [Development Phases](DEVELOPMENT_PHASES.md)
- [System Integration](SYSTEM_INTEGRATION.md)
- [Phase 2 Systems](systems/phase2/)
- [Phase 2.5 Systems](systems/phase2.5/)
- [System 6.95 Implementation](systems/phase2/system-6.95.1-implementation-plan.md)
