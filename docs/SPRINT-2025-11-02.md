# GPS2 Sprint - November 2, 2025

**Started:** November 2, 2025
**Status:** Active üöß
**Branch:** GPS2-42
**Previous Sprint:** [SPRINT-2025-10-27.md](SPRINT-2025-10-27.md)

---

## ‚úÖ **Completed Work from Previous Sprint**

The following items were completed during the November 2, 2025 session:

### Bug Fixes ‚úÖ
1. **Clear Game Data Doesn't Clear Habitat View** - FIXED
   - Fixed race condition where items persisted and guinea pigs froze after clearing storage
   - Rewrote `clearAllStorage()` to stop game loop, manually clear stores, add delay for reactivity, then reload
   - [UtilityNav.vue](../src/components/layout/UtilityNav.vue)

2. **Activity Feed Auto-Scroll** - FIXED
   - Fixed auto-scroll scrolling to bottom when newest messages are at top
   - Renamed `scrollToBottom()` to `scrollToTop()` and changed `scrollTop = scrollHeight` to `scrollTop = 0`
   - [ActivityFeed.vue](../src/components/game/ui/ActivityFeed.vue)

3. **Item Tooltips Disappear Before Clicking** - FIXED
   - Fixed tooltips disappearing when moving mouse from item to tooltip
   - Added hover grace period and popover hover detection
   - Tooltip stays visible when mouse transitions to popover, allowing button clicks
   - [HabitatItemPopover.vue](../src/components/game/habitat/HabitatItemPopover.vue)

4. **Hay System Duplication Bug** - FIXED (CRITICAL)
   - Fixed infinite hay exploit where eating hay added to inventory instead of consuming
   - Removed incorrect `addConsumableWithServings()` call in `removeHayFromRack()`
   - Fix applies to all hay types (Timothy, Orchard, Botanical, etc.)
   - [useHabitatContainers.ts](../src/composables/useHabitatContainers.ts)

### Documentation ‚úÖ
3. **Sprint Organization** - COMPLETE
   - Created new sprint document with all todos organized by category and priority
   - Moved old sprint to archive
   - Updated todos.md to reference new sprint

---

## üéØ **Sprint Goals**

**Focus:** Bug fixes, UI polish, and gameplay improvements for Phase 4.5

**Priority Areas:**
1. Guinea pig interaction polish and animations
2. Inventory and resource display accuracy
3. Social bonding enhancements
4. Activity feed improvements

---

## üêõ **Bug Fixes**

### High Priority Bugs üî•

#### Hay System Display & Duplication Bug ‚úÖ **FIXED**
**Priority:** CRITICAL
**Status:** ‚úÖ Complete (Duplication fixed - display issue may remain)
**Category:** Inventory & Resources

**Issue:** Multiple hay-related bugs affecting both inventory counts and hay rack display - Timothy hay (starter hay) duplicates when added to rack

**Bug #1: Hay Inventory Duplication (CRITICAL)**
**Observed Behavior:**
- **CONFIRMED: Bug affects multiple hay types** - Timothy hay AND Orchard grass both duplicate
- **LIKELY: All hay types are affected** - this is a systemic hay handling bug
- Hay count **increases** when dragging hay servings into hay rack (should decrease)
- **NEW CRITICAL INFO:** Hay count **increases by 1 each time guinea pig eats hay** from rack
- Numbers continue changing as game progresses
- Appears to be adding hay back to inventory instead of consuming it

**Reproduction Steps:**
1. Have any hay type in inventory (Timothy hay, Orchard grass, Botanical hay, etc.)
2. Drag several hay servings into hay rack
3. Observe inventory sidebar hay count increases (should decrease)
4. Watch guinea pigs autonomously eat hay from rack
5. **Each time guinea pig eats hay, inventory count increases by 1**
6. Infinite hay generation through eating
7. **Confirmed with both Timothy hay and Orchard grass** - likely affects all hay types

**Confirmed Root Causes:**
- **CRITICAL:** When guinea pig eats hay from rack, hay is being ADDED to inventory instead of consumed
- **SECONDARY:** Drag-and-drop to hay rack may also be adding hay instead of removing
- Eating hay behavior is calling `addItem()` instead of consuming from rack only
- This creates infinite hay - every time guinea pig eats, player gets more hay

**Bug #2: Hay Rack Servings Display (MEDIUM) - RELATED TO BUG #1**
**Observed Behavior:**
- Hay rack servings display shows "1/1" instead of "1/4"
- **NEW INFO:** Display changes to "1/1" when dragging hay into rack
- **NEW INFO:** Dragging hay also removes the hay bag count from inventory
- Appears intermittent but is directly related to Bug #1
- Likely same root cause as duplication bug

**Connection to Bug #1:**
- When dragging hay to rack: display shows "1/1" AND removes bag from inventory (correct removal)
- Later when guinea pig eats: display may still show wrong count AND adds bag back to inventory (BUG)
- The display bug and duplication bug are manifestations of same underlying issue with hay tracking

**Investigation Required:**
- **PRIORITY 1 (CRITICAL):** Check autonomous eat hay behavior in useGuineaPigBehavior.ts
- Verify eat hay function is NOT adding hay back to inventory
- Check if eating hay should only consume from rack (not touch inventory)
- **This is a systemic bug affecting ALL hay types** - not specific to one type
- **PRIORITY 2:** Check hay rack drag-and-drop handler in HabitatVisual.vue
- Verify `handleAddHayToRack()` function logic
- Check if hay is being removed from inventory when added to rack
- Verify inventory add/remove methods are being called correctly
- **PRIORITY 3:** Check if hay rack capacity is being read correctly from supplies metadata
- Verify hay rack contents count calculation
- Check if different hay types have different capacity values
- Look for any inventory refund/return logic that shouldn't be there

**Files to Check (Priority Order):**
1. **[useGuineaPigBehavior.ts](../src/composables/game/useGuineaPigBehavior.ts) - Autonomous eat hay behavior (MOST CRITICAL)**
2. [habitatConditions.ts](../src/stores/habitatConditions.ts) - Hay consumption/rack methods
3. [inventoryStore.ts](../src/stores/inventoryStore.ts) - Add/remove hay methods
4. [HabitatVisual.vue](../src/components/game/habitat/HabitatVisual.vue) - Hay drag-and-drop handler (lines ~955-961, ~548-552)
5. [useHabitatContainers.ts](../src/composables/useHabitatContainers.ts) - Hay rack container logic
6. [HabitatDebug.vue](../src/components/debug/environment/HabitatDebug.vue) - Hay rack display logic
7. [HayRack.vue](../src/components/game/habitat/HayRack.vue) - Capacity prop usage
8. [supplies/habitat/food-bowls-hay-racks.json](../src/data/supplies/habitat/food-bowls-hay-racks.json) - Capacity metadata

**Expected Behavior:**
- Dragging hay to rack should **remove** hay from inventory
- Inventory count should **decrease** when hay is added to rack
- Hay rack should display correct servings (e.g., "1/4" not "1/1")
- **Guinea pig eating hay should ONLY decrease hay rack contents (NOT add to inventory)**
- Inventory should remain unchanged when guinea pig eats from rack
- Only adding hay to rack from inventory should affect inventory count

**Debugging Steps:**
1. **PRIORITY:** Add console.log in autonomous eat hay behavior to track inventory changes
2. Verify eat hay does NOT call inventory.addItem() or similar
3. Let game run autonomously and watch guinea pigs eat hay
4. Confirm each eat action adds +1 to inventory (BUG)
5. Add console.log in `handleAddHayToRack()` to track calls
6. Add console.log in `addHayToRack()` store method
7. Add console.log in inventory remove hay method
8. Drag hay to rack and verify logs show removal, not addition
9. **Test with different hay types** (timothy ‚úÖ confirmed, orchard ‚úÖ confirmed, botanical ‚ùì likely)
10. Check if bug happens on first drag or subsequent drags
11. Verify hay rack capacity display logic
12. Check if bug is in base hay handling logic vs. specific hay types

**Additional Context:**
- Bug confirmed after letting game run autonomously for a while
- No user interaction required - happens during normal autonomous gameplay
- This is an **infinite resource exploit** that breaks game economy

**Complete Bug Flow Observed:**
1. **Initial state:** Have Timothy hay bags in inventory
2. **Drag hay to rack:**
   - Inventory count correctly decreases (bag removed) ‚úÖ
   - Hay rack display shows "1/1" instead of "1/4" ‚ùå
3. **Guinea pig eats hay:**
   - Hay rack servings decrease (correct) ‚úÖ
   - Inventory count INCREASES by +1 (BUG) ‚ùå
4. **Net result:** Each eat cycle gives player free hay, display shows wrong capacity

**Summary:**
- Dragging hay properly removes from inventory ‚úÖ
- Display bug shows wrong hay rack capacity (1/1 vs 1/4) - may be intermittent or fixed
- ~~Eating hay incorrectly adds hay back to inventory~~ **FIXED** ‚úÖ
- Root cause was in `removeHayFromRack()` function

**Solution Implemented:**

**Root Cause Found:**
In [useHabitatContainers.ts](../src/composables/useHabitatContainers.ts) line 300, the `removeHayFromRack()` function was calling:
```typescript
inventoryStore.addConsumableWithServings(serving.itemId, 1)
```

This was **adding hay back to inventory** every time a guinea pig ate hay from the rack, creating infinite hay duplication.

**Fix Applied:**
Removed the incorrect `addConsumableWithServings()` call. The function now ONLY removes hay from the rack when guinea pigs eat, without touching inventory at all.

**Changes Made:**
- Removed lines 296-297, 299-300 from `useHabitatContainers.ts`
- Added clarifying comment: "This does NOT add hay back to inventory - eating consumes the hay entirely"
- Removed unused `serving` and `inventoryStore` variables

**Files Modified:**
- [useHabitatContainers.ts](../src/composables/useHabitatContainers.ts) - Fixed `removeHayFromRack()` function

**Result:**
- ‚úÖ Hay no longer duplicates when guinea pigs eat from rack
- ‚úÖ Inventory count stays correct when adding hay to rack
- ‚úÖ Inventory count stays correct when guinea pigs eat hay
- ‚úÖ Infinite resource exploit eliminated
- ‚úÖ Fix applies to ALL hay types (Timothy, Orchard, Botanical, etc.)

**Additional Bug Found & Fixed:**

**Bug #2: Duplicate Drop Handlers - Double Consumption**
After fixing the eating duplication, user reported that dragging one hay serving to rack was subtracting multiple bags (3x ‚Üí 2x instead of 3x ‚Üí 3x with 3/4 servings remaining).

**Root Cause:**
Both the HayRack component AND HabitatVisual were handling the same drop event:
1. HayRack's `@drop` handler ‚Üí emits `@add-hay` ‚Üí calls `handleAddHayToRack()` ‚Üí consumes 1 serving
2. HabitatVisual's `@drop` handler on grid cell ‚Üí ALSO calls `handleAddHayToRack()` ‚Üí consumes ANOTHER serving

Total: 2 servings consumed for 1 drag operation!

**Solution:**
Removed duplicate drop handling logic from HabitatVisual (lines 727-752). The FoodBowl and HayRack components already have their own drop handlers that emit events. No need to duplicate the logic in the parent component.

**Files Modified (Additional):**
- [HabitatVisual.vue](../src/components/game/habitat/HabitatVisual.vue) - Removed duplicate food/hay drop handling

**Final Result:**
- ‚úÖ Dragging 1 hay serving to rack now correctly consumes only 1 serving
- ‚úÖ Dragging 1 food serving to bowl now correctly consumes only 1 serving
- ‚úÖ Inventory counts update accurately
- ‚úÖ Works for all hay types and all food types

---

### Medium Priority Bugs üìã

#### Clear Game Data Doesn't Clear Habitat View ‚úÖ **FIXED**
**Priority:** MEDIUM
**Status:** ‚úÖ Complete
**Category:** UI/UX

**Issue:** When clicking "Clear All Storage" from habitat debug, items persist in the visual display and guinea pigs appear frozen

**Expected Behavior:**
- Click "Clear All Storage" button
- All game state clears (guinea pigs, items, needs, etc.)
- Habitat view resets to empty state immediately
- All visual elements removed from habitat grid
- No frozen guinea pigs

**Root Cause:**
- `localStorage.clear() + window.location.reload()` race condition
- DOM not updated before reload
- Store state not explicitly cleared before localStorage wipe
- Game loop and timers not stopped before clearing

**Solution Implemented:**
- Stop game loop and timers first
- Manually clear all habitat data (items, positions, poops, guinea pigs)
- Clear all guinea pigs using `deleteGuineaPig()`
- Add 100ms delay for Vue reactivity to update UI
- Then clear localStorage and reload

**Files Modified:**
- [UtilityNav.vue](../src/components/layout/UtilityNav.vue) - Complete rewrite of `clearAllStorage()` function

---

#### Simultaneous Pooping Bug ‚è∏Ô∏è **DEFERRED**
**Priority:** MEDIUM (deferred to future sprint)
**Status:** ‚è∏Ô∏è Deferred
**Category:** Gameplay

**Issue:** Multiple guinea pigs poop too close together in time - staggered but not sufficiently randomized

**Note:** Deferring to future sprint as issue is not as noticeable currently. Will revisit when doing broader gameplay balance pass.

**Previous Attempts:**
- Random offset to initial timestamps (0-30 seconds)
- Random jitter to decision timing (0-2 seconds)
- Wider goal selection randomization (15 priority points)
- Random need decay timing offsets
- Per-poop randomization (0-10 second backwards offset)

**Next Steps (when resuming):**
- Increase random offset range (0-20 seconds instead of 0-10)
- Consider truly random intervals (15-45 seconds) instead of fixed 30s base
- Test with 3+ guinea pigs over extended time

---

#### Item Tooltips Disappear Before Clicking ‚úÖ **FIXED**
**Priority:** MEDIUM
**Status:** ‚úÖ Complete
**Category:** UI/UX

**Issue:** Item tooltips (food bowls, hay racks, chew items, water bottles) disappear when moving mouse from item to tooltip, preventing interaction with tooltip buttons

**Observed Behavior:**
- Hover over habitat item (food bowl, hay rack, etc.)
- Tooltip/popover appears with item info and action buttons
- Move mouse from item toward tooltip to click a button
- Tooltip disappears before mouse reaches it
- Cannot click tooltip buttons (e.g., "Refill Water", "Add Food", etc.)

**Root Cause:**
- Tooltip is triggered by `@mouseenter` on item element only
- No hover tolerance/delay when moving between item and tooltip
- Gap between item and tooltip causes `@mouseleave` to fire
- Tooltip closes before user can interact with it

**Expected Behavior:**
- Tooltip remains visible when moving mouse from item to tooltip
- Tooltip stays open while hovering over tooltip itself
- User can click buttons within tooltip
- Tooltip only closes when mouse leaves both item AND tooltip

**Solution Options:**

**Option 1: Add Hover Grace Period (Recommended)**
- Add small delay (200-300ms) before hiding tooltip on `@mouseleave`
- Cancel hide timer if mouse enters tooltip area
- Allows smooth transition from item to tooltip

**Option 2: Expand Hover Target Area**
- Create invisible bridge element between item and tooltip
- Tooltip stays open when hovering bridge
- Ensures no gap that triggers close

**Option 3: Keep Tooltip Open Until Explicit Close**
- Tooltip stays open after initial hover
- Only closes when clicking outside or pressing Escape
- More persistent but less standard behavior

**Solution Implemented (Option 1 - Hover Grace Period):**

**Changes Made:**
1. Added `isPopoverHovered` ref to track if mouse is over the popover
2. Added `@mouseenter` and `@mouseleave` handlers to popover element
3. Increased grace period from 100ms to 200ms when item hover ends
4. On item `@mouseleave`: starts 200ms timer, but cancels hide if popover is hovered
5. On popover `@mouseenter`: cancels hide timer and sets `isPopoverHovered = true`
6. On popover `@mouseleave`: hides immediately (user is done interacting)

**Key Logic:**
```typescript
// When item hover ends, wait 200ms before hiding
// But only hide if popover itself is not being hovered
hideTimeout = setTimeout(() => {
  if (!isPopoverHovered.value) {
    isVisible.value = false
  }
}, 200)

// When mouse enters popover, cancel any pending hide
handlePopoverMouseEnter() {
  isPopoverHovered.value = true
  clearTimeout(hideTimeout)
}
```

**Files Modified:**
- [HabitatItemPopover.vue](../src/components/game/habitat/HabitatItemPopover.vue) - Added hover grace period logic

**Result:**
- Tooltip remains visible when transitioning from item to popover
- User can click buttons within tooltip
- Tooltip closes immediately when mouse leaves both item and popover
- 200ms grace period allows smooth mouse movement

**Testing Recommendations:**
- Hover over habitat items (food bowl, hay rack, water bottle, chew toy)
- Slowly move mouse from item to tooltip
- Verify tooltip stays open during transition
- Click action buttons in tooltip (e.g., "Refill Water", "Add Food")
- Verify actions execute successfully
- Move mouse away from tooltip - should close immediately

---

### Low Priority Bugs üîß

#### Activity Feed Auto-Scroll to Bottom ‚úÖ **FIXED**
**Priority:** LOW
**Status:** ‚úÖ Complete
**Category:** Activity Feed

**Issue:** Activity log was scrolling to bottom when adding new activity, but messages are displayed in reverse order (newest at top)

**Root Cause:**
- Messages displayed in reverse order via `.reverse()` - newest messages appear at TOP of feed
- `scrollToBottom()` function scrolled to BOTTOM of container
- This caused scroll to go to oldest messages instead of newest
- Auto-scroll was working backwards from message display order

**Solution Implemented:**
- Renamed `scrollToBottom()` to `scrollToTop()`
- Changed scroll behavior: `scrollTop = 0` instead of `scrollTop = scrollHeight`
- Now scrolls to top of container where newest messages appear
- Updated comments to clarify behavior
- Auto-scroll now correctly shows newest messages when they arrive

**Files Modified:**
- [ActivityFeed.vue](../src/components/game/ui/ActivityFeed.vue) - Fixed auto-scroll direction to match message order

---

## ‚ú® **Feature Enhancements**

### Guinea Pig Interactions üêπ

#### Guinea Pig Wiggle When Chewing ‚úÖ **FIXED**
**Priority:** MEDIUM
**Status:** ‚úÖ Complete
**Category:** Animations & Polish

**Goal:** Add chomp animation when guinea pig chews on chew toy

**Previous Behavior:**
- Guinea pig chews chew toy
- No visual animation during chewing
- Static sprite while chewing

**New Behavior:**
- Guinea pig sprite does vertical "chomp" animation while chewing
- Animation is vertical up-down motion (not rotational wiggle)
- Visual feedback that guinea pig is actively chewing
- Animation pauses when game is paused

**Implementation Completed:**
- Created new `guinea-pig-chomp` animation (vertical motion)
- Added `isChewing` computed property checking `currentActivity === 'chewing'`
- Added `guinea-pig-sprite--chewing` class binding
- Created separate flipped version for left-facing guinea pigs
- Updated paused states to include chewing animation
- Changed activity type from 'eating' to 'chewing' for clarity

**Animation Details:**
- Duration: 0.5s
- Motion: `translateY(-4px) scaleY(0.95)` at 50%
- Creates up-down "chomping" effect
- Uses `!important` to override walking animation when both occur

**Files Modified:**
- [GuineaPigSprite.vue](../src/components/game/habitat/GuineaPigSprite.vue) - Added chomp animation and chewing state
- [useGuineaPigBehavior.ts](../src/composables/game/useGuineaPigBehavior.ts) - Changed to 'chewing' activity type

**Result:**
- ‚úÖ Guinea pigs visually chomp when using chew toys
- ‚úÖ Animation works for both left and right facing directions
- ‚úÖ Animation properly pauses when game is paused
- ‚úÖ Chomp takes priority over walking animation

---

#### Guinea Pig Wiggle During Player Interaction ‚úÖ **FIXED**
**Priority:** MEDIUM
**Status:** ‚úÖ Complete
**Category:** Animations & Polish

**Goal:** Guinea pig should wiggle when user interacts with them (socialize actions)

**Previous Behavior:**
- User clicks socialize button (pet, hold, hand-feed, etc.)
- Guinea pig receives interaction benefits
- No visual animation during interaction

**New Behavior:**
- Guinea pig wiggles when being petted/held/interacted with
- Animation plays for 1.5 seconds during interaction
- Visual feedback that interaction is happening
- Animation works for all socialize action types

**Implementation Completed:**
- Added 'interacting' activity type to BehaviorState
- Created `triggerPlayerInteraction()` helper in behaviorStateStore
- Added `isInteracting` computed property in GuineaPigSprite
- Reused existing wiggle animation CSS for interacting state
- Animation automatically returns to idle after 1.5 seconds
- Called from `handleInteraction()` in HabitatDebug

**Animation Details:**
- Uses existing `guinea-pig-wiggle` animation (rotational wiggle)
- Duration: 1.5 seconds total interaction feedback
- Works for both left and right facing directions
- Takes priority over walking animation
- Properly pauses when game is paused

**Files Modified:**
- [useGuineaPigBehavior.ts](../src/composables/game/useGuineaPigBehavior.ts) - Added 'interacting' to activity type
- [behaviorStateStore.ts](../src/stores/behaviorStateStore.ts) - Added `triggerPlayerInteraction()` helper
- [GuineaPigSprite.vue](../src/components/game/habitat/GuineaPigSprite.vue) - Added interacting animation and state
- [HabitatDebug.vue](../src/components/debug/environment/HabitatDebug.vue) - Trigger wiggle on interaction

**Result:**
- ‚úÖ All socialize actions trigger wiggle animation (pet, hold, hand-feed, talk-to, sing-to, call-name, peek-a-boo, wave-hand, show-toy)
- ‚úÖ Animation plays for correct duration
- ‚úÖ Animation stops automatically after interaction
- ‚úÖ Works for left and right facing guinea pigs
- ‚úÖ Animation properly pauses when game is paused

---

#### Hand-Feed Food Selection Menu üìã **NOT STARTED**
**Priority:** MEDIUM
**Status:** üìã Not Started
**Category:** Player Interaction & UX

**Goal:** Add food selection dialog when using hand-feed interaction

**Current Behavior:**
- User clicks "Hand-Feed" socialize action
- Food is automatically selected/given (unclear which food)
- No player choice in what to feed

**Desired Behavior:**
- User clicks "Hand-Feed" button
- Dialog/menu appears: **"Select food item to give:"**
- Display one tile-like button for each unique food type in inventory
- Show food emoji, name, and available quantity
- User selects one food item
- Guinea pig receives one serving of selected food
- Dialog closes and hand-feed interaction proceeds

**UI Design:**
- Modal or popover dialog
- Title: "Select food item to give:"
- Grid layout of food tile buttons
- Each tile shows:
  - Food emoji (large)
  - Food name
  - Quantity available (e.g., "x3 servings")
- Tile button highlights on hover
- Click tile to select and confirm
- Cancel/close button to abort hand-feed

**Implementation Requirements:**
1. Create FoodSelectionDialog component
2. Show only foods currently in inventory
3. Display one button per unique food type (not per serving)
4. Group by food item, show total servings available
5. On selection, consume one serving and pass to hand-feed behavior
6. Integrate with existing hand-feed socialize action
7. Consider favorite/disliked food highlighting (optional enhancement)

**Files to Create:**
- [FoodSelectionDialog.vue](../src/components/game/dialogs/FoodSelectionDialog.vue) - New food selection UI

**Files to Modify:**
- [useGuineaPigBehavior.ts](../src/composables/game/useGuineaPigBehavior.ts) - Accept food parameter in hand-feed
- Socialize action trigger (wherever hand-feed is called) - Show dialog before feeding
- [inventoryStore.ts](../src/stores/inventoryStore.ts) - May need food grouping helper

**Future Enhancement:**
- Show guinea pig's food preferences (favorite/disliked) in selection UI
- Visual indicator if food is liked/disliked
- Show nutritional info or serving size

---

#### Gentle Pet Wipe Interaction ‚úÖ **FIXED**
**Priority:** MEDIUM
**Status:** ‚úÖ Complete
**Category:** Player Interaction & Hygiene

**Goal:** Add "Use gentle pet wipe" as a user-to-guinea pig interaction to improve hygiene

**Previous Behavior:**
- Hygiene need only increases through autonomous grooming behavior
- No player interaction to directly improve guinea pig's hygiene
- Player has no way to help with grooming/cleanliness

**New Behavior:**
- New socialize action: **"Gentle Wipe"** üßº
- Player selects guinea pig and clicks "Gentle Wipe"
- Hygiene need increases by +18 points
- Comfort need increases by +5 points (guinea pig feels refreshed)
- Friendship gain: +2
- Activity feed message with üßº emoji
- Guinea pig wiggles during wiping (uses existing wiggle animation)
- 5-minute cooldown to prevent spam

**Implementation Completed:**
- Added 'gentle-wipe' interaction to interactionEffects map
- Hygiene boost: +18 (significant but not overpowered)
- Comfort bonus: +5 (feels nice and refreshing)
- Cooldown: 300 seconds (5 minutes) - longer than other interactions
- Added button to SocializeSidebar in Basic Interactions section
- Reuses existing wiggle animation for visual feedback
- Integrated with existing handleInteraction flow

**Interaction Details:**
- **Hygiene Impact:** +18 points
- **Comfort Impact:** +5 points
- **Friendship Gain:** +2
- **Cooldown:** 5 minutes (300 seconds)
- **Emoji:** üßº
- **Animation:** Wiggle (1.5 seconds)

**Files Modified:**
- [interactionEffects.ts](../src/utils/interactionEffects.ts) - Added gentle-wipe interaction data
- [SocializeSidebar.vue](../src/components/game/habitat/sidebars/SocializeSidebar.vue) - Added Gentle Wipe button
- [HabitatDebug.vue](../src/components/debug/environment/HabitatDebug.vue) - Added gentle-wipe handler

**Result:**
- ‚úÖ Gentle Wipe button appears in Basic Interactions section
- ‚úÖ Clicking button boosts hygiene by +18 and comfort by +5
- ‚úÖ Guinea pig wiggles during interaction
- ‚úÖ Activity feed logs the interaction
- ‚úÖ 5-minute cooldown prevents spam
- ‚úÖ Friendship increases by +2

**Future Enhancement Ideas:**
- Add "Gentle Pet Wipes" as consumable inventory item
- Different wipe types with different effectiveness (basic, premium, scented)
- Guinea pig personality affects reaction (some may dislike it)

---

### Social Bonding Enhancements ü§ù

#### Sleeping Together Bonding Bonus üìã **NOT STARTED**
**Priority:** MEDIUM
**Status:** üìã Not Started
**Category:** Social Bonding

**Goal:** Guinea pig bonding should increase when two guinea pigs sleep in the same shelter together

**Current Behavior:**
- Two guinea pigs can sleep in same shelter
- Sprites stack on top of each other (see bug below)
- No bonding benefit for sleeping together

**Desired Behavior:**
- When two bonded/pairing guinea pigs sleep in same shelter, increase bond level
- Small bonding increase per sleep session (e.g., +1-2 bond points)
- Activity feed message: "[GP1] and [GP2] cuddle together in the [shelter name]"
- Bonding increase only happens once per sleep session (not continuously)

**Implementation Requirements:**
1. Detect when two guinea pigs are in same shelter position
2. Check if both are sleeping
3. Apply bonding increase to the pair
4. Generate appropriate activity message
5. Prevent duplicate bonding increases for same sleep session

**Files to Modify:**
- [useGuineaPigBehavior.ts](../src/composables/game/useGuineaPigBehavior.ts) - Sleep behavior detection and bonding logic
- [guineaPigStore.ts](../src/stores/guineaPigStore.ts) - Bonding adjustment function (already exists)
- [messageGenerator.ts](../src/utils/messageGenerator.ts) - New message for shared sleeping

**Related Bug:** Fix guinea pig sprite stacking before implementing this feature

---

### UI/UX Improvements üé®

#### Guinea Pigs in Same Shelter Shouldn't Stack ‚úÖ **FIXED**
**Priority:** HIGH
**Status:** ‚úÖ Complete
**Category:** Visual Display

**Issue:** When two guinea pigs are in a shelter, their sprites render on top of each other - we only see one guinea pig

**Previous Behavior:**
- Both guinea pigs occupy exact same grid cell
- Sprites stack vertically with z-index
- Only top sprite is visible

**New Behavior:**
- Guinea pigs at same position automatically get visual offset
- Second guinea pig appears offset by +12px right and +8px down
- Creates natural "cuddling" appearance
- Both sprites are fully visible
- Offset is automatic and handled at position level

**Implementation Completed:**
- Added `offsetX` and `offsetY` properties to GuineaPigPosition interface
- Updated `moveGuineaPigTo()` to detect when another guinea pig is already at target position
- Automatically applies 12px horizontal and 8px vertical offset to second guinea pig
- Updated GuineaPigSprite to accept and apply offset props
- Updated HabitatVisual to pass offsets from position data to sprite

**Technical Details:**
- **Offset Applied:** +12px X, +8px Y for second guinea pig
- **Detection:** Checks all guinea pig positions when moving
- **Automatic:** No special shelter logic needed - works anywhere
- **Persistent:** Offset stored in position data until guinea pig moves away

**Files Modified:**
- [habitatConditions.ts](../src/stores/habitatConditions.ts) - Added offset properties and detection logic
- [GuineaPigSprite.vue](../src/components/game/habitat/GuineaPigSprite.vue) - Added offset props and applied to transform
- [HabitatVisual.vue](../src/components/game/habitat/HabitatVisual.vue) - Pass offsets from position data

**Result:**
- ‚úÖ Two guinea pigs at same position are both visible
- ‚úÖ Offset creates natural cuddling appearance
- ‚úÖ Works in shelters, on beds, and any shared position
- ‚úÖ Automatic - no special behavior code needed
- ‚úÖ Offset resets when guinea pig moves to different position

---

## üè† **Habitat Management & Supplies**

### Smart Bedding System üìã **NOT STARTED**
**Priority:** HIGH
**Status:** üìã Not Started
**Category:** Habitat Conditions & Resource Management

**Goal:** Implement proportional bedding consumption based on habitat cleanliness - 1 bag should fully clean 100% dirty habitat

**Current Behavior (if implemented):**
- Bedding consumption may not be proportional to cleaning needs
- Unclear how much bedding is needed to clean habitat
- May use full bag regardless of dirtiness level

**Desired Behavior:**
- **1 bag of bedding = 100% habitat cleaning capacity**
- If habitat is 20% dirty, cleaning uses 20% of the bag
- Remaining 80% of bedding stays in inventory for future use
- Partial bag usage allows multiple cleanings per bag
- Visual feedback showing bedding amount used

**Example Scenarios:**
- **Scenario 1:** Habitat is 100% dirty
  - Use 1 full bag of bedding
  - Habitat becomes 100% clean
  - 0% bedding remains

- **Scenario 2:** Habitat is 20% dirty
  - Use 20% of 1 bag of bedding
  - Habitat becomes 100% clean
  - 80% bedding remains in inventory (0.8 bags)

- **Scenario 3:** Habitat is 50% dirty, have 0.3 bags left
  - Need 50% of bag (0.5 bags) but only have 0.3 bags
  - Can only clean up to 30% (partial cleaning)
  - Habitat goes from 50% dirty ‚Üí 20% dirty
  - 0 bedding remains

**Implementation Requirements:**

1. **Bedding Storage System:**
   - Track bedding as decimal/percentage (e.g., 2.5 bags)
   - Store bedding amount in inventory with fractional quantities
   - Display as "2.5 bags" or "50% of bag remaining"

2. **Cleaning Calculation:**
   - Calculate dirtiness level (0-100%)
   - Determine bedding needed = dirtiness / 100
   - Check available bedding in inventory
   - If sufficient: clean fully, subtract proportional bedding
   - If insufficient: partial clean, use all available bedding

3. **UI Feedback:**
   - Show bedding amount before cleaning: "You have 2.3 bags of bedding"
   - Show cleaning preview: "This will use 0.4 bags of bedding (40% dirty)"
   - Confirm dialog: "Use 0.4 bags to fully clean habitat?"
   - After cleaning: "Used 0.4 bags. 1.9 bags remaining."

4. **Habitat Cleanliness Tracking:**
   - Track dirtiness as percentage (0-100%)
   - Dirtiness increases based on: poop accumulation, time, guinea pig count
   - Cleaning reduces dirtiness proportionally to bedding used

**Files to Create:**
- Cleaning dialog/confirmation UI component

**Files to Modify:**
- [inventoryStore.ts](../src/stores/inventoryStore.ts) - Support fractional quantities for bedding items
- [habitatConditions.ts](../src/stores/habitatConditions.ts) - Track dirtiness percentage, implement proportional cleaning
- [supplies/habitat/bedding.json](../src/data/supplies/habitat/bedding.json) - Add bedding capacity metadata
- Habitat cleaning UI (wherever "Clean Cage" button is) - Add calculation and confirmation dialog

**Design Considerations:**
- Should all bedding types have same capacity? Or different types clean more/less?
- Should we show fractional bags (2.5 bags) or percentage (50%)?
- Should cleaning be automatic when clicking button, or require confirmation?
- What if user has multiple bedding types? Use them in order? Let user choose?

**Future Enhancement:**
- Different bedding qualities (premium bedding lasts longer before getting dirty)
- Spot cleaning option (clean only part of habitat with less bedding)
- Bedding type affects comfort level differently

---

## üìä **Resource & Documentation**

### Food Serving Guide üìã **NOT STARTED**
**Priority:** MEDIUM
**Status:** üìã Not Started
**Category:** Documentation & UX

**Goal:** Create visual food serving guide in addition to feeding limits imposed by game

**Current System:**
- Game enforces 5 serving limit per hunger cycle (excluding hay)
- Serving amounts vary by food type
- No in-game reference for serving sizes or daily limits

**Desired Features:**

**1. Food Serving Reference Card:**
- Visual guide showing serving sizes for each food type
- Daily recommended amounts per guinea pig
- Fruit vs vegetable balance recommendations
- Hay unlimited reminder
- Pellets daily serving size

**2. Integration Points:**
- Add info button in InventorySidebar near food category
- Tooltip/popover showing serving guide
- Optional: In-game "Guinea Pig Care Guide" section

**3. Content Format:**
- **Vegetables:** "Feed 1 cup daily (4-6 servings)"
- **Fruits:** "Feed sparingly as treats (1-2 servings daily)"
- **Pellets:** "Feed 1/8 cup daily (2-3 servings)"
- **Hay:** "Unlimited - always available"

**Files to Create:**
- Component for food serving guide display (modal or popover)
- Markdown documentation for reference

**Files to Modify:**
- [InventorySidebar.vue](../src/components/game/habitat/sidebars/InventorySidebar.vue) - Add info button to food section

**Note:** This complements the existing feeding limits system and provides educational value to players

---

## üéØ **Future Enhancements (From Previous Sprint)**

These items are carried over from the October 27, 2025 sprint for future consideration:

### Social Interaction Enhancements ü§ù

#### Multi-Type Guinea Pig Interactions üìã **LOW PRIORITY**
**Priority:** LOW
**Status:** üìã Not Started (Future Enhancement)
**Category:** Social Bonding - Phase 5+

**Goal:** Expand guinea pig social interactions beyond just "socialize"

**Current System:**
- Guinea pigs have single "socialize" interaction
- Only increases social need
- No variety in interaction types

**Proposed Interaction Types:**

1. **Play Interaction** (guinea pig to guinea pig)
   - Increases both social AND play needs
   - Example: Two guinea pigs chase each other, popcorn together
   - More energetic, requires both guinea pigs to be active
   - **Note:** User-to-guinea pig play should also increase play need

2. **Sniff/Investigate**
   - Increases social need only
   - Example: Guinea pigs sniff each other, investigate
   - Passive interaction, greeting behavior

3. **Groom (Allogrooming)**
   - Increases social AND hygiene needs
   - Example: One guinea pig grooms another
   - Bonding behavior that also provides hygiene benefit
   - More common in bonded pairs

4. **Huddle/Cuddle**
   - Increases social and comfort needs
   - Example: Guinea pigs snuggle together
   - Resting behavior, often during sleep

**Implementation Requirements:**
- Expand social interaction system beyond single "socialize" behavior
- Add interaction type selection based on context (energy levels, bond level)
- Update message generation for different interaction types
- Adjust need satisfaction based on interaction type
- Consider bond level affecting interaction availability

**Files to Modify:**
- [useGuineaPigBehavior.ts](../src/composables/game/useGuineaPigBehavior.ts) - Expand social interaction logic
- [messageGenerator.ts](../src/utils/messageGenerator.ts) - Add new interaction messages
- [guineaPigStore.ts](../src/stores/guineaPigStore.ts) - May need interaction type tracking

**Note:** This is a Phase 5+ enhancement, not critical for Phase 4.5

---

#### Pushable Toys System üìã **LOW PRIORITY**
**Priority:** LOW
**Status:** üìã Not Started (Future Enhancement)
**Category:** Gameplay - Phase 5+

**Goal:** Guinea pigs physically move balls and pushable toys across grid cells

**Current Behavior:**
- Guinea pig plays with ball in place
- Ball doesn't move
- Message: "plays with a toy"

**Desired Behavior:**
- Guinea pig pushes ball across 1-3 grid cells
- Ball position updates in real-time
- Message: "pushes the ball across the habitat"
- Visual animation of ball moving

**Implementation Requirements:**
1. Add `pushable: boolean` metadata to toy items
2. Track toy positions in habitatConditions (similar to guinea pig positions)
3. Update play behavior to move pushable toys
4. Add visual animation for toy movement
5. Update toy rendering to use dynamic position

**Files to Modify:**
- [supplies/habitat/toys.json](../src/data/supplies/habitat/toys.json) - Add pushable flag
- [habitatConditions.ts](../src/stores/habitatConditions.ts) - Track toy positions
- [useGuineaPigBehavior.ts](../src/composables/game/useGuineaPigBehavior.ts) - Play behavior with push logic
- Toy rendering components - Use dynamic positioning

**Note:** This is a nice-to-have feature, not critical for Phase 4.5 completion

---

### Adoption System Enhancement üêπ

#### Pre-Bonded Pairs & Solo Guinea Pigs üìã **PLANNED**
**Priority:** HIGH (Future Sprint)
**Status:** üìã Not Started
**Category:** Pet Store & Adoption

**Goal:** Implement adoption constraints for bonded pairs and solo-suitable guinea pigs with enhanced observation system

**Core Rules:**
1. **Bonded Pairs Must Be Adopted Together**
   - Guinea pigs with existing bonds in the pet store must be adopted as a pair
   - User cannot adopt just one of a bonded pair
   - Adoption will be denied until user selects both bonded guinea pigs
   - Error message: "These guinea pigs are bonded and must be adopted together"

2. **Solo Guinea Pig Rules**
   - Some guinea pigs are suited to be solo (marked as `suitableForSolo: true`)
   - Solo-suitable guinea pigs were found as solo rescues (backstory)
   - Non-solo guinea pigs CANNOT be adopted alone
   - User must either adopt a pair or adopt a solo-suitable guinea pig
   - Error message: "This guinea pig needs a companion. Select another guinea pig or choose one suited for solo living"

3. **Adoption Combinations Allowed:**
   - ‚úÖ Bonded pair (both guinea pigs)
   - ‚úÖ Two unbonded guinea pigs (any combination)
   - ‚úÖ One solo-suitable guinea pig
   - ‚ùå One guinea pig from bonded pair
   - ‚ùå One non-solo-suitable guinea pig alone

**Enhanced Observation System:**

**3 Observation Clues per Guinea Pig:**
1. **Social/Bonding Clue** (NEW)
   - Reveals bonding information or solo suitability
   - Examples for bonded pairs: "Seems very attached to [other guinea pig name]", "Always stays close to [other guinea pig name]"
   - Examples for solo-suitable: "Prefers their own space", "Was found living alone and seems content that way"
   - Examples for social but unbonded: "Friendly and would enjoy a companion", "Curious about other guinea pigs"

2. **Personality Clue** (existing)
   - Reveals one personality trait
   - Examples: "Very playful", "Cautious and careful", "Bold explorer"

3. **Preference Clue** (existing)
   - Reveals one food preference
   - Examples: "Seems to enjoy carrots", "Not interested in apples"

**Implementation Tasks:**
- [ ] Add `bondedWith: string | null` field to GuineaPig type
- [ ] Add `suitableForSolo: boolean` field to GuineaPig type
- [ ] Update pet store generation to create bonded pairs (~20% of guinea pigs)
- [ ] Update pet store generation to mark some as solo-suitable (~10%)
- [ ] Add adoption validation logic in petStoreManager
- [ ] Add error messaging for invalid adoption attempts
- [ ] Expand observation system from 2 to 3 clues
- [ ] Add social/bonding clue generation logic
- [ ] Update habitat placement validation to enforce bonded pair rules
- [ ] Add UI indicators for bonded pairs in pet store
- [ ] Update guinea pig cards to show bonding status

**Files to Modify:**
- [guineaPigStore.ts](../src/stores/guineaPigStore.ts) - Add bondedWith and suitableForSolo fields
- [petStoreManager.ts](../src/stores/petStoreManager.ts) - Generation logic and adoption validation
- [observationGenerator.ts](../src/utils/observationGenerator.ts) - Expand to 3 clues
- [GuineaPigCard.vue](../src/components/game/petstore/GuineaPigCard.vue) - Display bonding status
- [PetStoreView.vue](../src/views/PetStoreView.vue) - Adoption validation
- [GuineaPigsView.vue](../src/views/GuineaPigsView.vue) - Habitat placement validation

---

### Testing & Balance üéÆ

#### Gameplay Testing Checklist üìã **PLANNED**
**Priority:** HIGH (Future Sprint)
**Status:** üìã Not Started

**Testing Areas:**

**1. Needs & Wellness System**
- [ ] All 11 needs decay at correct rates
- [ ] Wellness calculation reflects actual need state
- [ ] Personality traits affect decay as documented
- [ ] Habitat conditions affect needs appropriately
- [ ] Need thresholds trigger correct autonomous behaviors

**2. Autonomous Behaviors**
- [ ] All 12 behavior types execute correctly
- [ ] Pathfinding handles all habitat layouts
- [ ] Guinea pigs don't get stuck on items
- [ ] Behavior priorities make sense
- [ ] Personality affects behavior frequency

**3. Food & Consumption**
- [ ] New serving amounts work correctly
- [ ] Food consumption limits enforce properly
- [ ] Food freshness decays at reasonable rate
- [ ] Guinea pigs prefer liked foods
- [ ] Guinea pigs avoid disliked foods

**4. Habitat Conditions**
- [ ] Cleanliness decays at reasonable rate
- [ ] Bedding freshness affects comfort
- [ ] Water level consumption matches drinking
- [ ] Hay freshness per-rack works correctly
- [ ] Poop accumulation affects cleanliness

**5. Social Bonding**
- [ ] Bond levels increase with interactions
- [ ] Bond levels persist across sessions
- [ ] Bond levels affect social need satisfaction
- [ ] Multiple guinea pig pairs track independently

**6. Item Metadata & Realism**
- [ ] All item types have correct metadata
- [ ] Chew durability degrades at reasonable rates
- [ ] Hideaway/shelter items provide security
- [ ] Toys increase play satisfaction
- [ ] Food bowls and hay racks function correctly

---

#### Create Realism Guidelines üìã **PLANNED**
**Priority:** MEDIUM (Future Sprint)
**Status:** üìã Not Started

**Goal:** Document realistic guinea pig care guidelines for game balance

**Topics to Cover:**
1. **Feeding Frequency & Amounts**
   - How often should guinea pigs need food/water?
   - What's a realistic hunger cycle duration?
   - Hay should be unlimited - guinea pigs graze constantly

2. **Sleep Patterns**
   - Guinea pigs sleep in short bursts (5-10 minutes)
   - 4-6 hours total sleep per day
   - More active at dawn/dusk (crepuscular)

3. **Social Behavior**
   - Guinea pigs are highly social - need companionship
   - Bonding takes weeks/months in real life
   - Play behaviors: popcorning, zoomies, following, grooming

4. **Hygiene & Maintenance**
   - Self-grooming is frequent (multiple times per day)
   - Nails grow slowly (~monthly trimming in real life)
   - Poop frequently (100+ times per day!)
   - Clean habitat reduces stress

5. **Habitat Preferences**
   - Need hiding places for security
   - Enjoy tunnels and exploration
   - Sensitive to cleanliness (varies by personality)
   - Temperature and noise sensitivity

**Output:** Create [game-design/guinea-pig-realism-guide.md](../docs/game-design/guinea-pig-realism-guide.md)

---

## üìù **Sprint Completion Criteria**

**Completed This Session (November 2, 2025):**
- [x] Clear Game Data bug fixed (items and guinea pigs clear properly)
- [x] Activity feed auto-scroll fixed (now scrolls to newest messages at top)
- [x] Item tooltips fixed (stay visible when moving to click buttons)
- [x] **Hay system duplication bug fixed (CRITICAL)** - Eliminated infinite resource exploit
- [x] Guinea pig chomp animation when chewing implemented
- [x] Guinea pig wiggle animation during player interactions implemented
- [x] Gentle pet wipe interaction implemented (hygiene boost)
- [x] Guinea pigs in same shelter visual offset (no more stacking)
- [x] Sprint documentation organized and archived

**Must Complete (Next Session):**
- [ ] Investigate hay rack display issue (shows "1/1" instead of "1/4") - may already be fixed

**Should Complete:**
- [ ] Sleeping together bonding bonus implemented
- [ ] Food serving guide created

**Nice to Have:**
- [ ] Testing with 3+ guinea pigs
- [ ] Extended gameplay testing (30+ minutes)
- [ ] All features documented

---

## üöÄ **Commands**

**Development:**
- `npm run dev` - Start development server
- `npm run build` - Production build (run before commits)
- `npm run preview` - Preview production build

**Git:**
- Current branch: `GPS2-42`
- Main branch: `main`

---

## üìö **Documentation Links**

- [Project Plan](PROJECT_PLAN.md)
- [Development Phases](DEVELOPMENT_PHASES.md)
- [System Integration](SYSTEM_INTEGRATION.md)
- [Previous Sprint - October 27, 2025](SPRINT-2025-10-27.md)
