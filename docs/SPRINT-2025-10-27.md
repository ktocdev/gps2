# GPS2 Sprint - October 27, 2025

**Started:** October 27, 2025
**Status:** Phase 4 Complete ‚úÖ - Beginning Phase 4.5 Polish & Testing üîç
**Branch:** GPS2-39
**Previous Sprint:** [SPRINT-2025-10-20.md](archive/SPRINT-2025-10-20.md)

---

## üéâ **Phase 4 Complete!**

### Systems 17-21: Guinea Pig Integration ‚úÖ **ALL COMPLETE**

**Status:** ‚úÖ Completed October 27, 2025
**Implementation Time:** ~5-7 weeks (38-53 hours total)

All Phase 4 systems implemented and tested:
- ‚úÖ **System 17:** Visual Presence & Positioning - GuineaPigSprite with breed-specific emoji, grid positioning, selection state
- ‚úÖ **System 18:** Pathfinding & Movement - A* pathfinding, movement controller, CSS animations
- ‚úÖ **System 19:** Autonomous AI Behaviors - AI decision matrix (10 subsystems), all autonomous actions
- ‚úÖ **System 20:** Direct Interaction System - Manual socialize trigger, dual movement, adjacent positioning
- ‚úÖ **System 21:** Social Bonding System - Bond management, bonding progression (0-100), localStorage serialization

**Key Features:**
- Complete autonomous AI with 12 behavior types (eat, drink, sleep, groom, chew, play, shelter, popcorn, zoomies, hide, watch, poop)
- Personality-driven behavior variations
- Multi-guinea pig support fully tested and stable
- Comprehensive debug tools for testing and observation
- Activity feed integration for all behaviors
- Social bonding between guinea pig pairs

**Documentation:**
- [Phase 4 Guinea Pig Integration Plan](systems/phase4/phase-4-guinea-pig-integration-plan-full.md)
- [System 17: Visual Presence & Positioning](systems/phase4/system-17-visual-presence-positioning.md)
- [System 18: Pathfinding & Movement](systems/phase4/system-18-pathfinding-movement.md)
- [System 19: Autonomous AI Behaviors](systems/phase4/system-19-autonomous-ai-behaviors.md)
- [System 20: Direct Interaction System](systems/phase4/system-20-direct-interaction-system.md)
- [System 21: Social Bonding System](systems/phase4/system-21-social-bonding-system.md)

---

## üîç **Phase 4.5: Polish & Testing**

**Status:** üöß **IN PROGRESS**
**Priority:** HIGH
**Goal:** Manual gameplay testing, balance adjustments, metadata fixes, and UI polish before Phase 5

### Critical Bug Fixes üî•

#### Wellness Calculation Always at 0% ‚úÖ **FIXED**
**Priority:** CRITICAL
**Status:** ‚úÖ Complete

**Issue:** Wellness meter stuck at 0% despite needs being satisfied

**Root Cause:**
- Guinea pig tooltip was reading stored `stats.wellness` value which was never updated
- Stored value always remained 0 from initialization
- FriendshipDebug panel worked correctly because it called `needsController.calculateWellness()`

**Solution:**
- Updated GuineaPigSprite.vue tooltip to calculate wellness dynamically using `needsController.calculateWellness()`
- Removed unused `stats.wellness` property entirely from GuineaPigStats interface
- Updated bondingProgression.ts to calculate wellness dynamically (fixes bonding wellness bonus bug)
- Removed `wellness: 0` initialization from petStoreManager.ts and guineaPigStore.ts

**Files Modified:**
- `src/components/game/habitat/GuineaPigSprite.vue` - Calculate wellness dynamically in tooltip
- `src/utils/bondingProgression.ts` - Calculate wellness for bonding bonus
- `src/stores/guineaPigStore.ts` - Removed wellness from GuineaPigStats interface
- `src/stores/petStoreManager.ts` - Removed wellness initialization

---

### Food System Rebalancing üçé

#### Food Serving Amounts ‚úÖ **COMPLETE**
**Priority:** HIGH
**Status:** ‚úÖ Complete

**Completed:** Updated all fruit and vegetable serving amounts to realistic values

**Updated Serving Amounts:**

**Vegetables:**
- ü•ï Carrots: 4 servings per item ‚úÖ
- ü•í Cucumber: 6 servings per item ‚úÖ
- ü•¨ Zucchini: 6 servings per item ‚úÖ
- üåø Celery: 6 servings per item ‚úÖ
- ü•¶ Broccoli: 4 servings per item ‚úÖ
- üçÖ Cherry Tomato: 1 serving per item ‚úÖ

**Fruits:**
- üçé Apple: 4 servings per item ‚úÖ
- üçì Strawberry: 1 serving per item ‚úÖ
- ü´ê Blueberry: 1 serving per item ‚úÖ
- üçå Banana: 4 servings per item ‚úÖ
- üçâ Melon: 6 servings per item ‚úÖ
- üçä Orange: 4 servings per item ‚úÖ
- üçê Pear: 4 servings per item ‚úÖ

**Files Modified:**
- `src/data/supplies/food/vegetables.json` - Updated all vegetable servings
- `src/data/supplies/food/fruits.json` - Updated all fruit servings

---

#### Pellets Visual System ‚úÖ **COMPLETE**
**Priority:** MEDIUM
**Status:** ‚úÖ Complete

**Goal:** Improve pellets visual display in food bowl to show realistic scattered pile instead of single emoji

**Implementation:**
- Created dedicated `PelletsVisual.vue` component that renders 5 individual pellet emojis
- Each pellet positioned randomly with rotation to create natural scattered pile effect
- Pellets detect by checking if `itemId` includes 'pellets'
- Standard pellets use üå∞ emoji, fortified pellets use ‚ú® emoji
- All pellet types remain as bags with 10 servings

**Visual Details:**
- Pellet size: 0.75rem (larger and more visible)
- 5 pellets positioned in scattered cluster formation
- Each pellet has unique transform (position + rotation) for natural look
- HTML/CSS positioning instead of emoji string concatenation

**Files Created:**
- `src/components/game/habitat/PelletsVisual.vue` - New pellets display component

**Files Modified:**
- `src/components/game/habitat/FoodBowl.vue` - Integrated PelletsVisual component
- `src/data/supplies/food/pellets.json` - Simplified emoji to single character (üå∞ or ‚ú®)

---

#### Food Activity Messages ‚úÖ **COMPLETE**
**Priority:** MEDIUM
**Status:** ‚úÖ Complete

**Goal:** Update activity messages to use "piece" format for fruits and vegetables

**New Message Format:**
- **All fruits and vegetables:** "[Guinea pig name] ate a [food] piece"
  - Example: "Cinnamon ate a carrot piece"
  - Example: "Hazel ate a banana piece"
  - Example: "Butterscotch ate an apple piece"
  - Example: "Peanut ate a blueberry piece"
  - Example: "Mocha ate an orange piece"
- **Pellets and hay:** Use cleaned name without "(Bag)" suffix
  - Example: "Rocket munches on Standard Pellets"
  - Example: "Cinnamon munches on Botanical Hay"

**Implementation:**
- Added helper function `getArticle()` to determine a/an based on first letter
- Added helper function `formatFoodForPiece()` to format food names as "a [food] piece"
- Added helper function `cleanFoodName()` to remove "(Bag)" suffix from pellets/hay
- Updated detection logic to use `includes('pellet')` and `includes('hay')` for substring matching
- Updated `generateFeedMessage()` to use piece format for fruits/vegetables (not pellets/hay)
- Updated `generateAutonomousEatMessage()` for autonomous eating behavior
- Applied to favorite, disliked, and neutral food messages consistently

**Examples:**
- Neutral: "Butterscotch ate an apple piece"
- Favorite: "Cinnamon devours a carrot piece with enthusiasm!"
- Disliked: "Hazel accepts a cucumber piece without much enthusiasm"
- Pellets: "Rocket munches on Standard Pellets"

**Files Modified:**
- `src/utils/messageGenerator.ts` - Updated food consumption message generation

---

#### Poop Activity Messages ‚úÖ **COMPLETE**
**Priority:** LOW
**Status:** ‚úÖ Complete

**Goal:** Fix awkward poop messages and add contextual location detection

**Previous Bad Messages:**
- "Cinnamon left poop near the floor"
- "Hazel left poop near the hideaway"
- "Maple drops a poop near the floor"

**New Message Format:**
- Smart location detection for meaningful context
- Only shows location when near important items
- All messages end with proper period punctuation

**New Messages:**
- **With meaningful location:** "[Guinea pig name] pooped near the food bowl."
- **With meaningful location:** "[Guinea pig name] left a poop near the water bottle."
- **With meaningful location:** "[Guinea pig name] made a little mess near the shelter."
- **Without location:** "[Guinea pig name] left a poop."
- **Without location:** "[Guinea pig name] pooped."
- **Without location:** "[Guinea pig name] contributed to habitat maintenance."

**Implementation:**

**Smart Location Detection:**
- Checks items within 1 grid cell (Manhattan distance) of guinea pig position
- Only reports meaningful locations: water bottle, food bowl, shelter, hideaway, hideout, igloo, bottle, bowl
- Ignores non-meaningful locations like "floor" or "habitat"
- Uses first matching meaningful item found

**Coordinate System Fixes:**
- **Critical fix:** Corrected position coordinate system throughout codebase
- All positions use `{x, y}` format where `x = col` and `y = row`
- Fixed autonomous pooping location detection in `useGuineaPigBehavior.ts`
- Fixed Force Poop debug button in `PoopDebug.vue`
- Fixed distance calculations that were returning NaN

**Position Conversion Pattern:**
```typescript
// Guinea pig position uses {x, y} where x=col, y=row
const currentPos = { row: position.y, col: position.x }

// Item position also uses {x, y} format
const itemRow = itemPos.y
const itemCol = itemPos.x

// Manhattan distance calculation
const distance = Math.abs(itemRow - currentPos.row) + Math.abs(itemCol - currentPos.col)
```

**Poop Placement:**
- Converts grid position to subgrid (4x scale) for finer placement
- Adds random offset within grid cell for natural scattering
- Both autonomous and Force Poop button now work correctly

**Files Modified:**
- `src/utils/messageGenerator.ts` - Updated poop message templates with location filtering
- `src/composables/game/useGuineaPigBehavior.ts` - Smart location detection, coordinate fixes
- `src/components/debug/environment/PoopDebug.vue` - Force Poop button coordinate fixes

**Bug Fixes:**
- ‚úÖ Fixed Force Poop dropping in bottom right corner (position.row/col ‚Üí position.y/x)
- ‚úÖ Fixed NaN distance calculations (itemPos.row/col ‚Üí itemPos.y/x)
- ‚úÖ Fixed location detection not triggering (coordinate system confusion)
- ‚úÖ Added proper period punctuation to all poop messages

---

### UI/UX Improvements üé®

#### Auto-Select Guinea Pig in Debug Panels üìã **Planned**
**Priority:** MEDIUM
**Status:** üìã Not Started

**Goal:** Clicking a guinea pig sprite should automatically switch Autonomy Controls and Needs Panel to that guinea pig

**Current Behavior:**
- Clicking guinea pig shows selection ring
- Must manually toggle between guinea pigs in debug panels
- No connection between sprite selection and panel focus

**New Behavior:**
- Clicking guinea pig sprite selects it (existing)
- Automatically switches Autonomy Controls panel to that guinea pig
- Automatically switches Needs Panel to that guinea pig
- Visual feedback showing which guinea pig is selected in panels

**Implementation:**
- Listen for guinea pig selection change in HabitatVisual
- Update `selectedGuineaPigIndex` in both AutonomyDebug and NeedsPanel
- Emit event or use shared state for selection sync

**Files to Modify:**
- `src/components/game/habitat/HabitatVisual.vue` - Emit selection event
- `src/components/debug/environment/AutonomyDebug.vue` - Listen for selection
- `src/components/debug/environment/NeedsPanel.vue` - Listen for selection
- Consider creating shared selection state in behaviorStateStore

---

#### Social Bonding Empty State üìã **Planned**
**Priority:** LOW
**Status:** üìã Not Started

**Issue:** Social Bonding page shows empty/broken UI when no game session active

**Goal:** Display helpful message when no guinea pigs in game

**Message:**
```
No guinea pigs in game

Start a game session from the Guinea Pigs page to see social bonding data.
```

**Files to Modify:**
- `src/components/debug/gameplay/FriendshipDebug.vue` - Add empty state check

---

### Manual Testing & Balance üéÆ

#### Gameplay Testing Checklist üìã **Planned**
**Priority:** HIGH
**Status:** üìã Not Started

**Testing Areas:**

**1. Needs & Wellness System**
- [ ] All 11 needs decay at correct rates
- [ ] Wellness calculation reflects actual need state
- [ ] Personality traits affect decay as documented
- [ ] Habitat conditions affect needs appropriately
- [ ] Need thresholds trigger correct autonomous behaviors

**2. Autonomous Behaviors**
- [ ] All 12 behavior types execute correctly
- [ ] Pathfinding handles all habitat layouts
- [ ] Guinea pigs don't get stuck on items
- [ ] Behavior priorities make sense (urgent needs override low needs)
- [ ] Personality affects behavior frequency and effectiveness

**3. Food & Consumption**
- [ ] New serving amounts work correctly
- [ ] Food consumption limits enforce properly
- [ ] Food freshness decays at reasonable rate
- [ ] Guinea pigs prefer liked foods over neutral
- [ ] Guinea pigs avoid disliked foods

**4. Habitat Conditions**
- [ ] Cleanliness decays at reasonable rate
- [ ] Bedding freshness affects comfort appropriately
- [ ] Water level consumption matches guinea pig drinking
- [ ] Hay freshness per-rack works correctly
- [ ] Poop accumulation affects cleanliness

**5. Social Bonding**
- [ ] Bond levels increase with socialize interactions
- [ ] Bond levels persist across sessions
- [ ] Bond levels affect social need satisfaction
- [ ] Multiple guinea pig pairs track independently

**6. Item Metadata & Realism**
- [ ] All item types have correct metadata
- [ ] Chew durability degrades at reasonable rates
- [ ] Hideaway/shelter items provide security
- [ ] Toys increase play satisfaction
- [ ] Food bowls and hay racks function correctly

---

### Realism & Balance Rules üìê

#### Create Realism Guidelines üìã **Planned**
**Priority:** MEDIUM
**Status:** üìã Not Started

**Goal:** Document realistic guinea pig care guidelines for game balance

**Topics to Cover:**
1. **Feeding Frequency & Amounts**
   - How often should guinea pigs need food/water?
   - What's a realistic hunger cycle duration?
   - Hay should be unlimited - guinea pigs graze constantly

2. **Sleep Patterns**
   - Guinea pigs sleep in short bursts (5-10 minutes)
   - 4-6 hours total sleep per day
   - More active at dawn/dusk (crepuscular)

3. **Social Behavior**
   - Guinea pigs are highly social - need companionship
   - Bonding takes weeks/months in real life
   - Play behaviors: popcorning, zoomies, following, grooming

4. **Hygiene & Maintenance**
   - Self-grooming is frequent (multiple times per day)
   - Nails grow slowly (~monthly trimming in real life)
   - Poop frequently (100+ times per day!)
   - Clean habitat reduces stress

5. **Habitat Preferences**
   - Need hiding places for security
   - Enjoy tunnels and exploration
   - Sensitive to cleanliness (varies by personality)
   - Temperature and noise sensitivity

**Output:** Create [game-design/guinea-pig-realism-guide.md](game-design/guinea-pig-realism-guide.md)

---

### Adoption System Enhancement üêπ

#### Pre-Bonded Pairs & Solo Guinea Pigs üìã **Planned**
**Priority:** HIGH
**Status:** üìã Not Started

**Goal:** Implement adoption constraints for bonded pairs and solo-suitable guinea pigs with enhanced observation system

**Core Rules:**
1. **Bonded Pairs Must Be Adopted Together**
   - Guinea pigs with existing bonds in the pet store must be adopted as a pair
   - User cannot adopt just one of a bonded pair
   - Adoption will be denied until user selects both bonded guinea pigs
   - Error message: "These guinea pigs are bonded and must be adopted together"

2. **Solo Guinea Pig Rules**
   - Some guinea pigs are suited to be solo (marked as `suitableForSolo: true`)
   - Solo-suitable guinea pigs were found as solo rescues (backstory)
   - Non-solo guinea pigs CANNOT be adopted alone
   - User must either adopt a pair or adopt a solo-suitable guinea pig
   - Error message: "This guinea pig needs a companion. Select another guinea pig or choose one suited for solo living"

3. **Adoption Combinations Allowed:**
   - ‚úÖ Bonded pair (both guinea pigs)
   - ‚úÖ Two unbonded guinea pigs (any combination)
   - ‚úÖ One solo-suitable guinea pig
   - ‚ùå One guinea pig from bonded pair
   - ‚ùå One non-solo-suitable guinea pig alone

**Enhanced Observation System:**

**3 Observation Clues per Guinea Pig:**
1. **Social/Bonding Clue** (NEW)
   - Reveals bonding information or solo suitability
   - Examples for bonded pairs:
     - "Seems very attached to [other guinea pig name]"
     - "Always stays close to [other guinea pig name]"
     - "Grooms [other guinea pig name] frequently"
   - Examples for solo-suitable:
     - "Prefers their own space"
     - "Was found living alone and seems content that way"
     - "Independent personality, doesn't seek companionship"
   - Examples for social but unbonded:
     - "Friendly and would enjoy a companion"
     - "Curious about other guinea pigs"
     - "Would do well with a friend"

2. **Personality Clue** (existing)
   - Reveals one personality trait
   - Examples: "Very playful", "Cautious and careful", "Bold explorer"

3. **Preference Clue** (existing)
   - Reveals one food preference
   - Examples: "Seems to enjoy carrots", "Not interested in apples"

**Habitat Constraints:**
- Bonded pairs can only be placed in habitat together (both or neither)
- Cannot mix bonded pairs in same habitat (e.g., can't have 4 guinea pigs if they're 2 separate bonded pairs)
- Unbonded guinea pigs can be mixed freely (existing behavior)

**Future Enhancement (noted for Phase 5+):**
- Allow multiple bonded pairs in same habitat (4+ guinea pigs)
- Complex social dynamics between multiple pairs
- Larger habitat sizes to accommodate more guinea pigs

**Implementation Tasks:**
- [ ] Add `bondedWith: string | null` field to GuineaPig type (stores partner's ID)
- [ ] Add `suitableForSolo: boolean` field to GuineaPig type
- [ ] Update pet store generation to create some bonded pairs (~20% of guinea pigs)
- [ ] Update pet store generation to mark some guinea pigs as solo-suitable (~10%)
- [ ] Add adoption validation logic in petStoreManager
- [ ] Add error messaging for invalid adoption attempts
- [ ] Expand observation system from 2 to 3 clues
- [ ] Add social/bonding clue generation logic
- [ ] Update habitat placement validation to enforce bonded pair rules
- [ ] Add UI indicators for bonded pairs in pet store (visual link or badge)
- [ ] Update guinea pig cards to show "Bonded with [name]" or "Suitable for solo living"

**Files to Modify:**
- `src/stores/guineaPigStore.ts` - Add bondedWith and suitableForSolo fields
- `src/stores/petStoreManager.ts` - Generation logic and adoption validation
- `src/utils/observationGenerator.ts` - Expand to 3 clues, add social clue logic
- `src/components/game/petstore/GuineaPigCard.vue` - Display bonding status
- `src/views/PetStoreView.vue` - Adoption validation and error messaging
- `src/views/GuineaPigsView.vue` - Habitat placement validation

**Testing:**
- [ ] Generate pet store with bonded pairs visible
- [ ] Attempt to adopt one of bonded pair (should fail)
- [ ] Adopt full bonded pair (should succeed)
- [ ] Attempt to adopt non-solo guinea pig alone (should fail)
- [ ] Adopt solo-suitable guinea pig alone (should succeed)
- [ ] Verify observation system shows all 3 clues
- [ ] Verify bonded pairs cannot be separated in habitat

---

## üéØ **High Priority Improvements**

### Bonding Debug UI Cleanup üî•
**Priority:** HIGH
**Status:** üìã Not Started

**Goal:** Clean up Social Bonding debug interface and test system thoroughly

**Tasks:**
- [ ] Review FriendshipDebug.vue layout and styling
- [ ] Add empty state message when no game session
- [ ] Test bond level increases with socialize interactions
- [ ] Verify bond data persists across page reloads
- [ ] Test with multiple guinea pig pairs (3+ guinea pigs)
- [ ] Add bond level visualization (progress bar or meter)
- [ ] Ensure bond levels display correctly in guinea pig tooltips

**Files to Modify:**
- `src/components/debug/gameplay/FriendshipDebug.vue` - UI cleanup
- `src/stores/guineaPigStore.ts` - Bond data verification

---

## üìù **Phase 4.5 Completion Criteria**

Before moving to Phase 5, the following must be complete:

**Critical Fixes:**
- ‚úÖ All Phase 4 systems tested and stable
- ‚úÖ Wellness calculation working correctly (not stuck at 0%)
- ‚úÖ Food serving amounts realistic and balanced
- ‚úÖ Activity messages grammatically correct
- ‚úÖ Poop location detection and placement fixed

**Polish & UX:**
- [ ] Auto-select guinea pig in debug panels
- [ ] Social bonding empty state message
- [ ] All debug panels tested with 1, 2, and 3+ guinea pigs
- [ ] No console errors during normal gameplay

**Testing & Balance:**
- [ ] Manual gameplay testing checklist complete
- [ ] All autonomous behaviors working as expected
- [ ] Realism guidelines documented
- [ ] Game balance feels good for 10-15 minute play sessions

**Documentation:**
- [ ] Phase 4.5 changes documented
- [ ] Realism guide created
- [ ] Any new systems or changes added to DEVELOPMENT_PHASES.md

---

## üöÄ **Next: Phase 5 (Polish & Enhancements)**

**Phase 5 Systems (22-29):**
- System 22: Interaction Enhancement System
- System 23: Enrichment & Resource Management System
- System 24: Progression & Economy System
- System 25: Game Tutorial System
- System 26: Performance Mode System
- System 27: Sound System
- System 28: Settings Preferences Enhancement
- System 29: Guinea Pig Animation System

**See:** [DEVELOPMENT_PHASES.md - Phase 5](DEVELOPMENT_PHASES.md#phase-5-polish--enhancements-systems-22-29)

---

## üéÆ **Testing Checklist**

### Phase 4 Verification
- [x] All 5 systems (17-21) implemented
- [x] Guinea pig sprites render correctly
- [x] Pathfinding works with all item types
- [x] Autonomous behaviors execute reliably
- [x] Social bonding progresses with interactions
- [x] Multi-guinea pig support tested

### Phase 4.5 Testing
- [x] Wellness calculation shows correct values
- [x] Food serving amounts match specification
- [x] Activity messages use correct grammar
- [x] Pellets display as scattered pile in food bowl
- [x] Poop location detection working correctly
- [x] Force Poop debug button working correctly
- [ ] Guinea pig selection syncs with debug panels
- [ ] Social bonding page shows empty state
- [ ] All realism rules implemented and balanced

---

## üöÄ **Commands**

**Development:**
- `npm run dev` - Start development server
- `npm run build` - Production build (run before commits)
- `npm run preview` - Preview production build

**Git:**
- Current branch: `GPS2-39`
- Main branch: `main`

---

## üìö **Documentation Links**

- [Project Plan](PROJECT_PLAN.md)
- [Development Phases](DEVELOPMENT_PHASES.md)
- [System Integration](SYSTEM_INTEGRATION.md)
- [Phase 4 Systems](systems/phase4/)
- [Phase 5 Systems](systems/phase5/)
- [Previous Sprint](archive/SPRINT-2025-10-20.md)
