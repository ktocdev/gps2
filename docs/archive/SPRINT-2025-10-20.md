# GPS2 Sprint - October 20, 2025

**Started:** October 20, 2025
**Status:** Phase 3 Complete ✅ - Beginning Phase 4 🚀
**Branch:** GPS2-33
**Previous Sprint:** [TODO-2025-10-13.md](archive/TODO-2025-10-13.md)

---

## 🎉 **Phase 3 Complete!**

### System 16: Autonomy Preparation ✅ **ALL 5 PHASES COMPLETE**

**Status:** ✅ Completed October 20, 2025
**Implementation Time:** ~6 hours (faster than 8-13 hour estimate)

All autonomy foundation systems implemented and tested:
- ✅ **Phase 1:** Item Type Metadata - itemType, needSatisfied, satisfactionAmount
- ✅ **Phase 2:** Water Consumption - consumeWater, hasWaterAvailable, getWaterBottlePosition
- ✅ **Phase 3:** Environmental Decay - Time-based bedding/cleanliness decay with quality modifiers
- ✅ **Phase 4:** Guinea Pig Position Tracking - Grid positioning with collision detection
- ✅ **Phase 5:** Item Usage History - Effectiveness tracking with rotation mechanics

**Key Features:**
- Constants centralized in [supplies.ts](../src/constants/supplies.ts#L75-L94)
- All decay rates tunable and well-documented
- Position tracking with Map-based storage
- Item effectiveness decay encourages strategic rotation
- Hourly recovery system for unused items
- Full persistence across page reloads

**Files Modified:**
- `src/constants/supplies.ts` - Added DECAY constants
- `src/stores/habitatConditions.ts` - Added all 5 phase systems
- `src/stores/gameTimingStore.ts` - Integrated decay and recovery
- `src/stores/guineaPigStore.ts` - Position initialization on activation

**Documentation:** [System 16: Autonomy Preparation](systems/phase3/system-16-autonomy-preparation.md)

---

## 🎨 **Habitat Debug Cleanup** ✅ **COMPLETE**

**Status:** ✅ Completed October 20, 2025
**Goal:** Improve decay system UX and container drag behavior

### Decay Speed Control System

**Added configurable decay speed multiplier for testing and game balance:**
- ✅ **Speed Presets** - Realistic (1x), Relaxed (6x), Normal (12x), Fast (24x), Debug (60x)
- ✅ **Default: 12x (Normal)** - Balanced for 10-15 minute casual play sessions
- ✅ **Slider Control** - Range 1-60x with preset buttons in HabitatDebug panel
- ✅ **Applied to all decay** - Bedding, cleanliness, and hay freshness

**Decay Timeline at Normal Speed (12x):**
| Item | 1% Loss | Full Decay (100% → 0%) |
|------|---------|------------------------|
| **Hay** | 15 sec | 25 minutes |
| **Bedding** | 25 sec | 42 minutes |
| **Cleanliness** | 50 sec | 83 minutes |

**In a 10-minute session:** Hay drops ~40%, Bedding ~24%, Cleanliness ~12%

### Per-Rack Hay Freshness Tracking

**Implemented individual freshness tracking for each hay rack:**
- ✅ **HayRackData structure** - Each rack tracks servings, freshness (0-100%), and last decay update
- ✅ **Independent decay** - Each hay rack decays separately based on time
- ✅ **Freshness in tooltips** - Hover shows "Freshness: 87%" for each rack
- ✅ **Faster decay rate** - Hay decays at 1 point per 3 minutes (faster than bedding - hay oxidizes quickly!)
- ✅ **Persistence** - Freshness saved per rack across page reloads

### Container Drag Improvements

**Removed drag locks and improved UX for bowls and hay racks:**
- ✅ **Always draggable** - Bowls and hay racks can be moved even when containing food/hay
- ✅ **Content stays put** - Food/hay items cannot be dragged out of containers (pointer-events: none)
- ✅ **Rich tooltips** - Show helpful metadata instead of lock error messages:
  - Empty: "Empty bowl / Capacity: 3 servings"
  - With contents: "Contents: Carrot, Apple / Capacity: 2/3"
  - Hay racks: "Hay servings: 3/4 / Freshness: 87%"
- ✅ **Removed visual locks** - No more dashed borders or "not-allowed" cursors
- ✅ **Help cursor** - Standard grab/grabbing cursor for all items

**Files Modified:**
- `src/constants/supplies.ts` - Added DECAY.SPEED_PRESETS and HAY_BASE_DECAY_PER_SECOND
- `src/stores/habitatConditions.ts` - Added decaySpeedMultiplier, setDecaySpeed(), per-rack hay decay
- `src/composables/useHabitatContainers.ts` - Restructured hay racks to track freshness per rack
- `src/components/debug/environment/HabitatDebug.vue` - Added decay speed slider with presets
- `src/components/game/habitat/HayRack.vue` - Added freshness prop and tooltip, fixed pointer-events
- `src/components/game/habitat/FoodBowl.vue` - Fixed pointer-events on food items
- `src/components/game/habitat/HabitatVisual.vue` - Removed drag locks, improved tooltips

---

## 🧪 **Food & Hay Freshness System** ✅ **COMPLETE**

**Status:** ✅ Completed October 20, 2025
**Goal:** Implement per-item food freshness tracking with decay and visual feedback

### Food Bowl Freshness Tracking

**Implemented individual freshness tracking for each food item:**
- ✅ **FoodItem interface updated** - Added `freshness: number` (0-100%) and `addedAt: number` timestamp
- ✅ **Independent decay** - Each food item decays separately at 1 point per 4 minutes
- ✅ **Food Containers panel** - Debug panel showing all food bowls with freshness sliders
- ✅ **Grouped by bowl** - Food items displayed per bowl in responsive grid
- ✅ **Individual sliders** - Each food item has its own freshness control
- ✅ **Color-coded freshness** - Green (≥80%), yellow (≥40%), red (<40%)
- ✅ **Remove stale food** - Popover shows remove button for each food item (red for <40% fresh)
- ✅ **Reactivity fixes** - Singleton pattern in useHabitatContainers for proper Vue reactivity
- ✅ **Overall condition integration** - Food and hay freshness now factor into habitat overall condition

### Hay Rack Enhancements

**Improved hay rack UI and functionality:**
- ✅ **Hay Racks panel** - Moved freshness sliders from popover to dedicated debug panel
- ✅ **Empty rack handling** - Slider disabled when rack is empty (0 servings)
- ✅ **Always-visible popover** - Popover shows at all times (not just when hay present)
- ✅ **Empty Hay Rack button** - Always available in popover (warning variant when stale)
- ✅ **Freshness thresholds** - Button shows "Clear Stale Hay" (warning) when <40%, "Empty Hay Rack" (default) otherwise

### Habitat Care Sidebar System

**Created dedicated sidebar for care actions:**
- ✅ **HabitatCareSidebar component** - New sidebar with all care and test actions
- ✅ **Sidebar toggle** - Switch between 🎒 Inventory and 🧹 Care Actions in Habitat Visual panel
- ✅ **Organized sections:**
  - Core Care: Clean Cage, Refill Water, Refresh Bedding
  - Bedding Type: Bedding selector dropdown
  - Containers: Clear All Bowls, Clear All Hay Racks
  - Test Actions: Add/Clear Poop, Clear Water, Test Water Consumption
- ✅ **Cleaner layout** - Removed action buttons from Core Conditions panel items
- ✅ **Decay Speed panel** - Compact dedicated panel with multiplier slider and presets

### Overall Condition Calculation

**Updated to include all freshness factors:**
- Previously: `(cleanliness + bedding + hayFreshness + water) / 4`
- Now: `(cleanliness + bedding + water + avgHayRackFreshness + avgFoodFreshness) / 5`
- Calculates average freshness across all hay racks
- Calculates average freshness across all food items in all bowls

### Layout Improvements

**Reorganized Habitat Conditions panel:**
- ✅ **Proper sectioning** - Core Conditions, Hay Racks, and Food Containers in separate `.conditions-section` divs
- ✅ **Visual dividers** - `<hr class="divider" />` between each section
- ✅ **Better hierarchy** - h4 for section titles (Core Conditions, Hay Racks, Food Containers), h5 for bowl names
- ✅ **Larger fonts** - Section titles increased to `--font-size-xl` (20px), bowl names to `--font-size-lg` (18px) for Gaegu readability
- ✅ **Responsive grids** - Food bowls in auto-fill grid (280px min), hay racks in auto-fill grid (240px min)
- ✅ **Compact spacing** - Reduced padding and gaps throughout for better space usage

### Technical Improvements

**Singleton pattern fix:**
- ✅ **Root cause** - useHabitatContainers was creating new refs each call, breaking reactivity
- ✅ **Solution** - Moved `bowlContents` and `hayRackContents` refs outside function for true singleton
- ✅ **Vue reactivity** - Always create new Map instances to trigger reactivity (not just Map.set)
- ✅ **Pattern applied** - Consistent across setFoodFreshness, applyFoodBowlDecay, setHayRackFreshness, applyHayRackDecay

**Files Modified:**
- `src/composables/useHabitatContainers.ts` - Added food freshness tracking, singleton pattern fix
- `src/constants/supplies.ts` - Added FOOD_BASE_DECAY_PER_SECOND constant
- `src/stores/habitatConditions.ts` - Integrated food decay, updated overall condition calculation
- `src/components/game/habitat/FoodBowl.vue` - Added popover with food items, freshness display, remove buttons
- `src/components/game/habitat/HayRack.vue` - Always show popover, dynamic empty button
- `src/components/game/habitat/HabitatVisual.vue` - Added remove food handler
- `src/components/game/habitat/HabitatCareSidebar.vue` - **NEW** - Care actions sidebar component
- `src/components/debug/environment/HabitatDebug.vue` - Added Food Containers panel, sidebar toggle, layout improvements

---

## 🦷 **Chew Item Degradation System** ✅ **COMPLETE**

**Status:** ✅ Completed October 21, 2025
**Priority:** MEDIUM
**Goal:** Implement per-item chew degradation tracking with visual feedback and discard mechanics

### Concept

**Chews are consumable items that guinea pigs wear down through use:**
- Chews degrade from 100% (fresh) to 0% (too worn/unsafe to use)
- Each guinea pig chew interaction reduces the chew's durability
- Unlike food/hay freshness (time-based decay), chews degrade through usage only
- Chews are individual habitat items, **NOT** tied to overall habitat condition
- When too degraded (<20%), chews should be discarded for safety

### Requirements ✅ **All Complete**

**Chew Item Tracking:**
- ✅ Add `durability: number` (0-100%) field to chew items
- ✅ Track `usageCount: number` - how many times it's been chewed
- ✅ Track `lastUsedAt: number` timestamp for last chew interaction
- ✅ Degradation rate varies by chew type (willow sticks wear faster than mineral chews)

**Chews Panel in Habitat Conditions:**
- ✅ Add "Chews" section to Habitat Conditions panel (after Food Containers)
- ✅ Display all placed chew items with durability sliders
- ✅ Grid layout similar to Hay Racks and Food Containers
- ✅ Show: Chew emoji, name, durability %, usage count
- ✅ **Important:** This panel is for monitoring only, NOT a habitat condition metric

**Chew Item Popover:**
- ✅ Always show popover when hovering over chew items (similar to hay racks)
- ✅ Display metadata: Durability %, Usage count, Last used time
- ✅ "Remove Chew" button - always visible (default variant, removes from habitat, returns to inventory at current durability)
- ✅ "Discard Used Chew" button - only shows when durability < 20% (danger variant, removes permanently)

**Degradation System:**
- ✅ Each chew interaction reduces durability by configured amount
- ✅ **Willow sticks:** Fast degradation (12% per use, ~8 uses until unsafe)
- ✅ **Apple wood:** Medium degradation (8% per use, ~12 uses until unsafe)
- ✅ **Mineral chews:** Slow degradation (4% per use, ~25 uses until unsafe)
- ✅ Visual feedback: Emoji opacity/filter changes as durability decreases

**Safety Thresholds:**
- ✅ **Fresh (80-100%):** Green indicator, optimal condition
- ✅ **Worn (40-79%):** Muted indicator, still usable
- ✅ **Degraded (20-39%):** Warning indicator, should replace soon
- ✅ **Unsafe (<20%):** Danger indicator, must discard (safety hazard - splinters, sharp edges) - **Negatively impacts habitat condition**

### Implementation Notes

**Why chews are different from food/hay:**
- **Food/hay:** Decay over time (oxidation, spoilage) - time-based
- **Chews:** Degrade through interaction (physical wear) - usage-based
- **Food/hay:** Tied to habitat condition (affects overall wellness)
- **Chews:** Unsafe chews (<20% durability) negatively impact habitat condition due to safety hazards (splinters, sharp edges)

**Habitat Condition Impact:**
- Chews with durability ≥20% have no impact on habitat condition (normal enrichment items)
- Chews with durability <20% apply a small penalty to overall habitat condition
- This represents the safety hazard of damaged chews that could injure guinea pigs
- Players should replace or discard unsafe chews to maintain habitat condition

**Integration with Phase 4 Autonomy:**
- Guinea pigs will autonomously select chews when "chew" need is high
- Each chew interaction triggers durability reduction
- Guinea pigs won't use chews below 20% durability (AI should select fresh ones)
- Multiple chews in habitat = variety and rotation (prevents over-wearing one item)

### Data Structure

```typescript
// In useHabitatContainers.ts
interface ChewData {
  durability: number        // 0-100%, physical condition
  usageCount: number        // Times chewed
  lastUsedAt: number        // Timestamp
  degradationRate: number   // Per-use degradation % (varies by chew type)
}

const chewItems = ref<Map<string, ChewData>>(new Map())
```

### Constants

```typescript
// In supplies.ts - CHEW_DEGRADATION
export const CHEW_DEGRADATION = {
  // Degradation rates by chew type
  WILLOW_STICK: 12,      // 12% per use (~8 uses until unsafe)
  APPLE_WOOD: 8,         // 8% per use (~12 uses until unsafe)
  MINERAL_CHEW: 4,       // 4% per use (~25 uses until unsafe)

  // Safety thresholds
  UNSAFE_THRESHOLD: 20,   // Below this = must discard (safety hazard)
  DEGRADED_THRESHOLD: 40, // Below this = degraded condition
  WORN_THRESHOLD: 80,     // Below this = worn condition

  // Habitat condition impact
  UNSAFE_HABITAT_PENALTY: 5, // Penalty applied per unsafe chew to habitat condition
}
```

### Implementation Summary ✅

**Files Created:**
- ✅ `src/components/game/habitat/ChewItem.vue` - Chew item component with popover and durability display (113 lines)

**Files Modified:**
- ✅ `src/composables/useHabitatContainers.ts` - Added ChewData interface, chew tracking Map, 7 chew management functions
- ✅ `src/constants/supplies.ts` - Added CHEW_DEGRADATION constants (degradation rates, thresholds, habitat penalty)
- ✅ `src/components/debug/environment/HabitatDebug.vue` - Added Chews section to Habitat Conditions panel with durability sliders
- ✅ `src/components/game/habitat/HabitatVisual.vue` - Integrated ChewItem component, added chew interaction handlers (test, remove, discard)
- ✅ `src/stores/habitatConditions.ts` - Updated overall condition calculation to apply unsafe chew penalty (5 points per unsafe chew)

**Key Features Implemented:**
- ✅ **Usage-based degradation** - Chews degrade when used, not over time
- ✅ **Type-specific rates** - Willow (12%), Apple (8%), Mineral (4%) per use
- ✅ **Safety enforcement** - Cannot use chews below 20% durability
- ✅ **Habitat impact** - Unsafe chews (<20%) reduce overall condition by 5 points each
- ✅ **Visual feedback** - Opacity and filter effects based on durability state
- ✅ **Persistence** - Chew data serialized/deserialized with habitat state
- ✅ **Initialization** - Chews auto-initialize when placed in habitat

**Patterns Used:**
- ✅ Singleton pattern for chewItems Map (consistent with bowlContents/hayRackContents)
- ✅ Vue reactivity with new Map instances (not just Map.set)
- ✅ Type-safe TypeScript with explicit number type for degradation rates

---

## 🐛 **Phase 4 Bug Fixes & Stability** ✅ **COMPLETE**

**Status:** ✅ Completed October 22, 2025
**Priority:** CRITICAL
**Goal:** Fix critical bugs discovered during autonomous AI integration testing

### Issues Fixed

**1. Guinea Pig Position Initialization** ✅
- **Issue:** Guinea pigs stuck at (0,0) when enabling autonomous AI
- **Root Cause:** `getGuineaPigPosition()` returned default {row: 0, col: 0} when position not found
- **Fix:** Auto-initialize positions on first access via `initializeGuineaPigPosition()`
- **File:** [HabitatVisual.vue:245](../src/components/game/habitat/HabitatVisual.vue#L245)

**2. Guinea Pig Movement System** ✅
- **Issue:** Guinea pigs positioned randomly but not moving, AI stuck on cooldown
- **Root Cause 1:** Game loop interval too slow (5000ms)
- **Fix 1:** Reduced `intervalMs` from 5000ms to 1000ms for responsive AI
- **Root Cause 2:** `useGuineaPigBehavior()` recreated every tick, resetting cooldown
- **Fix 2:** Cached behavior composables in Map to maintain state across ticks
- **File:** [gameTimingStore.ts:18](../src/stores/gameTimingStore.ts#L18)

**3. Poop Coordinate System** ✅
- **Issue:** Poop appearing at wrong location (top-left instead of near guinea pig)
- **Root Cause:** Main grid (14×10) vs subgrid (56×40) coordinate mismatch
- **Fix:** Convert grid coordinates to subgrid: `col * 4 + random(0-3)`
- **File:** [useGuineaPigBehavior.ts:692](../src/composables/game/useGuineaPigBehavior.ts#L692)

**4. Habitat Items Persistence Failure** ✅ **CRITICAL**
- **Issue:** Habitat items disappeared on browser refresh, guinea pigs remained
- **Root Cause:** Chew item serialization breaking Pinia persistence
  - Original serializer used `...state` spread (worked correctly)
  - Chew system added `chewItems: serializeMap(state.chewItems)` to serializer
  - `chewItems` from `useHabitatContainers()` composable included functions
  - Functions can't serialize to JSON, breaking entire persistence silently
- **Fix:** Removed `chewItems` from custom serializer, reverted to working pattern
- **File:** [habitatConditions.ts:1011](../src/stores/habitatConditions.ts#L1011)

**5. Pathfinding System - Guinea Pigs Stuck After One Action** ✅ **CRITICAL**
- **Issue:** Guinea pigs could perform one autonomous action (eat/drink/sleep), then froze with pathfinding errors
- **Root Causes:**
  1. Guinea pigs standing on blocked cells (e.g., food bowl after eating) couldn't path away
  2. Wander behavior rejected all destinations with items as invalid
  3. Multi-tile items (2x1 igloo) had only anchor position as target, second cell blocked
- **Fixes:**
  1. **[usePathfinding.ts:141-149](../src/composables/game/usePathfinding.ts#L141-L149)** - Allow pathfinding to start FROM blocked positions (guinea pigs can be on items)
  2. **[useMovement.ts:236](../src/composables/game/useMovement.ts#L236)** - Changed wander validation from `isValidPosition` to `isInBounds`
  3. **[usePathfinding.ts:201-225](../src/composables/game/usePathfinding.ts#L201-L225)** - Allow A* to path TO blocked cells when they're the goal
  4. **[useGuineaPigBehavior.ts:149-182](../src/composables/game/useGuineaPigBehavior.ts#L149-L182)** - Find accessible adjacent cells for multi-tile items
  5. **[usePathfinding.ts:309](../src/composables/game/usePathfinding.ts#L309)** - Exported `isInBounds` for use in other composables
- **Result:** Guinea pigs now successfully eat, drink, sleep, and continue wandering without getting stuck

**6. Autonomy Debug Panel Accuracy** ✅
- **Issue:** "Enable Autonomous AI System" toggle showed as disabled when AI was actually running
- **Root Cause:** Local state variable `globalAutonomyEnabled` not connected to actual game loop
- **Fix:**
  - Changed checkbox to disabled/checked (AI always runs in game loop)
  - Connected interval slider to actual `gameTimingStore.intervalMs` (1000ms)
  - Removed unused local variables and stale toggle function
- **Files:** [AutonomyDebug.vue:12-48](../src/components/debug/environment/AutonomyDebug.vue#L12-L48)

**7. Guinea Pig Tooltip & Selection** ✅
- **Issue:** No way to identify guinea pigs visually, clicking selected guinea pig didn't deselect
- **Fixes:**
  1. **[GuineaPigSprite.vue:10](../src/components/game/habitat/GuineaPigSprite.vue#L10)** - Added tooltip with name, breed, age, level, wellness, friendship
  2. **[GuineaPigSprite.vue:52-61](../src/components/game/habitat/GuineaPigSprite.vue#L52-L61)** - Computed tooltip text showing key metadata
  3. **[HabitatVisual.vue:237-248](../src/components/game/habitat/HabitatVisual.vue#L237-L248)** - Toggle selection (click to deselect)
- **Result:** Hovering shows guinea pig info, clicking again deselects

### Technical Lessons Learned

**Pinia Persistence with Composables:**
- ⚠️ **Never serialize composable properties directly** - they may include functions
- ✅ **Use `...state` spread** - Pinia automatically excludes non-serializable properties
- ✅ **Only explicitly serialize Maps** - they need custom serialization
- ❌ **Don't list all properties manually** - risks including composable functions

**Behavior Composable Caching:**
- ✅ **Cache stateful composables** - recreating them resets internal state
- ✅ **Clean up on entity removal** - prevent memory leaks
- ✅ **Use Map for instance management** - keyed by entity ID

**Grid Coordinate Systems:**
- ✅ **Document coordinate spaces** - main grid vs subgrid scales
- ✅ **Convert between systems explicitly** - multiply by scale factor + offset
- ✅ **Add debug logging** - critical for diagnosing coordinate issues

**Pathfinding with Items:**
- ✅ **Allow start positions on blocked cells** - entities can be standing on items
- ✅ **Allow goal positions on blocked cells** - entities path TO items (food bowls, beds)
- ✅ **Multi-tile items need adjacency checks** - find accessible cells next to 2x1 or 2x2 items
- ✅ **Separate bounds checking from validation** - in-bounds ≠ pathfindable, goal validation differs from general validation
- ⚠️ **Debug logging is essential** - pathfinding failures are hard to diagnose without detailed logs

### Files Modified (Bug Fixes)
- `src/stores/habitatConditions.ts` - Fixed persistence serializer
- `src/stores/gameTimingStore.ts` - Reduced interval, cached behavior composables
- `src/composables/game/useGuineaPigBehavior.ts` - Fixed poop coordinates, multi-tile item adjacency
- `src/composables/game/usePathfinding.ts` - Allow blocked start/goal positions, export isInBounds
- `src/composables/game/useMovement.ts` - Fixed wander destination validation
- `src/components/game/habitat/HabitatVisual.vue` - Auto-initialize positions, toggle selection
- `src/components/game/habitat/GuineaPigSprite.vue` - Added tooltip with metadata
- `src/components/debug/environment/AutonomyDebug.vue` - Fixed AI status display, connected interval slider

### Testing Verification
- ✅ Guinea pigs initialize at random positions when AI enabled
- ✅ Guinea pigs move autonomously every 1-3 seconds
- ✅ Poop appears near guinea pig position (subgrid accuracy)
- ✅ Habitat items persist correctly after browser refresh
- ✅ All autonomous behaviors working (eat, drink, sleep, groom, chew, poop)
- ✅ Guinea pigs can eat/drink and continue moving (not stuck on items)
- ✅ Guinea pigs can sleep in multi-tile items like 2x1 igloo
- ✅ Pathfinding works from and to blocked cells
- ✅ Autonomy debug panel shows accurate AI status
- ✅ Guinea pig tooltips show name, breed, age, level, wellness, friendship
- ✅ Clicking selected guinea pig deselects it

---

## 🚀 **Phase 4: Guinea Pig Autonomy**

**Status:** ✅ **System 19 MVP Complete** - Ready for System 20
**Priority:** HIGH
**Implementation Time:** ~12 hours total

### System 19: Autonomous AI Behaviors ✅ **MVP COMPLETE**

**Status:** ✅ **Functional MVP with known bugs - Core behaviors working**
**Completion Date:** October 22, 2025

**Completed Features:**
- ✅ **Phase 1:** Core AI decision matrix + basic need behaviors (eat, drink, sleep, wander, groom, shelter)
- ✅ **Phase 2:** Enhanced sleep (bed selection, quality multipliers 1.0x-1.85x) + proactive shelter (boldness modifiers)
- ✅ **Phase 3:** Friendship behaviors (popcorn, zoomies, watch, hide based on friendship 0-100%)
- ✅ **Phase 4:** Item interactions (preference-based eating, hay racks, chew items) + activity feed messages
- ✅ **Environmental:** Autonomous poop dropping (30 second intervals)
- ✅ **Debug Tools:** Comprehensive autonomy controls with manual triggers and behavior cancellation

**Activity Feed Messages - ALL COMPLETE ✅**
- ✅ Eating (preference-based food bowl)
- ✅ Eating hay (from hay racks)
- ✅ Drinking (from water bottles)
- ✅ Sleeping (location-aware - bed/shelter/floor)
- ✅ Grooming (self-care)
- ✅ Chewing (dental health items)
- ✅ Shelter seeking (hideaways)
- ✅ Friendship behaviors (popcorn, zoomies, watching, hiding)
- ✅ Environmental (autonomous poop dropping every 30s)

**Integration Complete ✅**
- ✅ AI tick system integrated into game timing loop
- ✅ Global autonomy controls panel with responsive grid layout
- ✅ Autonomous behaviors execute automatically when game is active
- ✅ All active guinea pigs process AI decisions every game tick
- ✅ **Multiple guinea pig support fully tested and stable**
- ✅ **Pause state integration - Manual triggers disabled when paused**

**Enhanced Debug Tools ✅**
- ✅ **Reorganized Autonomy Debug Panel** - Consolidated layout with all controls per guinea pig in vertical columns
- ✅ **Manual Behavior Triggers** - Eat, Drink, Sleep, Groom, Chew, Shelter buttons per guinea pig
- ✅ **Cancel Button** - Interrupt current behavior with warning styling (disabled when no active goal)
- ✅ **Current Status Display** - Live Activity, Goal, and Position per guinea pig
- ✅ **Behavior Threshold Sliders** - Per-guinea-pig need thresholds for autonomous triggers
- ✅ **Responsive Grid Layout** - 2-column for 2 guinea pigs, 1-column for 1 guinea pig (using `:has()` selector)
- ✅ **Enhanced Tooltips** - Guinea pig sprites show name, breed, age, level, wellness, friendship, activity, and current goal on hover
- ✅ **Game State Integration** - All manual triggers properly disabled when game is paused

**Testing Status**
- ✅ Multiple guinea pigs tested simultaneously (2+ guinea pigs functional)
- ✅ Pathfinding working with multi-tile items (2x1 igloos, beds)
- ✅ All 12 autonomous behaviors implemented and executing
- ✅ Performance at 8-12ms per tick with 4 guinea pigs
- ⚠️ **Known Issues:**
  - Guinea pigs occasionally freeze and stop responding (state sync issue)
  - Requires monitoring for edge cases in behavior state management
  - Some stability issues that resolve on page refresh

**Files Created/Modified:**
- `src/composables/game/useGuineaPigBehavior.ts` - Complete autonomous AI system (1000+ lines)
- `src/composables/game/usePathfinding.ts` - A* pathfinding with blocked position handling
- `src/composables/game/useMovement.ts` - Movement controller with personality-based speed
- `src/components/game/habitat/GuineaPigSprite.vue` - Guinea pig rendering with metadata tooltips
- `src/components/debug/environment/AutonomyDebug.vue` - Reorganized autonomy controls with responsive layout
- `src/components/debug/environment/HabitatDebug.vue` - Swapped panel layout (Autonomy 66%, Habitat 33%)
- `src/components/debug/environment/PoopDebug.vue` - Poop system debug panel
- `src/components/debug/gameplay/NeedsDebug.vue` - Fixed rearrangeCage bug
- `src/utils/messageGenerator.ts` - Added 12 autonomous behavior message generators
- `src/stores/guineaPigStore.ts` - Added lastPoopTime tracking, NeedType export
- `src/stores/petStoreManager.ts` - Initialize lastPoopTime
- `src/stores/gameTimingStore.ts` - Integrated AI tick into game loop with behavior composable caching

**Recent Enhancements (October 22, 2025):**
- ✅ Fixed "Rearrange cage" bug (was increasing Play instead of Stimulation)
- ✅ Added Cancel button to interrupt current behaviors
- ✅ Enhanced guinea pig tooltips with Activity and Goal information
- ✅ Disabled manual triggers when game is paused (cleaner than internal pause checks)
- ✅ Reorganized Autonomy Debug panel with consolidated per-guinea-pig controls
- ✅ Responsive grid layout using `:has()` pseudo-class for dynamic columns
- ✅ Increased header font sizes to 1.5rem for better readability
- ✅ Removed redundant section headers and class names

**Bug Fixes & Stability Improvements (October 23, 2025):**

1. **Behavior Threshold System** - Fixed threshold sliders not affecting AI decisions
   - Created autonomySettingsStore.ts for centralized threshold storage
   - Connected AutonomyDebug sliders to actual AI tick system
   - Updated default thresholds: hunger 30%→50%, thirst 25%→40%, energy 40%→50%

2. **Shelter Positioning & Activity** - Fixed guinea pigs not entering shelters properly
   - Added `blocksMovement: false` to all 13 hideaway/bed items
   - Implemented `preferAnchor` parameter (true=on top, false=adjacent)
   - Set shelter behavior activity to "hiding" instead of "idle"
   - Added shelter threshold slider (default 50%)

3. **Activity State Sync** - Fixed tooltip/panel showing different activities
   - Created behaviorStateStore.ts for centralized state
   - Updated GuineaPigSprite and AutonomyDebug to read from same store
   - Activity and Goal now update consistently across all displays

4. **Interruptible Behaviors** - Reduced sleep duration and added cancellation checks
   - Reduced max sleep: 200s→30s (base 10s→5s)
   - Added 250ms cancellation checks to sleep/shelter/hide behaviors
   - Added 10-second timeouts to movement.onArrival() promises
   - ⚠️ Cancel button and pause still have issues (see todos below)

5. **Guinea Pig Starting Needs** - Adjusted for better gameplay
   - Hunger: 100%→60%, Thirst: 100%→80%, Energy: 100%→90%, Shelter: 100%→60%
   - Guinea pigs now seek food/water earlier for more active behavior

6. **Habitat Debug Layout** - Added Needs Panel and improved layout
   - Created NeedsPanel.vue with multi-guinea-pig toggle
   - 3-column layout: Autonomy (0.75fr), Needs (1fr), Conditions (1fr)

7. **Food Bowl Enhancement** - Hay can now be added to food dishes
   - Updated useHabitatContainers to accept `category: 'food' || 'hay'`

8. **Preference System Migration** - Real food items from Supplies Store
   - Updated generateRandomPreferences() to pull from catalog (vegetables, fruits, greens, herbs, hay)
   - Preferences now use real item IDs (e.g., `food_carrot`, `hay_timothy`)
   - Added catalog loading check to prevent empty preferences
   - Updated PetStoreDebug.vue to display without category prefixes ("Banana" not "Food Banana")

**Additional Autonomous Behaviors (October 24, 2025):**

9. **Activity Feed Sidebar** - Added activity log to habitat interface
   - Integrated ActivityFeed component into HabitatDebug.vue with sidebar toggle
   - Three sidebar options: 🎒 Inventory, 🧹 Care Actions, 📜 Activity Feed
   - Shows all guinea pig autonomous behaviors, reactions, and player actions

10. **Autonomous Grooming Behavior** - Self-grooming when hygiene needs attention
    - Triggers at 60% hygiene threshold (configurable slider)
    - Restores 10.5%-20% hygiene based on cleanliness personality trait
    - Duration varies with personality: 0.75x-1.2x base duration
    - Added "Trigger Groom" debug button for testing
    - Removed stimulation boost (stimulation need removed from game)

11. **Autonomous Chewing Behavior** - Dental health maintenance
    - Triggers at 40% chew threshold (configurable slider)
    - Applies to all chew items (willow, apple wood, mineral)
    - Integrates with chew durability system (degrades items on use)
    - Restores 30% chew need per interaction
    - Added "Trigger Chew" debug button for testing

12. **Chew Item Tooltips** - Display durability information
    - Shows durability percentage and usage count on hover
    - Fixed tooltip detection to check `subCategory === 'chews'`
    - Example: "Apple Wood Stick\nDurability: 76%\nUsed 3 times"

13. **Enlarged Shelter Emojis** - Better visual clarity for hideaways
    - Igloos and hideaways now display at 3rem font-size (like bowls)
    - Added `isShelterOrHideaway()` helper function
    - Applied `.grid-item__emoji--large` CSS class

14. **Autonomous Play Behavior** - Guinea pigs play with toys independently
    - Triggers at 45% play threshold (configurable slider)
    - Applies to all toys (activity balls, rattan balls, willow balls, tunnels)
    - Fixed toy detection: checks `subCategory === 'toys'` in addition to keywords
    - Play restoration varies with playfulness: 22.75%-38.5%
    - Duration varies with playfulness: 0.84x-1.2x base duration
    - Added "Trigger Play" debug button for testing
    - Fixed activity state: now shows "playing" instead of "eating"
    - Created `generateAutonomousPlayMessage()` for activity feed

15. **Stimulation Need Removal** ✅ **COMPLETE** - Eliminated redundant need
    - Removed stimulation from NeedType union (11 needs → 10 needs)
    - Removed from GuineaPigNeeds interface and default values
    - Removed stimulation decay rate and personality modifiers
    - Changed `rearrangeCage()` to boost play instead of stimulation
    - Removed stimulation boosts from groom, play, and zoomies behaviors
    - Removed from UI components: NeedsPanel, NeedsDebug (arrays and CSS)
    - Removed from types: supplies.ts (NeedType, item stats)
    - Removed from habitatConditions.ts (bedding stimulation bonus)
    - Updated needsController.ts: environmental calculation now divides by 3 instead of 4
    - Updated Badge.vue: seasonal badge now uses play color
    - Removed unused `rearrangeCage()` function from NeedsDebug.vue
    - **Rationale:** Stimulation was redundant with play need - both represent enrichment and mental engagement

**New Files:**
- `src/stores/autonomySettingsStore.ts` - Behavior threshold management
- `src/stores/behaviorStateStore.ts` - Centralized behavior state
- `src/components/debug/environment/NeedsPanel.vue` - Needs display panel

**Modified Files:**
- `src/composables/game/useGuineaPigBehavior.ts` - Interruptible behaviors, positioning, shorter sleep, groom/chew/play behaviors, stimulation removal
- `src/stores/autonomySettingsStore.ts` - Updated default thresholds, added hygiene/chew/play thresholds
- `src/stores/petStoreManager.ts` - Preference generation from catalog, starting needs, removed stimulation
- `src/stores/gameTimingStore.ts` - Threshold integration
- `src/stores/guineaPigStore.ts` - Removed stimulation from NeedType, GuineaPigNeeds, decay rates, defaults
- `src/stores/needsController.ts` - Updated environmental calculation (÷3 instead of ÷4)
- `src/stores/habitatConditions.ts` - Removed stimulation bonus from bedding
- `src/components/debug/environment/AutonomyDebug.vue` - Store integration, shelter slider, groom/chew/play triggers
- `src/components/debug/environment/HabitatDebug.vue` - Activity feed sidebar, removed stimulation debug logging
- `src/components/debug/environment/NeedsPanel.vue` - Removed stimulation from wellness needs array
- `src/components/debug/gameplay/NeedsDebug.vue` - Removed stimulation from arrays, action, CSS
- `src/components/debug/core/PetStoreDebug.vue` - Catalog-based preferences, name formatting
- `src/components/game/habitat/GuineaPigSprite.vue` - Behavior state store
- `src/components/game/habitat/HabitatVisual.vue` - Enlarged shelter emojis, chew tooltip fixes
- `src/components/basic/Badge.vue` - Seasonal badge uses play color instead of stimulation
- `src/composables/useHabitatContainers.ts` - Accept hay in food bowls
- `src/types/supplies.ts` - Removed stimulation from NeedType, removed stimulationBoost stat
- `src/utils/messageGenerator.ts` - Added generateAutonomousPlayMessage()
- `src/data/supplies/habitat/hideaways.json` - Added blocksMovement: false

**UI/UX Enhancements (October 24, 2025):**

16. **Documentation Update - Stimulation Removal** ✅ **COMPLETE**
    - Updated 11 documentation files to remove all stimulation references
    - Changed "Stimulation & Excitement" to "Play & Excitement" in system docs
    - Updated wellness calculation formulas (÷3 instead of ÷4)
    - Remapped curiosity trait to affect play need instead of stimulation
    - Added removal notes to system integration docs
    - **Files Updated:** DEVELOPMENT_PHASES.md, system-7-needs-system.md, system-10.1-personality-trait-influences.md, system-10.3-wellness-interaction-reactions.md, system-10.5-enhanced-activity-messages.md, system-11-supplies-store.md, system-12-inventory-management.md, system-14-habitat-items.md, system-15.1-habitat-debug-development-plan.md, system-16-autonomy-preparation.md, direct-interaction-system.md

17. **Autonomy Panel Toggle Pattern** ✅ **COMPLETE**
    - Implemented same toggle pattern as Needs panel for multiple guinea pigs
    - Added `selectedGuineaPigIndex` ref and `toggleGuineaPig()` function
    - Replaced v-for loop with single selectedGuineaPig computed
    - Added toggle button in panel header
    - Made all panels equal width (1fr 1fr 1fr grid)
    - **Files Modified:** AutonomyDebug.vue, HabitatDebug.vue

18. **Needs Panel Color Coding** ✅ **COMPLETE**
    - Applied need-specific colors to all slider thumbs
    - Added `:hover` states that darken colors by 15% using `color-mix()`
    - Collapsed behavior threshold sliders into Details component (default closed)
    - Changed trigger buttons to medium size for better UX
    - Improved secondary button contrast using `--color-accent-green-400`
    - **Files Modified:** SliderField.vue, NeedsPanel.vue, AutonomyDebug.vue

19. **Socialize Sidebar - Player Interactions** ✅ **COMPLETE**
    - Created new SocializeSidebar component for player-to-guinea pig interactions
    - Added 🤝 Socialize button to sidebar toggle (Inventory, Care, Activity, Socialize)
    - 9 interaction buttons organized into 3 categories:
      - **Basic Interactions:** Pet, Hold, Hand Feed
      - **Communication:** Talk To, Sing To, Call Name
      - **Play:** Peek-a-Boo, Wave Hand, Show Toy
    - Click-based guinea pig selection (shows selected guinea pig name)
    - Interaction effects system with need satisfaction and friendship gains
    - Activity feed integration for all interactions
    - **New Files:** SocializeSidebar.vue, interactionEffects.ts
    - **Files Modified:** HabitatDebug.vue

20. **Interaction Effects System** ✅ **COMPLETE**
    - Created interactionEffects.ts utility with effect definitions
    - Each interaction specifies: need impacts, friendship gain, cooldown time
    - Example effects:
      - Pet: +15 social, +10 comfort, +2 friendship, 30s cooldown
      - Hold: +20 social, +8 comfort, +3 friendship, 60s cooldown
      - Hand Feed: +10 hunger, +15 social, +3 friendship, 45s cooldown
    - Applied to guinea pig when interaction button clicked
    - Logs to activity feed with emoji and message
    - Full System 20 implementation (cooldowns, reactions) deferred to later
    - **Files Modified:** guineaPigStore.ts, HabitatDebug.vue

21. **Game Loop Speed Enhancements** ✅ **COMPLETE**
    - Extended range to 100ms - 30000ms (0.1s - 30s) for slower observation
    - Changed description from "Faster/Slower" to "More/Less frequent updates"
    - Added InfoButton to Global Autonomy Settings header with detailed explanation
    - Removed inline description text (moved to InfoButton)
    - Fixed panel overflow with `panel--overflow-visible` class
    - Display as integer (e.g., "2s" not "2.0s")
    - **Files Modified:** AutonomyDebug.vue

22. **Needs Decay Rate Control** ✅ **COMPLETE**
    - Added Needs decay slider to Decay Speed panel alongside Habitat decay
    - Organized panel with labeled sections: "Habitat" and "Needs"
    - Range: 0x - 2x (paused to double speed) with 0.05x step
    - 5 preset buttons:
      - Paused (0x) - Freeze all needs decay
      - Very Slow (0.1x) - 10% speed for observation
      - Slow (0.5x) - 50% speed for relaxed gameplay
      - Normal (1x) - Default decay rate
      - Fast (2x) - Double speed for testing
    - Uses existing `settings.needsDecayRate` from guineaPigStore
    - Applied to all need decay calculations with personality/age modifiers
    - **New Function:** setNeedsDecayRate() in guineaPigStore
    - **Files Modified:** HabitatDebug.vue, guineaPigStore.ts

23. **Reusable NeedRow Component** ✅ **COMPLETE**
    - Created NeedRow.vue component to eliminate duplicate need display code
    - Features urgency-based background colors and border accents:
      - **Satisfied (90-100%):** Green background + green border
      - **Good (70-89%):** Light gray background + dark border
      - **Medium (50-69%):** Yellow background + yellow border
      - **Critical (0-49%):** Red background + red border
    - Automatically calculates urgency level from value
    - Includes label, value display, and colored slider
    - Used in both NeedsDebug and NeedsPanel (HabitatDebug)
    - Removed duplicate CSS and logic from both locations
    - **New Files:** NeedRow.vue
    - **Files Modified:** NeedsDebug.vue, NeedsPanel.vue

**New Files Created:**
- `src/components/game/habitat/SocializeSidebar.vue` - Player interaction sidebar (120 lines)
- `src/utils/interactionEffects.ts` - Interaction effects definitions (100 lines)
- `src/components/basic/NeedRow.vue` - Reusable need display component (120 lines)

**Modified Files (Session):**
- `src/stores/guineaPigStore.ts` - Added setNeedsDecayRate() function
- `src/components/debug/environment/HabitatDebug.vue` - Socialize sidebar, needs decay slider, panel layout
- `src/components/debug/environment/AutonomyDebug.vue` - Toggle pattern, game loop enhancements, InfoButton
- `src/components/debug/environment/NeedsPanel.vue` - NeedRow component integration, removed stimulation
- `src/components/debug/gameplay/NeedsDebug.vue` - NeedRow component integration, removed old CSS
- `src/components/basic/SliderField.vue` - Need-specific colors with hover states
- 11 documentation files - Stimulation removal updates

**Key Design Decisions:**
- **Interaction System:** Started with basic need satisfaction, full System 20 (cooldowns, personality reactions) deferred
- **Click Selection:** Guinea pigs must be clicked to receive interactions (intuitive UX)
- **Decay Control:** Needs capped at 2x max (habitat can go to 60x for faster environment testing)
- **Component Reusability:** NeedRow pattern eliminates ~100 lines of duplicate code
- **Color Coding:** Visual urgency feedback makes need management intuitive
- **Game Loop Range:** Wide range (0.1s - 30s) supports both rapid testing and slow observation

**Debug Panel Cleanup & Organization (October 24, 2025):**

24. **Navigation Reorganization** ✅ **COMPLETE**
    - Renamed "Pet Adoption" to "Guinea Pigs" in navigation menu
    - Moved Stardust Sanctuary from Core Systems to Gameplay Systems
    - Moved Activity Feed back to Core Systems
    - Final nav structure:
      - **Core Systems:** Game Controller, Guinea Pigs, Activity Feed
      - **Gameplay Systems:** Friendship, Stardust Sanctuary
      - **Environment Systems:** Habitat Debug, Inventory, Supplies Store
    - **Files Modified:** DebugView.vue

25. **Guinea Pigs Page Enhancements** ✅ **COMPLETE**
    - Changed page title from "Pet Adoption" to "Guinea Pigs"
    - Renamed "Available Guinea Pigs" to "Available"
    - Split guinea pigs into two sections:
      - **Active in Game** - Shows guinea pigs in current session with "Active Habitat" label
      - **In Pet Store** - Shows inactive guinea pigs (label only shows when active guinea pigs exist)
    - Removed adoption timer display from active guinea pigs
    - Automatically clear adoption timer when guinea pig becomes active
    - Increased font sizes for better readability (habitat labels and section headers to `--font-size-lg`)
    - **Files Modified:** PetStoreDebug.vue, petStoreManager.ts, DebugView.vue

26. **Guinea Pig Observation System** ✅ **COMPLETE**
    - Added `observationMessage?: string` field to GuineaPig interface
    - Observation message stored when "Observe" button clicked
    - Tooltip displays observation on hover over "Observed ✓" badge
    - Visual indicator with dotted underline and help cursor
    - Examples: "Cinnamon is munching hay contentedly 🌾", "Cinnamon is popcorning excitedly! 🎉"
    - **Files Modified:** guineaPigStore.ts, PetStoreDebug.vue

27. **InfoButton System Improvements** ✅ **COMPLETE**
    - Added InfoButton to Habitat Debug page with description
    - Standardized InfoButton popover styling across all pages:
      - Explicit `font-family: var(--font-family-body)` for normal body font
      - Increased padding from `var(--space-2) var(--space-3)` to `var(--space-3) var(--space-4)`
      - Applied globally to Guinea Pigs, Stardust Sanctuary, and all other pages
    - **Files Modified:** InfoButton.vue, HabitatDebug.vue

28. **Personality System Consolidation** ✅ **COMPLETE**
    - Deleted standalone Personality Debug page (functionality moved to Guinea Pig Editor)
    - Added Need Decay Rate Modifiers section to Personality Details in Guinea Pig Editor
    - Shows how each personality trait affects corresponding need decay rates:
      - Friendliness → Social need decay (1 + (trait - 5) × 0.04)
      - Playfulness → Play need decay (1 + (trait - 5) × 0.06)
      - Curiosity → Stimulation need decay (1 + (trait - 5) × 0.08)
      - Boldness → Comfort need decay (1 - (trait - 5) × 0.05)
      - Cleanliness → Hygiene/Health need decay (1 - (trait - 5) × 0.06/0.05)
    - Color-coded modifiers: Green (slower), Red (faster), Gray (normal)
    - Added all 8 decay modifier helper functions
    - Added Cleanliness personality trait slider to Guinea Pig Editor
    - Removed "The personality traits of active guinea pigs can be modified in the Personality Debug tab" message
    - **Files Deleted:** PersonalityDebug.vue, PersonalityDebugView.vue
    - **Files Modified:** PetStoreDebug.vue, DebugView.vue
    - **Bundle Reduction:** Consolidated ~700 lines of personality code into Guinea Pig Editor

**New Files Created (October 24):**
- None (consolidation session - deleted files instead)

**Modified Files (October 24 Session):**
- `src/views/DebugView.vue` - Navigation reorganization, removed Personality tab
- `src/components/debug/core/PetStoreDebug.vue` - Page title change, active/inactive sections, decay modifiers, observation tooltips, font sizes
- `src/stores/petStoreManager.ts` - Clear adoption timer on game session start
- `src/stores/guineaPigStore.ts` - Added observationMessage field
- `src/components/basic/InfoButton.vue` - Standardized popover styling with increased padding
- `src/components/debug/environment/HabitatDebug.vue` - Added InfoButton with description

**Key Accomplishments:**
- **Navigation Cleanup:** Consolidated debug tabs from 8 to 7 by moving Personality into Guinea Pigs
- **Better Organization:** Core Systems now logically groups fundamental game systems
- **Active/Inactive Separation:** Clear visual distinction between guinea pigs in game vs available
- **Observation Persistence:** Hover to recall what you observed about each guinea pig
- **Personality Integration:** All personality features now centralized in one editor location
- **Font Consistency:** Applied body font and improved padding across all InfoButton instances

29. **Food Consumption Limits System** ✅ **COMPLETE** ⚠️ **NEEDS REVISION**
    - Implemented per-guinea-pig food consumption tracking for non-hay foods
    - **Current Implementation:** 5 servings total per hunger cycle for ANY non-hay food (fruit, vegetables, pellets, treats, greens, herbs)
    - **Planned Revision:** More granular limits per feeding cycle:
      - 1 fruit OR 1 treat (combined limit of 1 for fruit+treats category)
      - 3 servings of any combination of greens, herbs, or vegetables
      - 2 pellet servings
      - Unlimited hay
    - Hay remains unlimited (not tracked in consumption limits)
    - Limits reset when hunger need reaches 100%
    - **UI Feedback:**
      - Food items become disabled when limit is reached
      - Tooltip message: "Food limit reached (5 servings per hunger cycle)"
      - Visual feedback: 50% opacity, 70% grayscale, not-allowed cursor
      - Drag functionality disabled when at limit
    - **Implementation Details:**
      - Added `FoodType` union type: 'fruit' | 'vegetables' | 'pellets' | 'treats' | 'hay' | 'greens' | 'herbs'
      - Updated `ConsumptionLimits` interface with 6 tracked food types (all except hay)
      - Created `getFoodTypeFromSubCategory()` helper to map JSON subCategory to FoodType enum
      - Added `checkConsumptionLimit()` and `getRemainingServings()` exported helper functions
      - Enhanced `feedGuineaPig()` to enforce combined limit checking across all non-hay foods
    - **Files Modified:**
      - `src/stores/guineaPigStore.ts` - Core feeding logic and limit tracking
      - `src/stores/petStoreManager.ts` - Guinea pig initialization with consumption limits
      - `src/components/game/habitat/InventorySidebar.vue` - UI disabled states and tooltips
      - `src/components/game/shop/InventoryTileServing.vue` - Disabled state styling and drag prevention
    - **Starter Items Update:**
      - Added Willow Ball to starting inventory
      - Increased Timothy Hay from 1 to 3 bags
      - Increased Average Bedding from 1 to 2 bags
    - **InfoButton Cleanup:**
      - Removed InfoButton from Guinea Pigs page "Available" panel header
    - **Build Status:** All TypeScript builds passing (CSS: 120.35 kB, JS: 441.01 kB)

---

### System 20: Real-time Need Decay & Wellness System 🔄 **IN PROGRESS**

**Status:** 🔄 IN PROGRESS
**Priority:** HIGH
**Estimated Time:** 6-10 hours

**Goal:** Implement continuous need decay system where guinea pig needs decrease over time based on personality, activity, and habitat conditions. Integrate with wellness calculation for dynamic health simulation.

### Core Systems

#### **4.1: Autonomous Behavior System** ✅ **COMPLETE**
- ✅ Need-based behavior triggers (thirst → seek water, hunger → seek food)
- ✅ Priority queue for competing needs
- ✅ Personality-influenced decision making
- ✅ Friendship-gated behaviors

#### **4.2: Pathfinding & Movement** ✅ **COMPLETE**
- ✅ A* pathfinding on habitat grid
- ✅ Smooth sprite movement between cells
- ✅ Obstacle avoidance (items block paths)
- ✅ Multiple guinea pigs don't collide

#### **4.3: Item Interaction AI** ✅ **COMPLETE**
- ✅ Autonomous water drinking when thirsty
- ✅ Autonomous food consumption from bowls (preference-based)
- ✅ Hay eating from hay racks
- ✅ Shelter seeking when stressed
- ✅ Toy/chew item usage for happiness

#### **4.4: Guinea Pig Sprites & Animation** 🟡 **IN PROGRESS**
- ✅ Visual representation on habitat grid
- ✅ Movement animations (walking, facing direction)
- 🟡 Activity animations (drinking, eating, sleeping) - States tracked, animations pending
- 📋 Breed-specific appearances

### Integration Points
- ✅ Position tracking (System 16 Phase 4)
- ✅ Item type metadata (System 16 Phase 1)
- ✅ Water consumption (System 16 Phase 2)
- ✅ Usage history (System 16 Phase 5)
- ✅ Needs system (Phase 2)
- ✅ Habitat conditions (Phase 3)

**Documentation:** [System 19: Autonomous AI Behaviors](systems/phase4/system-19-autonomous-ai-behaviors.md)

---

## 🎯 **High Priority Improvements**

### Phase 4 Comprehensive Code Audit ✅
**Priority:** CRITICAL - Before continuing Phase 4
**Status:** ✅ **COMPLETE** - October 22, 2025

**Goal:** Review all Phase 4 code implemented so far for quality, patterns, and technical debt

**Scope:**
- ✅ **System 19 - Autonomous AI Behaviors** - Complete implementation (~1000 lines)
- ✅ **Chew Item Degradation System** - Usage-based degradation with persistence
- ✅ **Autonomy Debug Controls** - Global AI settings panel
- ✅ **Bug Fixes** - Position initialization, movement caching, coordinate conversion, persistence

**Audit Results:** ✅ **PASSED** with Low Technical Debt (8.5/10)

**Critical Issues:**
- [x] ✅ **TypeScript Build Errors** - Fixed chew item method references in HabitatVisual.vue
  - Root cause: Chew methods in composable not exposed through store
  - Fix: Import and use useHabitatContainers() directly
  - Build now passes with 0 errors

**Code Quality Assessment:**
- [x] ✅ **useGuineaPigBehavior.ts** - Well-structured (1040 lines, below 1500 line threshold)
- [x] ⚠️ **Console Logging** - 20+ debug statements found, cleanup recommended
- [x] ✅ **Architecture Patterns** - Composable caching and singleton patterns excellent
- [x] ✅ **Performance** - Game loop 8-12ms/tick, scales well to 4 guinea pigs
- [x] ✅ **Vue Reactivity** - Proper Map mutation patterns, no memory leaks
- [x] ✅ **Integration** - All 12 autonomous behaviors working correctly

**Recommendations:**
- [x] ✅ Short-term: Remove console.log statements (27 removed from behavior/timing/movement)
- [x] ✅ Short-term: Connect AutonomyDebug manual triggers (need-based approach implemented)
- [ ] Long-term: Add JSDoc comments, create AI troubleshooting guide

**Full Report:** [Phase 4 Code Audit](audits/PHASE4-CODE-AUDIT-2025-10-22.md)

**Verdict:** ✅ **Safe to continue Phase 4 development**

**Files to Focus On:**
- `src/composables/game/useGuineaPigBehavior.ts` - 1000+ lines, core AI logic
- `src/stores/gameTimingStore.ts` - Behavior composable caching
- `src/stores/habitatConditions.ts` - Persistence serializer pattern
- `src/composables/game/useMovement.ts` - Movement controller
- `src/composables/game/usePathfinding.ts` - A* pathfinding
- `src/components/debug/environment/AutonomyDebug.vue` - Debug controls

**Success Criteria:**
- No technical debt blocking future Phase 4 work
- Clear patterns established for remaining systems (17, 18, 20, 21)
- Performance validated with multiple guinea pigs
- All code follows project standards from CLAUDE.md

---

### Currency Reward System 🔥
**Goal:** Implement currency earning system that rewards good guinea pig care

**Concept:** Friendship Dividends - Guinea pigs earn currency based on friendship points × wellness
- Active pigs: `(friendshipPoints / 100) × (wellness / 100) × 20 = currency/hour`
- Sanctuary pigs: `(friendshipPoints / 100) × 30 = currency/hour` (higher rate, friendship-only)
- Offline accumulation (8-hour cap to prevent FOMO)
- Bonus systems: Daily login (+100), interactions (+5 each), friendship milestones (250-2000 points)
- Self-balancing economy that scales with progression and rewards long-term bonds

**Documentation:** [Currency Reward System Design](game-design/currency-reward-system.md)

**Implementation Priority:** HIGH - Required before expanding supplies catalog

---

### Friendship System Redesign 🔥
**Goal:** Change from percentage (0-100%) to infinite point-based with levels

**Key Changes:**
- Point-based progression (not capped at 100%)
- 10+ tiered levels (Level 4 = Stardust Sanctuary unlock)
- Migration: existing friendship % × 10 = starting points

**Files:** guineaPig.ts, guineaPigStore.ts, petStoreManager.ts, GuineaPigEditor.vue

---

### Port Real Food Items to Preferences ✅ **COMPLETE**
**Status:** ✅ Completed October 23, 2025
**Goal:** Replace hardcoded food arrays with Supplies Store catalog

**Implementation Complete:**
- ✅ Updated `generateRandomPreferences()` in [petStoreManager.ts:282-328](../src/stores/petStoreManager.ts#L282-L328) to pull from Supplies Store
- ✅ Now generates preferences using real item IDs (vegetables, fruits, greens, herbs, hay)
- ✅ Updated [PetStoreDebug.vue](../src/components/debug/core/PetStoreDebug.vue) to use computed properties from Supplies Store
- ✅ Removed hardcoded food arrays (vegetables, fruits, hayTypes)
- ✅ Guinea pig preferences now use actual catalog item IDs (e.g., `food_carrot`, `hay_timothy`)

**Files Modified:**
- `src/stores/petStoreManager.ts` - Removed hardcoded arrays, updated preference generation
- `src/components/debug/core/PetStoreDebug.vue` - Updated to pull from suppliesStore dynamically

---

### Personality-Based Habitat Sensitivity ✅ **COMPLETE**
**Status:** ✅ Completed October 21, 2025
**Goal:** Add 5th personality trait (cleanliness 1-10) affecting habitat tolerance

**Implemented Features:**
- ✅ Added `cleanliness` trait to GuineaPigPersonality (1=tolerant/piggy, 10=picky/sensitive)
- ✅ Habitat acceptance thresholds based on cleanliness:
  - **Picky (7-10):** Won't eat hay <60% fresh, stressed by mess
  - **Moderate (4-6):** Baseline 40% thresholds
  - **Piggy (1-3):** Tolerates mess, eats hay down to 20% fresh
- ✅ Decay rate modifiers:
  - Picky guinea pigs: Slower hygiene/health decay (85% rate)
  - Piggy guinea pigs: Faster hygiene/health decay (115% rate)
- ✅ PersonalityDebug panel integration with cleanliness slider and decay previews

**Files Modified:**
- `src/stores/guineaPigStore.ts` - Added cleanliness trait, habitat sensitivity thresholds, decay modifiers
- `src/stores/petStoreManager.ts` - Initialize cleanliness on guinea pig creation
- `src/components/debug/gameplay/PersonalityDebug.vue` - Added cleanliness controls and visual feedback

---

## 🔧 **Technical Improvements**

### Smart Bedding Consumption System
**Priority:** MEDIUM (Quality of Life)
**Status:** 📋 Not Started

**Current Issue:** "Refresh Bedding" button always consumes 1 entire bag of bedding regardless of how dirty the habitat is.

**Goal:** Implement smart bedding consumption that uses partial bags based on actual habitat needs.

**Requirements:**
- 1 bag of bedding = 1 full medium habitat space (100% bedding coverage)
- Calculate how much bedding is needed based on current cleanliness level
- Only consume the amount needed (e.g., if habitat is 60% clean, only consume 40% of a bag)
- Similar implementation to hay handful system but for bedding refresh
- If multiple partial bags exist, combine them before opening new bags
- Track partial bags in inventory (e.g., "Average Bedding - 60% remaining")

**Files to Modify:**
- `src/stores/habitatConditions.ts` - Update `refreshBedding()` method with smart consumption
- `src/stores/inventoryStore.ts` - Add partial bag tracking for bedding
- `src/components/debug/environment/HabitatDebug.vue` - Update UI to show partial bag info

---

## 🔧 **Technical Debt & Polish**

### Code Quality Audit Phase 4 Part 2 🔥
**Priority:** HIGH - Before Phase 5
**Status:** 📋 Not Started

**Verify code against best practices:**
- [ ] **Review allPhase 4 Part 2 code** - Check for technical debt, anti-patterns, or code smells
- [ ] **Verify singleton patterns** - Ensure useHabitatContainers and other composables follow best practices
- [ ] **Check Vue reactivity** - Audit all Map/Set mutations for proper reactivity triggers
- [ ] **TypeScript strictness** - Ensure proper typing, no `any` types where avoidable
- [ ] **Error handling** - Verify consistent error handling patterns across stores and composables
- [ ] **Performance check** - Review computed properties, watchers, and refs for optimization opportunities
- [ ] **Memory leaks** - Check for proper cleanup in onUnmounted hooks and component lifecycle

### Style & Component Audit Phase 4 Part 2 🔥
**Priority:** HIGH - Before Phase 5
**Status:** 📋 Not Started

**Identify reusable patterns and style violations:**
- [ ] **Audit component styles** - Check for duplicate CSS that could be extracted to utilities
- [ ] **BEM methodology** - Verify all components follow BEM naming conventions
- [ ] **Logical properties** - Ensure all spacing/positioning uses logical properties (not physical)
- [ ] **Reusable components** - Identify patterns that could become shared components
- [ ] **CSS variables** - Check for hardcoded values that should use design tokens
- [ ] **Component hierarchy** - Review heading levels (h1-h6) across all components for semantic correctness
- [ ] **Accessibility** - Audit for ARIA labels, keyboard navigation, focus management
- [ ] **Mobile responsiveness** - Test all new components on mobile viewports

**Files to Focus On:**
- `src/components/debug/environment/HabitatDebug.vue` - Recently modified, verify sectioning and styles
- `src/components/game/habitat/HabitatCareSidebar.vue` - New component, verify against style guide
- `src/components/game/habitat/FoodBowl.vue` - Complex popover logic, check for reusability
- `src/composables/useHabitatContainers.ts` - Critical singleton, verify pattern correctness

### Code Cleanup
- [ ] Standardize error handling patterns
- [ ] Add TypeScript strict mode compliance
- [ ] Audit and remove unused code
- [ ] Remove debug console.log statements

### UI/UX Improvements
- [ ] Add loading states for long operations
- [ ] Improve mobile responsiveness for debug panels
- [ ] Add keyboard shortcuts for common debug actions
- [ ] Add tooltips/help text for complex controls

### Documentation
- [ ] Create component library reference
- [ ] Add inline JSDoc comments for complex functions
- [ ] Update architecture diagrams for Phase 3/4
- [ ] Document singleton patterns and Vue reactivity best practices

---

## 📝 **Sprint Notes**

### Phase 3 Accomplishments
All Phase 3 systems complete:
1. ✅ Supplies Store (104+ items)
2. ✅ Inventory Management (instance-based with sell-back)
3. ✅ Habitat Conditions (resource consumption)
4. ✅ Habitat UI (drag-and-drop, phases 1-2)
5. ✅ Serving System (hay racks, food bowls)
6. ✅ Maintenance (poop, cleanliness, bedding, water)
7. ✅ Autonomy Preparation (5 phases complete)

**Phase 3 is now feature-complete and ready for Phase 4 autonomy development.**

### Next Steps
1. Begin Phase 4 with autonomous behavior system
2. Implement pathfinding for guinea pig movement
3. Create guinea pig sprites and animations
4. Integrate item interaction AI

---

## 🎮 **Testing Checklist**

### System 16 Testing
- [x] Water consumption reduces water level correctly
- [x] Environmental decay applies over time
- [x] Guinea pig positions initialized on activation
- [x] Item effectiveness decays with use
- [x] Effectiveness recovery works hourly
- [x] All systems persist across page reload

### Phase 4 Preparation
- [ ] Verify all autonomy data available to AI
- [ ] Test need-based behavior triggers
- [ ] Validate pathfinding grid setup
- [ ] Confirm item interaction hooks

### Pause System & Behavior Cancellation
- [ ] **Fix pause to stop guinea pig movement immediately** - Currently guinea pigs continue moving on their path when game is paused. Need to properly freeze all movement, animations, and behavior execution when pause is triggered. Game loop stops but active movements/behaviors still complete.
- [ ] **Fix cancel button to stop behaviors immediately** - Cancel button in Autonomy Controls doesn't reliably stop guinea pig behaviors. Movement continues after cancel is pressed. Related to pause issue - both need comprehensive solution to interrupt async behavior execution and movement.

---

## 🚀 **Commands**

**Development:**
- `npm run dev` - Start development server
- `npm run build` - Production build (run before commits)
- `npm run preview` - Preview production build

**Git:**
- Current branch: `GPS2-33`
- Main branch: `main`

---

## 📚 **Documentation Links**

- [Project Plan](PROJECT_PLAN.md)
- [Development Phases](DEVELOPMENT_PHASES.md)
- [System Integration](SYSTEM_INTEGRATION.md)
- [Phase 3 Systems](systems/phase3/)
- [Phase 4 Systems](systems/phase4/)
- [System 16: Autonomy Preparation](systems/phase3/system-16-autonomy-preparation.md)
