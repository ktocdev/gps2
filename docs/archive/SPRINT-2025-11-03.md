# GPS2 Sprint - November 3, 2025

**Started:** November 3, 2025
**Status:** Active üöß
**Branch:** GPS2-43
**Previous Sprint:** [SPRINT-2025-11-02.md](SPRINT-2025-11-02.md)

**Progress:**
- ‚úÖ Code Audit Completed (17 files audited, 9.6/10 score)
- ‚úÖ CSS Audit Completed (9 components, 9.6/10 score)
- ‚úÖ Magic Number Fix (CELL_SIZE)
- ‚úÖ Panel Utility Improvements Applied
- ‚úÖ Window Focus Bug Fixed (Page Visibility API + PauseOverlay)
- ‚úÖ Nails Need Display Fixed
- ‚úÖ Needs Decay System Fixed (recalibrated rates + removed death spiral)
- ‚úÖ Needs System Reframing (behavior thresholds + color system redesign)
- ‚úÖ Age Display Hidden (deferred to Phase 5+ aging feature)
- ‚úÖ Clip Nails Interaction Added (with need-based availability)
- ‚úÖ Emoji Selection Fixed (no-select utility class)
- ‚úÖ Bond Progress Bars Replaced (now using SliderField component)
- ‚úÖ Hand-Feed Dialog Confirmation Added (two-step process prevents accidents)
- ‚úÖ Treats Can Now Be Hand-Fed (added treats category to food dialog)
- ‚úÖ Fill Hay Rack Buttons Added (global + individual buttons for quick refills)
- ‚úÖ Friendship Value Display Added (numeric percentage above bond progress bars)
- ‚úÖ ProgressBar Component Created (read-only progress bar for game view)
- ‚úÖ Phase 2.5 Systems Reorganized (moved to Phase 5 as Systems 22 and 23.5)
- üöß Next: Phase 2.5 testing + additional polish

---

## üéØ **Sprint Goals**

**Focus:** Code audit, Phase 2.5 systems, and high-priority bug fixes

**Priority Areas:**
1. Audit previous sprint's code and CSS for consistency
2. Implement Phase 2.5 systems (Food consumption limits, personality traits)
3. Fix window focus bug affecting autonomous behavior
4. Polish and optimization

---

## üìã **Sprint Backlog**

### Code Audit & Cleanup üîç

#### Audit Previous Sprint Code
**Priority:** HIGH
**Status:** ‚úÖ Completed
**Category:** Code Quality

**Goal:** Review all code from November 2 sprint for consistency, best practices, and potential issues

**Areas Reviewed:**
1. **Smart Bedding System** ‚úÖ (Previously audited)
   - Proportional bedding consumption logic verified
   - Fractional quantity tracking working correctly
   - Dialog UX and error handling complete

2. **Companion Bond System Updates** ‚úÖ (Previously audited)
   - Proximity time tracking and reactivity fixes verified
   - Bond strength message calculations correct
   - Bonding rate (+1 per 10 seconds) working

3. **Player Friendship Display** ‚úÖ (Previously audited)
   - Friendship message logic verified
   - Display positioning and styling complete

4. **Toggle Button Implementation** ‚úÖ (Previously audited)
   - Toggle button consistency across panels verified
   - Flex utilities usage correct

5. **Hand-Feed System** ‚úÖ (Previously audited)
   - Food selection dialog verified
   - Cooldown system implementation complete
   - Bedding type select truncation fix working

6. **Animation Systems** ‚úÖ **NEW AUDIT**
   - Guinea pig chomp animation (chewing chew toys)
   - Guinea pig wiggle during player interactions
   - Animation timing, priorities, and paused states

7. **Visual Display Systems** ‚úÖ **NEW AUDIT**
   - Guinea pig sprite offsets (same shelter stacking fix)
   - Offset calculation and rendering

8. **Bug Fixes** ‚úÖ **NEW AUDIT**
   - clearAllStorage() rewrite
   - Activity feed auto-scroll direction fix
   - Tooltip hover grace period implementation
   - Hay duplication bug fix + duplicate drop handler removal

9. **Social Bonding** ‚úÖ **NEW AUDIT**
   - Sleeping-together bonding bonus (System 24)
   - Bond event recording

10. **Interaction Systems** ‚úÖ **NEW AUDIT**
    - Gentle pet wipe interaction (hygiene boost)
    - Interaction cooldown tracking

**Files Audited:**
- [habitatConditions.ts](../src/stores/habitatConditions.ts) ‚úÖ
- [guineaPigStore.ts](../src/stores/guineaPigStore.ts) ‚úÖ
- [bondingProgression.ts](../src/utils/bondingProgression.ts) ‚úÖ
- [CleanCageDialog.vue](../src/components/game/dialogs/CleanCageDialog.vue) ‚úÖ
- [FoodSelectionDialog.vue](../src/components/game/dialogs/FoodSelectionDialog.vue) ‚úÖ
- [SocializeSidebar.vue](../src/components/game/habitat/sidebars/SocializeSidebar.vue) ‚úÖ
- [HabitatDebug.vue](../src/components/debug/environment/HabitatDebug.vue) ‚úÖ
- [AutonomyDebug.vue](../src/components/debug/environment/AutonomyDebug.vue) ‚úÖ
- **[GuineaPigSprite.vue](../src/components/game/habitat/GuineaPigSprite.vue)** ‚úÖ **NEW**
- **[useGuineaPigBehavior.ts](../src/composables/game/useGuineaPigBehavior.ts)** ‚úÖ **NEW**
- **[behaviorStateStore.ts](../src/stores/behaviorStateStore.ts)** ‚úÖ **NEW**
- **[interactionEffects.ts](../src/utils/interactionEffects.ts)** ‚úÖ **NEW**
- **[UtilityNav.vue](../src/components/layout/UtilityNav.vue)** ‚úÖ **NEW**
- **[ActivityFeed.vue](../src/components/game/ui/ActivityFeed.vue)** ‚úÖ **NEW**
- **[HabitatItemPopover.vue](../src/components/game/habitat/HabitatItemPopover.vue)** ‚úÖ **NEW**
- **[useHabitatContainers.ts](../src/composables/useHabitatContainers.ts)** ‚úÖ **NEW**

**Checklist:**
- [x] Run TypeScript strict mode check ‚úÖ Build passes
- [x] Review all `TODO` and `FIXME` comments ‚úÖ Only 3 found, all future features
- [x] Check for unused imports and variables ‚úÖ None found
- [x] Verify error handling in new functions ‚úÖ All have proper guards and returns
- [x] Check for magic numbers (should use constants) ‚úÖ Most fixed, 1 minor issue found
- [x] Review computed property dependencies ‚úÖ All properly defined
- [x] Verify reactive updates work correctly ‚úÖ Map recreation pattern used correctly
- [x] Check for memory leaks (intervals, listeners) ‚úÖ **2 minor risks found**
- [x] Review animation systems ‚úÖ Properly implemented
- [x] Review bug fixes ‚úÖ All working correctly
- [x] Check for production console.logs ‚úÖ **Excessive logging found in behavior system**

**Code Quality Issues Fixed (Previous Audit):**
1. **habitatConditions.ts** - Replaced magic numbers (5, 10, 15) with `CONSUMPTION.WATER_MINIMUM_LEVEL`, `WATER_CONSUMPTION_MIN`, `WATER_CONSUMPTION_MAX`
2. **guineaPigStore.ts** - Fixed parameter name `hoursToAdd` ‚Üí `minutesToAdd` to match actual usage
3. **supplies.ts** - Added water consumption constants to centralized config

**Performance & Efficiency Fixes (Previous Audit):**
1. **üî¥ CRITICAL: SocializeSidebar.vue** - Fixed memory leak where `setInterval` created new Map every second
   - **Before:** `interactionCooldowns.value = new Map(interactionCooldowns.value)` every 1000ms
   - **After:** Interval only runs when cooldown active, auto-stops when expired
   - **Impact:** Eliminates unnecessary re-renders and Map allocations

2. **friendshipMessages.ts** - Extracted duplicate functions (38 lines ‚Üí shared utility)
   - Removed duplicate `getBondStrengthMessage()` and `getPlayerFriendshipMessage()`
   - Created shared utility with threshold-based lookup
   - **Impact:** DRY principle, easier to maintain message thresholds

3. **guineaPigStore.ts** - Added `getBondsForGuineaPig(id)` optimized method
   - **Before:** `getAllBonds().filter(bond => ...)` - O(n) get all + O(n) filter
   - **After:** Direct iteration with early returns - O(n) single pass
   - **Impact:** Faster bond lookups for UI rendering

4. **bondingProgression.ts** - Lazy-initialized cached store instances
   - **Before:** Called `useGuineaPigStore()` etc. every game tick per bond
   - **After:** Lazy initialization on first call, then cached (prevents circular dependency errors)
   - **Impact:** Eliminates repeated store initialization overhead while avoiding module-load issues

5. **FoodSelectionDialog.vue** - Optimized filtering logic
   - **Before:** `.map().filter()` - created objects then discarded them
   - **After:** Check quantity first, only create objects for items with stock
   - **Impact:** Fewer object allocations, faster filtering

6. **CleanCageDialog.vue** - Removed `!important` flag, used specificity instead
   - Changed `.text-warning` to `.bedding-info__value.text-warning`
   - **Impact:** Better CSS maintainability, follows BEM standards

**NEW Issues Found (Extended Audit):**

**üü° MEDIUM - Production Console.logs**
- **File:** [useGuineaPigBehavior.ts](../src/composables/game/useGuineaPigBehavior.ts)
- **Lines:** 596-710 (eat behavior), 973-1055 (eat hay behavior)
- **Issue:** 18+ console.log statements in production code
- **Impact:** Performance overhead, clutters console, not suitable for production
- **Recommendation:** Remove or wrap in `DEBUG_BEHAVIOR` flag (like `DEBUG_SOCIALIZE` on line 57)
- **Priority:** Medium (not breaking, but should be cleaned up)

**üü° MINOR - Memory Leak Risk: Uncleaned Timeout**
- **File:** [HabitatItemPopover.vue](../src/components/game/habitat/HabitatItemPopover.vue)
- **Line:** 74: `let hideTimeout: number | null = null`
- **Issue:** Timeout may not be cleared if component unmounts while timeout is pending
- **Impact:** Low risk - timeout is short (200-300ms), but cleanup is best practice
- **Recommendation:** Add `onUnmounted(() => { if (hideTimeout) clearTimeout(hideTimeout) })`
- **Priority:** Low (minor cleanup)

**üü° MINOR - Memory Leak Risk: Untracked setTimeout**
- **File:** [behaviorStateStore.ts](../src/stores/behaviorStateStore.ts)
- **Line:** 73: `setTimeout(() => { ... }, duration)`
- **Issue:** If guinea pig is removed from store before timeout completes, timeout will still execute
- **Impact:** Very low risk - just sets activity to idle on deleted guinea pig (no-op)
- **Recommendation:** Track timeout reference and add cleanup in `removeBehaviorState()`
- **Priority:** Low (edge case, minimal impact)

**üü¢ MINOR - Magic Number**
- **File:** [GuineaPigSprite.vue](../src/components/game/habitat/GuineaPigSprite.vue)
- **Line:** 51: `const CELL_SIZE = 60`
- **Issue:** Magic number duplicated from HabitatVisual
- **Impact:** Minimal - but creates maintenance risk if cell size changes
- **Recommendation:** Import from shared constants or props
- **Priority:** Low (not urgent)

**Verified Working:**
- Smart bedding system with proportional consumption ‚úÖ
- Bond proximity time tracking with reactivity ‚úÖ
- Fractional quantity tracking (amountRemaining) ‚úÖ
- Error handling in cleanCage() function ‚úÖ
- Food selection dialog with category filtering ‚úÖ
- All performance optimizations pass TypeScript strict mode ‚úÖ
- **Guinea pig chomp animation** ‚úÖ **NEW**
- **Guinea pig interaction wiggle animation** ‚úÖ **NEW**
- **Gentle wipe interaction (hygiene/comfort boost)** ‚úÖ **NEW**
- **Sleeping-together bonding bonus** ‚úÖ **NEW**
- **Sprite offset rendering (no stacking)** ‚úÖ **NEW**
- **clearAllStorage() proper sequencing** ‚úÖ **NEW**
- **Activity feed scroll to top (newest first)** ‚úÖ **NEW**
- **Tooltip hover grace period** ‚úÖ **NEW**
- **Hay duplication fix (infinite resource exploit eliminated)** ‚úÖ **NEW**

**Animation System Review:**
- ‚úÖ Chomp animation triggers correctly on chewing activity
- ‚úÖ Interaction wiggle animation triggers on all player interactions
- ‚úÖ Animation priorities handled with `!important` (playing/chewing/interacting > walking)
- ‚úÖ Paused states comprehensive (lines 218-234 in GuineaPigSprite.vue)
- ‚úÖ CSS uses BEM naming (`.guinea-pig-sprite--chewing`)
- ‚úÖ CSS uses logical properties throughout
- ‚úÖ Flipped animations for left-facing guinea pigs
- ‚úÖ `triggerPlayerInteraction()` helper properly sets duration and auto-returns to idle

**Bug Fix Verification:**
- ‚úÖ **clearAllStorage()** properly sequences: stop game loop ‚Üí clear habitat ‚Üí clear guinea pigs ‚Üí clear storage ‚Üí delay ‚Üí reload
- ‚úÖ **Activity feed** scrolls to top (line 161), matches reverse display order
- ‚úÖ **Tooltip hover** grace period (200ms) with popover hover detection prevents disappearing
- ‚úÖ **Hay duplication** fix removes incorrect `addConsumableWithServings()` call (useHabitatContainers.ts:297)
- ‚úÖ **Duplicate drop handlers** removed from HabitatVisual (prevents double consumption)

**Social Bonding Verification:**
- ‚úÖ **Sleeping together** bonus (+2 bond points) when both guinea pigs sleeping at same position
- ‚úÖ Bond event recorded with description in bond history
- ‚úÖ Activity feed shows cuddle message with location
- ‚úÖ Works for any shared sleeping location (shelters, beds, floor)

**Code Quality Summary:**
- **Total Files Audited:** 17 files (8 previously + 9 new)
- **Critical Issues:** 0
- **Medium Issues:** 1 (console.logs in production)
- **Minor Issues:** 2 (timeout cleanup edge cases) + 1 (magic number)
- **Systems Verified Working:** 15 systems (5 previous + 10 new)
- **Overall Assessment:** Code quality is excellent, only minor cleanup needed

---

#### CSS Audit & Consistency Check
**Priority:** HIGH
**Status:** ‚úÖ Completed
**Category:** Code Quality

**Goal:** Ensure CSS follows project standards and uses utilities where appropriate

**Audit Results:** See [CSS-AUDIT-SPRINT-2025-11-02.md](audits/CSS-AUDIT-SPRINT-2025-11-02.md)

**Files Audited:** 9 components from SPRINT-2025-11-02.md
- [CleanCageDialog.vue](../src/components/game/dialogs/CleanCageDialog.vue) ‚úÖ EXCELLENT (10/10)
- [FoodSelectionDialog.vue](../src/components/game/dialogs/FoodSelectionDialog.vue) ‚úÖ EXCELLENT (10/10)
- [SocializeSidebar.vue](../src/components/game/habitat/sidebars/SocializeSidebar.vue) ‚úÖ GOOD (9/10)
- [GuineaPigSprite.vue](../src/components/game/habitat/GuineaPigSprite.vue) ‚úÖ EXCELLENT (10/10)
- [HabitatDebug.vue](../src/components/debug/environment/HabitatDebug.vue) ‚úÖ GOOD (8.5/10)
- [ActivityFeed.vue](../src/components/game/ui/ActivityFeed.vue) ‚úÖ EXCELLENT (10/10)
- [HabitatItemPopover.vue](../src/components/game/habitat/HabitatItemPopover.vue) ‚úÖ EXCELLENT (10/10)
- [AutonomyDebug.vue](../src/components/debug/environment/AutonomyDebug.vue) ‚úÖ EXCELLENT (10/10)
- [UtilityNav.vue](../src/components/layout/UtilityNav.vue) ‚úÖ EXCELLENT (10/10)

**Overall Score: 9.6/10** - Excellent CSS Quality

**Checklist:**
- [x] No inline styles (use utility classes) ‚úÖ All fixed
- [x] BEM naming convention followed ‚úÖ 100% compliance
- [x] Logical properties used (margin-inline, etc.) ‚úÖ 100% usage
- [x] CSS variables used for spacing/colors ‚úÖ 100% usage
- [x] No !important flags (unless absolutely necessary) ‚úÖ Only 1 found, uses specificity
- [x] Mobile-first media queries ‚úÖ All components mobile-first
- [x] Container queries used where appropriate ‚ö™ Not yet adopted project-wide

**Minor Improvements Applied:**
- ‚úÖ SocializeSidebar.vue - Replaced custom `.bond-status` with `.panel .panel--compact` utility
- ‚úÖ HabitatDebug.vue - Replaced custom `.food-bowl-container` with `.panel .panel--compact` utility
- ‚úÖ CSS file size decreased: 134.16 kB ‚Üí 133.73 kB (0.43 kB saved)

**Key Findings:**
- ‚úÖ Perfect BEM naming convention adherence
- ‚úÖ 100% logical properties usage (RTL-ready)
- ‚úÖ Exclusive use of CSS variables (no magic numbers)
- ‚úÖ Zero inline styles
- ‚úÖ Mobile-first responsive design throughout
- ‚úÖ Accessibility-first animations with `prefers-reduced-motion`

---

### High Priority Bugs üî•

#### Guinea Pigs Stop Autonomous Behavior When Window Loses Focus ‚úÖ
**Priority:** HIGH
**Status:** ‚úÖ Complete
**Category:** Core Gameplay

**Issue:** When the game is running but user switches to a different program, guinea pigs fail to fulfill their needs or do any other autonomous actions (pooping still works).

**Solution Implemented:** Page Visibility API with automatic pause and PauseOverlay dialog

**Implementation:**
1. Added Page Visibility API listener in [App.vue](../src/App.vue)
2. Automatically pauses game when `document.hidden` is true (tab switch/window minimize)
3. Shows configurable [PauseOverlay](../src/components/game/dialogs/PauseOverlay.vue) dialog
4. Added `'visibility'` pause reason to [gameController.ts](../src/stores/gameController.ts)
5. Supports multiple pause reasons with context-aware messaging (manual, visibility, orientation, navigation)

**User Experience:**
- Tab switch ‚Üí Game pauses ‚Üí Overlay appears with clear message
- User can "Resume Game" or "Close and Pause" (dismiss overlay, keep paused)
- Overlay also used for manual pause with appropriate messaging

**Files Modified:**
- [App.vue](../src/App.vue) - Page Visibility API integration, pause watcher
- [gameController.ts](../src/stores/gameController.ts) - Added visibility pause reason, isVisibilityPaused computed
- [PauseOverlay.vue](../src/components/game/dialogs/PauseOverlay.vue) - Configurable pause dialog (created)

---

## ‚öôÔ∏è **Phase 2.5 Systems**

**Note:** These systems were deferred during Phase 4 development and need to be implemented before Phase 5.

### System 10.1: Personality Trait Influences on Interactions
**Priority:** HIGH
**Status:** üìã Not Started
**Category:** Social System Enhancement

**Documentation:** [System 10.1](systems/phase2.5/system-10.1-personality-influences.md)

**Goal:** Personality traits affect how guinea pigs respond to player interactions

**Key Features:**
- Shy guinea pigs: lower acceptance rate for handling/play
- Bold guinea pigs: higher acceptance rate, more eager
- Calm guinea pigs: longer tolerance for interactions
- Energetic guinea pigs: prefer active interactions (play > petting)

---

### System 10.2.5: Fulfillment Limitation System
**Priority:** HIGH
**Status:** üìã Not Started
**Category:** Food & Wellness System

**Documentation:** [System 10.2.5](systems/phase2.5/system-10.2.5-fulfillment-limitation.md)

**Goal:** Limit food consumption per hunger cycle to prevent spam feeding

**Key Features:**
- 5 servings max per hunger cycle (excludes hay)
- Hay unlimited (always available)
- Prevents overfeeding exploits
- More realistic feeding patterns

**Includes:** Food Serving Guide UI component (see documentation)

---

### System 10.3: Wellness-Based Interaction Reactions
**Priority:** HIGH
**Status:** üìã Not Started
**Category:** Social System Enhancement

**Documentation:** [System 10.3](systems/phase2.5/system-10.3-wellness-reactions.md)

**Goal:** Guinea pig wellness affects interaction acceptance rates

**Key Features:**
- High wellness (>70): more accepting, lower rejection rate
- Low wellness (<30): more rejections, needs rest/care
- Creates gameplay loop: good care ‚Üí better interactions ‚Üí higher friendship

---

### Needs System Fixes üéØ

#### Add Nails Need to Needs Display ‚úÖ
**Priority:** HIGH
**Status:** ‚úÖ Complete
**Category:** Bug Fix

**Issue:** Nails need was not visible in the needs section display, though it existed in the data model.

**Root Cause:** The `'nails'` need type was missing from the `wellnessNeeds` array in NeedsPanel.vue (line 109).

**Solution:** Added `'nails'` to the `wellnessNeeds` category array.

**Files Modified:**
- [NeedsPanel.vue](../src/components/debug/environment/NeedsPanel.vue) - Added 'nails' to wellnessNeeds array

**Verification:**
- NeedBar.vue already had 'nails' in formatNeedName mapping (line 116) ‚úÖ
- Nails need now displays in Wellness Needs section
- Replenish All Needs button now includes nails in the operation

---

#### Adjust Thirst Decay Rate ‚úÖ
**Priority:** HIGH
**Status:** ‚úÖ Complete
**Category:** Game Balance

**Issue:** Needs decaying 2 points per tick creating unfair death spirals.

**Root Causes:**
1. Decay rates designed for 5-sec ticks, game runs 1-sec ticks
2. Health/wellness modifiers compounded decay, creating death spirals

**Solution - Two-Part Fix:**

**Part 1: Recalibrated decay rates (11 needs):**
- Critical: hunger: 10, thirst: 8, energy: 7, shelter: 9
- Environmental: play: 5, social: 4, comfort: 3
- Maintenance: hygiene: 3, nails: 0.5, health: 1, chew: 2.5

**Part 2: Removed death spiral modifiers:**
- ‚ùå Removed age modifier (0.5x-2.0x)
- ‚ùå Removed health modifier (accelerated hunger/thirst when low)
- ‚úÖ Kept personality modifiers (stable)
- ‚úÖ Kept bonding modifiers (positive only)

**Result:** Fair, consistent decay without wellness spirals

**Files Modified:**
- [guineaPigStore.ts](../src/stores/guineaPigStore.ts) - Lines 439-456, 609-643

---

#### Needs System Reframing: From "Death Meter" to "Comfortable Guinea Pig" ‚úÖ
**Priority:** HIGH
**Status:** ‚úÖ Complete
**Category:** Game Design & Balance

**Philosophy Shift:** The needs system was reframed from a "survival panic" model to a "comfortable guinea pig" model where guinea pigs autonomously fulfill needs before they become critical.

**Key Changes:**

**1. Behavior Threshold Adjustments:**
- Guinea pigs now seek fulfillment at comfortable levels (40-65% range)
- Prevents emergency situations in normal gameplay
- Final thresholds after iterative balancing:
  - hunger: 65% (seek food when satisfaction drops below 65%)
  - thirst: 60%
  - energy: 60%
  - shelter: 65%
  - hygiene: 55%
  - chew: 55%
  - play: 50%
  - social: 50%

**2. Need Bar Color System Redesign:**
- **Old System:** Orange/red warning colors appeared too early
- **New System:** More gradual, less alarming progression
  - **Green (60-100%):** Satisfied, guinea pig comfortable
  - **Grey (40-60%):** Okay, not urgent
  - **Yellow (30-40%):** Getting low, attention recommended
  - **Red (0-30%):** Low, guinea pig uncomfortable

**3. Status Text Updates:**
- Replaced alarming language with neutral descriptions:
  - "Satisfied" (60-100%)
  - "Okay" (40-60%)
  - "Getting Low" (30-40%)
  - "Low" (0-30%)

**Design Rationale:**
- 30-40% satisfaction is **not a bad thing** in this model
- Guinea pigs proactively manage their needs
- Needs decay provides engagement without stress
- Penalties only occur when needs fall critically low (prolonged neglect)

**Files Modified:**
- [autonomySettingsStore.ts](../src/stores/autonomySettingsStore.ts) - Updated DEFAULT_THRESHOLDS (lines 12-21)
- [NeedBar.vue](../src/components/game/ui/NeedBar.vue) - Updated color thresholds and status text (lines 45-58, 140-161)
- [NeedRow.vue](../src/components/basic/NeedRow.vue) - Updated urgency calculation (lines 42-47)

**Player Feedback Integration:**
> "i think this is less of '0 is the need is totally drained' and more of 'the point in which they seek fulfillment is when it starts to bother the guinea pig a little bit' but not dire. the guinea pig can choose what to do and is just going to fulfill needs as needed. i think with that we should use less reds in the needs bars, because it isn't a 'death' meter, but more of a timer to when the guinea pig gets it."

This reframing creates a more relaxed, observation-focused gameplay experience rather than constant emergency management.

---

#### Hide Age Display (Defer to Phase 5+) ‚úÖ
**Priority:** LOW
**Status:** ‚úÖ Complete
**Category:** Code Cleanup

**Issue:** Age was displayed in guinea pig tooltip but no aging mechanics exist yet. Age field exists in data model but has no gameplay impact.

**Decision:** Temporarily hide age display until proper aging system is implemented (Phase 5+).

**What Was Done:**
- Commented out age calculation in tooltip (line 88)
- Removed "Age: X days" from tooltip display (line 96)
- Added comment: "temporarily hidden - will be re-enabled with aging system"

**What Remains Unchanged:**
- `birthDate` field still stored
- `stats.age` field still calculated on creation
- Age data preserved for future aging feature

**Files Modified:**
- [GuineaPigSprite.vue](../src/components/game/habitat/GuineaPigSprite.vue) - Lines 87-88, 96

**Reasoning:**
- Age was only cosmetic data with no gameplay effect
- Discovered age was being used in unfair death spiral modifiers (now removed)
- Cleaner to hide until proper aging mechanics designed

---

#### Add "Clip Nails" Interaction ‚úÖ
**Priority:** MEDIUM
**Status:** ‚úÖ Complete
**Category:** Player Interactions

**Goal:** Add player interaction to fulfill the nails need, complementing the existing hygiene interaction (gentle wipe).

**Implementation:**

**1. New Interaction Button:**
- Added "‚úÇÔ∏è Clip Nails" button to Basic Interactions section in [SocializeSidebar.vue](../src/components/game/habitat/sidebars/SocializeSidebar.vue)
- Positioned after "Gentle Wipe" for logical grouping of care actions

**2. Interaction Effects:**
- **Nails Need:** +100 (fully restores)
- **Comfort Need:** -5 (guinea pigs tolerate but don't enjoy nail clipping)
- **Friendship Gain:** +1 (minimal, it's necessary care not fun)
- **Cooldown:** 600 seconds (10 minutes)

**3. Smart Availability:**
- Button disabled when nails ‚â• 75%
- Tooltip feedback: "Nails are still good (wait until below 75%)"
- Prevents unnecessary/excessive nail clipping

**4. Consistent UX Pattern:**
Applied need-based disabling to related interactions:
- **Hand Feed:** Disabled when hunger ‚â• 95%
- **Gentle Wipe:** Disabled when hygiene ‚â• 75%
- **Clip Nails:** Disabled when nails ‚â• 75%

**Files Modified:**
- [SocializeSidebar.vue](../src/components/game/habitat/sidebars/SocializeSidebar.vue) - Added button, disabled states, tooltips (lines 116-125, 286-336)
- [HabitatDebug.vue](../src/components/debug/environment/HabitatDebug.vue) - Added clip-nails event handler (line 96)
- [interactionEffects.ts](../src/utils/interactionEffects.ts) - Added clip-nails effect data, name, and emoji (lines 41-45, 98, 118)

**Design Notes:**
- Nails decay very slowly (0.5 rate vs 3-10 for other needs)
- 75% threshold means player clips nails roughly every 200 minutes of gameplay
- Reflects realistic guinea pig nail care frequency
- Small comfort penalty creates authentic care experience

---

### UI/UX Improvements üé®

#### Prevent Emoji Selection During Drag & Drop ‚úÖ
**Priority:** MEDIUM
**Status:** ‚úÖ Complete
**Category:** User Experience

**Issue:** Emojis were being accidentally selected/highlighted when trying to drag and drop items in the habitat, creating a poor user experience.

**Solution:** Added CSS `user-select: none` utility class to all draggable emoji elements.

**Implementation:**

**1. Created `.no-select` Utility Class:**
```css
.no-select {
  user-select: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
}
```

**2. Applied to All Draggable Elements:**
- **Habitat Items:**
  - [FoodBowl.vue](../src/components/game/habitat/FoodBowl.vue) - Bowl emoji
  - [HayRack.vue](../src/components/game/habitat/HayRack.vue) - Ladder and hay emojis
  - [WaterBottle.vue](../src/components/game/habitat/WaterBottle.vue) - Water droplet emoji
  - [ChewItem.vue](../src/components/game/habitat/ChewItem.vue) - Chew item emoji
  - [Poop.vue](../src/components/game/habitat/Poop.vue) - Poop emoji
  - [PelletsVisual.vue](../src/components/game/habitat/PelletsVisual.vue) - Pellet emojis

- **Interactive Elements:**
  - [GuineaPigSprite.vue](../src/components/game/habitat/GuineaPigSprite.vue) - Guinea pig emoji
  - [InventorySidebar.vue](../src/components/game/habitat/sidebars/InventorySidebar.vue) - Draggable inventory item emojis and text

**Files Modified:**
- [base.css](../src/styles/base.css) - Added `.no-select` utility class (lines 227-232)
- 8 Vue component files - Applied class to emoji elements

**Result:** Users can now drag and drop items without accidentally selecting text or emojis, creating a smoother interaction experience.

**Bonus Refactor:**
- Discovered [Poop.vue](../src/components/game/habitat/Poop.vue) was dead code (not being used)
- Poops were being rendered as raw emojis in [HabitatVisual.vue](../src/components/game/habitat/HabitatVisual.vue)
- Refactored to use the Poop component properly for encapsulation and consistency with other habitat items
- Removed obsolete `handleSubgridItemClick` function

---

#### Replace Bond Progress Bar with Slider Component ‚úÖ
**Priority:** MEDIUM
**Status:** ‚úÖ Complete
**Category:** UI Enhancement

**Issue:** Bond progress bars (both player friendship and companion bonds) didn't visually update as bond levels increased due to CSS transition issues.

**Solution:** Replaced custom bond progress bar implementation with the SliderField component in read-only mode (disabled state).

**Implementation:**

**1. Replaced Player Friendship Bar:**
```vue
<SliderField
  :model-value="Math.round(selectedGuineaPig.friendship)"
  :min="0"
  :max="100"
  :step="1"
  disabled
  size="sm"
  suffix="%"
  @update:model-value="() => {}"
/>
```

**2. Replaced Companion Bond Bars:**
```vue
<SliderField
  :model-value="Math.round(bondInfo.bond.bondingLevel)"
  :min="0"
  :max="100"
  :step="1"
  disabled
  size="sm"
  suffix="%"
  @update:model-value="() => {}"
/>
```

**3. Removed Obsolete CSS:**
- Removed `.bond-progress`, `.bond-progress__bar`, `.bond-progress__fill`, `.bond-progress__label` styles
- Kept `.bond-stats`, `.bond-stat`, `.bond-status__header`, and `.bond-tier` styles

**Files Modified:**
- [SocializeSidebar.vue](../src/components/game/habitat/sidebars/SocializeSidebar.vue) - Replaced both friendship and companion bond progress bars

**Benefits:**
- ‚úÖ Bond levels now update visually in real-time
- ‚úÖ Consistent UI with other progress displays (SliderField component)
- ‚úÖ Native browser range input provides smooth visual feedback
- ‚úÖ Reduced custom CSS maintenance

---

#### Add Confirmation Button to Hand-Feed Dialog ‚úÖ
**Priority:** MEDIUM
**Status:** ‚úÖ Complete
**Category:** UX Improvement

**Issue:** Clicking a food item in the hand-feed dialog immediately fed it, leading to accidental feeding.

**Solution:** Implemented two-step confirmation process for safer interaction.

**Implementation:**

**1. Added Selection State:**
- Added `selectedFoodId` ref to track currently selected food
- Updated `selectFood()` to only set selection (not immediately feed)
- Created new `confirmFeed()` function to handle actual feeding

**2. Visual Selection Feedback:**
```css
.food-item--selected {
  border-color: var(--color-primary);
  background-color: var(--color-primary-bg);
}
```

**3. Added Feed Button:**
- Primary "Feed" button in footer (only enabled when food selected)
- Cancel button (tertiary) to close dialog without feeding
- Footer uses flex layout with gap for proper spacing

**User Flow:**
1. User opens hand-feed dialog
2. User clicks a food item ‚Üí item highlights with selection state
3. User clicks "Feed" button ‚Üí guinea pig is fed and dialog closes
4. Selection resets for next use

**Files Modified:**
- [FoodSelectionDialog.vue](../src/components/game/dialogs/FoodSelectionDialog.vue) - Added selection state, confirmation button, and visual feedback

**Benefits:**
- ‚úÖ Prevents accidental feeding
- ‚úÖ Clear visual feedback of selection
- ‚úÖ Explicit confirmation step
- ‚úÖ Better UX for deliberate actions

---

### Habitat Item System üè†

#### Enable Treats to be Hand-Fed
**Priority:** HIGH
**Status:** ‚úÖ Complete
**Category:** Gameplay Feature

**Issue:** Treats didn't appear in hand-feed dialog, but they should be available alongside regular food.

**Implementation:**
- Added "Treats" category to food selection dialog with üç™ emoji
- Treats now appear alongside vegetables, greens, fruits, herbs, and pellets
- Uses existing `suppliesStore.itemsBySubCategory('treats')` to query treats
- Treats are hand-fed using standard hand-feed interaction
- Works with the two-step confirmation process (select treat ‚Üí click Feed button)

```typescript
const foodCategories = [
  { id: 'vegetables', label: 'Vegetables', emoji: 'ü•ï' },
  { id: 'greens', label: 'Greens', emoji: 'ü•¨' },
  { id: 'fruits', label: 'Fruits', emoji: 'üçì' },
  { id: 'herbs', label: 'Herbs', emoji: 'üåø' },
  { id: 'pellets', label: 'Pellets', emoji: 'üü§' },
  { id: 'treats', label: 'Treats', emoji: 'üç™' } // ‚Üê NEW
]
```

**Files Modified:**
- [FoodSelectionDialog.vue](../src/components/game/dialogs/FoodSelectionDialog.vue) - Added treats category (line 106)

**Current Behavior:**
- ‚úÖ Treats appear in hand-feed dialog under "Treats" category
- ‚úÖ Players can hand-feed treats to guinea pigs
- ‚úÖ Treats consumed from inventory when hand-fed

---

#### Add "Fill Hay Rack" Buttons (Global + Individual)
**Priority:** MEDIUM
**Status:** ‚úÖ Complete
**Category:** UX Improvement

**Issue:** Players had to manually drag hay servings into hay racks one at a time, which was tedious especially with multiple racks.

**Implementation:**

**1. Global "Fill All Hay Racks" Button**
- Added to Habitat Care Sidebar under Core Care section
- Fills ALL hay racks in habitat sequentially until hay inventory is exhausted
- Distributes hay across all racks with empty slots
- Button disabled when: no hay racks exist, all racks full, or no hay in inventory
- Shows contextual tooltip explaining why button is disabled

**2. Individual "Fill This Rack" Button**
- Added to each hay rack's popover (alongside Empty Hay Rack button)
- Fills ONLY the selected hay rack with available hay
- Only appears when rack has empty slots
- Uses same underlying logic as global button

**Implementation Details:**

**Core Implementation (useHabitatContainers.ts):**
```typescript
function fillAllHayRacks(hayRackInstanceIds: string[]): { totalAdded: number, racksFilled: number } {
  // Finds available hay in inventory
  // Iterates through each rack, filling empty slots
  // Consumes hay from inventory using existing addHayToRack logic
  // Returns count of servings added and racks filled
}
```

**Button State Logic:**
- Checks for hay racks in habitat
- Checks for empty slots in any rack
- Checks for hay inventory with available servings
- Shows contextual tooltip based on state

**Files Modified:**
- [useHabitatContainers.ts](../src/composables/useHabitatContainers.ts) - Added `fillAllHayRacks()` function
- [habitatConditions.ts](../src/stores/habitatConditions.ts) - Exposed `fillAllHayRacks` from composable
- [HabitatCareSidebar.vue](../src/components/game/habitat/sidebars/HabitatCareSidebar.vue) - Added global fill button with disabled state and tooltip props
- [HabitatDebug.vue](../src/components/debug/environment/HabitatDebug.vue) - Added computed properties for button state and handler
- [HayRack.vue](../src/components/game/habitat/HayRack.vue) - Added fill-rack action to popover when rack has empty slots
- [HabitatVisual.vue](../src/components/game/habitat/HabitatVisual.vue) - Added handler for individual rack fill

**Current Behavior:**
- ‚úÖ Global "Fill All Hay Racks" button in Habitat Care Sidebar (Core Care section)
- ‚úÖ Individual "Fill Rack" button in each hay rack's popover
- ‚úÖ Smart disabled states with contextual tooltips
- ‚úÖ Both buttons use available hay from inventory
- ‚úÖ Automatically consumes servings from inventory
- ‚úÖ Activity feed logging for global fill action
- ‚úÖ Console logging for individual rack fills

**Benefits:**
- ‚úÖ Significantly faster hay rack management
- ‚úÖ Handles multiple hay racks intelligently
- ‚úÖ Consistent UX pattern with Refill Bedding button
- ‚úÖ Flexible: bulk fill OR targeted fill
- ‚úÖ Eliminates tedious manual dragging

---

#### Show Friendship Points Value in Socialize Sidebar
**Priority:** MEDIUM
**Status:** ‚úÖ Complete
**Category:** UX Improvement

**Issue:** The Socialize Sidebar shows bond progress bars (SliderField components in disabled mode) but doesn't display the actual numeric friendship value. Players should be able to see exact friendship points alongside the visual progress bar.

**Implementation:**
Added numeric friendship value display above the SliderField components in SocializeSidebar.vue:
- Player bond: Shows "Friendship: X%" label above slider
- Companion bond: Shows "Bond Level: X%" label above slider
- Clean layout with label on left, value on right

**Layout:**
```
Friendship:        72%
[===============---] 72%
Content message here
```

**Files Modified:**
- [SocializeSidebar.vue](../src/components/game/habitat/sidebars/SocializeSidebar.vue) - Added `.friendship-value` display component with BEM styling

**Implementation Details:**
```vue
<div class="friendship-value">
  <span class="friendship-value__label">Friendship:</span>
  <span class="friendship-value__number">{{ Math.round(selectedGuineaPig.friendship) }}%</span>
</div>
```

**CSS Styling:**
- `.friendship-value`: Flexbox layout with space-between
- `.friendship-value__label`: Secondary text color, medium weight
- `.friendship-value__number`: Primary text color, semibold weight, larger size
- Margin below to separate from SliderField

**Current Behavior:**
- ‚úÖ Player friendship shows numeric value above progress bar
- ‚úÖ Companion bond levels show numeric values above each bond progress bar
- ‚úÖ Values update in real-time as friendship/bonds change
- ‚úÖ Clean, readable layout consistent with sidebar design

**Time Taken:** ~20 minutes

---

#### Create Read-Only Progress Bar Component for Game View
**Priority:** MEDIUM
**Status:** ‚úÖ Complete
**Category:** Component Development

**Issue:** SliderField components are currently used for both debug (editable) and game view (read-only display). While SliderField works when disabled, a dedicated read-only progress bar component is more semantically appropriate and simpler for displaying needs and friendship meters in the game view.

**Implementation:**
Created a new `ProgressBar.vue` component in `src/components/basic/` with the following features:

**Component Props:**
```typescript
interface Props {
  value: number           // Current value
  min?: number           // Minimum value (default: 0)
  max?: number           // Maximum value (default: 100)
  label?: string         // Optional label text
  suffix?: string        // Optional suffix (e.g., '%')
  showValue?: boolean    // Show numeric value (default: false)
  variant?: 'critical' | 'warning' | 'medium' | 'good' | 'satisfied' | 'default'
  size?: 'sm' | 'md' | 'lg'  // Size variants
  ariaLabel?: string     // Custom aria-label for accessibility
}
```

**Features:**
- ‚úÖ Clean visual progress bar (no slider thumb)
- ‚úÖ Flexible layout with optional label and value display
- ‚úÖ Color variants matching NeedRow urgency levels:
  - `satisfied`: Green (var(--color-green-500))
  - `good`: Grey (var(--color-gray-500))
  - `medium`: Yellow (var(--color-yellow-500))
  - `warning`: Orange (var(--color-orange-500))
  - `critical`: Red (var(--color-red-500))
  - `default`: Primary color
- ‚úÖ Three size variants (sm: 6px, md: 8px, lg: 12px track height)
- ‚úÖ Full accessibility support (role="progressbar", aria-valuenow/min/max)
- ‚úÖ Smooth transitions (0.3s ease for width and color changes)
- ‚úÖ Automatic percentage calculation from min/max/value
- ‚úÖ BEM CSS methodology

**DOM Structure:**
```html
<div class="progress-bar progress-bar--{variant} progress-bar--{size}">
  <div class="progress-bar__label">Label</div>
  <div class="progress-bar__track" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100">
    <div class="progress-bar__fill" style="width: 75%"></div>
  </div>
  <div class="progress-bar__value">75%</div>
</div>
```

**Usage Examples:**
```vue
<!-- Simple progress bar -->
<ProgressBar :value="75" />

<!-- With label and value -->
<ProgressBar
  :value="hunger"
  label="Hunger"
  suffix="%"
  :show-value="true"
  variant="satisfied"
/>

<!-- Different sizes -->
<ProgressBar :value="50" size="sm" variant="warning" />
<ProgressBar :value="75" size="lg" variant="good" />
```

**Use Cases:**
- Needs display in game view (hunger, thirst, energy, etc.)
- Friendship meters in socialize sidebar (future refactor)
- Bond strength displays (future refactor)
- Any other read-only progress indicators

**Files Created:**
- [ProgressBar.vue](../src/components/basic/ProgressBar.vue) - Complete read-only progress component

**Potential Future Refactors:**
- NeedRow.vue - Could use ProgressBar instead of disabled SliderField
- SocializeSidebar.vue - Could use ProgressBar for friendship display
- Other components currently using disabled SliderField for display

**Benefits:**
- ‚úÖ Semantically correct (progress bar vs disabled slider)
- ‚úÖ Simpler component for simpler use case
- ‚úÖ Better accessibility (proper ARIA attributes)
- ‚úÖ Easier to style and customize
- ‚úÖ Cleaner DOM (no input element)
- ‚úÖ No confusion about "why is this slider disabled?"
- ‚úÖ Consistent color theming with existing need urgency system

**Note:** This component is now available for use throughout the application. SliderField will continue to be used in debug panels (where editing is needed), while ProgressBar can be used for read-only displays in the game view.

**Time Taken:** ~45 minutes

---

## üéØ **Future Work**

All future feature work has been moved to [Phase 5 Documentation](DEVELOPMENT_PHASES.md#phase-5-polish--enhancement-systems-22-29).

**Phase 5 Additional Polish Features:**
- Multi-Type Guinea Pig Interactions (play, groom, huddle/cuddle)
- Pushable Toys System
- Special Treat Visual Effects (glow effects, emoji transformations)
- Pre-Bonded Pairs & Solo Guinea Pigs adoption system
- Gameplay Testing & Balance
- Realism Guidelines Documentation

See [DEVELOPMENT_PHASES.md Phase 5](DEVELOPMENT_PHASES.md#phase-5-polish--enhancement-systems-22-29) for complete specifications

---

## üìù **Notes**

### Completed This Sprint ‚úÖ
- **Code Audit** - Comprehensive audit of 17 files from previous sprint
  - Created [CODE-AUDIT-2025-11-03.md](audits/CODE-AUDIT-2025-11-03.md)
  - Found and documented 1 medium + 3 minor issues
  - All systems verified working correctly

- **CSS Audit** - Comprehensive CSS standards audit of 9 components
  - Created [CSS-AUDIT-SPRINT-2025-11-02.md](audits/CSS-AUDIT-SPRINT-2025-11-02.md)
  - **Overall Score: 9.6/10** - Excellent quality
  - 100% BEM compliance, 100% logical properties, 100% CSS variables
  - Applied panel utility improvements to SocializeSidebar and HabitatDebug

- **Bug Fixes**
  - ‚úÖ Fixed CELL_SIZE magic number in GuineaPigSprite (now uses prop from parent)
  - ‚úÖ Memory leak fixes from previous sprint verified
  - ‚úÖ Fixed emoji selection during drag & drop (added `.no-select` utility class)
  - ‚úÖ Refactored Poop component - was dead code, now properly integrated in HabitatVisual
  - ‚úÖ Fixed bond progress bars not updating visually (replaced with SliderField component)
  - ‚úÖ Added hand-feed confirmation button (prevents accidental feeding)

- **Needs System Improvements**
  - ‚úÖ Recalibrated all 11 needs decay rates for 1-second game loop
  - ‚úÖ Removed death spiral modifiers (age/health compounding)
  - ‚úÖ Reframed needs system philosophy: "comfortable guinea pig" vs "death meter"
  - ‚úÖ Updated behavior thresholds (40-65% range for autonomous fulfillment)
  - ‚úÖ Redesigned need bar colors: Green (60+) ‚Üí Grey (40-60) ‚Üí Yellow (30-40) ‚Üí Red (0-30)
  - ‚úÖ Updated status text to be less alarming

- **New Features**
  - ‚úÖ Page Visibility API - auto-pause when tab loses focus
  - ‚úÖ PauseOverlay dialog with configurable messaging
  - ‚úÖ Clip Nails interaction with need-based availability
  - ‚úÖ Smart interaction disabling (Hand Feed, Gentle Wipe, Clip Nails)
  - ‚úÖ Added nails need to display
  - ‚úÖ Treats can now be hand-fed (added treats category to food dialog)
  - ‚úÖ Fill Hay Rack buttons (global + individual for quick refills)

### Active Items üöß

**High Priority Bugs & Fixes:**
- ‚úÖ ~~Window focus bug (autonomous behavior stops when window loses focus)~~ - COMPLETED
- ‚úÖ ~~Nails need not showing in needs display~~ - COMPLETED
- ‚úÖ ~~Thirst decay rate too fast~~ - COMPLETED (recalibrated all needs)
- ‚úÖ ~~Treats cannot be hand-fed~~ - COMPLETED

**Medium Priority UX Improvements:**
- ‚úÖ ~~Bond progress bars not updating visually~~ - COMPLETED (replaced with SliderField)
- ‚úÖ ~~Hand-feed dialog needs confirmation button~~ - COMPLETED (two-step selection process)
- ‚úÖ ~~Emoji selection during drag & drop~~ - COMPLETED
- ‚úÖ ~~Show friendship points value in Socialize Sidebar~~ - COMPLETED
- ‚úÖ ~~Create read-only ProgressBar component for game view~~ - COMPLETED

**Phase 2.5 Systems:**
- ‚û°Ô∏è Systems 10.2.5, 10.3, 10.4, 10.5 moved to Phase 5 (see [System 22](systems/phase5/system-22-interaction-enhancement.md) and [System 23.5](systems/phase5/system-23.5-fulfillment-limitation.md))
- ‚úÖ System 10.1 (Personality Trait Influences) - Testing needed
- ‚úÖ System 10.2 (Preferences: Likes & Dislikes) - Testing needed

**Future Enhancements:**
- ‚û°Ô∏è All future polish features moved to [Phase 5 Additional Polish Features](DEVELOPMENT_PHASES.md#additional-polish-features-low-priority)

### Next Steps
1. ‚úÖ ~~Fix high-priority bugs~~ - COMPLETED
2. ‚úÖ ~~Window focus bug + Page Visibility API~~ - COMPLETED
3. ‚úÖ ~~Medium-priority UX improvements~~ - COMPLETED
4. **Testing:** Phase 2.5 systems (Personality Influences, Preferences)
5. **Future:** Phase 5 systems and polish features
