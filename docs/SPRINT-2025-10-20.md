# GPS2 Sprint - October 20, 2025

**Started:** October 20, 2025
**Status:** Phase 3 Complete âœ… - Beginning Phase 4 ðŸš€
**Branch:** GPS2-33
**Previous Sprint:** [TODO-2025-10-13.md](archive/TODO-2025-10-13.md)

---

## ðŸŽ‰ **Phase 3 Complete!**

### System 16: Autonomy Preparation âœ… **ALL 5 PHASES COMPLETE**

**Status:** âœ… Completed October 20, 2025
**Implementation Time:** ~6 hours (faster than 8-13 hour estimate)

All autonomy foundation systems implemented and tested:
- âœ… **Phase 1:** Item Type Metadata - itemType, needSatisfied, satisfactionAmount
- âœ… **Phase 2:** Water Consumption - consumeWater, hasWaterAvailable, getWaterBottlePosition
- âœ… **Phase 3:** Environmental Decay - Time-based bedding/cleanliness decay with quality modifiers
- âœ… **Phase 4:** Guinea Pig Position Tracking - Grid positioning with collision detection
- âœ… **Phase 5:** Item Usage History - Effectiveness tracking with rotation mechanics

**Key Features:**
- Constants centralized in [supplies.ts](../src/constants/supplies.ts#L75-L94)
- All decay rates tunable and well-documented
- Position tracking with Map-based storage
- Item effectiveness decay encourages strategic rotation
- Hourly recovery system for unused items
- Full persistence across page reloads

**Files Modified:**
- `src/constants/supplies.ts` - Added DECAY constants
- `src/stores/habitatConditions.ts` - Added all 5 phase systems
- `src/stores/gameTimingStore.ts` - Integrated decay and recovery
- `src/stores/guineaPigStore.ts` - Position initialization on activation

**Documentation:** [System 16: Autonomy Preparation](systems/phase3/system-16-autonomy-preparation.md)

---

## ðŸŽ¨ **Habitat Debug Cleanup** âœ… **COMPLETE**

**Status:** âœ… Completed October 20, 2025
**Goal:** Improve decay system UX and container drag behavior

### Decay Speed Control System

**Added configurable decay speed multiplier for testing and game balance:**
- âœ… **Speed Presets** - Realistic (1x), Relaxed (6x), Normal (12x), Fast (24x), Debug (60x)
- âœ… **Default: 12x (Normal)** - Balanced for 10-15 minute casual play sessions
- âœ… **Slider Control** - Range 1-60x with preset buttons in HabitatDebug panel
- âœ… **Applied to all decay** - Bedding, cleanliness, and hay freshness

**Decay Timeline at Normal Speed (12x):**
| Item | 1% Loss | Full Decay (100% â†’ 0%) |
|------|---------|------------------------|
| **Hay** | 15 sec | 25 minutes |
| **Bedding** | 25 sec | 42 minutes |
| **Cleanliness** | 50 sec | 83 minutes |

**In a 10-minute session:** Hay drops ~40%, Bedding ~24%, Cleanliness ~12%

### Per-Rack Hay Freshness Tracking

**Implemented individual freshness tracking for each hay rack:**
- âœ… **HayRackData structure** - Each rack tracks servings, freshness (0-100%), and last decay update
- âœ… **Independent decay** - Each hay rack decays separately based on time
- âœ… **Freshness in tooltips** - Hover shows "Freshness: 87%" for each rack
- âœ… **Faster decay rate** - Hay decays at 1 point per 3 minutes (faster than bedding - hay oxidizes quickly!)
- âœ… **Persistence** - Freshness saved per rack across page reloads

### Container Drag Improvements

**Removed drag locks and improved UX for bowls and hay racks:**
- âœ… **Always draggable** - Bowls and hay racks can be moved even when containing food/hay
- âœ… **Content stays put** - Food/hay items cannot be dragged out of containers (pointer-events: none)
- âœ… **Rich tooltips** - Show helpful metadata instead of lock error messages:
  - Empty: "Empty bowl / Capacity: 3 servings"
  - With contents: "Contents: Carrot, Apple / Capacity: 2/3"
  - Hay racks: "Hay servings: 3/4 / Freshness: 87%"
- âœ… **Removed visual locks** - No more dashed borders or "not-allowed" cursors
- âœ… **Help cursor** - Standard grab/grabbing cursor for all items

**Files Modified:**
- `src/constants/supplies.ts` - Added DECAY.SPEED_PRESETS and HAY_BASE_DECAY_PER_SECOND
- `src/stores/habitatConditions.ts` - Added decaySpeedMultiplier, setDecaySpeed(), per-rack hay decay
- `src/composables/useHabitatContainers.ts` - Restructured hay racks to track freshness per rack
- `src/components/debug/environment/HabitatDebug.vue` - Added decay speed slider with presets
- `src/components/game/habitat/HayRack.vue` - Added freshness prop and tooltip, fixed pointer-events
- `src/components/game/habitat/FoodBowl.vue` - Fixed pointer-events on food items
- `src/components/game/habitat/HabitatVisual.vue` - Removed drag locks, improved tooltips

---

## ðŸ§ª **Food & Hay Freshness System** âœ… **COMPLETE**

**Status:** âœ… Completed October 20, 2025
**Goal:** Implement per-item food freshness tracking with decay and visual feedback

### Food Bowl Freshness Tracking

**Implemented individual freshness tracking for each food item:**
- âœ… **FoodItem interface updated** - Added `freshness: number` (0-100%) and `addedAt: number` timestamp
- âœ… **Independent decay** - Each food item decays separately at 1 point per 4 minutes
- âœ… **Food Containers panel** - Debug panel showing all food bowls with freshness sliders
- âœ… **Grouped by bowl** - Food items displayed per bowl in responsive grid
- âœ… **Individual sliders** - Each food item has its own freshness control
- âœ… **Color-coded freshness** - Green (â‰¥80%), yellow (â‰¥40%), red (<40%)
- âœ… **Remove stale food** - Popover shows remove button for each food item (red for <40% fresh)
- âœ… **Reactivity fixes** - Singleton pattern in useHabitatContainers for proper Vue reactivity
- âœ… **Overall condition integration** - Food and hay freshness now factor into habitat overall condition

### Hay Rack Enhancements

**Improved hay rack UI and functionality:**
- âœ… **Hay Racks panel** - Moved freshness sliders from popover to dedicated debug panel
- âœ… **Empty rack handling** - Slider disabled when rack is empty (0 servings)
- âœ… **Always-visible popover** - Popover shows at all times (not just when hay present)
- âœ… **Empty Hay Rack button** - Always available in popover (warning variant when stale)
- âœ… **Freshness thresholds** - Button shows "Clear Stale Hay" (warning) when <40%, "Empty Hay Rack" (default) otherwise

### Habitat Care Sidebar System

**Created dedicated sidebar for care actions:**
- âœ… **HabitatCareSidebar component** - New sidebar with all care and test actions
- âœ… **Sidebar toggle** - Switch between ðŸŽ’ Inventory and ðŸ§¹ Care Actions in Habitat Visual panel
- âœ… **Organized sections:**
  - Core Care: Clean Cage, Refill Water, Refresh Bedding
  - Bedding Type: Bedding selector dropdown
  - Containers: Clear All Bowls, Clear All Hay Racks
  - Test Actions: Add/Clear Poop, Clear Water, Test Water Consumption
- âœ… **Cleaner layout** - Removed action buttons from Core Conditions panel items
- âœ… **Decay Speed panel** - Compact dedicated panel with multiplier slider and presets

### Overall Condition Calculation

**Updated to include all freshness factors:**
- Previously: `(cleanliness + bedding + hayFreshness + water) / 4`
- Now: `(cleanliness + bedding + water + avgHayRackFreshness + avgFoodFreshness) / 5`
- Calculates average freshness across all hay racks
- Calculates average freshness across all food items in all bowls

### Layout Improvements

**Reorganized Habitat Conditions panel:**
- âœ… **Proper sectioning** - Core Conditions, Hay Racks, and Food Containers in separate `.conditions-section` divs
- âœ… **Visual dividers** - `<hr class="divider" />` between each section
- âœ… **Better hierarchy** - h4 for section titles (Core Conditions, Hay Racks, Food Containers), h5 for bowl names
- âœ… **Larger fonts** - Section titles increased to `--font-size-xl` (20px), bowl names to `--font-size-lg` (18px) for Gaegu readability
- âœ… **Responsive grids** - Food bowls in auto-fill grid (280px min), hay racks in auto-fill grid (240px min)
- âœ… **Compact spacing** - Reduced padding and gaps throughout for better space usage

### Technical Improvements

**Singleton pattern fix:**
- âœ… **Root cause** - useHabitatContainers was creating new refs each call, breaking reactivity
- âœ… **Solution** - Moved `bowlContents` and `hayRackContents` refs outside function for true singleton
- âœ… **Vue reactivity** - Always create new Map instances to trigger reactivity (not just Map.set)
- âœ… **Pattern applied** - Consistent across setFoodFreshness, applyFoodBowlDecay, setHayRackFreshness, applyHayRackDecay

**Files Modified:**
- `src/composables/useHabitatContainers.ts` - Added food freshness tracking, singleton pattern fix
- `src/constants/supplies.ts` - Added FOOD_BASE_DECAY_PER_SECOND constant
- `src/stores/habitatConditions.ts` - Integrated food decay, updated overall condition calculation
- `src/components/game/habitat/FoodBowl.vue` - Added popover with food items, freshness display, remove buttons
- `src/components/game/habitat/HayRack.vue` - Always show popover, dynamic empty button
- `src/components/game/habitat/HabitatVisual.vue` - Added remove food handler
- `src/components/game/habitat/HabitatCareSidebar.vue` - **NEW** - Care actions sidebar component
- `src/components/debug/environment/HabitatDebug.vue` - Added Food Containers panel, sidebar toggle, layout improvements

---

## ðŸ¦· **Chew Item Degradation System**

**Status:** ðŸ“‹ Not Started
**Priority:** MEDIUM
**Goal:** Implement per-item chew degradation tracking with visual feedback and discard mechanics

### Concept

**Chews are consumable items that guinea pigs wear down through use:**
- Chews degrade from 100% (fresh) to 0% (too worn/unsafe to use)
- Each guinea pig chew interaction reduces the chew's durability
- Unlike food/hay freshness (time-based decay), chews degrade through usage only
- Chews are individual habitat items, **NOT** tied to overall habitat condition
- When too degraded (<20%), chews should be discarded for safety

### Requirements

**Chew Item Tracking:**
- [ ] Add `durability: number` (0-100%) field to chew items
- [ ] Track `usageCount: number` - how many times it's been chewed
- [ ] Track `lastUsedAt: number` timestamp for last chew interaction
- [ ] Degradation rate varies by chew type (willow sticks wear faster than mineral chews)

**Chews Panel in Habitat Conditions:**
- [ ] Add "Chews" section to Habitat Conditions panel (after Food Containers)
- [ ] Display all placed chew items with durability sliders
- [ ] Grid layout similar to Hay Racks and Food Containers
- [ ] Show: Chew emoji, name, durability %, usage count
- [ ] **Important:** This panel is for monitoring only, NOT a habitat condition metric

**Chew Item Popover:**
- [ ] Always show popover when hovering over chew items (similar to hay racks)
- [ ] Display metadata: Durability %, Usage count, Last used time
- [ ] "Remove Chew" button - always visible (default variant, removes from habitat, returns to inventory at current durability)
- [ ] "Discard Used Chew" button - only shows when durability < 20% (warning variant, removes permanently)

**Degradation System:**
- [ ] Each chew interaction reduces durability by configured amount (e.g., 5-15% per use depending on chew type)
- [ ] **Willow sticks:** Fast degradation (10-15% per use, ~7-10 uses)
- [ ] **Apple wood:** Medium degradation (7-10% per use, ~10-14 uses)
- [ ] **Mineral chews:** Slow degradation (3-5% per use, ~20-33 uses)
- [ ] Visual feedback: Emoji opacity/filter changes as durability decreases

**Safety Thresholds:**
- **Fresh (80-100%):** Green indicator, optimal condition
- **Worn (40-79%):** Yellow indicator, still usable
- **Degraded (20-39%):** Orange indicator, should replace soon
- **Unsafe (<20%):** Red indicator, must discard (safety hazard - splinters, sharp edges) - **Negatively impacts habitat condition**

### Implementation Notes

**Why chews are different from food/hay:**
- **Food/hay:** Decay over time (oxidation, spoilage) - time-based
- **Chews:** Degrade through interaction (physical wear) - usage-based
- **Food/hay:** Tied to habitat condition (affects overall wellness)
- **Chews:** Unsafe chews (<20% durability) negatively impact habitat condition due to safety hazards (splinters, sharp edges)

**Habitat Condition Impact:**
- Chews with durability â‰¥20% have no impact on habitat condition (normal enrichment items)
- Chews with durability <20% apply a small penalty to overall habitat condition
- This represents the safety hazard of damaged chews that could injure guinea pigs
- Players should replace or discard unsafe chews to maintain habitat condition

**Integration with Phase 4 Autonomy:**
- Guinea pigs will autonomously select chews when "chew" need is high
- Each chew interaction triggers durability reduction
- Guinea pigs won't use chews below 20% durability (AI should select fresh ones)
- Multiple chews in habitat = variety and rotation (prevents over-wearing one item)

### Data Structure

```typescript
// In useHabitatContainers.ts
interface ChewData {
  durability: number        // 0-100%, physical condition
  usageCount: number        // Times chewed
  lastUsedAt: number        // Timestamp
  degradationRate: number   // Per-use degradation % (varies by chew type)
}

const chewItems = ref<Map<string, ChewData>>(new Map())
```

### Constants

```typescript
// In supplies.ts - CHEW_DEGRADATION
export const CHEW_DEGRADATION = {
  // Degradation rates by chew type
  WILLOW_STICK: 12,      // 12% per use (~8 uses until unsafe)
  APPLE_WOOD: 8,         // 8% per use (~12 uses until unsafe)
  MINERAL_CHEW: 4,       // 4% per use (~25 uses until unsafe)

  // Safety thresholds
  UNSAFE_THRESHOLD: 20,   // Below this = must discard (safety hazard)
  DEGRADED_THRESHOLD: 40, // Below this = degraded condition
  WORN_THRESHOLD: 80,     // Below this = worn condition

  // Habitat condition impact
  UNSAFE_HABITAT_PENALTY: 5, // Penalty applied per unsafe chew to habitat condition
}
```

### Files to Create/Modify

**New:**
- `src/components/game/habitat/ChewItem.vue` - Chew item component with popover and durability display

**Modified:**
- `src/composables/useHabitatContainers.ts` - Add chew tracking Map, degradation functions (chewItem, getChewDurability, setChewDurability, etc.)
- `src/constants/supplies.ts` - Add CHEW_DEGRADATION constants
- `src/components/debug/environment/HabitatDebug.vue` - Add Chews section to Habitat Conditions panel
- `src/components/game/habitat/HabitatVisual.vue` - Integrate ChewItem component, handle chew interactions
- `src/stores/habitatConditions.ts` - Update overall condition calculation to factor in unsafe chew penalty

**Pattern to Follow:**
- Similar to food/hay tracking but usage-based instead of time-based
- Use singleton pattern for chewItems Map (consistent with bowlContents/hayRackContents)
- Vue reactivity with new Map instances (not just Map.set)

---

## ðŸš€ **Phase 4: Guinea Pig Autonomy**

**Status:** ðŸ“‹ Ready to Start
**Priority:** HIGH
**Estimated Time:** 15-25 hours

### Goal
Implement autonomous guinea pig behavior with need-based decision making, pathfinding, and intelligent item usage.

### Core Systems

#### **4.1: Autonomous Behavior System**
- Need-based behavior triggers (thirst â†’ seek water, hunger â†’ seek food)
- Priority queue for competing needs
- Personality-influenced decision making
- Friendship-gated behaviors

#### **4.2: Pathfinding & Movement**
- A* pathfinding on habitat grid
- Smooth sprite movement between cells
- Obstacle avoidance (items block paths)
- Multiple guinea pigs don't collide

#### **4.3: Item Interaction AI**
- Autonomous water drinking when thirsty
- Autonomous food consumption from bowls
- Hay eating from hay racks
- Shelter seeking when stressed
- Toy/chew item usage for happiness

#### **4.4: Guinea Pig Sprites & Animation**
- Visual representation on habitat grid
- Movement animations (walking, idle)
- Activity animations (drinking, eating, sleeping)
- Breed-specific appearances

### Integration Points
- âœ… Position tracking (System 16 Phase 4)
- âœ… Item type metadata (System 16 Phase 1)
- âœ… Water consumption (System 16 Phase 2)
- âœ… Usage history (System 16 Phase 5)
- âœ… Needs system (Phase 2)
- âœ… Habitat conditions (Phase 3)

**Documentation:** [Guinea Pig Autonomy System](systems/phase4/guinea-pig-autonomy-system.md)

---

## ðŸŽ¯ **High Priority Improvements**

### Currency Reward System ðŸ”¥
**Goal:** Implement currency earning system that rewards good guinea pig care

**Concept:** Friendship Dividends - Guinea pigs earn currency based on friendship points Ã— wellness
- Active pigs: `(friendshipPoints / 100) Ã— (wellness / 100) Ã— 20 = currency/hour`
- Sanctuary pigs: `(friendshipPoints / 100) Ã— 30 = currency/hour` (higher rate, friendship-only)
- Offline accumulation (8-hour cap to prevent FOMO)
- Bonus systems: Daily login (+100), interactions (+5 each), friendship milestones (250-2000 points)
- Self-balancing economy that scales with progression and rewards long-term bonds

**Documentation:** [Currency Reward System Design](game-design/currency-reward-system.md)

**Implementation Priority:** HIGH - Required before expanding supplies catalog

---

### Friendship System Redesign ðŸ”¥
**Goal:** Change from percentage (0-100%) to infinite point-based with levels

**Key Changes:**
- Point-based progression (not capped at 100%)
- 10+ tiered levels (Level 4 = Stardust Sanctuary unlock)
- Migration: existing friendship % Ã— 10 = starting points

**Files:** guineaPig.ts, guineaPigStore.ts, petStoreManager.ts, GuineaPigEditor.vue

---

### Port Real Food Items to Preferences ðŸ”¥
**Goal:** Replace hardcoded food arrays with Supplies Store catalog

**Implementation:**
- Pull food from `suppliesStore.getFoodByCategory()` instead of hardcoded lists
- Update preference generation to use real item IDs
- Validate guinea pig preferences against Supplies Store

**Files:** GuineaPigEditor.vue, petStoreManager.ts, guineaPigStore.ts

---

### Personality-Based Habitat Sensitivity ðŸ”¥
**Goal:** Add 5th personality trait (cleanliness 1-10) affecting habitat tolerance

**Trait Effects:**
- **Picky (7-10):** Won't eat hay <60% fresh, stressed by mess
- **Moderate (4-6):** Baseline 40% thresholds
- **Piggy (1-3):** Tolerates mess, eats hay down to 20% fresh

**Files:** guineaPig.ts, guineaPigStore.ts, habitatConditions.ts, needsController.ts, messageGenerator.ts

---

## ðŸ”§ **Technical Improvements**

### Smart Bedding Consumption System
**Priority:** MEDIUM (Quality of Life)
**Status:** ðŸ“‹ Not Started

**Current Issue:** "Refresh Bedding" button always consumes 1 entire bag of bedding regardless of how dirty the habitat is.

**Goal:** Implement smart bedding consumption that uses partial bags based on actual habitat needs.

**Requirements:**
- 1 bag of bedding = 1 full medium habitat space (100% bedding coverage)
- Calculate how much bedding is needed based on current cleanliness level
- Only consume the amount needed (e.g., if habitat is 60% clean, only consume 40% of a bag)
- Similar implementation to hay handful system but for bedding refresh
- If multiple partial bags exist, combine them before opening new bags
- Track partial bags in inventory (e.g., "Average Bedding - 60% remaining")

**Files to Modify:**
- `src/stores/habitatConditions.ts` - Update `refreshBedding()` method with smart consumption
- `src/stores/inventoryStore.ts` - Add partial bag tracking for bedding
- `src/components/debug/environment/HabitatDebug.vue` - Update UI to show partial bag info

---

## ðŸ”§ **Technical Debt & Polish**

### Code Quality Audit ðŸ”¥
**Priority:** HIGH - Before Phase 4
**Status:** ðŸ“‹ Not Started

**Verify code against best practices:**
- [ ] **Review all Phase 3 code** - Check for technical debt, anti-patterns, or code smells
- [ ] **Verify singleton patterns** - Ensure useHabitatContainers and other composables follow best practices
- [ ] **Check Vue reactivity** - Audit all Map/Set mutations for proper reactivity triggers
- [ ] **TypeScript strictness** - Ensure proper typing, no `any` types where avoidable
- [ ] **Error handling** - Verify consistent error handling patterns across stores and composables
- [ ] **Performance check** - Review computed properties, watchers, and refs for optimization opportunities
- [ ] **Memory leaks** - Check for proper cleanup in onUnmounted hooks and component lifecycle

### Style & Component Audit ðŸ”¥
**Priority:** HIGH - Before Phase 4
**Status:** ðŸ“‹ Not Started

**Identify reusable patterns and style violations:**
- [ ] **Audit component styles** - Check for duplicate CSS that could be extracted to utilities
- [ ] **BEM methodology** - Verify all components follow BEM naming conventions
- [ ] **Logical properties** - Ensure all spacing/positioning uses logical properties (not physical)
- [ ] **Reusable components** - Identify patterns that could become shared components
- [ ] **CSS variables** - Check for hardcoded values that should use design tokens
- [ ] **Component hierarchy** - Review heading levels (h1-h6) across all components for semantic correctness
- [ ] **Accessibility** - Audit for ARIA labels, keyboard navigation, focus management
- [ ] **Mobile responsiveness** - Test all new components on mobile viewports

**Files to Focus On:**
- `src/components/debug/environment/HabitatDebug.vue` - Recently modified, verify sectioning and styles
- `src/components/game/habitat/HabitatCareSidebar.vue` - New component, verify against style guide
- `src/components/game/habitat/FoodBowl.vue` - Complex popover logic, check for reusability
- `src/composables/useHabitatContainers.ts` - Critical singleton, verify pattern correctness

### Code Cleanup
- [ ] Standardize error handling patterns
- [ ] Add TypeScript strict mode compliance
- [ ] Audit and remove unused code
- [ ] Remove debug console.log statements

### UI/UX Improvements
- [ ] Add loading states for long operations
- [ ] Improve mobile responsiveness for debug panels
- [ ] Add keyboard shortcuts for common debug actions
- [ ] Add tooltips/help text for complex controls

### Documentation
- [ ] Create component library reference
- [ ] Add inline JSDoc comments for complex functions
- [ ] Update architecture diagrams for Phase 3/4
- [ ] Document singleton patterns and Vue reactivity best practices

---

## ðŸ“ **Sprint Notes**

### Phase 3 Accomplishments
All Phase 3 systems complete:
1. âœ… Supplies Store (104+ items)
2. âœ… Inventory Management (instance-based with sell-back)
3. âœ… Habitat Conditions (resource consumption)
4. âœ… Habitat UI (drag-and-drop, phases 1-2)
5. âœ… Serving System (hay racks, food bowls)
6. âœ… Maintenance (poop, cleanliness, bedding, water)
7. âœ… Autonomy Preparation (5 phases complete)

**Phase 3 is now feature-complete and ready for Phase 4 autonomy development.**

### Next Steps
1. Begin Phase 4 with autonomous behavior system
2. Implement pathfinding for guinea pig movement
3. Create guinea pig sprites and animations
4. Integrate item interaction AI

---

## ðŸŽ® **Testing Checklist**

### System 16 Testing
- [x] Water consumption reduces water level correctly
- [x] Environmental decay applies over time
- [x] Guinea pig positions initialized on activation
- [x] Item effectiveness decays with use
- [x] Effectiveness recovery works hourly
- [x] All systems persist across page reload

### Phase 4 Preparation
- [ ] Verify all autonomy data available to AI
- [ ] Test need-based behavior triggers
- [ ] Validate pathfinding grid setup
- [ ] Confirm item interaction hooks

---

## ðŸš€ **Commands**

**Development:**
- `npm run dev` - Start development server
- `npm run build` - Production build (run before commits)
- `npm run preview` - Preview production build

**Git:**
- Current branch: `GPS2-33`
- Main branch: `main`

---

## ðŸ“š **Documentation Links**

- [Project Plan](PROJECT_PLAN.md)
- [Development Phases](DEVELOPMENT_PHASES.md)
- [System Integration](SYSTEM_INTEGRATION.md)
- [Phase 3 Systems](systems/phase3/)
- [Phase 4 Systems](systems/phase4/)
- [System 16: Autonomy Preparation](systems/phase3/system-16-autonomy-preparation.md)
