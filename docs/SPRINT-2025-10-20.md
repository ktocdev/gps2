# GPS2 Sprint - October 20, 2025

**Started:** October 20, 2025
**Status:** Phase 3 Complete âœ… - Beginning Phase 4 ðŸš€
**Branch:** GPS2-33
**Previous Sprint:** [TODO-2025-10-13.md](archive/TODO-2025-10-13.md)

---

## ðŸŽ‰ **Phase 3 Complete!**

### System 16: Autonomy Preparation âœ… **ALL 5 PHASES COMPLETE**

**Status:** âœ… Completed October 20, 2025
**Implementation Time:** ~6 hours (faster than 8-13 hour estimate)

All autonomy foundation systems implemented and tested:
- âœ… **Phase 1:** Item Type Metadata - itemType, needSatisfied, satisfactionAmount
- âœ… **Phase 2:** Water Consumption - consumeWater, hasWaterAvailable, getWaterBottlePosition
- âœ… **Phase 3:** Environmental Decay - Time-based bedding/cleanliness decay with quality modifiers
- âœ… **Phase 4:** Guinea Pig Position Tracking - Grid positioning with collision detection
- âœ… **Phase 5:** Item Usage History - Effectiveness tracking with rotation mechanics

**Key Features:**
- Constants centralized in [supplies.ts](../src/constants/supplies.ts#L75-L94)
- All decay rates tunable and well-documented
- Position tracking with Map-based storage
- Item effectiveness decay encourages strategic rotation
- Hourly recovery system for unused items
- Full persistence across page reloads

**Files Modified:**
- `src/constants/supplies.ts` - Added DECAY constants
- `src/stores/habitatConditions.ts` - Added all 5 phase systems
- `src/stores/gameTimingStore.ts` - Integrated decay and recovery
- `src/stores/guineaPigStore.ts` - Position initialization on activation

**Documentation:** [System 16: Autonomy Preparation](systems/phase3/system-16-autonomy-preparation.md)

---

## ðŸŽ¨ **Habitat Debug Cleanup** âœ… **COMPLETE**

**Status:** âœ… Completed October 20, 2025
**Goal:** Improve decay system UX and container drag behavior

### Decay Speed Control System

**Added configurable decay speed multiplier for testing and game balance:**
- âœ… **Speed Presets** - Realistic (1x), Relaxed (6x), Normal (12x), Fast (24x), Debug (60x)
- âœ… **Default: 12x (Normal)** - Balanced for 10-15 minute casual play sessions
- âœ… **Slider Control** - Range 1-60x with preset buttons in HabitatDebug panel
- âœ… **Applied to all decay** - Bedding, cleanliness, and hay freshness

**Decay Timeline at Normal Speed (12x):**
| Item | 1% Loss | Full Decay (100% â†’ 0%) |
|------|---------|------------------------|
| **Hay** | 15 sec | 25 minutes |
| **Bedding** | 25 sec | 42 minutes |
| **Cleanliness** | 50 sec | 83 minutes |

**In a 10-minute session:** Hay drops ~40%, Bedding ~24%, Cleanliness ~12%

### Per-Rack Hay Freshness Tracking

**Implemented individual freshness tracking for each hay rack:**
- âœ… **HayRackData structure** - Each rack tracks servings, freshness (0-100%), and last decay update
- âœ… **Independent decay** - Each hay rack decays separately based on time
- âœ… **Freshness in tooltips** - Hover shows "Freshness: 87%" for each rack
- âœ… **Faster decay rate** - Hay decays at 1 point per 3 minutes (faster than bedding - hay oxidizes quickly!)
- âœ… **Persistence** - Freshness saved per rack across page reloads

### Container Drag Improvements

**Removed drag locks and improved UX for bowls and hay racks:**
- âœ… **Always draggable** - Bowls and hay racks can be moved even when containing food/hay
- âœ… **Content stays put** - Food/hay items cannot be dragged out of containers (pointer-events: none)
- âœ… **Rich tooltips** - Show helpful metadata instead of lock error messages:
  - Empty: "Empty bowl / Capacity: 3 servings"
  - With contents: "Contents: Carrot, Apple / Capacity: 2/3"
  - Hay racks: "Hay servings: 3/4 / Freshness: 87%"
- âœ… **Removed visual locks** - No more dashed borders or "not-allowed" cursors
- âœ… **Help cursor** - Standard grab/grabbing cursor for all items

**Files Modified:**
- `src/constants/supplies.ts` - Added DECAY.SPEED_PRESETS and HAY_BASE_DECAY_PER_SECOND
- `src/stores/habitatConditions.ts` - Added decaySpeedMultiplier, setDecaySpeed(), per-rack hay decay
- `src/composables/useHabitatContainers.ts` - Restructured hay racks to track freshness per rack
- `src/components/debug/environment/HabitatDebug.vue` - Added decay speed slider with presets
- `src/components/game/habitat/HayRack.vue` - Added freshness prop and tooltip, fixed pointer-events
- `src/components/game/habitat/FoodBowl.vue` - Fixed pointer-events on food items
- `src/components/game/habitat/HabitatVisual.vue` - Removed drag locks, improved tooltips

---

## ðŸ§ª **Food & Hay Freshness System** âœ… **COMPLETE**

**Status:** âœ… Completed October 20, 2025
**Goal:** Implement per-item food freshness tracking with decay and visual feedback

### Food Bowl Freshness Tracking

**Implemented individual freshness tracking for each food item:**
- âœ… **FoodItem interface updated** - Added `freshness: number` (0-100%) and `addedAt: number` timestamp
- âœ… **Independent decay** - Each food item decays separately at 1 point per 4 minutes
- âœ… **Food Containers panel** - Debug panel showing all food bowls with freshness sliders
- âœ… **Grouped by bowl** - Food items displayed per bowl in responsive grid
- âœ… **Individual sliders** - Each food item has its own freshness control
- âœ… **Color-coded freshness** - Green (â‰¥80%), yellow (â‰¥40%), red (<40%)
- âœ… **Remove stale food** - Popover shows remove button for each food item (red for <40% fresh)
- âœ… **Reactivity fixes** - Singleton pattern in useHabitatContainers for proper Vue reactivity
- âœ… **Overall condition integration** - Food and hay freshness now factor into habitat overall condition

### Hay Rack Enhancements

**Improved hay rack UI and functionality:**
- âœ… **Hay Racks panel** - Moved freshness sliders from popover to dedicated debug panel
- âœ… **Empty rack handling** - Slider disabled when rack is empty (0 servings)
- âœ… **Always-visible popover** - Popover shows at all times (not just when hay present)
- âœ… **Empty Hay Rack button** - Always available in popover (warning variant when stale)
- âœ… **Freshness thresholds** - Button shows "Clear Stale Hay" (warning) when <40%, "Empty Hay Rack" (default) otherwise

### Habitat Care Sidebar System

**Created dedicated sidebar for care actions:**
- âœ… **HabitatCareSidebar component** - New sidebar with all care and test actions
- âœ… **Sidebar toggle** - Switch between ðŸŽ’ Inventory and ðŸ§¹ Care Actions in Habitat Visual panel
- âœ… **Organized sections:**
  - Core Care: Clean Cage, Refill Water, Refresh Bedding
  - Bedding Type: Bedding selector dropdown
  - Containers: Clear All Bowls, Clear All Hay Racks
  - Test Actions: Add/Clear Poop, Clear Water, Test Water Consumption
- âœ… **Cleaner layout** - Removed action buttons from Core Conditions panel items
- âœ… **Decay Speed panel** - Compact dedicated panel with multiplier slider and presets

### Overall Condition Calculation

**Updated to include all freshness factors:**
- Previously: `(cleanliness + bedding + hayFreshness + water) / 4`
- Now: `(cleanliness + bedding + water + avgHayRackFreshness + avgFoodFreshness) / 5`
- Calculates average freshness across all hay racks
- Calculates average freshness across all food items in all bowls

### Layout Improvements

**Reorganized Habitat Conditions panel:**
- âœ… **Proper sectioning** - Core Conditions, Hay Racks, and Food Containers in separate `.conditions-section` divs
- âœ… **Visual dividers** - `<hr class="divider" />` between each section
- âœ… **Better hierarchy** - h4 for section titles (Core Conditions, Hay Racks, Food Containers), h5 for bowl names
- âœ… **Larger fonts** - Section titles increased to `--font-size-xl` (20px), bowl names to `--font-size-lg` (18px) for Gaegu readability
- âœ… **Responsive grids** - Food bowls in auto-fill grid (280px min), hay racks in auto-fill grid (240px min)
- âœ… **Compact spacing** - Reduced padding and gaps throughout for better space usage

### Technical Improvements

**Singleton pattern fix:**
- âœ… **Root cause** - useHabitatContainers was creating new refs each call, breaking reactivity
- âœ… **Solution** - Moved `bowlContents` and `hayRackContents` refs outside function for true singleton
- âœ… **Vue reactivity** - Always create new Map instances to trigger reactivity (not just Map.set)
- âœ… **Pattern applied** - Consistent across setFoodFreshness, applyFoodBowlDecay, setHayRackFreshness, applyHayRackDecay

**Files Modified:**
- `src/composables/useHabitatContainers.ts` - Added food freshness tracking, singleton pattern fix
- `src/constants/supplies.ts` - Added FOOD_BASE_DECAY_PER_SECOND constant
- `src/stores/habitatConditions.ts` - Integrated food decay, updated overall condition calculation
- `src/components/game/habitat/FoodBowl.vue` - Added popover with food items, freshness display, remove buttons
- `src/components/game/habitat/HayRack.vue` - Always show popover, dynamic empty button
- `src/components/game/habitat/HabitatVisual.vue` - Added remove food handler
- `src/components/game/habitat/HabitatCareSidebar.vue` - **NEW** - Care actions sidebar component
- `src/components/debug/environment/HabitatDebug.vue` - Added Food Containers panel, sidebar toggle, layout improvements

---

## ðŸ¦· **Chew Item Degradation System** âœ… **COMPLETE**

**Status:** âœ… Completed October 21, 2025
**Priority:** MEDIUM
**Goal:** Implement per-item chew degradation tracking with visual feedback and discard mechanics

### Concept

**Chews are consumable items that guinea pigs wear down through use:**
- Chews degrade from 100% (fresh) to 0% (too worn/unsafe to use)
- Each guinea pig chew interaction reduces the chew's durability
- Unlike food/hay freshness (time-based decay), chews degrade through usage only
- Chews are individual habitat items, **NOT** tied to overall habitat condition
- When too degraded (<20%), chews should be discarded for safety

### Requirements âœ… **All Complete**

**Chew Item Tracking:**
- âœ… Add `durability: number` (0-100%) field to chew items
- âœ… Track `usageCount: number` - how many times it's been chewed
- âœ… Track `lastUsedAt: number` timestamp for last chew interaction
- âœ… Degradation rate varies by chew type (willow sticks wear faster than mineral chews)

**Chews Panel in Habitat Conditions:**
- âœ… Add "Chews" section to Habitat Conditions panel (after Food Containers)
- âœ… Display all placed chew items with durability sliders
- âœ… Grid layout similar to Hay Racks and Food Containers
- âœ… Show: Chew emoji, name, durability %, usage count
- âœ… **Important:** This panel is for monitoring only, NOT a habitat condition metric

**Chew Item Popover:**
- âœ… Always show popover when hovering over chew items (similar to hay racks)
- âœ… Display metadata: Durability %, Usage count, Last used time
- âœ… "Remove Chew" button - always visible (default variant, removes from habitat, returns to inventory at current durability)
- âœ… "Discard Used Chew" button - only shows when durability < 20% (danger variant, removes permanently)

**Degradation System:**
- âœ… Each chew interaction reduces durability by configured amount
- âœ… **Willow sticks:** Fast degradation (12% per use, ~8 uses until unsafe)
- âœ… **Apple wood:** Medium degradation (8% per use, ~12 uses until unsafe)
- âœ… **Mineral chews:** Slow degradation (4% per use, ~25 uses until unsafe)
- âœ… Visual feedback: Emoji opacity/filter changes as durability decreases

**Safety Thresholds:**
- âœ… **Fresh (80-100%):** Green indicator, optimal condition
- âœ… **Worn (40-79%):** Muted indicator, still usable
- âœ… **Degraded (20-39%):** Warning indicator, should replace soon
- âœ… **Unsafe (<20%):** Danger indicator, must discard (safety hazard - splinters, sharp edges) - **Negatively impacts habitat condition**

### Implementation Notes

**Why chews are different from food/hay:**
- **Food/hay:** Decay over time (oxidation, spoilage) - time-based
- **Chews:** Degrade through interaction (physical wear) - usage-based
- **Food/hay:** Tied to habitat condition (affects overall wellness)
- **Chews:** Unsafe chews (<20% durability) negatively impact habitat condition due to safety hazards (splinters, sharp edges)

**Habitat Condition Impact:**
- Chews with durability â‰¥20% have no impact on habitat condition (normal enrichment items)
- Chews with durability <20% apply a small penalty to overall habitat condition
- This represents the safety hazard of damaged chews that could injure guinea pigs
- Players should replace or discard unsafe chews to maintain habitat condition

**Integration with Phase 4 Autonomy:**
- Guinea pigs will autonomously select chews when "chew" need is high
- Each chew interaction triggers durability reduction
- Guinea pigs won't use chews below 20% durability (AI should select fresh ones)
- Multiple chews in habitat = variety and rotation (prevents over-wearing one item)

### Data Structure

```typescript
// In useHabitatContainers.ts
interface ChewData {
  durability: number        // 0-100%, physical condition
  usageCount: number        // Times chewed
  lastUsedAt: number        // Timestamp
  degradationRate: number   // Per-use degradation % (varies by chew type)
}

const chewItems = ref<Map<string, ChewData>>(new Map())
```

### Constants

```typescript
// In supplies.ts - CHEW_DEGRADATION
export const CHEW_DEGRADATION = {
  // Degradation rates by chew type
  WILLOW_STICK: 12,      // 12% per use (~8 uses until unsafe)
  APPLE_WOOD: 8,         // 8% per use (~12 uses until unsafe)
  MINERAL_CHEW: 4,       // 4% per use (~25 uses until unsafe)

  // Safety thresholds
  UNSAFE_THRESHOLD: 20,   // Below this = must discard (safety hazard)
  DEGRADED_THRESHOLD: 40, // Below this = degraded condition
  WORN_THRESHOLD: 80,     // Below this = worn condition

  // Habitat condition impact
  UNSAFE_HABITAT_PENALTY: 5, // Penalty applied per unsafe chew to habitat condition
}
```

### Implementation Summary âœ…

**Files Created:**
- âœ… `src/components/game/habitat/ChewItem.vue` - Chew item component with popover and durability display (113 lines)

**Files Modified:**
- âœ… `src/composables/useHabitatContainers.ts` - Added ChewData interface, chew tracking Map, 7 chew management functions
- âœ… `src/constants/supplies.ts` - Added CHEW_DEGRADATION constants (degradation rates, thresholds, habitat penalty)
- âœ… `src/components/debug/environment/HabitatDebug.vue` - Added Chews section to Habitat Conditions panel with durability sliders
- âœ… `src/components/game/habitat/HabitatVisual.vue` - Integrated ChewItem component, added chew interaction handlers (test, remove, discard)
- âœ… `src/stores/habitatConditions.ts` - Updated overall condition calculation to apply unsafe chew penalty (5 points per unsafe chew)

**Key Features Implemented:**
- âœ… **Usage-based degradation** - Chews degrade when used, not over time
- âœ… **Type-specific rates** - Willow (12%), Apple (8%), Mineral (4%) per use
- âœ… **Safety enforcement** - Cannot use chews below 20% durability
- âœ… **Habitat impact** - Unsafe chews (<20%) reduce overall condition by 5 points each
- âœ… **Visual feedback** - Opacity and filter effects based on durability state
- âœ… **Persistence** - Chew data serialized/deserialized with habitat state
- âœ… **Initialization** - Chews auto-initialize when placed in habitat

**Patterns Used:**
- âœ… Singleton pattern for chewItems Map (consistent with bowlContents/hayRackContents)
- âœ… Vue reactivity with new Map instances (not just Map.set)
- âœ… Type-safe TypeScript with explicit number type for degradation rates

---

## ðŸ› **Phase 4 Bug Fixes & Stability** âœ… **COMPLETE**

**Status:** âœ… Completed October 22, 2025
**Priority:** CRITICAL
**Goal:** Fix critical bugs discovered during autonomous AI integration testing

### Issues Fixed

**1. Guinea Pig Position Initialization** âœ…
- **Issue:** Guinea pigs stuck at (0,0) when enabling autonomous AI
- **Root Cause:** `getGuineaPigPosition()` returned default {row: 0, col: 0} when position not found
- **Fix:** Auto-initialize positions on first access via `initializeGuineaPigPosition()`
- **File:** [HabitatVisual.vue:245](../src/components/game/habitat/HabitatVisual.vue#L245)

**2. Guinea Pig Movement System** âœ…
- **Issue:** Guinea pigs positioned randomly but not moving, AI stuck on cooldown
- **Root Cause 1:** Game loop interval too slow (5000ms)
- **Fix 1:** Reduced `intervalMs` from 5000ms to 1000ms for responsive AI
- **Root Cause 2:** `useGuineaPigBehavior()` recreated every tick, resetting cooldown
- **Fix 2:** Cached behavior composables in Map to maintain state across ticks
- **File:** [gameTimingStore.ts:18](../src/stores/gameTimingStore.ts#L18)

**3. Poop Coordinate System** âœ…
- **Issue:** Poop appearing at wrong location (top-left instead of near guinea pig)
- **Root Cause:** Main grid (14Ã—10) vs subgrid (56Ã—40) coordinate mismatch
- **Fix:** Convert grid coordinates to subgrid: `col * 4 + random(0-3)`
- **File:** [useGuineaPigBehavior.ts:692](../src/composables/game/useGuineaPigBehavior.ts#L692)

**4. Habitat Items Persistence Failure** âœ… **CRITICAL**
- **Issue:** Habitat items disappeared on browser refresh, guinea pigs remained
- **Root Cause:** Chew item serialization breaking Pinia persistence
  - Original serializer used `...state` spread (worked correctly)
  - Chew system added `chewItems: serializeMap(state.chewItems)` to serializer
  - `chewItems` from `useHabitatContainers()` composable included functions
  - Functions can't serialize to JSON, breaking entire persistence silently
- **Fix:** Removed `chewItems` from custom serializer, reverted to working pattern
- **File:** [habitatConditions.ts:1011](../src/stores/habitatConditions.ts#L1011)

### Technical Lessons Learned

**Pinia Persistence with Composables:**
- âš ï¸ **Never serialize composable properties directly** - they may include functions
- âœ… **Use `...state` spread** - Pinia automatically excludes non-serializable properties
- âœ… **Only explicitly serialize Maps** - they need custom serialization
- âŒ **Don't list all properties manually** - risks including composable functions

**Behavior Composable Caching:**
- âœ… **Cache stateful composables** - recreating them resets internal state
- âœ… **Clean up on entity removal** - prevent memory leaks
- âœ… **Use Map for instance management** - keyed by entity ID

**Grid Coordinate Systems:**
- âœ… **Document coordinate spaces** - main grid vs subgrid scales
- âœ… **Convert between systems explicitly** - multiply by scale factor + offset
- âœ… **Add debug logging** - critical for diagnosing coordinate issues

### Files Modified (Bug Fixes)
- `src/stores/habitatConditions.ts` - Fixed persistence serializer
- `src/stores/gameTimingStore.ts` - Reduced interval, cached behavior composables
- `src/composables/game/useGuineaPigBehavior.ts` - Fixed poop coordinates
- `src/components/game/habitat/HabitatVisual.vue` - Auto-initialize positions

### Testing Verification
- âœ… Guinea pigs initialize at random positions when AI enabled
- âœ… Guinea pigs move autonomously every 1-3 seconds
- âœ… Poop appears near guinea pig position (subgrid accuracy)
- âœ… Habitat items persist correctly after browser refresh
- âœ… All autonomous behaviors working (eat, drink, sleep, groom, chew, poop)

---

## ðŸš€ **Phase 4: Guinea Pig Autonomy**

**Status:** ðŸŸ¢ In Progress - System 19 Complete, Bug Fixes Complete
**Priority:** HIGH
**Estimated Time:** 15-25 hours

### System 19: Autonomous AI Behaviors âœ… **Phases 1-4 Complete**

**Status:** âœ… Core implementation complete - Ready for integration testing
**Implementation Time:** ~8 hours

**Completed Features:**
- âœ… **Phase 1:** Core AI decision matrix + basic need behaviors (eat, drink, sleep, wander, groom, shelter)
- âœ… **Phase 2:** Enhanced sleep (bed selection, quality multipliers 1.0x-1.85x) + proactive shelter (boldness modifiers)
- âœ… **Phase 3:** Friendship behaviors (popcorn, zoomies, watch, hide based on friendship 0-100%)
- âœ… **Phase 4:** Item interactions (preference-based eating, hay racks, chew items) + activity feed messages
- âœ… **Environmental:** Autonomous poop dropping (30 second intervals)
- âœ… **Debug Tools:** Autonomy threshold controls + poop debug panel

**Activity Feed Messages - ALL COMPLETE âœ…**
- âœ… Eating (preference-based food bowl)
- âœ… Eating hay (from hay racks)
- âœ… Drinking (from water bottles)
- âœ… Sleeping (location-aware - bed/shelter/floor)
- âœ… Grooming (self-care)
- âœ… Chewing (dental health items)
- âœ… Shelter seeking (hideaways)
- âœ… Friendship behaviors (popcorn, zoomies, watching, hiding)
- âœ… Environmental (autonomous poop dropping every 30s)

**Integration Complete âœ…**
- âœ… AI tick system integrated into game timing loop
- âœ… Global autonomy controls panel (enable/disable AI, adjust tick interval 1-10s)
- âœ… Autonomous behaviors execute automatically when game is active
- âœ… All active guinea pigs process AI decisions every game tick

**Optional Future Enhancements:**
- [ ] Test with multiple guinea pigs simultaneously (functional testing)
- [ ] Add visual indicators for current behavior state (polish)
- [ ] Performance optimization for multiple guinea pigs (if needed)

**Files Created/Modified:**
- `src/composables/game/useGuineaPigBehavior.ts` - Complete autonomous AI system (1000+ lines)
- `src/composables/game/usePathfinding.ts` - A* pathfinding
- `src/composables/game/useMovement.ts` - Movement controller with personality-based speed
- `src/components/game/habitat/GuineaPigSprite.vue` - Guinea pig rendering with z-index
- `src/components/debug/environment/AutonomyDebug.vue` - Autonomy controls + global settings
- `src/components/debug/environment/PoopDebug.vue` - Poop system debug panel
- `src/utils/messageGenerator.ts` - Added 12 autonomous behavior message generators
- `src/stores/guineaPigStore.ts` - Added lastPoopTime tracking, NeedType export
- `src/stores/petStoreManager.ts` - Initialize lastPoopTime
- `src/stores/gameTimingStore.ts` - **Integrated AI tick into game loop**

### Goal
Implement autonomous guinea pig behavior with need-based decision making, pathfinding, and intelligent item usage.

### Core Systems

#### **4.1: Autonomous Behavior System** âœ… **COMPLETE**
- âœ… Need-based behavior triggers (thirst â†’ seek water, hunger â†’ seek food)
- âœ… Priority queue for competing needs
- âœ… Personality-influenced decision making
- âœ… Friendship-gated behaviors

#### **4.2: Pathfinding & Movement** âœ… **COMPLETE**
- âœ… A* pathfinding on habitat grid
- âœ… Smooth sprite movement between cells
- âœ… Obstacle avoidance (items block paths)
- âœ… Multiple guinea pigs don't collide

#### **4.3: Item Interaction AI** âœ… **COMPLETE**
- âœ… Autonomous water drinking when thirsty
- âœ… Autonomous food consumption from bowls (preference-based)
- âœ… Hay eating from hay racks
- âœ… Shelter seeking when stressed
- âœ… Toy/chew item usage for happiness

#### **4.4: Guinea Pig Sprites & Animation** ðŸŸ¡ **IN PROGRESS**
- âœ… Visual representation on habitat grid
- âœ… Movement animations (walking, facing direction)
- ðŸŸ¡ Activity animations (drinking, eating, sleeping) - States tracked, animations pending
- ðŸ“‹ Breed-specific appearances

### Integration Points
- âœ… Position tracking (System 16 Phase 4)
- âœ… Item type metadata (System 16 Phase 1)
- âœ… Water consumption (System 16 Phase 2)
- âœ… Usage history (System 16 Phase 5)
- âœ… Needs system (Phase 2)
- âœ… Habitat conditions (Phase 3)

**Documentation:** [System 19: Autonomous AI Behaviors](systems/phase4/system-19-autonomous-ai-behaviors.md)

---

## ðŸŽ¯ **High Priority Improvements**

### Phase 4 Comprehensive Code Audit ðŸ”¥
**Priority:** CRITICAL - Before continuing Phase 4
**Status:** ðŸ“‹ Not Started

**Goal:** Review all Phase 4 code implemented so far for quality, patterns, and technical debt

**Scope:**
- âœ… **System 19 - Autonomous AI Behaviors** - Complete implementation (~1000 lines)
- âœ… **Chew Item Degradation System** - Usage-based degradation with persistence
- âœ… **Autonomy Debug Controls** - Global AI settings panel
- âœ… **Bug Fixes** - Position initialization, movement caching, coordinate conversion, persistence

**Review Checklist:**
- [ ] **Code Quality**
  - [ ] Review useGuineaPigBehavior.ts (1000+ lines) - Look for opportunities to break into smaller composables
  - [ ] Check for proper error handling in all autonomous behavior functions
  - [ ] Verify TypeScript strict mode compliance
  - [ ] Identify and remove debug console.log statements
  - [ ] Check for code duplication across behavior functions

- [ ] **Architecture Patterns**
  - [ ] Verify composable caching pattern in gameTimingStore.ts is correct
  - [ ] Review Map-based behavior instance management for memory leaks
  - [ ] Check singleton pattern consistency in useHabitatContainers.ts
  - [ ] Validate coordinate conversion approach (grid vs subgrid)
  - [ ] Review Pinia persistence serializer pattern

- [ ] **Performance**
  - [ ] Analyze game loop performance with multiple guinea pigs
  - [ ] Check for unnecessary reactive subscriptions
  - [ ] Review pathfinding cache efficiency
  - [ ] Verify behavior composable cleanup on guinea pig removal
  - [ ] Test with 2+ active guinea pigs simultaneously

- [ ] **Vue Reactivity**
  - [ ] Audit all Map mutations for proper reactivity triggers
  - [ ] Check computed properties for optimization opportunities
  - [ ] Verify ref unwrapping in Pinia stores
  - [ ] Review watchers for unnecessary re-runs

- [ ] **Integration & Dependencies**
  - [ ] Verify activity feed message integration for all behaviors
  - [ ] Check need satisfaction amounts for game balance
  - [ ] Review personality trait influence on behaviors
  - [ ] Validate item usage tracking and effectiveness decay
  - [ ] Test autonomous poop system timing and cleanup

- [ ] **Documentation**
  - [ ] Add JSDoc comments to complex AI decision functions
  - [ ] Document grid coordinate system and conversion formulas
  - [ ] Update system integration docs with actual implementation patterns
  - [ ] Create troubleshooting guide for common AI issues

**Files to Focus On:**
- `src/composables/game/useGuineaPigBehavior.ts` - 1000+ lines, core AI logic
- `src/stores/gameTimingStore.ts` - Behavior composable caching
- `src/stores/habitatConditions.ts` - Persistence serializer pattern
- `src/composables/game/useMovement.ts` - Movement controller
- `src/composables/game/usePathfinding.ts` - A* pathfinding
- `src/components/debug/environment/AutonomyDebug.vue` - Debug controls

**Success Criteria:**
- No technical debt blocking future Phase 4 work
- Clear patterns established for remaining systems (17, 18, 20, 21)
- Performance validated with multiple guinea pigs
- All code follows project standards from CLAUDE.md

---

### Currency Reward System ðŸ”¥
**Goal:** Implement currency earning system that rewards good guinea pig care

**Concept:** Friendship Dividends - Guinea pigs earn currency based on friendship points Ã— wellness
- Active pigs: `(friendshipPoints / 100) Ã— (wellness / 100) Ã— 20 = currency/hour`
- Sanctuary pigs: `(friendshipPoints / 100) Ã— 30 = currency/hour` (higher rate, friendship-only)
- Offline accumulation (8-hour cap to prevent FOMO)
- Bonus systems: Daily login (+100), interactions (+5 each), friendship milestones (250-2000 points)
- Self-balancing economy that scales with progression and rewards long-term bonds

**Documentation:** [Currency Reward System Design](game-design/currency-reward-system.md)

**Implementation Priority:** HIGH - Required before expanding supplies catalog

---

### Friendship System Redesign ðŸ”¥
**Goal:** Change from percentage (0-100%) to infinite point-based with levels

**Key Changes:**
- Point-based progression (not capped at 100%)
- 10+ tiered levels (Level 4 = Stardust Sanctuary unlock)
- Migration: existing friendship % Ã— 10 = starting points

**Files:** guineaPig.ts, guineaPigStore.ts, petStoreManager.ts, GuineaPigEditor.vue

---

### Port Real Food Items to Preferences ðŸ”¥
**Goal:** Replace hardcoded food arrays with Supplies Store catalog

**Implementation:**
- Pull food from `suppliesStore.getFoodByCategory()` instead of hardcoded lists
- Update preference generation to use real item IDs
- Validate guinea pig preferences against Supplies Store

**Files:** GuineaPigEditor.vue, petStoreManager.ts, guineaPigStore.ts

---

### Personality-Based Habitat Sensitivity âœ… **COMPLETE**
**Status:** âœ… Completed October 21, 2025
**Goal:** Add 5th personality trait (cleanliness 1-10) affecting habitat tolerance

**Implemented Features:**
- âœ… Added `cleanliness` trait to GuineaPigPersonality (1=tolerant/piggy, 10=picky/sensitive)
- âœ… Habitat acceptance thresholds based on cleanliness:
  - **Picky (7-10):** Won't eat hay <60% fresh, stressed by mess
  - **Moderate (4-6):** Baseline 40% thresholds
  - **Piggy (1-3):** Tolerates mess, eats hay down to 20% fresh
- âœ… Decay rate modifiers:
  - Picky guinea pigs: Slower hygiene/health decay (85% rate)
  - Piggy guinea pigs: Faster hygiene/health decay (115% rate)
- âœ… PersonalityDebug panel integration with cleanliness slider and decay previews

**Files Modified:**
- `src/stores/guineaPigStore.ts` - Added cleanliness trait, habitat sensitivity thresholds, decay modifiers
- `src/stores/petStoreManager.ts` - Initialize cleanliness on guinea pig creation
- `src/components/debug/gameplay/PersonalityDebug.vue` - Added cleanliness controls and visual feedback

---

## ðŸ”§ **Technical Improvements**

### Smart Bedding Consumption System
**Priority:** MEDIUM (Quality of Life)
**Status:** ðŸ“‹ Not Started

**Current Issue:** "Refresh Bedding" button always consumes 1 entire bag of bedding regardless of how dirty the habitat is.

**Goal:** Implement smart bedding consumption that uses partial bags based on actual habitat needs.

**Requirements:**
- 1 bag of bedding = 1 full medium habitat space (100% bedding coverage)
- Calculate how much bedding is needed based on current cleanliness level
- Only consume the amount needed (e.g., if habitat is 60% clean, only consume 40% of a bag)
- Similar implementation to hay handful system but for bedding refresh
- If multiple partial bags exist, combine them before opening new bags
- Track partial bags in inventory (e.g., "Average Bedding - 60% remaining")

**Files to Modify:**
- `src/stores/habitatConditions.ts` - Update `refreshBedding()` method with smart consumption
- `src/stores/inventoryStore.ts` - Add partial bag tracking for bedding
- `src/components/debug/environment/HabitatDebug.vue` - Update UI to show partial bag info

---

## ðŸ”§ **Technical Debt & Polish**

### Code Quality Audit ðŸ”¥
**Priority:** HIGH - Before Phase 4
**Status:** ðŸ“‹ Not Started

**Verify code against best practices:**
- [ ] **Review all Phase 3 code** - Check for technical debt, anti-patterns, or code smells
- [ ] **Verify singleton patterns** - Ensure useHabitatContainers and other composables follow best practices
- [ ] **Check Vue reactivity** - Audit all Map/Set mutations for proper reactivity triggers
- [ ] **TypeScript strictness** - Ensure proper typing, no `any` types where avoidable
- [ ] **Error handling** - Verify consistent error handling patterns across stores and composables
- [ ] **Performance check** - Review computed properties, watchers, and refs for optimization opportunities
- [ ] **Memory leaks** - Check for proper cleanup in onUnmounted hooks and component lifecycle

### Style & Component Audit ðŸ”¥
**Priority:** HIGH - Before Phase 4
**Status:** ðŸ“‹ Not Started

**Identify reusable patterns and style violations:**
- [ ] **Audit component styles** - Check for duplicate CSS that could be extracted to utilities
- [ ] **BEM methodology** - Verify all components follow BEM naming conventions
- [ ] **Logical properties** - Ensure all spacing/positioning uses logical properties (not physical)
- [ ] **Reusable components** - Identify patterns that could become shared components
- [ ] **CSS variables** - Check for hardcoded values that should use design tokens
- [ ] **Component hierarchy** - Review heading levels (h1-h6) across all components for semantic correctness
- [ ] **Accessibility** - Audit for ARIA labels, keyboard navigation, focus management
- [ ] **Mobile responsiveness** - Test all new components on mobile viewports

**Files to Focus On:**
- `src/components/debug/environment/HabitatDebug.vue` - Recently modified, verify sectioning and styles
- `src/components/game/habitat/HabitatCareSidebar.vue` - New component, verify against style guide
- `src/components/game/habitat/FoodBowl.vue` - Complex popover logic, check for reusability
- `src/composables/useHabitatContainers.ts` - Critical singleton, verify pattern correctness

### Code Cleanup
- [ ] Standardize error handling patterns
- [ ] Add TypeScript strict mode compliance
- [ ] Audit and remove unused code
- [ ] Remove debug console.log statements

### UI/UX Improvements
- [ ] Add loading states for long operations
- [ ] Improve mobile responsiveness for debug panels
- [ ] Add keyboard shortcuts for common debug actions
- [ ] Add tooltips/help text for complex controls

### Documentation
- [ ] Create component library reference
- [ ] Add inline JSDoc comments for complex functions
- [ ] Update architecture diagrams for Phase 3/4
- [ ] Document singleton patterns and Vue reactivity best practices

---

## ðŸ“ **Sprint Notes**

### Phase 3 Accomplishments
All Phase 3 systems complete:
1. âœ… Supplies Store (104+ items)
2. âœ… Inventory Management (instance-based with sell-back)
3. âœ… Habitat Conditions (resource consumption)
4. âœ… Habitat UI (drag-and-drop, phases 1-2)
5. âœ… Serving System (hay racks, food bowls)
6. âœ… Maintenance (poop, cleanliness, bedding, water)
7. âœ… Autonomy Preparation (5 phases complete)

**Phase 3 is now feature-complete and ready for Phase 4 autonomy development.**

### Next Steps
1. Begin Phase 4 with autonomous behavior system
2. Implement pathfinding for guinea pig movement
3. Create guinea pig sprites and animations
4. Integrate item interaction AI

---

## ðŸŽ® **Testing Checklist**

### System 16 Testing
- [x] Water consumption reduces water level correctly
- [x] Environmental decay applies over time
- [x] Guinea pig positions initialized on activation
- [x] Item effectiveness decays with use
- [x] Effectiveness recovery works hourly
- [x] All systems persist across page reload

### Phase 4 Preparation
- [ ] Verify all autonomy data available to AI
- [ ] Test need-based behavior triggers
- [ ] Validate pathfinding grid setup
- [ ] Confirm item interaction hooks

---

## ðŸš€ **Commands**

**Development:**
- `npm run dev` - Start development server
- `npm run build` - Production build (run before commits)
- `npm run preview` - Preview production build

**Git:**
- Current branch: `GPS2-33`
- Main branch: `main`

---

## ðŸ“š **Documentation Links**

- [Project Plan](PROJECT_PLAN.md)
- [Development Phases](DEVELOPMENT_PHASES.md)
- [System Integration](SYSTEM_INTEGRATION.md)
- [Phase 3 Systems](systems/phase3/)
- [Phase 4 Systems](systems/phase4/)
- [System 16: Autonomy Preparation](systems/phase3/system-16-autonomy-preparation.md)
