# GPS2 Sprint - December 31, 2025

**Started:** December 31, 2025
**Status:** Phase 4 - Interactions, Animation & Visual Polish
**Branch:** main
**Previous Sprint:** [SPRINT-2025-12-28.md](../phase3.5/archived/SPRINT-2025-12-28.md)

---

## Last Sprint Accomplishments (Dec 28-30)

- **Mobile Optimization** - Pinch-to-zoom, two-finger pan, safe area support, dynamic viewport height
- **New 3D Food Models** - Carrot stick, pellet pile, lettuce pile with food routing system
- **UI Color Contrast Fixes** - Green/cyan FAB colors, cyan color palette, activity log icon
- **Code Audit & Bug Fixes** - Index bounds, food selection reset, CSS logical properties, cleanup
- **Interaction Handler Refactoring** - Extracted petting/hand-feed to `use3DInteractions.ts` composable
- **Model Viewer Mobile** - Touch controls, mobile-first styles, UX fixes

---

## Critical Bugs & Blockers

None currently blocking. Medium priority bugs carried to backlog.

---

## High Priority Tasks

### 1. Code & CSS Audit
**Priority:** HIGH
**Status:** ‚úÖ Complete

**Goal:** Audit all code changes since last audit (Dec 28) for quality and consistency

**Files Audited (17 total):**

*Initial audit (Dec 30 changes):*
- `src/composables/3d-models/food/pellets.ts` ‚úÖ
- `src/composables/3d-models/food/greens.ts` ‚úÖ
- `src/composables/3d-models/food/vegetables.ts` ‚úÖ
- `src/composables/3d-models/containers/bowls.ts` ‚úÖ
- `src/components/debug/prototypes/ModelViewerDebug.vue` ‚úÖ
- `src/styles/game-fab.css` ‚úÖ
- `src/styles/variables.css` ‚úÖ

*Additional audit (Dec 28-30 missed files):*
- `src/composables/3d-models/food/held-food.ts` ‚úÖ
- `src/composables/3d/use3DInteractions.ts` ‚úÖ
- `src/composables/use3DCamera.ts` ‚úÖ
- `src/styles/game-view.css` ‚úÖ
- `src/components/game/SidePanel3D.vue` ‚úÖ
- `src/components/debug/environment/Habitat3DDebug.vue` ‚úÖ
- `src/components/game/GameView.vue` ‚úÖ
- `src/composables/3d-models/shelters/tunnels.ts` ‚úÖ
- `src/constants/3d.ts` ‚úÖ
- `src/types/supplies.ts` ‚úÖ

**Checklist Results:**
- [x] BEM naming convention
- [x] CSS logical properties (no physical margin/padding)
- [x] CSS variables usage
- [x] TypeScript strict types
- [x] THREE.js resource cleanup
- [x] No scoped styles
- [x] Consistent patterns

**Result:** All 17 files pass with no issues found.

---

### 2. Chat Bubbles
**Priority:** HIGH
**Status:** ‚úÖ Complete

**Goal:** Add guinea pig chat bubbles for reactions - parity with 2D game

**Implementation Approach:** HTML Overlay
- Chose HTML overlay approach for crisp text rendering
- Uses world-to-screen coordinate projection (`camera.project()`)
- Consistent with existing 3D UI patterns (menus, popovers)

**Files Created:**
- `src/composables/3d/use3DChatBubbles.ts` - Composable for bubble management
- `src/components/game/ChatBubble3D.vue` - Chat bubble component

**Files Modified:**
- `src/components/game/GameView.vue` - Integration with animation loop

**Tasks:**
- [x] Research best approach for 3D chat bubbles (HTML Overlay chosen)
- [x] Create `use3DChatBubbles.ts` composable
- [x] Create `ChatBubble3D.vue` component
- [x] Position above guinea pig head (Y offset + 3.5 units)
- [x] Trigger via `show-chat-bubble` event (same as 2D)
- [x] Add reaction text/emoji content
- [x] Auto-dismiss after duration (default 3 seconds)
- [x] Hide when guinea pig is behind camera

**Features:**
- One bubble per guinea pig at a time (new replaces old)
- 5 color variants: positive, neutral, negative, warning, critical
- Mobile-responsive sizing
- Reduced motion support
- Animated enter transition

**Chat Bubble Trigger Analysis:**

| Trigger Source | 2D Status | 3D Status | Notes |
|----------------|-----------|-----------|-------|
| **GP-to-GP Social** (`useSocialBehaviors.ts`) | ‚úÖ | ‚úÖ | Uses document events, works in both |
| **Autonomous Behaviors** (`useGuineaPigBehavior.ts`) | ‚úÖ | ‚úÖ | Uses document events, works in both |
| **Pet interaction** | ‚úÖ | ‚úÖ | Added to `use3DInteractions.ts` |
| **Hand-feed interaction** | ‚úÖ | ‚úÖ | Added to `use3DInteractions.ts` |
| **Hold interaction** | ‚úÖ | ‚ùå | Interaction not implemented in 3D yet |
| **Gentle Wipe interaction** | ‚úÖ | ‚ùå | Interaction not implemented in 3D yet |
| **Show Toy interaction** | ‚úÖ | ‚ùå | Interaction not implemented in 3D yet |
| **Trim Nails interaction** | ‚úÖ | ‚ùå | Interaction not implemented in 3D yet |
| **Talk To interaction** | ‚úÖ | ‚ùå | Interaction not implemented in 3D yet |
| **Clean Cage care** | ‚úÖ | ‚úÖ | Added to `use3DHabitatCare.ts` |
| **Quick Clean care** | ‚úÖ | ‚úÖ | Added to `use3DHabitatCare.ts` |
| **Water Refill care** | ‚úÖ | ‚úÖ | Added to `use3DHabitatCare.ts` |
| **Hay Fill care** | ‚úÖ | ‚úÖ | Added to `HayManagementDialog.vue` |
| **Bowl Fill care** | ‚úÖ | ‚úÖ | Added to `use3DContainerMenu.ts` |

**Next Steps for Chat Bubbles:**
1. ~~Add chat bubble triggers to `use3DHabitatCare.ts` for care actions~~ ‚úÖ Complete
2. ~~Add bowl fill chat bubble~~ ‚úÖ Complete (via container menu)
3. Implement remaining 5 player-to-GP interactions with chat bubbles

---

### 3. Item Removal from Habitat
**Priority:** HIGH
**Status:** ‚úÖ Complete

**Goal:** Allow removing placed items (toys, balls, tunnels, shelters) from habitat back to inventory

**Implementation:**
- [x] Add click/tap handler on placed items
- [x] Show context menu with "Remove" option
- [x] Call `habitatConditions.removeItemFromHabitat()`
- [x] Call `inventoryStore.unmarkAsPlacedInHabitat()`
- [x] Remove 3D model from scene
- [x] Add activity log entry

**Files Created:**
- `src/composables/3d/use3DItemPopover.ts` - Composable for item popover state/actions
- `src/components/game/ItemPopover3D.vue` - Popover UI component

**Files Modified:**
- `src/components/game/GameView.vue` - Click detection and integration

**Notes:**
- Handles `hideaways`, `toys`, and `enrichment` subcategories
- Regular click = show popover, Shift+click = physics push (same pattern as chews)
- Chews and bowls/bottles have their own specialized menus
- **"Move to Inventory"** for non-degradable items (can then be sold from inventory)
- Chews have no "move to inventory" option - they stay until discarded when unsafe

---

### 4. Multiple Item Placement
**Priority:** HIGH
**Status:** ‚úÖ Complete

**Goal:** Support placing multiple instances of same item type in habitat

**Tasks:**
- [x] Test current behavior with multiple food bowls
- [x] Test with multiple water bottles
- [x] Test with multiple toys
- [x] Fix issues with instance tracking
- [x] Ensure each instance has unique position/state

**Bugs Fixed:**

#### 4a. Per-Bottle Water Tracking
**Issue:** Multiple water bottles showed the same water percentage (global `waterLevel` ref).

**Root Cause:** Water level was stored as a single global value, not per-bottle like bowls/hay racks.

**Solution:** Implemented per-bottle water tracking in `useHabitatContainers.ts`:
- Added `WaterBottleData` interface and `waterBottles` Map
- Added per-bottle management functions: `initializeWaterBottle`, `getWaterBottleLevel`, `setWaterBottleLevel`, `refillWaterBottle`, `consumeWaterFromBottle`, `findAvailableWaterBottle`, `removeWaterBottle`
- Changed `waterLevel` from mutable ref to computed getter (`getAggregateWaterLevel()`)
- Updated `refillWater()` to accept optional `bottlePlacementId`
- Updated `consumeWater()` to use `findAvailableWaterBottle()` for GP drinking
- Added persistence support for `waterBottles` Map

**Files Modified:**
- `src/composables/useHabitatContainers.ts` - Added water bottle tracking
- `src/stores/habitatConditions.ts` - Changed to use per-bottle water levels
- `src/composables/3d/use3DWaterBottle.ts` - Added `currentBottleWaterLevel` computed
- `src/components/game/GameView.vue` - Pass per-bottle water level to menu

#### 4b. "Move to Inventory" Buttons
**Issue:** Water bottles, bowls, and hay racks lacked "Move to Inventory" buttons in their popovers.

**Solution:** Added removal functionality to all container popovers:
- Water bottles: Added `handleRemoveWaterBottle()` to `use3DWaterBottle.ts`
- Bowls/Hay racks: Added `handleRemoveContainer()` to `use3DContainerMenu.ts`
- Added `remove` emit and "üì¶ Move to Inventory" button to `WaterBottleMenu.vue`
- Added `remove` emit and button to `ContainerContentsMenu.vue`

#### 4c. Hay Rack & Bowl 3D Content Not Visible
**Issue:** Hay in hay racks and food in bowls not appearing visually, despite correct data in popovers.

**Root Cause:** `createItemModel()` was called with **base item ID** (e.g., `habitat_hay_rack_wooden`), but `getHayRackContents()` and `getBowlContents()` use **placement IDs** as keys (e.g., `habitat_hay_rack_wooden::instance_abc`). Content lookup always returned empty.

**Solution:** Changed `use3DItems.ts` to pass placement ID instead of base item ID to `createItemModel()`:
- Line 57: Initial model creation
- Line 125: Bowl contents watcher re-render
- Line 167: Hay rack contents watcher re-render

The placement ID contains the base item ID as a prefix, so model type detection via `includes()` still works correctly.

**Files Modified:**
- `src/composables/use3DItems.ts` - Pass placement ID to `createItemModel()`

#### 4d. Water Bottle Level Update Spam Warning
**Issue:** Console spam with "Water bottle does not have waterMesh in userData" warning every animation frame.

**Root Cause (Part 1):** `findWaterBottleModel()` in `use3DWaterBottle.ts` was using placement IDs directly with `suppliesStore.getItemById()`, which expects base item IDs. The lookup failed.

**Root Cause (Part 2):** `createItemModel()` checked for `itemId.includes('water') && itemId.includes('bottle')`, but some water bottle IDs don't contain "water":
- `habitat_basic_water_bottle` ‚úì
- `habitat_large_capacity_bottle` ‚úó (missing "water")
- `habitat_wellness_bottle` ‚úó (missing "water")
- `habitat_refreshing_bottle` ‚úó (missing "water")

**Solution:**
- Fixed `findWaterBottleModel()` to use `getBaseItemId()` before supply lookup
- Added `getAllWaterBottles()` function returning all bottles with placement IDs
- Updated GameView.vue animation loop to iterate all bottles and update each with its individual water level
- Simplified `createItemModel()` check to `itemId.includes('bottle')` (all bottle items are water bottles)
- Fixed same check in `use3DItems.ts` for water bottle rotation

**Files Modified:**
- `src/composables/3d/use3DWaterBottle.ts` - Fixed lookup, added `getAllWaterBottles()`
- `src/components/game/GameView.vue` - Updated animation loop for per-bottle updates
- `src/composables/3d-models/index.ts` - Simplified water bottle detection
- `src/composables/use3DItems.ts` - Fixed water bottle rotation check

---

### 5. Chew Item Popover Menu
**Priority:** HIGH
**Status:** ‚úÖ Complete

**Goal:** Add popover menu for chew items (parity with 2D game)

**Features:**
- [x] Click/tap on placed chew item shows popover menu
- [x] Display remaining durability (percentage bar with color coding)
- [x] "Remove Chew" button (returns to inventory)
- [x] "Discard Unsafe Chew" button (appears when durability < 20%)
- [x] Position popover near clicked item (uses Floating UI)

**Files Created:**
- `src/composables/3d/use3DChewPopover.ts` - Composable for popover state/actions
- `src/components/game/ChewPopover3D.vue` - Popover UI component

**Files Modified:**
- `src/components/game/GameView.vue` - Click detection and integration

**Notes:**
- Uses same pattern as container menus (bowl/hay rack)
- Durability thresholds: Good (80%+), Worn (40-80%), Degraded (20-40%), Unsafe (<20%)
- Chewing degradation already works in 3D via `useHabitatContainers.chewItem()`
- **Interaction**: Regular click = popover, Shift+click = physics push
- Auto-initializes chew tracking on first click if not already tracked
- **Bug Fix**: Added `habitatContainers.chewItem()` call in `use3DBehavior.ts` `finishChewing()` to degrade durability when GP chews

---

### 6. FAB Color Reorganization
**Priority:** LOW
**Status:** ‚úÖ Complete

**Goal:** Reorganize FAB button colors for better visual hierarchy

**Changes:**
| Button | Before | After |
|--------|--------|-------|
| Heart/Interact (üíõ) | Pink | Violet |
| Interact Popover | Pink theme | Violet theme |
| Open Control Panel | Violet | Pink |
| Habitat Care (üè†) | Green | Cyan |
| Habitat Care Subactions | Green | Cyan |
| Help (‚ùì) | Cyan | Green |

**Files Modified:**
- `src/components/game/GameView.vue` - FAB color class changes
- `src/components/game/SidePanel3D.vue` - Control panel button color
- `src/styles/game-fab.css` - Added `.game-fab-sub--cyan` style

---

## Medium Priority (Backlog)

### User-to-GP Interactions (5 Remaining)
**Status:** üöß In Progress (from previous sprint)

**Completed:**
- [x] Pet interaction
- [x] Hand Feed interaction

**Remaining:**
- [ ] **Hold** - Pick up guinea pig (+20-30% social, +2 friendship)
- [ ] **Gentle Wipe** - Cleaning (+40-50% cleanliness, +5% social, +1 friendship)
- [ ] **Show Toy** - Show toy to GP (+10-15% play, +5% social, +1 friendship)
- [ ] **Trim Nails** - Nail maintenance (+40-50% nails, +1 friendship)
- [ ] **Talk To** - Voice interaction (+10-15% social, +1 friendship)

---

### GP-to-GP Social Interactions
**Status:** üöß In Progress
**Goal:** Player-triggered GP-to-GP social interactions via FAB menu + autonomous social behavior

**Current Bonding Mechanics (already implemented in 2D):**

| Interaction | Bond Change | Source |
|-------------|-------------|--------|
| Approach Companion | +1 | `useSocialBehaviors.ts` |
| Groom Partner | +5 | `useSocialBehaviors.ts` |
| Play Together | +4 | `useSocialBehaviors.ts` |
| Share Food | +3 | `useSocialBehaviors.ts` |
| Sleep Together | +2 | `useSocialBehaviors.ts` |
| Cuddle Together | +2 | `useSocialBehaviors.ts` |
| Greet | +1 | `useSocialBehaviors.ts` |
| Inspect | +2 | `useSocialBehaviors.ts` |
| Follow | +1 | `useSocialBehaviors.ts` |
| Kick (negative) | -3 to -5 | `useSocialBehaviors.ts` |
| Sleep at same position | +2 | `useGuineaPigBehavior.ts` |

**Igloo/Shelter Bonding:** GPs sleeping at the same position (e.g., on top of igloo) get +2 bond when both are in "sleeping" activity state.

**FAB Implementation Plan:**

- **Icon:** üëØ (two figures) - represents two GPs together
- **Button color:** Golden yellow-orange (#fec802) - warm/social, high visibility
- **CSS:** `game-fab--red-orange` class (name kept for consistency)
- **Location:** Right FAB container, above Interact FAB

**Interaction Flow (mirrors U2G pattern):**
1. Player clicks Social FAB (üëØ) ‚Üí menu opens
2. Player selects action (e.g., "Approach Companion")
3. Instruction overlay appears: "Select a guinea pig to initiate socialization!"
4. Player clicks on a guinea pig (the "initiator")
5. Initiator GP performs the social action toward the other GP (the "target")
6. Bond change applied, chat bubbles shown

**State Management:**
- `pendingSocialAction` ref stores selected action ID (like `pendingInteraction` for U2G)
- On GP click, check if `pendingSocialAction` is set
- If set, trigger social behavior instead of normal click action
- Clear `pendingSocialAction` after execution

**Tasks:**
- [x] Add `game-fab--red-orange` color variant to `game-fab.css`
- [x] Add GP-to-GP FAB button (üëØ golden yellow)
- [x] Create FabSubnavMenu with social actions (orange theme)
- [x] Add `pendingSocialAction` state and instruction overlay
- [x] Wire up GP click to check for pending social action
- [x] Call `useSocialBehaviors.ts` functions on GP selection
- [x] Add 3D animation for "Approach Companion" action
- [x] Add autonomous social behavior to 3D behavior system
- [ ] Add 3D animations for remaining social interactions (play, groom)

**Autonomous Social Behavior (3D):**
When guinea pig's social need drops below threshold (55%), they will autonomously:
1. Find their bonded companion (prioritizes highest bond level)
2. Walk to companion and face them (4 second facing duration)
3. Restore social need (+25 initiator, +17 partner)
4. Increase bond (+1)

**Configuration (`use3DBehavior.ts`):**
- `THRESHOLDS.social`: 55% - triggers social seeking
- `COOLDOWNS.socialize`: 45 seconds between social interactions
- `RESTORE_AMOUNTS.social`: 25 points restored

**Files Modified:**
- `src/composables/3d/use3DBehavior.ts` - Added social goal selection and execution
- `src/composables/3d/use3DSocialActions.ts` - Shared by both FAB and autonomous triggers

**Social Actions Menu:**
| Action | Icon | Instruction Message |
|--------|------|---------------------|
| Approach Companion | üö∂ | "Select a guinea pig to initiate socialization!" |
| Play Together | üéæ | "Select a guinea pig to start playing!" |
| Groom Partner | ‚ú® | "Select a guinea pig to groom their companion!" |
| Share Food | ü•¨ | "Select a guinea pig to share food!" |
| Greet | üëã | "Select a guinea pig to greet their companion!"

---

### Fix Guinea Pig Collisions
**Status:** ‚úÖ Complete
**Issue:** Guinea pigs walk through arch tunnel, igloo walls, water bottle

**Root Cause Analysis:**
- Obstacle radii in pathfinding were too small compared to visual model sizes
- Pathfinding margin (0.5) was too small to account for guinea pig body
- Tunnels were incorrectly treated as solid obstacles (should be passable)

**Solution:**

1. **Increased obstacle radii** in `movement3DStore.ts`:
   | Item | Before | After |
   |------|--------|-------|
   | food_bowl | 1.5 | 2.0 |
   | water_bottle | 1.5 | 2.5 |
   | shelter | 4.0 | 4.5 |
   | igloo | 4.0 | 4.5 |
   | tunnel | 3.0 | 0 (passable) |
   | hideout | 2.5 | 3.0 |
   | bed | 2.5 | 3.0 |
   | hay_rack | 2.0 | 2.5 |
   | default | 1.5 | 2.0 |

2. **Increased pathfinding margin** in `use3DPathfinding.ts`:
   - `getAvoidanceWaypoint()` margin: 0.5 ‚Üí 1.2
   - `findNearestValidPosition()` margin: 0.5 ‚Üí 1.2

3. **Made tunnels passable:**
   - Set tunnel radius to 0
   - Added skip logic for 0-radius obstacles in `syncObstaclesFromHabitat()`

**Files Modified:**
- `src/stores/movement3DStore.ts` - Updated obstacle radii
- `src/composables/3d/use3DPathfinding.ts` - Increased pathfinding margin

---

### Replace Comfort Need with Stimulation
**Goal:** Replace comfort need with stimulation need (documented in docs folder)

---

## Low Priority (Backlog)

### GameView.vue Refactoring
**Status:** üìã Planned

**Issue:** GameView.vue has grown to 1634 lines and is becoming bloated.

**Goal:** Analyze and extract logic into appropriate composables/helper files.

**Potential Extractions:**
- [ ] Click/raycast handling ‚Üí `use3DClickHandler.ts`
- [ ] Guinea pig model management ‚Üí enhance `use3DGuineaPig.ts`
- [ ] Animation loop logic ‚Üí `use3DAnimationLoop.ts`
- [ ] Chewing state management ‚Üí already in `use3DBehavior.ts`
- [ ] Popover/menu coordination ‚Üí `use3DMenus.ts` aggregator

---

### Transition to External GLTF Models
**Status:** üìã Planned

**Goal:** Move from procedural THREE.js geometry to external GLTF/GLB model files for better scalability

**Benefits:**
- Models don't bloat JS bundle (loaded on demand)
- Can use Blender for more detailed/complex models
- Enables LOD (level of detail) for performance
- Easier artist workflow

**Tasks:**
- [ ] Set up `public/models/` directory structure
- [ ] Create model loader utility with caching
- [ ] Convert existing procedural models to GLTF (Blender export)
- [ ] Implement lazy loading for model categories
- [ ] Add loading states/placeholders while models load

**Model Categories:**
- Guinea pigs (with fur pattern variants)
- Habitat items (bowls, bottles, shelters)
- Food items (vegetables, hay, pellets)
- Enrichment items (toys, tunnels, hideouts)

---

### Add "Move Object" Button to Habitat Items
**Status:** üìã Planned

**Goal:** Allow repositioning placed items without removing and re-placing

**Scope:** Any item that has a "Move to Inventory" button should also have a "Move Object" button

**Tasks:**
- [ ] Add "Move Object" button to item popovers (ItemPopover3D, ContainerContentsMenu, WaterBottleMenu, ChewPopover3D)
- [ ] Re-enter placement mode with existing item selected
- [ ] Remove item from old position when new position confirmed
- [ ] Update obstacle positions in pathfinding

---

### Other Backlog Items
- Water bottle drinking animation
- Mini progress bars in Habitat Care FABs
- Bedding items should look disabled in Inventory Panel
- Enhance groom animation
- Create fur patterns

---

## Sprint Completion Criteria

Before closing this sprint:
- [x] Code & CSS audit completed with fixes applied
- [x] Chat bubbles implemented and working
- [x] Item removal from habitat working
- [x] Multiple item placement tested and working
- [x] Chew item popover menu working
- [x] All changes documented in sprint doc
- [x] `npm run build` passes

---

## Commands

**Development:**
- `npm run dev` - Start development server
- `npm run build` - Production build (run before commits)
- `npm run preview` - Preview production build

**Git:**
- Current branch: `main`
- Main branch: `main`

---

## Reference Files

| Feature | Reference |
|---------|-----------|
| 3D Interactions | `src/composables/3d/use3DInteractions.ts` |
| Chat Bubbles | `src/composables/3d/use3DChatBubbles.ts` |
| Chat Bubble Component | `src/components/game/ChatBubble3D.vue` |
| Container Menu | `src/composables/3d/use3DContainerMenu.ts` |
| Water Bottle Menu | `src/composables/3d/use3DWaterBottle.ts` |
| Chew Popover | `src/composables/3d/use3DChewPopover.ts` |
| Chew Popover Component | `src/components/game/ChewPopover3D.vue` |
| Item Popover | `src/composables/3d/use3DItemPopover.ts` |
| Item Popover Component | `src/components/game/ItemPopover3D.vue` |
| Placement Mode | `src/composables/3d/use3DPlacement.ts` |
| Habitat Care | `src/composables/3d/use3DHabitatCare.ts` |
| Social Actions 3D | `src/composables/3d/use3DSocialActions.ts` |
| Habitat Containers | `src/composables/useHabitatContainers.ts` |
| 3D Items Sync | `src/composables/use3DItems.ts` |
| 3D Hand Model | `src/composables/3d-models/use3DHand.ts` |
| Food Models | `src/composables/3d-models/food/` |
| Model Viewer | `src/components/debug/prototypes/ModelViewerDebug.vue` |
| Habitat Debug | `src/components/debug/environment/Habitat3DDebug.vue` |
| Habitat Conditions | `src/stores/habitatConditions.ts` |

---

## Documentation Links

- [Project Plan](../../PROJECT_PLAN.md)
- [Development Phases](../../DEVELOPMENT_PHASES.md)
- [Previous Sprint](../phase3.5/archived/SPRINT-2025-12-28.md)
