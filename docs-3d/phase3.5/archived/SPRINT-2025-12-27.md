# GPS2 3D Sprint - December 27, 2025

**Started:** December 27, 2025
**Status:** Active
**Branch:** GPS2-60
**Previous Sprint:** [SPRINT-2025-12-25.md](./archived/SPRINT-2025-12-25.md)

---

## Sprint Goals

**Focus:** Behavior Parity, UI Polish, Bug Fixes

**Priority Areas:**
1. Complete all autonomous guinea pig behaviors (3D parity with 2D)
2. Fix bugs and improve UX (activity feed, camera, keyboard shortcuts)
3. UI renaming and polish
4. Visual polish for guinea pig appearance

---

## Completed This Sprint

- [x] **Fix animations not pausing** - Clouds and water bottle bubbles now pause when game is paused
- [x] **Move Help FAB to left side** - Repositioned for better UI balance
- [x] **Sidebar button icon** - Changed from üì¶ to ‚ò∞, title to "Control Panel"
- [x] **Consolidate Help overlay to BaseDialog** - Created HelpDialog.vue, removed ~120 lines of custom CSS from Habitat3DDebug.vue, fixes scrolling issues
- [x] **Dialog scroll lock** - BaseDialog now locks body scroll when open, with scrollbar width compensation to prevent layout shift
- [x] **Fix food consumption bug** - Guinea pigs now properly consume food from bowls and hay from racks when eating (was only satisfying hunger need without removing food)
- [x] **Fix Activity Feed** - Added activity logging to 3D behavior system (was missing loggingStore calls for eating, drinking, grooming, sheltering, sleeping, pooping)
- [x] **Enhanced Habitat Physics** - Added physics system for ball/stick items: velocity, damping, collision, rolling animation, click interaction
- [x] **Chewing Behavior** - Guinea pig finds chew items, picks them up (pinned to mouth), gnaws with subtle head shake animation
- [x] **Play/Chew Item Shake Animation** - Ball and stick now shake with guinea pig's head movement during play/chew (were static before)
- [x] **Popcorn Animation** - Guinea pig does happy jump after playing with toy (body twist, leg kicks, excited eyes)
- [x] **Interact FAB & Subnav Menu** - Renamed Guinea Pigs FAB to Interact (üíõ), created FabSubnavMenu popover with 7 actions (Pet, Hold, Hand Feed, Gentle Wipe, Show Toy, Peek-a-Boo, Talk To)
- [x] **3D Hand Model** - Simpsons-style yellow hand for user interactions (bubbly, chunky, cartoonish design with articulated fingers)
- [x] **Petting Animation** - Hand descends, pets guinea pig with stroking motion, rises back up (3.1s animation)
- [x] **Pet Interaction Need Fulfillment** - Petting now satisfies social need (+25) and increases friendship (+2), logs activity with ü´≥ emoji
- [x] **Pet Interaction UX** - Instruction overlay ("Click the guinea pig you want to pet!"), hand cursor in pet mode, pink hover ring on guinea pigs (persists during petting)
- [x] **Hover Ring System** - Green hover ring on guinea pigs in normal gameplay, pink in pet mode; shared `createRingMesh()` helper eliminates code duplication
- [x] **Guinea Pig Sidebar Tab** - User Friendship section (progress bar, last interaction, total interactions), GP-to-GP Bonding section with bonding level and tier display

---

## Active Tasks

### Code & CSS Audit ‚úÖ
**Priority:** HIGH (P1)
**Category:** Code Quality
**Status:** COMPLETE

**Goal:** Audit new code added since last audit (Dec 25 sprint)

**Files Audited:**
- [x] `ActionResultDialog.vue` - PASS
- [x] `usePopover.ts` - PASS
- [x] `HelpDialog.vue` - PASS

**Fixes Applied:**
- [x] `stats.css` - Fixed `border-bottom` ‚Üí `border-block-end`

**Checklist:**
- [x] TypeScript strict compliance
- [x] BEM naming convention
- [x] CSS logical properties
- [x] CSS variables usage
- [x] Memory management (cleanup)
- [x] Error handling

---

### Enhanced Habitat Physics (Prerequisite for Play/Chew) ‚úÖ
**Priority:** HIGH (P1)
**Category:** Feature
**Status:** COMPLETE

**Goal:** Add physics to habitat items like in 3D demo

**Why First:** Physics system is needed for Play and Chew behaviors:
- **Chewing:** May need to disable/lock physics while guinea pig is chewing an item
- **Playing:** Need controlled physics during play interaction (push ball, bat stick)
- **Wandering/Idle:** Allow natural free physics (items can be bumped, roll naturally)
- **Take Control mode:** Physics should respond naturally to guinea pig movement

**Features Implemented:**
- [x] Clicking stick/ball makes them roll naturally
- [x] Guinea pig can push stick, ball, and other appropriate items
- [x] Physics state management (locked, controlled, free)

**Files Created:**
- `src/types/physics3d.ts` - Physics types and presets (ball, stick configs)
- `src/stores/physics3DStore.ts` - Pinia store for physics state
- `src/composables/3d/use3DPhysics.ts` - Physics composable with update loop

**Files Modified:**
- `src/composables/use3DItems.ts` - Auto-registers ball/stick for physics
- `src/components/debug/environment/Habitat3DDebug.vue` - Physics in animation loop + click handler

**Physics Implementation Details:**
- Ball: damping 0.96, bounce 0.7, perpendicular rolling
- Stick: damping 0.90, bounce 0.5, X-axis rolling
- Guinea pig collision: pushes items when within 1.6 units
- Wall collision: clamps position, reflects velocity
- Obstacle collision: pushes out of obstacles, reflects velocity

---

### Complete All Autonomous Actions
**Priority:** HIGH (P1)
**Category:** Behavior Parity
**Status:** IN PROGRESS (Physics prerequisite complete)

**Goal:** Implement remaining autonomous behaviors in 3D to match 2D parity

**Current 3D Behaviors:**
- [x] Eating (food bowl)
- [x] Drinking (water bottle)
- [x] Sleeping
- [x] Seek Shelter
- [x] Grooming
- [x] Pooping
- [x] Idle wandering
- [x] Hay eating (consumes hay from rack)

**Missing 3D Behaviors (require physics):**
- [x] **Playing** - Find toys, play animation, satisfy play need ‚úÖ
  - Implementation: GP walks to toy, shakes it (head waggle + ball shakes with head), headbutts it (toy rolls via physics), then popcorns!
  - Threshold: 55%, Cooldown: 90s, Duration: 6s, Restore: 35%
  - Item shake: Ball moves side-to-side synced with head movement (was static before)
  - Popcorn: After headbutt, GP does happy jump (0.5s animation)
  - Files: `use3DBehavior.ts`, `use3DGuineaPig.ts`, `use3DPhysics.ts`, `Habitat3DDebug.vue`
- [x] **Chewing** - Gnaw on sticks/chews, item pinned to mouth ‚úÖ
  - Implementation: GP walks to chew item, picks it up (pinned to mouth), gnaws with subtle head shake
  - Threshold: 60%, Cooldown: 60s, Duration: 5s, Restore: 40%
  - Item shake: Stick rotates and bobs synced with head gnawing motion (was static before)
  - Files: `use3DBehavior.ts`, `use3DGuineaPig.ts`, `Habitat3DDebug.vue`

**Note:** Socializing behavior moved to GP2GP section (requires multi-guinea-pig coordination)

---

### Implement Chewing Behavior ‚úÖ
**Priority:** HIGH (P1)
**Category:** Behavior Parity
**Status:** COMPLETE

**Goal:** Guinea pig finds chew items and chews on them to satisfy chew need

**Implementation:**
- Item detection for `subCategory === 'chews'` (also matches 'stick', 'chew' in item ID)
- Threshold: 60%, Cooldown: 60s, Duration: 5s, Restore: 40%
- Chew animation: subtle head shake + gnawing motion (up-down nod)
- Stick pinned to guinea pig's mouth during chewing (perpendicular rotation)
- **Stick shake animation:** Stick rotates and bobs synced with head gnawing motion
- Physics locked while chewing, unlocked on finish
- Activity logging with ü™µ emoji

**Files Modified:**
- `src/composables/3d/use3DBehavior.ts` - Added chew behavior logic, callbacks
- `src/composables/use3DGuineaPig.ts` - Added chew animation (gnawing motion)
- `src/components/debug/environment/Habitat3DDebug.vue` - Wired up callbacks, item pinning with shake

---

### Implement Popcorn Animation ‚úÖ
**Priority:** LOW (P3)
**Category:** Animation Polish
**Status:** COMPLETE

**Goal:** Guinea pig does a happy "popcorn" jump after playing with a toy

**Implementation:**
- Triggered automatically after `finishPlaying()` completes
- New activity state: `'popcorning'`
- Duration: 500ms
- Animation features:
  - Parabolic jump arc (1.5 units high)
  - Body twist during jump (z-rotation)
  - Legs kick out (all 4 feet)
  - Excited wide eyes (1.2x scale)
  - Smooth return to ground after animation

**Files Modified:**
- `src/composables/3d/use3DBehavior.ts` - Added popcorning activity, `startPopcorning()`, `finishPopcorning()`, callbacks
- `src/composables/use3DGuineaPig.ts` - Added popcorn animation state with jump physics
- `src/components/debug/environment/Habitat3DDebug.vue` - Wired up popcorn callbacks, reset phase on start

---

### Clean Up Hay Rack UI ‚úÖ
**Priority:** LOW (P3)
**Category:** UI Polish
**Status:** COMPLETE

**Goal:** Review and polish hay rack related UI components

**Completed:**
- Fixed "No hay racks to fill" bug (dialog now finds placed hay racks correctly)
- Unified dialog styles with new `.game-dialog` class system (320px min-width)
- Replaced custom `.hay-status*` styles with global `.stats-grid` classes
- Added `.stat-value--success` for green freshness indicator
- "Replace All Hay" button always visible, disabled when racks full & fresh
- Text colors fixed (was black, now uses theme colors)

---

### Fix Activity Feed ‚úÖ
**Priority:** HIGH (P1)
**Category:** Bug Fix
**Status:** COMPLETE

**Issue:** Activity feed not showing any logs except pause and resume messages

**Root Cause:** The 3D behavior system (`use3DBehavior.ts`) was implemented without activity logging - no import of `loggingStore` and no calls to log behavior completions.

**Fixes Applied:**

**1. Autonomous Behavior Logging** (`use3DBehavior.ts`):
- `finishEating()` - logs eating food/hay with appropriate emoji
- `finishDrinking()` - logs drinking water üíß
- `finishGrooming()` - logs grooming ‚ú®
- `finishSheltering()` - logs leaving shelter üè†
- `finishSleeping()` - logs waking up üò¥
- `checkAutonomousPooping()` - logs pooping üí© (as environmental event)

**2. Player Action Logging** (`Habitat3DDebug.vue`):
- `fabQuickClean()` - logs quick clean result üßΩ
- `fabRefillWater()` - logs water refill with amount üíß
- `handleRefillWater()` - logs water refill from bottle menu üíß
- `handleContainerFill()` - logs filling hay rack üåæ
- `handleContainerClear()` - logs clearing hay rack üåæ or food bowl ü•ó
- `handleAddItemToContainer()` - logs adding food to bowl (with food name/emoji) or hay to rack üåæ

**3. Hay Management Dialog Logging** (`HayManagementDialog.vue`):
- `handleAddServing()` - logs adding hay to rack üåæ
- `handleClearRack()` - logs clearing hay rack üåæ
- `handleReplaceAll()` - logs replacing all hay with count üåæ

**4. Activity Feed Display Fix** (`Habitat3DDebug.vue`):
- Reversed message order so newest appear at top: `[...loggingStore.activityMessages].reverse()`

---

### 3D Game View Improvements ‚úÖ
**Priority:** HIGH (P1)
**Category:** UX
**Status:** COMPLETE

**Tasks:**
- [x] On page load, camera should have a clear centered view of the entire habitat
  - Changed INITIAL_POSITION from `{ x: 10, y: 15, z: 30 }` to `{ x: 0, y: 22, z: 28 }`
- [x] When not in fullscreen, show pause button next to Enter Fullscreen button
  - Added pause/resume button to game-view__header
- [x] Rename class `habitat-3d-debug__normal-header` to `game-view__header`
  - Updated class in template and CSS

---

### Keyboard Shortcuts ‚úÖ
**Priority:** MEDIUM (P2)
**Category:** UX
**Status:** COMPLETE

**Tasks:**
- [x] Add shortcut for pause/play:
  - `Space` toggles pause/resume (shows pause dialog)
  - `Shift+Space` toggles pause/resume silently (no dialog)
- [x] Optimize camera control keyboard shortcuts:
  - `Q/E` for rotation (more intuitive than comma/period)
  - `R` to reset camera to initial position
  - Comma/period kept for backward compatibility
- [x] Add Shift+Drag for camera panning:
  - Regular drag = rotate view
  - `Shift+Drag` = pan camera (move X/Z position)

**Files Modified:**
- `src/stores/gameController.ts` - Added 'silent' pause reason
- `src/composables/use3DCamera.ts` - Q/E rotation, R reset, Shift+drag pan
- `src/components/debug/environment/Habitat3DDebug.vue` - Space/Shift+Space for pause
- `src/components/game/dialogs/HelpDialog.vue` - Updated shortcuts documentation
- `src/constants/3d.ts` - Added MOUSE_PAN_SPEED constant

---

### User-to-GP FAB & Interactions
**Priority:** MEDIUM (P2)
**Category:** Feature / UI
**Status:** IN PROGRESS

**Goal:** Rename Guinea Pigs FAB and implement user-initiated interactions - parity with 2D game

**UI Tasks:**
- [x] Rename "Guinea Pigs" FAB to "Interact" with üíõ yellow heart icon
- [x] Create FabSubnavMenu component for action grid popover
  - Pink themed, 4-column grid with icons + text labels
  - Uses Floating UI (usePopover) for smart positioning
  - Reusable pattern for other FABs
- [x] Change inventory sidebar button icon to something more generic
  - Changed from üì¶ to ‚ò∞ (hamburger menu)

**Interaction Actions (7 total):**
- ü´≥ Pet
- ü´¥ Hold
- ü•ï Hand Feed (needs food selection dialog)
- üßº Gentle Wipe
- üß∏ Show Toy
- üëÄ Peek-a-Boo
- üí¨ Talk To

**Files Created:**
- `src/components/game/FabSubnavMenu.vue` - Reusable grid popover component
- `src/styles/fab-subnav.css` - Styles with theme variants (pink, green, violet, yellow)
- `src/composables/3d-models/use3DHand.ts` - Simpsons-style 3D hand model

**3D Hand Model:**
- Simpsons yellow (#FFD90F) cartoonish hand
- Bubbly, chunky design with stubby fingers
- Articulated joints for animation (3 joints per finger)
- Predefined poses: open, closed, pointing, petting, holding, wave
- Palm: scaled sphere (2.8 x 1.2 x 2.2 units)
- Fingers: chunky spheres (radii 0.34-0.42)

**Petting Interaction (implemented):**
- [x] Two-step flow: Select Pet ‚Üí Click guinea pig ‚Üí Hand animates
- [x] Hand descends from above, pets guinea pig, rises back up
- [x] Animation duration: 3.125 seconds (descend ‚Üí stroke ‚Üí rise)
- [x] Hand rotation: palm faces down, fingers perpendicular to floor
- [x] Activity logging with ü´≥ emoji
- [x] Instruction overlay: "Click the guinea pig you want to pet!" (pink themed)
- [x] Cursor changes to hand when in pet mode
- [x] Pink hover ring on guinea pigs (persists during petting)
- [x] Social need fulfillment: +25 social, +2 friendship
- [x] Tracks lastInteraction and totalInteractions

**Hand Feed Interaction (implemented):**
- [x] FoodSelectionDialog integration (6 food categories)
- [x] Food selection ‚Üí guinea pig targeting flow
- [x] Instruction overlay shows selected food name
- [x] Need effects: hunger +10, social +15
- [x] Friendship: +3, tracks lastInteraction & totalInteractions
- [x] Consumes food from inventory (supports serving system)
- [x] Activity logging with food emoji
- [x] **Hand Feed Animation**:
  - New 'gripping' hand pose (fingers curled to hold food)
  - Food morsel mesh (colored sphere: orange=carrot, green=veggies, brown=pellets)
  - 2.5s animation: descend ‚Üí linger (GP accepts) ‚Üí food disappears ‚Üí rise
  - Pink hover ring during animation

**Remaining:**
- [ ] Hook up need fulfillment for remaining interactions:
  - [ ] Hold ‚Üí social need (+20-30%)
  - [ ] Gentle Wipe ‚Üí cleanliness need (+40-50%), social need (+5%)
  - [ ] Show Toy ‚Üí play need (+10-15%), social need (+5%)
  - [ ] Peek-a-Boo ‚Üí social need (+10%)
  - [ ] Talk To ‚Üí social need (+10-15%)
- [ ] Wire up actual interaction logic for remaining 5 actions:
  - [ ] Hold (ü´¥)
  - [ ] Gentle Wipe (üßº)
  - [ ] Show Toy (üß∏)
  - [ ] Peek-a-Boo (üëÄ)
  - [ ] Talk To (üí¨)

---

### Guinea Pig Sidebar Tab Implementation ‚úÖ
**Priority:** MEDIUM (P2)
**Category:** UI Feature
**Status:** COMPLETE

**Goal:** Build out the Guinea Pigs tab in the right sidebar

**Completed Features (Phase 1):**
- [x] User Friendship section with FriendshipProgress component
- [x] Last interaction timestamp (formatted as "Just now", "5m ago", etc.)
- [x] Total interactions counter
- [x] GP-to-GP Bonding section (shows when 2+ guinea pigs)
  - Bonding progress bar with gradient fill
  - Bonding level percentage
  - Bonding tier badge (Neutral, Friends, Bonded)
- [x] Toggle between guinea pigs when multiple exist
- [x] Syncs with 3D click selection
- [x] Empty state when no guinea pigs

**Completed Features (Phase 2):**
- [x] Guinea pig info section (breed, gender, fur color/pattern)
- [x] Activity history/log (last 5 activities with relative timestamps)

**Files Modified:**
- `src/components/game/Inventory3DPanel.vue` - Guinea Pigs tab content with User Friendship, GP-to-GP Bonding, Guinea Pig Info, and Activity History sections

---

### Item Removal from Habitat
**Priority:** MEDIUM (P2)
**Category:** Feature

**Goal:** Allow removing placed items (toys, balls, tunnels, shelters) from habitat back to inventory

**Implementation:**
- Add click menu on placed items with "Remove" option
- Call `habitatConditions.removeItemFromHabitat()` and `inventoryStore.unmarkAsPlacedInHabitat()`

**Notes:**
- 2D version only has removal for chew items (via hover popover)
- Backend already exists, just need UI trigger

---

### Chat Bubbles
**Priority:** MEDIUM (P2)
**Category:** Feature

**Goal:** Add guinea pig chat bubbles for reactions - parity from 2D game

**Questions:**
- Would 3D chat bubbles look cute?
- Flat 3D (billboard style)?

---

### Refactor Habitat3DDebug Component
**Priority:** MEDIUM (P2)
**Category:** Code Quality

**Goal:** Extract logic from oversized component into composables before it grows further

**Extraction Candidates:**
- Container menu logic ‚Üí composable
- Placement mode logic ‚Üí composable
- FAB handlers ‚Üí composable
- Water bottle menu ‚Üí separate component

---

## Backlog (Future Refinement)

### Guinea Pig to Guinea Pig Actions (GP2GP) & Socializing Behavior
**Priority:** MEDIUM (P2)
**Category:** Feature / Behavior Parity

**Goal:** Implement GP-to-GP social actions and autonomous socializing - parity with 2D game

**Autonomous Socializing Behavior:**
- [ ] Guinea pig seeks out another guinea pig when social need is low
- [ ] Approach animation, social interaction, satisfy social need
- 2D reference: `useSocialBehaviors.ts`

**Player-Initiated GP2GP Actions:**
- Social interaction
- Play together
- Groom each other
- Greet
- Check out

**Notes:**
- Requires multi-guinea-pig coordination logic
- May need pathfinding to locate other guinea pigs
- Social interactions affect both guinea pigs' needs

**Files to Modify:**
- `src/composables/3d/use3DBehavior.ts` - Add social behavior
- `src/composables/3d/use3DSocialBehaviors.ts` - New composable for GP2GP

---

### Replace Comfort Need with Stimulation
**Priority:** MEDIUM (P2)
**Category:** Game Design

**Goal:** Replace comfort need with stimulation need

**Notes:** This is documented in the docs folder somewhere

---

### 3D Models
**Priority:** MEDIUM (P2)
**Category:** Assets

**Tasks:**
- Create 3D models for other food items
- Enhance hay 3D model
- Create 3D models for some other habitat items

---

### Fix Guinea Pig Collisions
**Priority:** MEDIUM (P2)
**Category:** Bug Fix

**Issue:** Guinea pigs walk through arch tunnel, igloo walls, water bottle

**Goal:** Proper collision detection/avoidance

---

### Water Bottle Drinking Animation
**Priority:** LOW (P3)
**Category:** Animation

**Goal:** Guinea pig visually drinks through water bottle spout

---

### Multiple Item Instances Testing
**Priority:** LOW (P3)
**Category:** Testing

**Goal:** Test adding multiple instances of:
- Food containers
- Water bottles
- Toys, etc.

---

### Mini Progress Bars in Habitat Care FABs
**Priority:** LOW (P3)
**Category:** UI Enhancement

**Goal:** When Habitat Care FAB is expanded, show mini progress bars in each pill

**Metrics:**
- Water level %
- Hay freshness % (average of all racks)
- Bedding freshness %
- Poop ratio (poops until dirty)

---

### Bedding Items in Inventory Panel Should Look Disabled
**Priority:** LOW (P3)
**Category:** UI Enhancement

**Goal:** Bedding Items in the Inventory Panel should look disabled and grayed out to prevent confusion. 

---

### Enhance Groom Animation
**Priority:** LOW (P3)
**Category:** Animation

**Goal:** Improve the current grooming animation

---

### Create Fur Patterns
**Priority:** LOW (P3)
**Category:** Visual Polish

**Reason:** Complex texture work, solid colors sufficient for MVP.

---

## Reference Files

| Feature | Reference |
|---------|-----------|
| Unified Behavior System | `src/composables/3d/use3DBehavior.ts` |
| Movement Controller | `src/composables/3d/use3DMovement.ts` |
| Guinea Pig Animation | `src/composables/use3DGuineaPig.ts` |
| 3D Hand Model | `src/composables/3d-models/use3DHand.ts` |
| 3D Model Sync | `src/composables/use3DSync.ts` |
| Habitat Containers | `src/composables/useHabitatContainers.ts` |
| Hay Management Dialog | `src/components/game/dialogs/HayManagementDialog.vue` |
| Container Menu | `src/components/basic/ContainerContentsMenu.vue` |
| Inventory Panel | `src/components/game/Inventory3DPanel.vue` |
| Friendship Progress | `src/components/game/ui/FriendshipProgress.vue` |
| FAB Subnav Menu | `src/components/game/FabSubnavMenu.vue` |
| FAB Subnav Styles | `src/styles/fab-subnav.css` |
| Habitat Debug | `src/components/debug/environment/Habitat3DDebug.vue` |
| Habitat Conditions Store | `src/stores/habitatConditions.ts` |
| 2D Behavior Reference | `src/composables/useGuineaPigBehavior.ts` |
