# GPS2 3D Sprint - December 25, 2025

**Started:** December 25, 2025
**Status:** Active
**Branch:** GPS2-57
**Previous Sprint:** [SPRINT-2025-12-14.md](./archived/SPRINT-2025-12-14.md)

---

## Sprint Goals

**Focus:** Code Quality, Feature Testing, UI/UX Polish

**Priority Areas:**
1. Code and CSS audits for new features
2. Test all new 3D habitat features
3. Fix critical bugs (poop positioning, take control mode)
4. UI/UX improvements (popovers, FABs, keyboard controls)

---

## Completed Tasks

### Code & CSS Audit ‚úÖ
**Category:** Code Quality

**Goal:** Audit new code added since last audit

**Files Audited:**
- [x] `HayManagementDialog.vue` - ‚úÖ Clean
- [x] `ContainerContentsMenu.vue` - ‚úÖ Clean
- [x] `Inventory3DPanel.vue` - ‚úÖ Clean
- [x] `useHabitatContainers.ts` - ‚úÖ Clean
- [x] `Habitat3DDebug.vue` - ‚úÖ Fixed magic number

**Checklist:**
- [x] TypeScript strict compliance - ‚úÖ All files compliant
- [x] BEM naming convention - ‚úÖ All files compliant
- [x] CSS logical properties - ‚úÖ All files use logical properties
- [x] CSS variables usage - ‚úÖ All valid (`--spacing-*` are aliases for `--space-*`)
- [x] Memory management (cleanup) - ‚úÖ No issues
- [x] Error handling - ‚úÖ Proper null checks throughout

**Issues Found & Fixed:**
1. ~~`Habitat3DDebug.vue:1042`: Magic number `4`~~ ‚Üí Now uses `CONSUMPTION.HAY_RACK_MAX_CAPACITY`

**Notes:**
- `clearBowl` deletes entry while `clearHayRack` keeps entry - intentional (racks need tracking when empty)

---

### Fix Poop Spawn Position ‚úÖ
**Category:** Bug Fix

**Issue:** ~~Poops appear in wrong places instead of dropping under the guinea pig~~ ‚úÖ FIXED

**Root Cause:** Two issues:
1. Lossy conversion chain between coordinate systems (world ‚Üí grid ‚Üí subgrid ‚Üí store ‚Üí subgrid ‚Üí world)
2. **Primary issue:** The 2D behavior system (`useGuineaPigBehavior`) was running via `gameTimingStore` even in 3D mode, creating poops without world coordinates

**Solution Implemented:**
- Added optional `worldX`/`worldZ` fields to Poop interface
- Updated `addPoop()` to accept optional world coordinates
- Updated `checkAutonomousPooping()` in use3DBehavior.ts to pass world coords directly
- Updated use3DPoop.ts to use world coordinates when available (falls back to subgrid for 2D)
- **Key fix:** Added mode check in `gameTimingStore.ts` to skip 2D behavior tick when in 3D mode

**Files Modified:**
- `src/stores/habitatConditions.ts` - Poop interface + addPoop function
- `src/composables/3d/use3DBehavior.ts` - checkAutonomousPooping function
- `src/composables/use3DPoop.ts` - Poop rendering logic
- `src/stores/gameTimingStore.ts` - Skip 2D behavior in 3D mode

---

### WASD/Arrow Keyboard Controls ‚úÖ
**Category:** UX

**Goal:** ~~W/D/X/A keyboard controls for moving guinea pig, same as arrow keys.~~ Clarified: WASD for camera, arrows context-sensitive.

**Implementation:**
- **WASD** - Always controls camera panning
- **Arrow keys** - Control camera when NOT in Take Control mode
- **Arrow keys** - Control guinea pig when IN Take Control mode
- Added `disableArrowKeys` option to `use3DCamera` composable
- Added arrow key guinea pig movement in `handleKeyDown`

**Files Modified:**
- `src/composables/use3DCamera.ts` - Added WASD, arrow key disable option
- `src/components/debug/environment/Habitat3DDebug.vue` - Arrow key guinea pig control

---

### Allow More Camera Zoom Out ‚úÖ
**Category:** UX

**Goal:** ~~Allow more zooming out to view entire habitat~~ ‚úÖ DONE

**Changes:**
- Increased `HEIGHT_MAX` from 20 to 50 in `CAMERA_CONFIG`
- Adjusted `TILT_OFFSET_MULTIPLIER` from 0.5 to 0.4 for better centering when zoomed out

**File Modified:** `src/constants/3d.ts`

---

### Create Habitat World Boundaries ‚úÖ
**Category:** UX

**Goal:** ~~Create boundaries around habitat world so camera doesn't drift endlessly~~ ‚úÖ DONE

**Implementation:**
- Added `BOUND_X_MIN/MAX` and `BOUND_Z_MIN/MAX` to `CAMERA_CONFIG`
- Boundaries: X ¬±35, Z -30 to +40 (extra room in +Z for viewing angle)
- Camera X/Z positions now clamped in `updateCameraPosition()`

**Files Modified:**
- `src/constants/3d.ts` - Added boundary constants
- `src/composables/use3DCamera.ts` - Added X/Z clamping

---

### Fix Fullscreen Distortion ‚úÖ
**Category:** Bug Fix

**Goal:** ~~Fullscreen is distorted on large monitors - need to constrain proportions~~ ‚úÖ FIXED

**Implementation:**
- Added 16:10 aspect ratio constraint to fullscreen canvas wrapper
- Canvas now uses `max-inline-size` calculated from viewport height √ó aspect ratio
- Added `margin-inline: auto` to center canvas horizontally
- Added dark background (`#111`) to container for letterboxing effect on wide monitors

**File Modified:** `src/components/debug/environment/Habitat3DDebug.vue`

---

## In Progress

### Fix Take Control Mode üîÑ
**Priority:** HIGH (P1)
**Category:** Bug Fix

**Issue:** ~~Take control mode is not working~~ ‚úÖ Core functionality working

**Remaining Work - 2D Parity:**
- [ ] Show countdown timer until control expires
- [ ] Visual feedback when control is released (ring removal animation)
- [ ] Match 2D game control release behavior

**Current Behavior (Working):**
- Click guinea pig to select
- Click "Take Control" button
- Click in habitat to make guinea pig walk there
- Guinea pig walks around obstacles
- Different colored highlight ring when controlled
- Releases control after 30 seconds

---

## Remaining Backlog

### Testing

#### Test New Features
**Priority:** HIGH (P1)
**Category:** Testing

**Features to Test:**
- [ ] Hay Management Dialog
  - [ ] Shows all hay racks with fullness/freshness
  - [ ] Replace All Hay button works
  - [ ] Per-rack + button adds serving
  - [ ] Per-rack √ó button clears rack
  - [ ] Dialog updates in real-time
- [ ] Container Contents Menu
  - [ ] Food bowl shows individual items with freshness
  - [ ] Hay rack shows servings count
  - [ ] Fill Rack button fills to capacity
  - [ ] Clear button empties container
- [ ] Clean Cage Dialog
  - [ ] Shows bedding options with inventory counts
  - [ ] Full/partial clean works correctly
- [ ] Inventory Panel
  - [ ] Selection styling works
  - [ ] Container fill mode works
  - [ ] Placement mode works

---

### UI/UX Improvements

#### Clean Up Hay Rack UI
**Priority:** MEDIUM (P2)
**Category:** UI Polish

**Goal:** Review and polish hay rack related UI components

---

#### Water Refill Dialog
**Priority:** MEDIUM (P2)
**Category:** Feature

**Goal:** When clicking "Refill Water" FAB action, show a dialog that says "Water refilled successfully!" with stats about water filled, and an OK button to close.

---

#### Help FAB Button
**Priority:** MEDIUM (P2)
**Category:** Feature

**Goal:** Add help game FAB button that contains tutorial info, keyboard shortcuts, etc. Remove `habitat-3d-debug__info` element.

---

#### Item Removal from Habitat
**Priority:** MEDIUM (P2)
**Category:** Feature

**Goal:** Allow removing placed items (toys, balls, tunnels, shelters) from habitat back to inventory.

**Notes:**
- 2D version only has removal for chew items (via hover popover)
- Backend already exists: `habitatConditions.removeItemFromHabitat()` and `inventoryStore.unmarkAsPlacedInHabitat()`
- Need UI to trigger removal (click menu, long-press, or similar)

---

#### Mini Progress Bars in Habitat Care FABs
**Priority:** MEDIUM (P2)
**Category:** UI Enhancement

**Goal:** When Habitat Care FAB is expanded, update internal FABs to show progress:

**Design:**
- Internal FABs should be pills instead of circles
- Each pill contains a mini progress bar showing the metric value
- Metrics:
  - Water level %
  - Hay freshness % (average of all hay racks)
  - Bedding freshness % (for clean habitat)
  - Poop ratio (poops until dirty cage) for quick clean

---

#### Smart Popover Positioning
**Priority:** MEDIUM (P2)
**Category:** UX

**Issue:** Popovers are blocked by hidden overflow of habitat canvas when target is near edge.

**Current Problems:**
- Guinea pig, water, food container popovers get cut off
- Popovers always appear below the target
- Popovers get cut off on left and right sides

**Potential Solutions:**
- Use Popover API (check browser support)
- Use positioning library (Floating UI, Popper.js)
- Write custom positioning logic

---

#### Improve Side Panel Tabs Visibility
**Priority:** LOW (P3)
**Category:** UI Polish

**Goal:** Improve visibility of `.side-panel-3d__tabs`, possibly by creating menu bars to visually bring them on top of the canvas.

---

#### Remove Bedding Tab Pointer/Hover
**Priority:** LOW (P3)
**Category:** UI Polish

**Goal:** Remove pointer cursor and hover state from bedding tab in inventory sidebar (non-interactive display).

---

### Component Refactoring

#### Refactor Habitat3DDebug Component
**Priority:** MEDIUM (P2)
**Category:** Code Quality

**Goal:** Check Habitat3DDebug for code that should be in its own composable/store/component

**Notes:** Component has grown large - identify extraction candidates:
- Container menu logic ‚Üí composable
- Placement mode logic ‚Üí composable
- FAB handlers ‚Üí composable
- Water bottle menu ‚Üí separate component

---

### Animation & Visual Polish

#### Chew Animation
**Priority:** MEDIUM (P2)
**Category:** Animation

**Goal:** Add chew animation for guinea pig when chewing toys/items

---

#### Enhance Groom Animation
**Priority:** LOW (P3)
**Category:** Animation

**Goal:** Improve the current grooming animation

---

#### Create Fur Patterns ‚è∏Ô∏è DEFERRED
**Priority:** LOW (P3)
**Category:** Visual Polish

**Reason:** Complex texture work, solid colors sufficient for MVP.

---

### Guinea Pig Menus (Future)

#### Guinea Pig Click Menu Redesign
**Priority:** LOW (P3)
**Category:** UI/UX

**Goal:** Improve guinea pig interaction menu

**From docs-3d/todos.md:**
- Remove current floating action buttons connected to clicking guinea pig
- Show a larger menu (similar to 2D Habitat View) with:
  - Current needs (static, not sliders)
  - General info
  - "Take Control" button
  - Friendship info

---

## Reference Files

| Feature | Reference |
|---------|-----------|
| Unified Behavior System | `src/composables/3d/use3DBehavior.ts` |
| Movement Controller | `src/composables/3d/use3DMovement.ts` |
| Guinea Pig Animation | `src/composables/use3DGuineaPig.ts` |
| Habitat Containers | `src/composables/useHabitatContainers.ts` |
| Hay Management Dialog | `src/components/game/dialogs/HayManagementDialog.vue` |
| Container Menu | `src/components/basic/ContainerContentsMenu.vue` |
| Inventory Panel | `src/components/game/Inventory3DPanel.vue` |
| Habitat Debug | `src/components/debug/environment/Habitat3DDebug.vue` |
| Habitat Conditions Store | `src/stores/habitatConditions.ts` |
