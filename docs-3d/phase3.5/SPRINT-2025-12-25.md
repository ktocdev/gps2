# GPS2 3D Sprint - December 25, 2025

**Started:** December 25, 2025
**Status:** Active
**Branch:** GPS2-57
**Previous Sprint:** [SPRINT-2025-12-14.md](./archived/SPRINT-2025-12-14.md)

---

## Sprint Goals

**Focus:** Code Quality, Feature Testing, UI/UX Polish

**Priority Areas:**
1. Code and CSS audits for new features
2. Test all new 3D habitat features
3. Fix critical bugs (poop positioning, take control mode)
4. UI/UX improvements (popovers, FABs, keyboard controls)

---

## Completed Tasks

### Code & CSS Audit ‚úÖ
**Category:** Code Quality

**Goal:** Audit new code added since last audit

**Files Audited:**
- [x] `HayManagementDialog.vue` - ‚úÖ Clean
- [x] `ContainerContentsMenu.vue` - ‚úÖ Clean
- [x] `Inventory3DPanel.vue` - ‚úÖ Clean
- [x] `useHabitatContainers.ts` - ‚úÖ Clean
- [x] `Habitat3DDebug.vue` - ‚úÖ Fixed magic number

**Checklist:**
- [x] TypeScript strict compliance - ‚úÖ All files compliant
- [x] BEM naming convention - ‚úÖ All files compliant
- [x] CSS logical properties - ‚úÖ All files use logical properties
- [x] CSS variables usage - ‚úÖ All valid (`--spacing-*` are aliases for `--space-*`)
- [x] Memory management (cleanup) - ‚úÖ No issues
- [x] Error handling - ‚úÖ Proper null checks throughout

**Issues Found & Fixed:**
1. ~~`Habitat3DDebug.vue:1042`: Magic number `4`~~ ‚Üí Now uses `CONSUMPTION.HAY_RACK_MAX_CAPACITY`

**Notes:**
- `clearBowl` deletes entry while `clearHayRack` keeps entry - intentional (racks need tracking when empty)

---

### Fix Poop Spawn Position ‚úÖ
**Category:** Bug Fix

**Issue:** ~~Poops appear in wrong places instead of dropping under the guinea pig~~ ‚úÖ FIXED

**Root Cause:** Two issues:
1. Lossy conversion chain between coordinate systems (world ‚Üí grid ‚Üí subgrid ‚Üí store ‚Üí subgrid ‚Üí world)
2. **Primary issue:** The 2D behavior system (`useGuineaPigBehavior`) was running via `gameTimingStore` even in 3D mode, creating poops without world coordinates

**Solution Implemented:**
- Added optional `worldX`/`worldZ` fields to Poop interface
- Updated `addPoop()` to accept optional world coordinates
- Updated `checkAutonomousPooping()` in use3DBehavior.ts to pass world coords directly
- Updated use3DPoop.ts to use world coordinates when available (falls back to subgrid for 2D)
- **Key fix:** Added mode check in `gameTimingStore.ts` to skip 2D behavior tick when in 3D mode

**Files Modified:**
- `src/stores/habitatConditions.ts` - Poop interface + addPoop function
- `src/composables/3d/use3DBehavior.ts` - checkAutonomousPooping function
- `src/composables/use3DPoop.ts` - Poop rendering logic
- `src/stores/gameTimingStore.ts` - Skip 2D behavior in 3D mode

---

### WASD/Arrow Keyboard Controls ‚úÖ
**Category:** UX

**Goal:** ~~W/D/X/A keyboard controls for moving guinea pig, same as arrow keys.~~ Clarified: WASD for camera, arrows context-sensitive.

**Implementation:**
- **WASD** - Always controls camera panning
- **Arrow keys** - Control camera when NOT in Take Control mode
- **Arrow keys** - Control guinea pig when IN Take Control mode
- Added `disableArrowKeys` option to `use3DCamera` composable
- Added arrow key guinea pig movement in `handleKeyDown`

**Files Modified:**
- `src/composables/use3DCamera.ts` - Added WASD, arrow key disable option
- `src/components/debug/environment/Habitat3DDebug.vue` - Arrow key guinea pig control

---

### Allow More Camera Zoom Out ‚úÖ
**Category:** UX

**Goal:** ~~Allow more zooming out to view entire habitat~~ ‚úÖ DONE

**Changes:**
- Increased `HEIGHT_MAX` from 20 to 50 in `CAMERA_CONFIG`
- Adjusted `TILT_OFFSET_MULTIPLIER` from 0.5 to 0.4 for better centering when zoomed out

**File Modified:** `src/constants/3d.ts`

---

### Create Habitat World Boundaries ‚úÖ
**Category:** UX

**Goal:** ~~Create boundaries around habitat world so camera doesn't drift endlessly~~ ‚úÖ DONE

**Implementation:**
- Added `BOUND_X_MIN/MAX` and `BOUND_Z_MIN/MAX` to `CAMERA_CONFIG`
- Boundaries: X ¬±35, Z -30 to +40 (extra room in +Z for viewing angle)
- Camera X/Z positions now clamped in `updateCameraPosition()`

**Files Modified:**
- `src/constants/3d.ts` - Added boundary constants
- `src/composables/use3DCamera.ts` - Added X/Z clamping

---

### Fix Fullscreen Distortion ‚úÖ
**Category:** Bug Fix

**Goal:** ~~Fullscreen is distorted on large monitors - need to constrain proportions~~ ‚úÖ FIXED

**Implementation:**
- Added 16:10 aspect ratio constraint to fullscreen canvas wrapper
- Canvas now uses `max-inline-size` calculated from viewport height √ó aspect ratio
- Added `margin-inline: auto` to center canvas horizontally
- Added dark background (`#111`) to container for letterboxing effect on wide monitors

**File Modified:** `src/components/debug/environment/Habitat3DDebug.vue`

---

### Help FAB Button ‚úÖ
**Category:** Feature

**Goal:** ~~Add help game FAB button that contains tutorial info, keyboard shortcuts, etc. Remove `habitat-3d-debug__info` element.~~ ‚úÖ DONE

**Implementation:**
- Added Help FAB button (‚ùì cyan) at bottom of FAB stack
- Created modal overlay with keyboard shortcuts organized by category:
  - üéÆ Camera Controls (WASD, arrows, drag, scroll, Z/X)
  - üêπ Guinea Pig Control (click, Take Control, arrows when controlling)
  - üì¶ Items & Inventory (containers, placement)
  - üñ•Ô∏è View (fullscreen)
- Removed old `habitat-3d-debug__info` bar from top of canvas
- Cleaned up unused CSS (control-badge, placement-badge, info styles)

**File Modified:** `src/components/debug/environment/Habitat3DDebug.vue`

---

### Improve Side Panel Tabs Visibility ‚è™ REVERTED
**Category:** UI Polish

**Goal:** ~~Improve visibility of side panel tabs by creating menu bars to visually bring them on top of the canvas.~~

**Status:** Reverted - menu bar concept didn't fit the UI direction. Replaced with sidebar redesign approach below.

---

### Container Click During Placement Mode ‚úÖ
**Category:** Bug Fix

**Issue:** ~~When an item is selected in inventory for placement, clicking a container shows the popover instead of continuing to place items into it.~~ ‚úÖ FIXED

**Solution:** Keep container fill mode active after successful add. Only exit when:
- Item runs out of servings
- Add fails (container full or incompatible)

**File Modified:** `src/components/debug/environment/Habitat3DDebug.vue`

---

### Fix Take Control Mode ‚úÖ
**Category:** Bug Fix

**Issue:** ~~Take control mode needs 2D parity features~~ ‚úÖ FIXED

**Implementation:**
- Added countdown timer display in guinea pig popover button: "üîÑ Release (Xs)"
- Added control status indicator: "üü¢ Controlling"
- Added hint text: "Click in habitat to move"
- Selection ring changes color (blue when controlled, green when not)
- Timer auto-releases after 30 seconds
- Popover stays open during control to show status

**Files Modified:**
- `src/components/game/GuineaPigInfoMenu.vue` - Added control state UI
- `src/components/debug/environment/Habitat3DDebug.vue` - Added countdown timer logic

---

### Water Refill & Quick Clean Dialogs ‚úÖ
**Category:** Feature

**Goal:** ~~Show feedback dialogs when performing quick actions~~ ‚úÖ DONE

**Implementation:**
- Created reusable `ActionResultDialog` component
- Water Refill: Shows üíß icon, amount filled, new water level
- Quick Clean: Shows üßπ icon, poops removed, cleanliness boost
- Both show appropriate messages when already clean/full

**Files Created:**
- `src/components/game/dialogs/ActionResultDialog.vue`

**Files Modified:**
- `src/components/debug/environment/Habitat3DDebug.vue`

---

## Remaining Backlog

### Testing

#### Test New Features
**Priority:** HIGH (P1)
**Category:** Testing

**Features to Test:**
- [X] Hay Management Dialog
  - [X] Shows all hay racks with fullness/freshness
  - [X] Replace All Hay button works
  - [X] Per-rack + button adds serving
  - [X] Per-rack √ó button clears rack
  - [X] Dialog updates in real-time
- [X] Container Contents Menu
  - [X] Food bowl shows individual items with freshness
  - [X] Hay rack shows servings count
  - [X] Fill Rack button fills to capacity
  - [X] Clear button empties container
- [X] Clean Cage Dialog
  - [X] Shows bedding options with inventory counts
  - [X] Full/partial clean works correctly
- [X] Inventory Panel
  - [X] Selection styling works
  - [X] Container fill mode works
  - [X] Placement mode works

---

### UI/UX Improvements

#### Sidebar Redesign ‚úÖ
**Priority:** HIGH (P1)
**Category:** UI/UX

**Context:** Sidebars work well for displaying information (like in 2D game). FAB buttons work well for quick actions. This redesign improves sidebar usability and adds internal tab navigation.

**Tasks:**

1. ~~**Remove top menu bar**~~ ‚úÖ
   - Removed `.habitat-3d-debug__top-bar` element and CSS

2. ~~**Increase sidebar tab button size**~~ ‚úÖ
   - Tab buttons now 48√ó48px with rounded corners and hover effects
   - Icons updated: üìù (Activity Log), üì¶ (Inventory)

3. ~~**Add internal tab navigation to SidePanel3D**~~ ‚úÖ
   - Added optional `tabs` and `activeTab` props to SidePanel3D
   - Tab buttons appear below header when tabs provided
   - Emits `update:activeTab` for v-model binding

4. ~~**Add Guinea Pig Info tab to right sidebar**~~ ‚úÖ
   - Right sidebar now has Inventory and Guinea Pigs tabs
   - Guinea Pig tab shows placeholder with feature list
   - Ready for full implementation later

**Files Modified:**
- `src/components/game/SidePanel3D.vue` - Tab support
- `src/components/game/Inventory3DPanel.vue` - Two tabs with content
- `src/components/debug/environment/Habitat3DDebug.vue` - Icon updates, top bar removed

**Design Notes:**
- Sidebars = Information display (Activity Feed, Inventory, Guinea Pig Info)
- FABs = Quick actions (Habitat Care, Guinea Pigs selection, Help)
- Guinea Pig popover = Quick info & actions (needs summary, Take Control)
- Guinea Pig sidebar tab = Comprehensive info (full needs, friendship, history)

---

#### Clean Up Hay Rack UI
**Priority:** MEDIUM (P2)
**Category:** UI Polish

**Goal:** Review and polish hay rack related UI components

---

#### Item Removal from Habitat
**Priority:** MEDIUM (P2)
**Category:** Feature

**Goal:** Allow removing placed items (toys, balls, tunnels, shelters) from habitat back to inventory.

**Notes:**
- 2D version only has removal for chew items (via hover popover)
- Backend already exists: `habitatConditions.removeItemFromHabitat()` and `inventoryStore.unmarkAsPlacedInHabitat()`
- Need UI to trigger removal (click menu, long-press, or similar)

---

#### Mini Progress Bars in Habitat Care FABs
**Priority:** MEDIUM (P2)
**Category:** UI Enhancement

**Goal:** When Habitat Care FAB is expanded, update internal FABs to show progress:

**Design:**
- Internal FABs should be pills instead of circles
- Each pill contains a mini progress bar showing the metric value
- Metrics:
  - Water level %
  - Hay freshness % (average of all hay racks)
  - Bedding freshness % (for clean habitat)
  - Poop ratio (poops until dirty cage) for quick clean

---

#### Smart Popover Positioning
**Priority:** MEDIUM (P2)
**Category:** UX

**Issue:** Popovers are blocked by hidden overflow of habitat canvas when target is near edge.

**Current Problems:**
- Guinea pig, water, food container popovers get cut off
- Popovers always appear below the target
- Popovers get cut off on left and right sides

**Potential Solutions:**
- Use Popover API (check browser support)
- Use positioning library (Floating UI, Popper.js)
- Write custom positioning logic

---

#### Remove Bedding Tab Pointer/Hover
**Priority:** LOW (P3)
**Category:** UI Polish

**Goal:** Remove pointer cursor and hover state from bedding tab in inventory sidebar (non-interactive display).

---

### Component Refactoring

#### Refactor Habitat3DDebug Component
**Priority:** MEDIUM (P2)
**Category:** Code Quality

**Goal:** Check Habitat3DDebug for code that should be in its own composable/store/component

**Notes:** Component has grown large - identify extraction candidates:
- Container menu logic ‚Üí composable
- Placement mode logic ‚Üí composable
- FAB handlers ‚Üí composable
- Water bottle menu ‚Üí separate component

---

### Animation & Visual Polish

#### Chew Animation
**Priority:** MEDIUM (P2)
**Category:** Animation

**Goal:** Add chew animation for guinea pig when chewing toys/items

---

#### Enhance Groom Animation
**Priority:** LOW (P3)
**Category:** Animation

**Goal:** Improve the current grooming animation

---

#### Create Fur Patterns ‚è∏Ô∏è DEFERRED
**Priority:** LOW (P3)
**Category:** Visual Polish

**Reason:** Complex texture work, solid colors sufficient for MVP.

---

## Reference Files

| Feature | Reference |
|---------|-----------|
| Unified Behavior System | `src/composables/3d/use3DBehavior.ts` |
| Movement Controller | `src/composables/3d/use3DMovement.ts` |
| Guinea Pig Animation | `src/composables/use3DGuineaPig.ts` |
| Habitat Containers | `src/composables/useHabitatContainers.ts` |
| Hay Management Dialog | `src/components/game/dialogs/HayManagementDialog.vue` |
| Container Menu | `src/components/basic/ContainerContentsMenu.vue` |
| Inventory Panel | `src/components/game/Inventory3DPanel.vue` |
| Habitat Debug | `src/components/debug/environment/Habitat3DDebug.vue` |
| Habitat Conditions Store | `src/stores/habitatConditions.ts` |
