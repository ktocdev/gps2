# GPS2 3D Sprint - December 28, 2025

**Started:** December 28, 2025
**Status:** Active
**Branch:** GPS2-60
**Previous Sprint:** [SPRINT-2025-12-27.md](./archived/SPRINT-2025-12-27.md)

---

## Previous Sprint Summary (Dec 27, 2025)

A highly productive sprint focused on **Behavior Parity**, **UI Polish**, and **User Interactions**.

### Major Accomplishments:
- **Physics System** - Ball/stick physics with velocity, damping, collision, and rolling animations
- **Autonomous Behaviors** - Playing (with popcorn animation!) and Chewing now fully implemented
- **3D Hand Model** - Simpsons-style yellow hand with articulated fingers and multiple poses
- **Petting Interaction** - Complete flow with hand animation, need fulfillment, and activity logging
- **Hand Feed Interaction** - Food selection dialog, gripping pose, food morsel animation, inventory consumption
- **Guinea Pig Sidebar** - User friendship, GP-to-GP bonding, info section, activity history
- **Keyboard Shortcuts** - Space for pause, Q/E for rotation, R for reset, Shift+drag for pan
- **Activity Feed** - Fixed logging for all autonomous behaviors and player actions

### Code Audit Results (Dec 28):

**Files Audited:**
- `Inventory3DPanel.vue` - Guinea Pig sidebar tab
- `FoodSelectionDialog.vue` - Food selection dialog
- `use3DHand.ts` - Hand model & poses
- `Habitat3DDebug.vue` - Hand feed animation

**Issues Found & Fixed:**
| Priority | Issue | Fix Applied |
|----------|-------|-------------|
| HIGH | Index out of bounds when GP removed | Added safe index clamping in `selectedGuineaPig` computed |
| MEDIUM | Food selection persists across category changes | Added `watch(selectedCategory)` to reset selection |
| MEDIUM | CSS `margin` shorthand instead of logical properties | Changed to `margin-block-*` and `margin-inline` |
| LOW | `handFeedFoodMesh` not explicitly cleaned on unmount | Added explicit cleanup before `interactionHand` disposal |

**Passed Checks:**
- BEM naming convention
- CSS variables usage
- TypeScript types
- THREE.js resource cleanup
- Global styles (no scoped)

### Today's Progress (Dec 28):

**3D Model Viewer Debug Page:**
- New debug page at `/debug/model-viewer` for previewing all 3D models
- Categories: Characters, Food, Containers, Shelters, Toys
- Includes "Hand Holding Food" model showing gripping hand with food ball
- Camera controls: drag to rotate, shift+drag to pan, scroll to zoom, R to reset

**Gripping Hand & Food Ball System:**
- Improved gripping pose to look like ðŸ¤Œ pinched fingers emoji
- Created `createHeldFoodBall()` helper in `src/composables/3d-models/food/held-food.ts`
- Supports hex color strings or category-based fallback colors
- Added `foodBallColor` metadata to all food items in JSON data files:
  - Vegetables: Orange/red/green colors matching the food
  - Fruits: Red/pink/purple/yellow colors
  - Greens: Light to medium greens
  - Herbs: Dark greens
  - Pellets: Browns
  - Treats: Gold/special colors
- Updated hand feed animation to use same rotation as model viewer (`rotation.z = Math.PI`)

**Model Adjustments:**
- Wooden tunnel size reduced by 15%
- Fixed twig ball, chew stick, cucumber positions (no longer sink into floor)

**Refactoring - Interaction Handlers:**
- Created `use3DInteractions.ts` composable (~350 lines)
- Extracted petting animation logic from Habitat3DDebug.vue
- Extracted hand feed animation logic from Habitat3DDebug.vue
- Composable manages: hand model creation, animation states, need fulfillment, activity logging
- Reduced Habitat3DDebug.vue by ~200 lines

**Files Created/Modified:**
- `src/components/debug/prototypes/ModelViewerDebug.vue` (new)
- `src/composables/3d-models/food/held-food.ts` (new)
- `src/composables/3d/use3DInteractions.ts` (new)
- `src/types/supplies.ts` - Added `foodBallColor` to stats
- `src/data/supplies/food/*.json` - Added foodBallColor to all items
- `src/composables/3d-models/use3DHand.ts` - Improved gripping pose
- `src/composables/3d-models/shelters/tunnels.ts` - Size reduction
- `src/components/debug/environment/Habitat3DDebug.vue` - Refactored to use interactions composable

---

## Sprint Goals

**Focus:** Complete Remaining Interactions, Polish, Bug Fixes

**Priority Areas:**
1. Implement remaining 5 Interact FAB actions (Hold, Gentle Wipe, Show Toy, Peek-a-Boo, Talk To)
2. Code quality improvements (refactoring, cleanup)
3. UI polish and bug fixes

---

## Active Tasks

### User-to-GP FAB & Interactions (Rollover)
**Priority:** HIGH (P1)
**Category:** Feature
**Status:** IN PROGRESS

**Goal:** Complete remaining user-initiated interactions - parity with 2D game

**Completed:**
- [x] Interact FAB with ðŸ’› icon
- [x] FabSubnavMenu component (7 actions grid)
- [x] 3D Hand Model with poses (open, closed, pointing, petting, holding, wave, gripping)
- [x] Pet interaction (animation, need fulfillment, activity logging)
- [x] Hand Feed interaction (food dialog, gripping animation, inventory consumption)

**Remaining Actions (5):**
- [ ] **Hold (ðŸ«´)** - Pick up guinea pig, hold animation
  - Social need: +20-30%
  - Friendship: +2
- [ ] **Gentle Wipe (ðŸ§¼)** - Cleaning interaction
  - Cleanliness need: +40-50%
  - Social need: +5%
  - Friendship: +1
- [ ] **Show Toy (ðŸ§¸)** - Show toy to guinea pig
  - Play need: +10-15%
  - Social need: +5%
  - Friendship: +1
- [ ] **Peek-a-Boo (ðŸ‘€)** - Playful interaction
  - Social need: +10%
  - Friendship: +1
- [ ] **Talk To (ðŸ’¬)** - Voice interaction
  - Social need: +10-15%
  - Friendship: +1

**Files to Modify:**
- `src/components/debug/environment/Habitat3DDebug.vue` - Add interaction handlers
- `src/composables/3d-models/use3DHand.ts` - May need new poses

---

### Item Removal from Habitat
**Priority:** MEDIUM (P2)
**Category:** Feature

**Goal:** Allow removing placed items (toys, balls, tunnels, shelters) from habitat back to inventory

**Implementation:**
- Add click menu on placed items with "Remove" option
- Call `habitatConditions.removeItemFromHabitat()` and `inventoryStore.unmarkAsPlacedInHabitat()`

**Notes:**
- 2D version only has removal for chew items (via hover popover)
- Backend already exists, just need UI trigger

---

### Refactor Habitat3DDebug Component
**Priority:** MEDIUM (P2)
**Category:** Code Quality
**Status:** COMPLETE âœ…

**Goal:** Extract logic from oversized component into composables before it grows further

**Before:** `Habitat3DDebug.vue` was ~3000 lines containing all 3D game logic, interactions, menus, and UI state.

**After:** `Habitat3DDebug.vue` is now a **thin wrapper** (~130 lines) that:
- Renders the layout (header, GameView, NeedsPanel)
- Manages fullscreen state
- Delegates all game logic to `GameView.vue`

**Architecture:**
```
Habitat3DDebug.vue (thin wrapper - debug page)
  â””â”€â”€ GameView.vue (production game component)
        â””â”€â”€ Uses composables for all logic
```

**Completed Extractions:**
| Composable | Responsibility | Location |
|------------|----------------|----------|
| `use3DInteractions.ts` | Petting, hand feed, hold animations | `src/composables/3d/` |
| `use3DContainerMenu.ts` | Food bowl & hay rack menus | `src/composables/3d/` |
| `use3DPlacement.ts` | Item placement mode & preview | `src/composables/3d/` |
| `use3DHabitatCare.ts` | FAB habitat care actions | `src/composables/3d/` |
| `use3DWaterBottle.ts` | Water bottle menu & refill | `src/composables/3d/` |

**Benefits:**
- Clear separation of concerns
- Reusable composables for other views
- Easier testing and maintenance
- `GameView.vue` can be used standalone in production

---

### Chat Bubbles
**Priority:** MEDIUM (P2)
**Category:** Feature

**Goal:** Add guinea pig chat bubbles for reactions - parity from 2D game

**Questions:**
- Would 3D chat bubbles look cute?
- Flat 3D (billboard style)?

---

## Known Bugs

### Food Container Add Fails After Refresh
**Priority:** HIGH
**Category:** Bug
**Status:** FIXED âœ…

**Issue:** After refreshing the 3D game view, adding food to food containers fails silently.

**Root Causes (2 issues found):**

1. **State sync issue:** `useHabitatContainers` composable (module-level singleton refs) wasn't synced with `habitatConditions` store after persistence rehydration. Deserialization created NEW Map instances but composable refs pointed to ORIGINAL empty Maps.

2. **Serving data corruption:** `removeFoodFromBowl()` used `addItem()` instead of `addConsumableWithServings()`, causing hay/food returned to inventory to lose their `servingsRemaining` data. After refresh, items existed but couldn't be used.

**Fixes Applied:**
- Added `afterHydrate` hook to `habitatConditions.ts` to sync Maps back to composable refs
- Fixed `removeFoodFromBowl()` in `useHabitatContainers.ts` to use `addConsumableWithServings()` for serving-based items
- Added migration in `inventoryStore.ts` `afterHydrate` to restore missing `servingsRemaining` data on corrupted instances

---

### Fullscreen Mode: Fill Entire Browser
**Priority:** MEDIUM (P2)
**Category:** UI/UX
**Status:** COMPLETE âœ…

**Goal:** When entering fullscreen mode, GameView should fill the entire browser window on ALL devices

**Decision Made:**
- âœ… All devices (mobile, tablet, desktop): GameView fills entire browser
- âœ… No gray background or padding
- âœ… Only `habitat-3d-debug__fullscreen-header` visible above canvas
- âœ… Canvas takes remaining viewport height

**Implementation:**
- [x] Remove `max-inline-size` aspect ratio constraint in fullscreen mode
- [x] Set canvas wrapper to `100vw` width and `calc(100vh - header)` height
- [x] Remove `margin-inline: auto` centering
- [x] Remove border-radius in fullscreen
- [x] Ensure `touch-action: none` on canvas for mobile
- [x] Fixed header heights: 52px desktop, 40px mobile landscape

---

## Backlog

### Guinea Pig to Guinea Pig Actions (GP2GP) & Socializing Behavior
**Priority:** MEDIUM (P2)
**Category:** Feature / Behavior Parity

**Goal:** Implement GP-to-GP social actions and autonomous socializing - parity with 2D game

**Autonomous Socializing Behavior:**
- [ ] Guinea pig seeks out another guinea pig when social need is low
- [ ] Approach animation, social interaction, satisfy social need
- 2D reference: `useSocialBehaviors.ts`

**Player-Initiated GP2GP Actions:**
- Social interaction
- Play together
- Groom each other
- Greet
- Check out

**Notes:**
- Requires multi-guinea-pig coordination logic
- May need pathfinding to locate other guinea pigs
- Social interactions affect both guinea pigs' needs

---

### Replace Comfort Need with Stimulation
**Priority:** MEDIUM (P2)
**Category:** Game Design

**Goal:** Replace comfort need with stimulation need

**Notes:** This is documented in the docs folder somewhere

---

### 3D Models
**Priority:** MEDIUM (P2)
**Category:** Assets

**Tasks:**
- Create 3D models for other food items
- Enhance hay 3D model
- Create 3D models for some other habitat items

---

### Fix Guinea Pig Collisions
**Priority:** MEDIUM (P2)
**Category:** Bug Fix

**Issue:** Guinea pigs walk through arch tunnel, igloo walls, water bottle

**Goal:** Proper collision detection/avoidance

---

### Water Bottle Drinking Animation
**Priority:** LOW (P3)
**Category:** Animation

**Goal:** Guinea pig visually drinks through water bottle spout

---

### Multiple Item Instances Testing
**Priority:** LOW (P3)
**Category:** Testing

**Goal:** Test adding multiple instances of:
- Food containers
- Water bottles
- Toys, etc.

---

### Mini Progress Bars in Habitat Care FABs
**Priority:** LOW (P3)
**Category:** UI Enhancement

**Goal:** When Habitat Care FAB is expanded, show mini progress bars in each pill

**Metrics:**
- Water level %
- Hay freshness % (average of all racks)
- Bedding freshness %
- Poop ratio (poops until dirty)

---

### Bedding Items in Inventory Panel Should Look Disabled
**Priority:** LOW (P3)
**Category:** UI Enhancement

**Goal:** Bedding Items in the Inventory Panel should look disabled and grayed out to prevent confusion.

---

### Enhance Groom Animation
**Priority:** LOW (P3)
**Category:** Animation

**Goal:** Improve the current grooming animation

---

### Create Fur Patterns
**Priority:** LOW (P3)
**Category:** Visual Polish

**Reason:** Complex texture work, solid colors sufficient for MVP.

---

## Reference Files

| Feature | Reference |
|---------|-----------|
| Unified Behavior System | `src/composables/3d/use3DBehavior.ts` |
| Movement Controller | `src/composables/3d/use3DMovement.ts` |
| 3D Interactions | `src/composables/3d/use3DInteractions.ts` |
| Container Menu Logic | `src/composables/3d/use3DContainerMenu.ts` |
| Placement Mode Logic | `src/composables/3d/use3DPlacement.ts` |
| Habitat Care Actions | `src/composables/3d/use3DHabitatCare.ts` |
| Water Bottle Menu | `src/composables/3d/use3DWaterBottle.ts` |
| Guinea Pig Animation | `src/composables/use3DGuineaPig.ts` |
| 3D Hand Model | `src/composables/3d-models/use3DHand.ts` |
| Held Food Ball | `src/composables/3d-models/food/held-food.ts` |
| 3D Model Viewer | `src/components/debug/prototypes/ModelViewerDebug.vue` |
| 3D Model Sync | `src/composables/use3DSync.ts` |
| Habitat Containers | `src/composables/useHabitatContainers.ts` |
| Hay Management Dialog | `src/components/game/dialogs/HayManagementDialog.vue` |
| Food Selection Dialog | `src/components/game/dialogs/FoodSelectionDialog.vue` |
| Container Menu | `src/components/basic/ContainerContentsMenu.vue` |
| Inventory Panel | `src/components/game/Inventory3DPanel.vue` |
| Friendship Progress | `src/components/game/ui/FriendshipProgress.vue` |
| FAB Subnav Menu | `src/components/game/FabSubnavMenu.vue` |
| FAB Subnav Styles | `src/styles/fab-subnav.css` |
| Habitat Debug | `src/components/debug/environment/Habitat3DDebug.vue` |
| Habitat Conditions Store | `src/stores/habitatConditions.ts` |
| 2D Behavior Reference | `src/composables/useGuineaPigBehavior.ts` |
