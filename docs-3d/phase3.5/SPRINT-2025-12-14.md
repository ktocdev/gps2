# GPS2 3D Sprint - December 14, 2025

**Started:** December 14, 2025
**Status:** Active
**Branch:** GPS2-56
**Previous Sprint:** [SPRINT-2025-12-12.md](./archived/SPRINT-2025-12-12.md)

**Progress:**
- Code Audit - 3D Behavior System DONE (8.5/10)
- CSS Audit - New Components DONE (9/10)
- Guinea Pig Selection Toggle marked COMPLETE (via NeedsPanel)
- Manual Triggers Panel marked WON'T DO (NeedsPanel covers this)
- Shelter Need Fulfillment DONE
- Sleep Need Fulfillment DONE
- Shared Shelter Positioning DONE (left/right slots for two guinea pigs)
- Groom Need Fulfillment DONE

---

## Sprint Goals

**Focus:** Testing, Code Quality, Shelter Need Implementation

**Priority Areas:**
1. Test existing hunger/thirst behaviors
2. Code and CSS audits
3. Implement shelter need (guinea pig enters igloo)

---

## Sprint Backlog

### Test Drinking Behavior
**Priority:** HIGH (P1)
**Status:** ðŸ”² TODO
**Category:** Testing

**Checklist:**
- [X] Thirst < 65 triggers seek water behavior
- [X] Guinea pig navigates to water bottle
- [X] Water level decreases visually when drinking
- [X] Bubble animation appears during drinking
- [X] Thirst restores to correct value after drinking (35% restore)

---

### Test Hunger Behavior
**Priority:** HIGH (P1)
**Status:** ðŸ”² TODO
**Category:** Testing

**Checklist:**
- [X] Hunger < 70 triggers seek food behavior
- [X] Guinea pig navigates to food bowl
- [X] Guinea pig eats at bowl (3 second duration)
- [X] Hunger restores to correct value after eating (50 restore)

---

### Code Audit - 3D Behavior System
**Priority:** MEDIUM (P2)
**Status:** âœ… COMPLETE
**Category:** Code Quality

**Overall Score: 8.5/10**

| File | TS | Memory | Errors | Structure |
|------|-----|--------|--------|-----------|
| use3DBehavior.ts | 9/10 | 9/10 | 8/10 | 9/10 |
| use3DMovement.ts | 8/10 | 9/10 | 8/10 | 9/10 |
| use3DGuineaPig.ts | 8/10 | 9/10 | 7/10 | 9/10 |

**Issues Found & Fixed:**
- `use3DMovement.ts:24` - Changed `let isAnimating` to `const isAnimating` âœ…

**Issues Reviewed (No Action Needed):**
- Direct store mutation for `lastPoopTime` - consistent with 2D behavior pattern, valid in Pinia setup stores

---

### CSS Audit - New Components
**Priority:** MEDIUM (P2)
**Status:** âœ… COMPLETE
**Category:** Code Quality

**Overall Score: 9/10**

| File | BEM | Logical Props | CSS Vars | Score |
|------|-----|---------------|----------|-------|
| GuineaPigInfoMenu.vue | 10/10 | 10/10 | 9/10 | 9.5/10 |
| WaterBottleMenu.vue | 10/10 | 10/10 | 9/10 | 9/10 |

**Issues Found & Fixed:**
- `WaterBottleMenu.vue:172-178` - Changed hardcoded `#0088ff`/`#0066cc` to `var(--color-info)`/`var(--color-info-hover)` âœ…

**Notes:**
- Water level gradient colors kept as-is (semantic: blue=high, yellow=medium, red=low)

---

### Implement Shelter Need Fulfillment
**Priority:** HIGH (P1)
**Status:** âœ… COMPLETE
**Category:** Core Feature

**Goal:** Guinea pig enters igloo when shelter need is low

**Implementation:**
1. [X] Pathfinding navigates to entrance position (+Z offset from igloo center)
2. [X] Added shelter threshold = 50 to `use3DBehavior.ts`
3. [X] Added `seek_shelter` behavior type with priority 70 (moderate)
4. [X] Guinea pig navigates to igloo entrance (5 units in front)
5. [X] Guinea pig moves inside igloo (visible through transparent dome)
6. [X] Shelter need restores 30 points, comfort restores 15 points
7. [X] Guinea pig exits after 8 seconds

**Design Decisions Made:**
- Guinea pig is **visible** inside igloo (seen through transparent pink dome)
- Duration: **8 seconds** in shelter
- Also restores **comfort +15** when sheltering (synergy bonus)

**Animation Sequence:**
1. Walk to entrance (pathfinding, avoids obstacles)
2. Walk directly into center (no pathfinding - bypasses obstacles for intentional entry)
3. Rotate 180Â° to face entrance (smooth eased rotation over 600ms)
4. Rest for 8 seconds inside shelter
5. Walk directly out to entrance (head first, smooth exit)
6. Resume normal behavior

**New Functions Added:**
- `moveDirectTo()` - Move without pathfinding for intentional shelter entry/exit
- `rotateTo()` - Smooth rotation animation with cubic easing
- `isAnotherGuineaPigInShelter()` - Check if shelter is occupied
- `getShelterSlotPosition()` - Get left/right position inside shelter

**Shared Shelter Support:**
- First guinea pig always positions on the **left** side
- Second guinea pig positions on the **right** side
- Both guinea pigs can shelter/sleep simultaneously
- Side offset: 1.2 units from center

**Configuration:**
| Need | Threshold | Duration | Restore | Cooldown |
|------|-----------|----------|---------|----------|
| Shelter | 50 | 8000ms | 30 | 60s |

**Files Modified:**
- [use3DBehavior.ts](../../src/composables/3d/use3DBehavior.ts) - Added shelter behavior with async animation sequence
- [use3DMovement.ts](../../src/composables/3d/use3DMovement.ts) - Added `moveDirectTo()` and `rotateTo()` functions
- [Habitat3DDebug.vue](../../src/components/debug/environment/Habitat3DDebug.vue) - Added shelter start/end callbacks

---

### Implement Sleep Need Fulfillment
**Priority:** HIGH (P1)
**Status:** âœ… COMPLETE
**Category:** Core Feature

**Goal:** Guinea pig sleeps when energy is low (matching 2D behavior)

**Implementation:**
1. [X] Added `sleep` behavior type and `sleeping` activity
2. [X] Added `findSleepPosition()` - finds bed > shelter > sleep in place
3. [X] Sleep priority 80 (high), triggers when energy < 40
4. [X] Reuses shelter entry animation for sleeping in igloo
5. [X] Sleep pose: closed eyes (scale.y = 0.1), squished body (scale.y = 0.85)
6. [X] Breathing animation continues during sleep
7. [X] Sleep quality multiplier: 1.0x (floor) to 1.85x (bed+shelter)

**Configuration:**
| Parameter | Value |
|-----------|-------|
| Energy Threshold | < 40% |
| Priority Weight | 80 (high) |
| Base Duration | 5000ms |
| Duration Multiplier | 1.2x-2.0x based on tiredness |
| Max Duration | 15 seconds |
| Base Energy Restore | 25 |
| Cooldown | 2 minutes |

**Sleep Location Priority:**
1. **Bed** (if available) - walk to bed, lay down
2. **Shelter/Igloo** (if available) - reuse shelter entry animation
3. **Floor** (fallback) - sleep in place

**Quality Multiplier:**
- Floor: 1.0x (25 energy restored)
- Bed: 1.55x (~39 energy restored)
- Shelter/Igloo: 1.65x (~41 energy restored)

**Visual Changes:**
- Eyes closed (no blinking during sleep)
- Body scale Y reduced to 0.85 (laying/curled pose)
- Breathing continues (shows guinea pig is alive)

**Shared Igloo Sleep:**
- Uses same left/right slot positioning as shelter behavior
- Both guinea pigs can sleep in igloo simultaneously
- Future: Social bonding increases when sleeping together

**Files Modified:**
- [use3DBehavior.ts](../../src/composables/3d/use3DBehavior.ts) - Added sleep behavior, config, callbacks, shared slot positioning
- [use3DGuineaPig.ts](../../src/composables/use3DGuineaPig.ts) - Added `isSleeping` param for visual state
- [Habitat3DDebug.vue](../../src/components/debug/environment/Habitat3DDebug.vue) - Pass sleep state to animation

---

### Implement Groom Need Fulfillment
**Priority:** MEDIUM (P2)
**Status:** âœ… COMPLETE
**Category:** Core Feature

**Goal:** Guinea pig grooms itself when hygiene is low (matching 2D behavior)

**Implementation:**
1. [X] Added `groom` behavior type and `grooming` activity
2. [X] Groom priority 50 (moderate), triggers when hygiene < 60
3. [X] No movement required - guinea pig grooms in place
4. [X] Personality cleanliness trait affects duration and restoration
5. [X] Grooming animation: front legs paw at face, eyes squinted

**Configuration:**
| Parameter | Value |
|-----------|-------|
| Hygiene Threshold | < 60% |
| Priority Weight | 50 (moderate) |
| Base Duration | 4000ms |
| Duration Multiplier | 0.75x-1.2x based on cleanliness trait |
| Base Hygiene Restore | 15 |
| Restore Multiplier | 0.55x-1.0x based on cleanliness trait |
| Cooldown | 30 seconds |

**Personality Influence:**
- Cleanliness trait (1-10) affects both duration and restoration
- Higher cleanliness = longer, more thorough grooming = more hygiene restored
- Cleanliness 1: ~8 hygiene restored, 3s duration
- Cleanliness 10: ~15 hygiene restored, 4.8s duration

**Animation:**
- Guinea pig sits up on haunches (body tilts back ~15Â°)
- Front legs lift higher and paw alternately (like washing face)
- Eyes slightly squinted (concentrating)
- Breathing continues
- Back legs remain planted (supporting sit-up pose)
- Smooth transition in/out of sit-up pose

**Files Modified:**
- [use3DBehavior.ts](../../src/composables/3d/use3DBehavior.ts) - Added groom behavior, config, callbacks
- [use3DGuineaPig.ts](../../src/composables/use3DGuineaPig.ts) - Added `isGrooming` param for paw animation
- [Habitat3DDebug.vue](../../src/components/debug/environment/Habitat3DDebug.vue) - Pass groom state to animation

---

## Deferred Items (From Previous Sprint)

### Fix Poop Spawn Position
**Priority:** HIGH (P0)
**Status:** â¸ï¸ DEFERRED
**Category:** Bug Fix

**Issue:** Poops appear in wrong places instead of dropping under the guinea pig

**Root Cause:** The unified 3D behavior system doesn't have poop handling yet. Need to port poop logic from deleted `use3DHungerBehavior.ts`.

---

### Add Guinea Pig Selection Toggle
**Priority:** LOW (P3)
**Status:** âœ… COMPLETE
**Category:** Debug Feature

**Implementation:** Already available via the guinea pig toggle buttons in the NeedsPanel component.

---

### Add Manual Triggers Panel
**Priority:** LOW (P3)
**Status:** âŒ WON'T DO
**Category:** Debug Feature

**Reason:** Needs panel already allows editing need values directly, which triggers behaviors. No separate trigger panel needed.

---

### Create Fur Patterns
**Priority:** LOW (P3)
**Status:** â¸ï¸ DEFERRED
**Category:** Visual Polish

**Reason:** Complex texture work, solid colors sufficient for MVP.

---

## Implementation Order

**Phase 1: Testing (Verify Existing Work)**
1. [ ] Test drinking behavior end-to-end
2. [ ] Test hunger behavior end-to-end

**Phase 2: Code Quality**
3. [ ] Run code audit on 3D behavior system
4. [ ] Run CSS audit on new menu components
5. [ ] Fix any issues found

**Phase 3: Shelter Need (Core Feature)**
6. [ ] Research igloo pathfinding
7. [ ] Add shelter behavior to unified system
8. [ ] Implement enter/exit igloo logic
9. [ ] Test shelter need fulfillment

---

## Future Needs Roadmap

| Need | Item Required | Notes |
|------|---------------|-------|
| Hunger | Food bowl | âœ… Implemented |
| Thirst | Water bottle | âœ… Implemented |
| Shelter | Igloo/Hideout | âœ… Implemented |
| Energy | Igloo/Hideout/Bed | âœ… Implemented |
| Hygiene | Self-groom | âœ… Implemented (groom in place) |
| Chew | Chew toy | Navigate to toy |
| Play | Toy | Navigate to toy, play animation |
| Social | Other guinea pig | Approach companion |
| Comfort | Fleece/bedding | Sit on comfortable surface |
| Nails | Player interaction | Cannot self-fulfill |
| Health | Player interaction | Cannot self-fulfill |

---

## Reference Files

| Feature | Reference |
|---------|-----------|
| Unified Behavior System | `src/composables/3d/use3DBehavior.ts` |
| Movement Controller | `src/composables/3d/use3DMovement.ts` |
| Guinea Pig Animation | `src/composables/use3DGuineaPig.ts` |
| Igloo Model | `src/composables/3d-models/environment/igloos.ts` |
| 2D Shelter Behavior | `src/composables/game/useGuineaPigBehavior.ts` |
