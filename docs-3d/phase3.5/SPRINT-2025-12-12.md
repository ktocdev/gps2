# GPS2 3D Sprint - December 12, 2025

**Started:** December 12, 2025
**Status:** Active
**Branch:** GPS2-54
**Previous Work:** Phase 3.5 Implementation (Autonomous Hunger Behavior)

**Progress:**
- Code Audit Complete (8.5/10)
- CSS/Layout Audit Complete (9.4/10)
- Audit fixes applied (seededRandom, receiveShadow, CSS variable)
- P0 Bug: Poop spawn position - partial fix (still not dropping directly under guinea pig)
- P0 Bug: Poop click inside igloo FIXED
- P2: Remove water bottle rotation debug panel DONE
- P1: Remove floating action buttons DONE
- P1: Create GuineaPigInfoMenu component DONE

---

## Sprint Goals

**Focus:** 3D UX Improvements, Guinea Pig Interaction Menu, Debug Panels

**Priority Areas:**
1. Fix blocking bugs (poop positioning)
2. Replace floating action buttons with guinea pig info menu
3. Implement "Take Control" mode for manual guinea pig movement
4. Add debug panels for testing (Needs, Manual Triggers)

---

## Sprint Backlog

### Fix Poop Spawn Position
**Priority:** HIGH (P0)
**Status:** ⏸️ DEFERRED
**Category:** Bug Fix

**Issue:** Poops appear in wrong places instead of dropping under the guinea pig

**Root Cause:** The 3D hunger behavior (`use3DHungerBehavior.ts`) didn't have poop handling. The 2D behavior system was creating poop based on 2D positions which weren't updated in 3D mode.

**Solution:** Added `checkAutonomousPooping()` function to `use3DHungerBehavior.ts` that:
1. Gets guinea pig's world position from `movement3DStore`
2. Converts world position to grid coordinates using `worldToGrid()`
3. Converts grid to subgrid with random offset for visual variety
4. Calls `habitatConditions.addPoop()` with correct coordinates

**Files Modified:**
- [use3DHungerBehavior.ts](../../src/composables/3d/use3DHungerBehavior.ts) - Added poop handling

---

### Fix Poop Click Detection Inside Igloo
**Priority:** HIGH (P0)
**Status:** ✅ COMPLETE
**Category:** Bug Fix

**Issue:** Can't click to remove poop when it's inside the igloo/shelter

**Root Cause:** Raycaster was only checking the first intersection (`intersects[0]`), so when poop was inside the igloo, the igloo mesh was hit first and blocked poop detection.

**Solution:** Changed poop detection to loop through ALL intersections, not just the first one. This allows clicking "through" the igloo to reach poop inside.

**Files Modified:**
- [Habitat3DDebug.vue](../../src/components/debug/environment/Habitat3DDebug.vue) - Updated `handleCanvasClick()` to check all intersections for poop

---

### Remove Water Bottle Rotation Debug Panel
**Priority:** MEDIUM (P2)
**Status:** ✅ COMPLETE
**Category:** Cleanup

**Goal:** Remove the Water Bottle Rotation Debug panel - feature is now stable

**Files Modified:**
- [Habitat3DDebug.vue](../../src/components/debug/environment/Habitat3DDebug.vue) - Removed rotation debug panel, CSS, and related functions

---

### Remove Floating Action Buttons
**Priority:** HIGH (P1)
**Status:** ✅ COMPLETE
**Category:** Refactor

**Goal:** Remove the current floating action buttons (Feed, Water, Play, Pet, Deselect) that appear when clicking a guinea pig

**Files Modified:**
- [Habitat3DDebug.vue](../../src/components/debug/environment/Habitat3DDebug.vue) - Removed FAB components, replaced with GuineaPigInfoMenu

---

### Create Guinea Pig Info Menu Component
**Priority:** HIGH (P1)
**Status:** ✅ COMPLETE
**Category:** New Feature

**Goal:** Create a menu that appears when clicking a guinea pig showing info and controls

**Implementation:**
- Created [GuineaPigInfoMenu.vue](../../src/components/game/GuineaPigInfoMenu.vue)
- Displays: Name, breed, gender, age
- Shows all 8 needs as color-coded progress bars (green/yellow/red based on value)
- Positioned near clicked guinea pig
- "Take Control" button (placeholder for next sprint item)
- Close button to deselect

**Files Created:**
- [GuineaPigInfoMenu.vue](../../src/components/game/GuineaPigInfoMenu.vue) - New component

**Files Modified:**
- [Habitat3DDebug.vue](../../src/components/debug/environment/Habitat3DDebug.vue) - Integrated new menu, click handling

---

### Implement "Take Control" Mode
**Priority:** HIGH (P1)
**Status:** ✅ COMPLETE
**Category:** New Feature

**Goal:** Allow player to manually control guinea pig movement by clicking destinations

**Behavior:**
1. Click "Take Control" button in guinea pig menu
2. Guinea pig gets different colored selection ring (blue instead of green)
3. Click anywhere in habitat to set walk destination
4. Guinea pig walks to clicked point using existing pathfinding (obstacle avoidance)
5. Control auto-releases after 30 seconds (like 2D view)
6. Menu can be closed while still in control mode
7. Clicking another guinea pig or pressing escape releases control

**Implementation:**
- Added `controlledGuineaPigId` ref to track which guinea pig is being controlled
- Modified `handleCanvasClick` to detect control mode and set walk destination
- Uses `use3DMovement.moveTo()` for pathfinding
- Added 30-second auto-release timer
- Selection ring changes from green (0x00ff00) to blue (0x0088ff) when controlling
- Pauses autonomous hunger behavior while controlling, resumes on release

**Files Modified:**
- [Habitat3DDebug.vue](../../src/components/debug/environment/Habitat3DDebug.vue) - Control mode logic, click handling
- [GuineaPigInfoMenu.vue](../../src/components/game/GuineaPigInfoMenu.vue) - Take Control button with emit

---

### Add Guinea Pig Selection Toggle
**Priority:** MEDIUM (P2)
**Status:** ⏸️ DEFERRED
**Category:** UI Enhancement

**Goal:** Add guinea pig selection toggle button (reuse from 2D HabitatDebug)

**Reason Deferred:** Debug-only feature, not needed for final game. Testing via click selection in 3D view.

---

### Add Manual Triggers Panel
**Priority:** MEDIUM (P2)
**Status:** ⏸️ DEFERRED
**Category:** Debug Feature

**Goal:** Add debug panel with manual behavior triggers

**Reason Deferred:** Debug-only feature, not needed for final game.

---

### Add Needs Panel
**Priority:** MEDIUM (P2)
**Status:** ⏸️ DEFERRED
**Category:** Debug Feature

**Goal:** Add debug panel for viewing/editing guinea pig needs

**Reason Deferred:** Debug-only feature, not needed for final game. Needs visible in GuineaPigInfoMenu.

---

### Add Colors to Guinea Pig Model
**Priority:** LOW (P3)
**Status:** ✅ COMPLETE
**Category:** UX Polish

**Goal:** Add color variations to the 3D guinea pig model

**Implementation:**
- Created `GuineaPig3DColors` type and `getGuineaPig3DColors()` mapping function
- Maps fur color names (brown, cream, black, etc.) to hex values for fur, ear, skin, eye
- `createGuineaPigModel()` accepts optional colors parameter
- `use3DSync` passes guinea pig appearance colors when creating models

**Files Modified:**
- [guineaPigColors.ts](../../src/constants/guineaPigColors.ts) - Color mapping constants
- [use3DGuineaPig.ts](../../src/composables/use3DGuineaPig.ts) - Accept color parameter
- [use3DSync.ts](../../src/composables/use3DSync.ts) - Pass colors from guinea pig appearance

---

### Create Fur Patterns
**Priority:** LOW (P3)
**Status:** ⏸️ DEFERRED
**Category:** UX Polish

**Goal:** Add fur pattern variations to guinea pig models

**Reason Deferred:** Complex texture work, colors sufficient for MVP.

---

### Implement Drink Action (Thirst Behavior)
**Priority:** HIGH (P1)
**Status:** ✅ COMPLETE
**Category:** Core Feature

**Goal:** Guinea pigs autonomously drink water when thirsty, with visual feedback

**Behavior:**
1. Replicate thirst need values/thresholds from 2D version
2. When thirst drops below threshold, guinea pig navigates to water bottle
3. Guinea pig drinks water (animation at bottle)
4. Water level decreases visually in bottle
5. Animated bubbles appear in bottle while drinking
6. Click water bottle to show menu:
   - Display current water level value
   - "Refill Water Bottle" button

**Implementation:**
- Thirst threshold = 65 (seek water when < 65), drinking duration = 3000ms, restore amount = 35%
- Updated water bottle 3D model to show dynamic water level (scales based on habitatConditions.waterLevel)
- Added bubble particle effect during drinking (8 bubbles with wobble animation)
- Created `WaterBottleMenu.vue` component with water level display and refill button
- Wired up click detection in `Habitat3DDebug.vue`
- **Note:** Initially created as separate `use3DThirstBehavior.ts`, later refactored into unified system (see below)

**Files Created:**
- [WaterBottleMenu.vue](../../src/components/game/WaterBottleMenu.vue) - Water bottle interaction menu

**Files Modified:**
- [Habitat3DDebug.vue](../../src/components/debug/environment/Habitat3DDebug.vue) - Add thirst behavior, water bottle click, bubble updates
- [water-bottles.ts](../../src/composables/3d-models/containers/water-bottles.ts) - Dynamic water level, bubble animation functions

---

### Unified 3D Behavior System
**Priority:** HIGH (P1)
**Status:** ✅ COMPLETE
**Category:** Architecture Refactor

**Problem:** Separate behavior composables (`use3DHungerBehavior.ts`, `use3DThirstBehavior.ts`) each created their own movement controller, causing conflicts when both tried to control the same guinea pig.

**Solution:** Created unified `use3DBehavior.ts` following the 2D pattern from `useGuineaPigBehavior.ts`:
- Single behavior controller per guinea pig
- Single movement controller shared across all behaviors
- Priority-based goal selection (higher urgency = higher priority)
- Cooldown system to prevent behavior spamming
- Extensible for future needs (sleep, groom, play, etc.)

**Thresholds:**
| Need | Threshold | Duration | Restore |
|------|-----------|----------|---------|
| Hunger | 70 | 3000ms | 50 |
| Thirst | 65 | 3000ms | 35 |

**Files Created:**
- [use3DBehavior.ts](../../src/composables/3d/use3DBehavior.ts) - Unified behavior controller
- [2-unified-3d-behavior-system.md](./2-unified-3d-behavior-system.md) - Design document

**Files Modified:**
- [Habitat3DDebug.vue](../../src/components/debug/environment/Habitat3DDebug.vue) - Use unified behavior

**Files Deleted:**
- `use3DHungerBehavior.ts` - Replaced by unified system
- `use3DThirstBehavior.ts` - Replaced by unified system

---

## Implementation Order

**Phase 1: Bug Fixes & Cleanup (Quick Wins)**
1. [~] Fix poop spawn position - DEFERRED
2. [X] Fix poop click in igloo ✅
3. [X] Remove water bottle rotation panel ✅

**Phase 2: Guinea Pig Menu (Core Feature)**
4. [X] Remove floating action buttons ✅
5. [X] Create GuineaPigInfoMenu component ✅
6. [X] Wire up menu display on guinea pig click ✅
7. [X] Implement "Take Control" mode

**Phase 3: Debug Panels (Testing Support)**
8. [~] Add guinea pig selection toggle - DEFERRED
9. [~] Add Manual Triggers panel - DEFERRED
10. [~] Add Needs panel - DEFERRED

**Phase 4: Visual Polish (If Time Permits)**
11. [X] Add guinea pig colors
12. [~] Create fur patterns - DEFERRED

**Phase 5: Thirst Behavior (Next Core Feature)**
13. [X] Implement Drink Action (Thirst Behavior) ✅

**Phase 6: Unified Behavior System**
14. [X] Refactor to unified priority-based behavior system ✅

---

## Notes

### Active Items
- P0 bugs should be fixed first (blocking issues)
- Guinea pig menu is the main feature for this sprint
- Debug panels help with testing Take Control feature

### Dependencies
- Task 4 (remove FABs) must complete before Task 5-7
- Task 5 (create menu) must complete before Task 6-7
- Tasks 8-10 (debug panels) can be done in parallel

### Reference Files
| Feature | Reference |
|---------|-----------|
| Guinea Pig Selection | `HabitatDebug.vue` |
| Needs Panel Styles | `NeedsPanel.vue` |
| Take Control (2D) | `useMovement.ts` |
| Poop System | `use3DPoop.ts` |
| Current FABs | `Habitat3DDebug.vue:29-83` |

---

## Completed This Sprint

### Code Audit GPS2-54
**Date:** December 12, 2025
**Category:** Code Quality

**Results:**
- Overall Score: 8.5/10
- TypeScript Quality: 10/10
- Code Structure: 9/10
- Memory/Performance: 9/10
- CSS Quality: 9.4/10

**Issues Found & Fixed:**
- Fixed `chew-toys.ts` to use seededRandom (prevents jitter)
- Added `receiveShadow` to vegetables.ts cucumber slice
- Added `--color-bg-canvas` CSS variable
- Updated Habitat3DDebug.vue to use CSS variable

**Full Report:** [GPS2-54-3D-CODE-AUDIT.md](../../docs/audits/GPS2-54-3D-CODE-AUDIT.md)

---

## Testing Checklist (from Phase 3.5)

- [X] Guinea pig appears in 3D habitat on game start
- [X] Guinea pig wanders randomly when not hungry
- [X] Hunger decreases over time (existing decay)
- [X] When hunger < 70, guinea pig navigates to food bowl
- [X] Path goes around obstacles, not through them
- [X] Guinea pig eats at food bowl (3 seconds)
- [X] After eating, hunger resets to 100
- [X] Game pause stops movement, resume continues
- [X] Multiple guinea pigs move independently
